/*
 * Copyright (C) 2009-2014 SAP SE or an SAP affiliate company. All rights reserved
 */
jQuery.sap.require("sap.ca.scfld.md.controller.BaseFullscreenController");jQuery.sap.require("sap.ca.ui.message.message");sap.ca.scfld.md.controller.BaseFullscreenController.extend("cus.crm.ppm.mgr.view.S1",{onInit:function(){sap.ca.scfld.md.controller.BaseFullscreenController.prototype.onInit.call(this);this._initControllerVariables();var d=sap.ui.Device,b=d.browser;if(this.getServiceVersion()==1&&this.getServiceSchemaVersion()>=2){var c=this.getView().byId("sSP2");var i=new sap.ui.core.ListItem("liBarChart",{key:"BarChart",text:this.oBundle.getText("BTN_SELECT_BARCHART")});c.addItem(i);if(this._bIsRTL&&!d.system.phone)this.getView().byId("fvbChart")._oChartPopover.attachAfterOpen(jQuery.proxy(this._checkForPopoverArrow,this))}this.loaddata();if(b.BROWSER.INTERNET_EXPLORER==b.name&&b.version<10){var s=this.getView().byId("opportunitySlider");s.removeStyleClass("alignRight");s.addStyleClass("alignRightIE9")}this._initializeAllControllerFragments();sap.ui.getCore().byId("dlSalesPeriodSet").addStyleClass("sapcrmMDialogCont");sap.ui.getCore().byId("poPage").addStyleClass("sapUiStdPage");this.byId("page").addStyleClass("sapUiStdPage");this.byId("objectStatus").addStyleClass("boldText");this.disableTextSelection();window.addEventListener("orientationchange",function(){if(sap.ui.getCore().byId("po").isOpen())sap.ui.getCore().byId("po").close()},false);this.filteredOpportunities=this.Opportunities.slice(0);this.OpportunitiesAll_chart=this.Opportunities.slice(0)},_initControllerVariables:function(){this.oBundle=this.oApplicationFacade.getResourceBundle();this.oDataModel=this.oApplicationFacade.getODataModel();this._iServiceSchemaVersion=this._getServiceSchemaVersion(this.oDataModel,"Opportunity");this._iServiceVersion=this._getServiceVersion(this.oDataModel,"Opportunity");this.data={results:[]};this.filteredData={results:[]};this.graphDataToShow={results:[]};this.oApplicationFacade.oApplicationImplementation.oCurController.FullCtrl=this;this.viewType={};this.ptGroup={};this.ptGroup_chart={};this.filteredOpportunities=false;this.OpportunitiesAll_chart=false;this.reRenderTopNSlider=true;this._bIsRTL=sap.ui.getCore().getConfiguration().getRTL()},onBeforeRendering:function(){this.defineButtons();this.calculateProgress()},disableTextSelection:function(){this.getView().byId('page').allowTextSelection(false);this.getView().byId('objectHeader').allowTextSelection(false);sap.ui.getCore().byId('po').allowTextSelection(false);sap.ui.getCore().byId('dlAppSettings').allowTextSelection(false);sap.ui.getCore().byId('dlSalesPeriodSet').allowTextSelection(false);sap.ui.getCore().byId('popup').allowTextSelection(false)},onExit:function(){this._destroyAllControllerFragments();if(this._bIsRTL&&!sap.ui.Device.system.phone)this.getView().byId("fvbChart")._oChartPopover.detachAfterOpen(jQuery.proxy(this._checkForPopoverArrow,this));if(sap.ui.getCore().byId("liBarChart"))sap.ui.getCore().byId("liBarChart").destroy()},getServiceVersion:function(){return this._iServiceVersion},getServiceSchemaVersion:function(){return this._iServiceSchemaVersion},_getEntityAnnotation:function(m,a,e){var M=m.getServiceMetadata();if(M&&M.dataServices&&M.dataServices.schema&&M.dataServices.schema.length>0&&M.dataServices.schema[0].entityType){var E=M.dataServices.schema[0].entityType;for(var i=-1,c;c=E[++i];)if(e===c.name&&c.extensions)for(var j=-1,C;C=c.extensions[++j];)if(C.name===a)return C.value}return null},_getServiceSchemaVersion:function(m,e){var v=this._getEntityAnnotation(m,"service-schema-version",e);return(v!=null)?parseInt(v):1},_getServiceVersion:function(m,e){var v=this._getEntityAnnotation(m,"service-version",e);return(v!=null)?parseInt(v):1},defineButtons:function(){var a=new sap.m.Button("acButAppS",{press:jQuery.proxy(this.selectActSetting,this),icon:"sap-icon://settings",text:this.oBundle.getText("BTN_APPSETTINGS"),});if(sap.ui.version<"1.19.0"){var s=null;var f=this.getView().byId("masterFooter");f.destroyContentLeft();s=sap.ushell.services.AppConfiguration.getSettingsControl();s.setText("").setWidth("");s.setMenuItems([a]);f.addContentLeft(s)}else{sap.ushell.services.AppConfiguration.addApplicationSettingsButtons([a])}},showErrorMsg:function(e,i){var a=null,m=null;if(e.response){a=jQuery.parseJSON(e.response.body).error;m=a.message.value}else m=e.message;sap.ca.ui.message.showMessageBox({type:sap.ca.ui.message.Type.ERROR,message:m})},batchRead:function(){var t=this;var m=this.oDataModel;var R=[m.createBatchOperation("SalesPipelineSettings","GET"),m.createBatchOperation("PeriodicityTexts","GET"),m.createBatchOperation("TimeIntervals","GET"),m.createBatchOperation("YearRanges","GET"),m.createBatchOperation("Currencies","GET"),m.createBatchOperation("Opportunities","GET"),m.createBatchOperation("UserStatusCodes","GET")];if(this.getServiceVersion()==1&&this.getServiceSchemaVersion()>=2){R.push(m.createBatchOperation("OrganizationSalesTargets","GET"));R.push(m.createBatchOperation("SalesStages","GET"))}m.addBatchReadOperations(R);m.setHeaders({"X-REQUESTED-WITH":"XMLHttpRequest"});var s=function(o,a){var b=o.__batchResponses;for(var c=0;c<b.length;c++){if(parseInt(b[c].statusCode)!==200){t.showErrorMsg(b[c],true);break}var d=b[c].data.results;var M=new sap.ui.model.json.JSONModel();switch(c){case 0:d[0].STP2=d[0].SalesTargetPeriodicity;M.setData(d[0]);t.getView().setModel(M,"SalesPipelineSetting");t.SalesPipelineSetting=d[0];t.copysetting("SettingsForDisplay");var C=t.getView().byId("chart_sim");C.setMaxBubbleValue(d[0].OpportunityMaxValue);C.setMinBubbleValue(d[0].OpportunityMinValue);C.setBubbleStepValue(d[0].OpportunityStepValue);break;case 1:M.setData(d);t.getView().setModel(M,"PeriodicityTexts");break;case 2:var T=d;var f=T;if(T.length>100){f=[];var r=0;for(var l=0;l<T.length;l+=2){f[r]=T[l];r++}f[r]=T[T.length-1]}M.setData(f);t.getView().setModel(M,"TimeIntervals");var g=[];var h=[];var k=t.getView().getModel("TimeIntervals").oData;var n={"value":"","value2":""};var C=t.getView().byId("chart_sim");var p=t.getView().getModel('SalesPipelineSetting').oData;var q=p.SalesTargetPeriodicity;if(k.length==1){n.value=0;n.value2=k.length-1;if(n.value2==0){n.value2=1;k.push(k[0]);M.setData(k);t.getView().setModel(M,"TimeIntervals")}var u=new sap.ui.model.json.JSONModel(n);t.getView().setModel(u,"sliderValue");for(var i=0,j=k.length;i<j;i++){g[i]=k[i].Label;h[i]=k[i].TimeFrom}C.setXStart(h[0]);C.setXEnd(k[k.length-1].TimeTo)}else{var v=new Date(),j=0;v.setHours(0);v.setMinutes(0);v.setSeconds(0);v.setMilliseconds(0);v=cus.crm.ppm.mgr.util.formatter.convFromSixZeros(v);if(T.length>100){for(;j<T.length-1;j++){if((v>=T[j].TimeFrom)&&(v<=T[j].TimeTo)){break}}j=parseInt(j/2)}else{for(;j<k.length-1;j++){if((v>=k[j].TimeFrom)&&(v<=k[j].TimeTo)){break}}}if(j==k.length-1){if(v.getFullYear()<new Date(k[1].TimeFrom).getFullYear()){j=0}if(v.getFullYear()>new Date(k[1].TimeFrom).getFullYear()){switch(q){case"1":j=k.length-5;break;case"2":j=k.length-4;break;case"3":j=k.length-2;break;case"4":j=k.length-2;break}}}n.value=j;switch(q){case"1":n.value2=j+4;break;case"2":n.value2=j+3;break;case"3":n.value2=j+1;break;case"4":n.value2=j+1;break}if(n.value2>=k.length){n.value2=k.length-1;switch(q){case"1":n.value=k.length-5;break;case"2":n.value=k.length-4;break;case"3":n.value=k.length-2;break;case"4":n.value=k.length-2;break}}if(n.value2==n.value){n.value2=n.value+1;k.push(k[n.value]);M.setData(k);t.getView().setModel(M,"TimeIntervals")}for(var i=n.value;i<=n.value2;i++){g[i-n.value]=k[i].Label;h[i-n.value]=k[i].TimeFrom;if(i==n.value)C.setXStart(k[i].TimeFrom);if(i==n.value2)C.setXEnd(k[i].TimeTo)}}t.getView().setModel(new sap.ui.model.json.JSONModel(n),"sliderValues");t.getView().byId("name").setValue(n.value);t.getView().byId("name").setValue2(n.value2);t.getView().setModel(new sap.ui.model.json.JSONModel(h),"xLabelValues");t.getView().setModel(new sap.ui.model.json.JSONModel(g),"xLabelTexts");break;case 3:M.setData(d);t.getView().setModel(M,"YearRanges");break;case 4:M.setData(d);t.getView().setModel(M,"CurrencyList");break;case 5:M.setData(d);t.getView().setModel(M,"Opportunities");t.Opportunities=d;break;case 6:for(var i=0;i<d.length;i++){var w=d[i];if(!t.ptGroup[w.ProcessType]){t.ptGroup[w.ProcessType]=new Object({"StatusProfile":"","StatusCodes":[],"BusinessTxn":[],});t.ptGroup[w.ProcessType].StatusProfile=w.StatusProfile}t.ptGroup[w.ProcessType].StatusCodes.push(w.StatusCode);t.ptGroup[w.ProcessType].BusinessTxn.push(w.BusinessTcode)}break;case 7:M.setData(d);t.getView().setModel(M,"OrganizationSalesTargets");t.OrganizationSalesTargets=d;break;case 8:for(var i=0;i<d.length;i++){var w=d[i];if(!t.ptGroup_chart[w.ProcessType]){t.ptGroup_chart[w.ProcessType]=new Object({"ProcessType":"","SalesStage":[]});t.ptGroup_chart[w.ProcessType].ProcessType=w.ProcessType}t.ptGroup_chart[w.ProcessType].SalesStage.push(w)}break}}};var e=function(E){t.showErrorMsg(E,true)};m.refreshSecurityToken();m.submitBatch(s,e,false)},loaddata:function(){this.batchRead();this.LoadFacetFilter();this.setMinMax();var y=null,a=null;if(sap.ui.Device.system.phone){y=new sap.ui.model.json.JSONModel([0,50,100]);a=new sap.ui.model.json.JSONModel(["0%","50%","100%"])}else{var v=[0,20,40,60,80,100];var t=["0%","20%","40%","60%","80%","100%"];y=new sap.ui.model.json.JSONModel(v);a=new sap.ui.model.json.JSONModel(t)}this.getView().setModel(y,"yLabelValues");this.getView().setModel(a,"yLabelTexts")},copysetting:function(m){var s=new Object({});s=this.getView().getModel("SalesPipelineSetting").oData;var M=new sap.ui.model.json.JSONModel(s);if(m=="SettingsForDisplay")M.setDefaultBindingMode(sap.ui.model.BindingMode.OneWay);this.getView().setModel(M,m)},LoadSalesPipelineSettings:function(s){var t=this;this.SalesPipelineSetting=false;var S=function(o,r){o.results[0].STP2=t.viewType;var m=new sap.ui.model.json.JSONModel(o.results[0]);t.getView().setModel(m,"SalesPipelineSetting");t.SalesPipelineSetting=o.results[0];t.copysetting("SettingsForDisplay");var c=t.getView().byId("chart_sim");c.setMaxBubbleValue(o.results[0].OpportunityMaxValue);c.setMinBubbleValue(o.results[0].OpportunityMinValue);c.setBubbleStepValue(o.results[0].OpportunityStepValue)};var e=function(E){t.showErrorMsg(E,true)};this.oDataModel.read("SalesPipelineSettings",null,null,s,S,e)},LoadOpportunities:function(s){var t=this;this.Opportunities=false;var S=function(o,r){var m=new sap.ui.model.json.JSONModel(o.results);t.getView().setModel(m,"Opportunities");t.Opportunities=o.results};var e=function(E){t.showErrorMsg(E,true)};this.oDataModel.read("Opportunities",null,null,s,S,e)},LoadTimeIntervals:function(s,p){var t=this;this.TimeIntervals=false;var f=null;if(p){f=[];f[0]="$filter=PeriodicityType eq '"+p+"'"}var S=function(o,a){var T=o.results;var b=T;if(T.length>100){b=[];var r=0;for(var l=0;l<T.length;l=l+2){b[r]=T[l];r++}b[r]=T[T.length-1]}var m=new sap.ui.model.json.JSONModel(b);t.getView().setModel(m,"TimeIntervals");var c=[];var d=[];var g=t.getView().getModel("TimeIntervals").oData;var h={"value":"","value2":""};var C=t.getView().byId("chart_sim");if(g.length==1){h.value=0;h.value2=g.length-1;if(h.value2==0){h.value2=1;g.push(g[0]);m.setData(g);t.getView().setModel(m,"TimeIntervals")}var M=new sap.ui.model.json.JSONModel(h);t.getView().setModel(M,"sliderValue");for(var i=0,j=g.length;i<j;i++){c[i]=g[i].Label;d[i]=g[i].TimeFrom}C.setXStart(d[0]);C.setXEnd(g[g.length-1].TimeTo)}else{var k=new Date(),j=0;k.setHours(0);k.setMinutes(0);k.setSeconds(0);k.setMilliseconds(0);k=cus.crm.ppm.mgr.util.formatter.convFromSixZeros(k);if(T.length>100){for(;j<T.length-1;j++){if((k>=T[j].TimeFrom)&&(k<=T[j].TimeTo)){break}}j=parseInt(j/2)}else{for(;j<g.length-1;j++){if((k>=g[j].TimeFrom)&&(k<=g[j].TimeTo)){break}}}if(j==g.length-1){if(k.getFullYear()<new Date(g[1].TimeFrom).getFullYear()){j=0}if(k.getFullYear()>new Date(g[1].TimeFrom).getFullYear()){switch(p){case"1":j=g.length-5;break;case"2":j=g.length-4;break;case"3":j=g.length-2;break;case"4":j=g.length-2;break}}}h.value=j;switch(p){case"1":h.value2=j+4;break;case"2":h.value2=j+3;break;case"3":h.value2=j+1;break;case"4":h.value2=j+1;break}if(h.value2>=g.length){h.value2=g.length-1;switch(p){case"1":h.value=g.length-5;break;case"2":h.value=g.length-4;break;case"3":h.value=g.length-2;break;case"4":h.value=g.length-2;break}}if(h.value2==h.value){h.value2=h.value+1;g.push(g[h.value]);m.setData(g);t.getView().setModel(m,"TimeIntervals")}for(var i=h.value;i<=h.value2;i++){c[i-h.value]=g[i].Label;d[i-h.value]=g[i].TimeFrom;if(i==h.value)C.setXStart(g[i].TimeFrom);if(i==h.value2)C.setXEnd(g[i].TimeTo)}}m=new sap.ui.model.json.JSONModel(h);t.getView().setModel(m,"sliderValues");t.getView().byId("name").setValue(h.value);t.getView().byId("name").setValue2(h.value2);m=new sap.ui.model.json.JSONModel(d);t.getView().setModel(m,"xLabelValues");m=new sap.ui.model.json.JSONModel(c);t.getView().setModel(m,"xLabelTexts");t.TimeIntervals=true};var e=function(E){t.showErrorMsg(E,true)};this.oDataModel.read("TimeIntervals",null,f,s,S,e)},LoadPeriodicityTexts:function(s){var t=this;var S=function(o,r){var m=new sap.ui.model.json.JSONModel(o.results);t.getView().setModel(m,"PeriodicityTexts")};var e=function(E){t.showErrorMsg(E,true)};this.oDataModel.read("PeriodicityTexts",null,null,s,S,e)},LoadYearRanges:function(s){var t=this;var S=function(o,r){var m=new sap.ui.model.json.JSONModel(o.results);t.getView().setModel(m,"YearRanges")};var e=function(E){t.showErrorMsg(E,true)};this.oDataModel.read("YearRanges",null,null,true,S,e)},LoadCurrencyList:function(s){var t=this;var S=function(o,r){var m=new sap.ui.model.json.JSONModel(o.results);t.getView().setModel(m,"CurrencyList")};var e=function(E){t.showErrorMsg(E,true)};this.oDataModel.read("Currencies",null,null,true,S,e)},_initValuesToFacetFilter:function(f,i,O,I,n){var c=new Object(),N=true;for(var j=-1,F;F=f[++j];)if(F.Id==O[i][I]){F.Opportunities.push(O[i]);N=false;break}if(N){c.Name=O[i][n];if(c.Name=="")c.Name=this.oBundle.getText("LBL_OTHERS");c.Id=O[i][I];c.Opportunities=[];c.Opportunities.push(O[i]);f.push(c)}},_bindFacetFilterData:function(f,c,m,k,C){var M=new sap.ui.model.json.JSONModel(f);c=new sap.m.FacetFilterList({title:"{"+m+">/name}",key:k,items:{path:m+">/values",template:new sap.m.FacetFilterItem({text:"{"+m+">Name}",key:"{"+m+">Id}"})}});c.setModel(M,m);this.byId("facetFilter").addList(c);c.attachListClose(jQuery.proxy(C,this))},LoadFacetFilter:function(){this.byId("facetFilter").removeAllLists();var O=this.getView().getModel("Opportunities").getData();this.OpportunitiesAllForFacetFilter=O;var E=[],A=[],a=[];for(var i=0;i<O.length;i++)this._initValuesToFacetFilter(E,i,O,"EmployeeID","EmployeeName");var D={name:this.oBundle.getText("EMPLOYEE_RESPONSIBLE"),values:E};this._bindFacetFilterData(D,this.oFacetListEmployeeResponsibles,"EmpResp","emp_responsible",this.closeListEmployees);for(var i=0;i<O.length;i++)this._initValuesToFacetFilter(A,i,O,"AccountID","AccountName");var b={name:this.oBundle.getText("ACCOUNTS"),values:A};this._bindFacetFilterData(b,this.oFacetListAccounts,"OppAccount","accounts",this.closeListAccounts);var c={};if(this.getServiceVersion()==1&&this.getServiceSchemaVersion()>=2){for(var i=0;i<O.length;i++)this._initValuesToFacetFilter(a,i,O,"SalesOrganizationUnit","SalesOrganizationUnitText");c={name:this.oBundle.getText("LBL_ORG"),values:a};this._bindFacetFilterData(c,this.oFacetListORG,"OppOrgData","org",this.closeListORG)}if(this.extHookAddFacetFilter)this.extHookAddFacetFilter()},resetFunc:function(e){var f=this.byId("facetFilter");var F=f.getLists();for(var i=0;i<F.length;i++){var I=F[i].getItems();for(var j=0;j<I.length;j++){I[j].setSelected(false)}F[i].getBinding("items").filter([])}var O=this.OpportunitiesAllForFacetFilter;this.filteredOpportunities=O;this.showTopNOpp();this.calculateProgress()},chartChange:function(e){var k=undefined;if(e&&e.getParameter&&e.getParameter('selectedItem'))k=e.getParameter('selectedItem').getKey();else k=this.getView().byId('sSP2').getSelectedKey();switch(k){case"SalesPipeline":case"Top10Opportunities":this.byId("filterButton").setEnabled(true);this.showBubbleChart(e);if(k=="SalesPipeline")this.filteredOpportunities=this.Opportunities;this.showTopNOpp();this.calculateProgress();break;case"BarChart":this.reRenderTopNSlider=false;this.byId("filterButton").setEnabled(false);this.showBarChart(e);this.resetFunc(e);this.getView().byId("FilterPanel").setVisible(false);break}if(this.extHookAddViews)this.extHookAddViews()},toggleButtons:function(e){var f=this.getView().byId("FilterPanel");if(f.getVisible())f.setVisible(false);else f.setVisible(true)},closeListEmployees:function(e){var f=this.byId("facetFilter");var F=f.getLists();for(var i=0;i<F.length;i++){if(F[i].getKey()=="emp_responsible")continue;var I=F[i].getItems();for(var j=0;j<I.length;j++){I[j].setSelected(false)}F[i].getBinding("items").filter([])}f.rerender();var O=this.OpportunitiesAllForFacetFilter;var s=e.getParameter("selectedItems").length;if(s==0){var m=new sap.ui.model.json.JSONModel(O);this.getView().setModel(m,"Opportunities");this.filteredOpportunities=O;this.showTopNOpp();this.calculateProgress();return}var a=[];for(var i=0;i<s;i++)a[i]=e.getParameter("selectedItems")[i].getKey();var b=[];var d=e.getSource().getModel("EmpResp").oData.values;for(var i=0;i<a.length;i++){for(var j=0;j<d.length;j++)if(a[i]==d[j].Id){for(var r=0;r<d[j].Opportunities.length;r++)b.push(d[j].Opportunities[r])}}this.filteredOpportunities=b;this.showTopNOpp();this.calculateProgress()},closeListAccounts:function(e){var f=this.byId("facetFilter");var F=f.getLists();for(var i=0;i<F.length;i++){if(F[i].getKey()=="accounts")continue;var I=F[i].getItems();for(var j=0;j<I.length;j++){I[j].setSelected(false)}F[i].getBinding("items").filter([])}f.rerender();var O=this.OpportunitiesAllForFacetFilter;var s=e.getParameter("selectedItems").length;if(s==0){var m=new sap.ui.model.json.JSONModel(O);this.getView().setModel(m,"Opportunities");this.filteredOpportunities=O;this.showTopNOpp();this.calculateProgress();return}var a=[];for(var i=0;i<s;i++)a[i]=e.getParameter("selectedItems")[i].getKey();var b=[];var d=e.getSource().getModel("OppAccount").oData.values;for(var i=0;i<a.length;i++){for(var j=0;j<d.length;j++)if(a[i]==d[j].Id){for(var r=0;r<d[j].Opportunities.length;r++)b.push(d[j].Opportunities[r])}}this.filteredOpportunities=b;this.showTopNOpp();this.calculateProgress()},_getBTCode:function(o){var p=undefined,b="";for(var a in this.ptGroup)if(a==o.ProcessType){p=this.ptGroup[a];break}if(p!=undefined&&o.UserStatusCode!=undefined)for(var j=0;j<p.StatusCodes.length;j++)if(p.StatusCodes[j]==o.UserStatusCode){b=p.BusinessTxn[j];break}return b},_getSalesStage:function(o){var p=undefined,s="";for(var a in this.ptGroup_chart)if(a==o.ProcessType){p=this.ptGroup_chart[a];break}if(p!=undefined&&o.SalesStageCode!=undefined)for(var j=0;j<p.SalesStage.length;j++)if(p.SalesStage[j].SalesStageCode==o.SalesStageCode){s=p.SalesStage[j].SalesStageDescription;break}return s},calculateProgress:function(){var S=this.getView().getModel("SalesPipelineSetting").oData;var a=S.StartOfPeriod;var b=S.EndOfPeriod;var o=this.getView().getModel("Opportunities");if(o!=undefined){var O=o.oData;var P=0.0,T=null,c=0.0;for(var i=0;i<O.length;i++){var d=O[i].ClosingDate>=a;var e=O[i].ClosingDate<=b;var f=true;var t=this._getBTCode(O[i]);if(t=='LOST')f=false;if(d&&e&&f)c+=((O[i].ExpectedSalesVolume*O[i].ChanceOfSuccess)/100)}var g=this.getView().byId("pg");var L=this.getView().byId("objectStatus");if(S.SalesTarget>0)P=(c/S.SalesTarget)*100;P=Math.round(P);var u=cus.crm.ppm.mgr.util.formatter;var v=0,h=0;if(sap.ui.Device.system.phone==true){v=u.displayTargetNumbers(Math.ceil(c));h=u.displayTargetNumbers(Math.ceil(S.SalesTarget))}else{v=u.displayNumbers(Math.ceil(c));h=u.displayNumbers(Math.ceil(S.SalesTarget))}T=v+" "+this.oBundle.getText("LBL_OF")+" "+h;if(P>=100)g.setPercentValue(100);else g.setPercentValue(P);g.setDisplayValue(P+"%");L.setText(T+" ("+S.CurrencyCode+")")}},selectActSetting:function(e){this.copysetting("SettingsForSave");var s=this.getView().getModel("SettingsForSave"),n={};n["SalesTarget"]=s.oData.SalesTarget;n["CurrencyCode"]=s.oData.CurrencyCode;n["SalesTargetPeriodicity"]=s.oData.SalesTargetPeriodicity;n["TimeFrom"]=s.oData.TimeFrom;n["TimeTo"]=s.oData.TimeTo;this.oSalesSettings=n;if(this.oFragmentList.salesPeriodSettings)this.oFragmentList.salesPeriodSettings.setModel(s,"SettingsForSave");this.oFragmentList.appSettings.open()},selectDlgSetting:function(e){this.oFragmentList.appSettings.close();var l=this.oFragmentList.appSettings.getContent()[0];if(l.getItems()[0].isSelected())this.oFragmentList.salesPeriodSettings.open();l.getSelectedItem().setSelected(false)},closeAppSettDialog:function(e){this.oFragmentList.appSettings.close()},navBack:function(e){var s=this.getView().getModel("SettingsForSave").oData;s["SalesTarget"]=this.oSalesSettings.SalesTarget;s["CurrencyCode"]=this.oSalesSettings.CurrencyCode;s["SalesTargetPeriodicity"]=this.oSalesSettings.SalesTargetPeriodicity;s["TimeFrom"]=this.oSalesSettings.TimeFrom;s["TimeTo"]=this.oSalesSettings.TimeTo;sap.ui.getCore().byId("sliSaTa").setSelected(false);this.oFragmentList.salesPeriodSettings.close();this.oFragmentList.appSettings.open()},setMinMax:function(){if(this.getView().getModel("Opportunities")!=undefined){var O=this.getView().getModel("Opportunities").oData;var e=[];for(var i=0;i<O.length;i++)e.push(parseFloat(O[i].ExpectedSalesVolume));e.sort(function(a,b){return a-b});var c=this.byId("chart_sim");c.setMaxBubbleValue(3*e[e.length-1]);c.setMinBubbleValue(0.25*e[0])}},saveAppSetChange:function(e){var t=this,c=e.getSource();this.reRenderTopNSlider=true;var E=this.getView().getModel("SettingsForSave").oData;var u=cus.crm.ppm.mgr.util.formatter;if(c==sap.ui.getCore().byId("spButSave")){E.TimeFrom=new Date(E.TimeFrom);E.TimeTo=new Date(E.TimeTo);this.viewType=E.STP2;delete E.STP2;var v=sap.ui.getCore().byId("iST").getValue();E.SalesTarget=u.reverseNumbers(v)+".0";var p={};p.bMerge=false;p.fnSuccess=function(){if(sap.ui.getCore().byId("spButSave")==c)t.oFragmentList.salesPeriodSettings.close();sap.ca.ui.message.showMessageToast(t.oBundle.getText("LBL_SUCCESSUPDATE"));t.LoadSalesPipelineSettings(false);t.LoadOpportunities(false);t.setMinMax();t.LoadTimeIntervals(false,t.viewType);if(t.getServiceVersion()==1&&t.getServiceSchemaVersion()>=2)t.LoadOrgData(false);t.chartChange();t.calculateProgress()};p.fnError=function(){var b=t.oBundle.getText("LBL_FAILEDUPDATE");sap.ca.ui.message.showMessageBox({type:sap.ca.ui.message.Type.ERROR,message:b})};var a="/SalesPipelineSettings('"+E.UserName+"')";this.oDataModel.update(a,E,p);this.LoadFacetFilter()}else{E["SalesTarget"]=this.oSalesSettings.SalesTarget;E["CurrencyCode"]=this.oSalesSettings.CurrencyCode;E["SalesTargetPeriodicity"]=this.oSalesSettings.SalesTargetPeriodicity;E["TimeFrom"]=this.oSalesSettings.TimeFrom;E["TimeTo"]=this.oSalesSettings.TimeTo;this.oFragmentList.salesPeriodSettings.close()}},cancelAppSetChange:function(e){var s=this.getView().getModel("SettingsForSave").oData;s["SalesTarget"]=this.oSalesSettings.SalesTarget;s["CurrencyCode"]=this.oSalesSettings.CurrencyCode;s["SalesTargetPeriodicity"]=this.oSalesSettings.SalesTargetPeriodicity;s["TimeFrom"]=this.oSalesSettings.TimeFrom;s["TimeTo"]=this.oSalesSettings.TimeTo;if(sap.ui.getCore().byId("spButCancel")==e.getSource())this.oFragmentList.salesPeriodSettings.close()},TimespanChange:function(e){var s=sap.ui.getCore().byId("sFrom");var a=sap.ui.getCore().byId("sTo");var t=[],b=[];for(var i=-1,c;c=a.getItems()[++i];){var p=parseInt(c.getText());t.push(new Object({"dispText":p?p:c.getText(),"key":c.getKey()}))}for(var i=-1,c;c=s.getItems()[++i];){var p=parseInt(c.getText());b.push(new Object({"dispText":p?p:c.getText(),"key":c.getKey()}))}var d=e.getParameter("selectedItem").getText();d=parseInt(d)?parseInt(d):d;if(s==e.getSource()){for(var i=0;i<b.length;i++)if(d==b[i]["dispText"])break;var o=a.getSelectedItem().getText();var f=new Object({"key":a.getSelectedKey(),"dispText":parseInt(o)?parseInt(o):o});if(!(d<=f["dispText"]))a.setSelectedKey(t[i]["key"])}else{for(var i=0;i<t.length;i++)if(d==t[i]["dispText"])break;var o=s.getSelectedItem().getText();var f=new Object({"key":s.getSelectedKey(),"dispText":parseInt(o)?parseInt(o):o});if(!(f["dispText"]<=d))s.setSelectedKey(b[i]["key"])}},dualsliderchange:function(){var c=this.getView().byId("chart_sim");var v=arguments[0].getParameter("value");var a=arguments[0].getParameter("value2");var u=this.byId("name").getUnits();var t=this.getView().getModel("TimeIntervals");var l=[];var b=[];for(var i=v;i<=a;i++){l[i-v]=u[i].getValue();b[i-v]=u[i].getKey();if(i==v)c.setXStart(u[i].getKey());if(i==a)c.setXEnd(t.oData[i].TimeTo)}c.setXLabelTexts(l);c.setXLabelValues(b)},onPeriodicityChange:function(e){this.LoadTimeIntervals(true,e.getSource().getSelectedKey());this.reRenderTopNSlider=true},bubbleclick:function(e){var t=this;if(!this.oFragmentList.Opportunity){this.oFragmentList.Opportunity=new sap.ui.xmlfragment('cus.crm.ppm.mgr.view.Opportunity',this);this.oFragmentList.Opportunity.setModel(this.getView().getModel("i18n"),"i18n")}var a=this.oFragmentList.Opportunity;a.close();var m=this.oDataModel;m.setCountSupported(false);var o=this.getView().getModel("Opportunities").oData;this.guidVal=e.getParameter('item').key;var p=undefined,b=undefined,c=undefined;sap.ui.getCore().byId("mainContact").setVisible(false);sap.ui.getCore().byId("empResp").setVisible(false);var s=undefined,d=undefined,f=undefined;var g=undefined,h=undefined,j=undefined;var k=undefined,l=undefined;for(var i=0;i<o.length;i++){if(o[i].Guid===this.guidVal){s=o[i];p=s.ProcessType;b=s.CurrencyCode;d=s.EmployeeName;f=s.ContactPersonName;this.pContactId=s.ContactPersonID;g=s.AccountName;this.pAccountId=s.AccountID;h=s.Id;j=s.Description;k=s.SalesStageCode;l=s.UserStatusText;break}}sap.ui.getCore().byId("OppId").setText(h);sap.ui.getCore().byId("status").setValue(l);sap.ui.getCore().byId("OppDescription").setText(j);var n=" ("+b+")";var L=sap.ui.getCore().byId("lblExpRev");var q=sap.ui.getCore().byId("lblWgtRev");L.setText(this.oBundle.getText("LBL_OD_EXPECTEDREVENUE")+n);q.setText(this.oBundle.getText("LBL_OD_WEIGHTEDREVENUE")+n);var r=[m.createBatchOperation("SalesStages?$filter="+jQuery.sap.encodeURL("ProcessType eq '"+p+"'"),"GET"),m.createBatchOperation("Opportunities(guid'"+this.guidVal+"')?$expand=SalesTeam","GET")];m.addBatchReadOperations(r);m.setHeaders({"X-REQUESTED-WITH":"XMLHttpRequest"});var u=null;var S=function(I,J){var K=I.__batchResponses;for(var i=0;i<K.length;i++){if(parseInt(K[i].statusCode)!==200){t.showErrorMsg(K[i],true);break}else switch(i){case 0:u={stageValues:K[i].data.results};break;case 1:c=K[i].data.SalesTeam.results;break}}};var E=function(I){t.showErrorMsg(I,true)};m.submitBatch(S,E,false);var v=cus.crm.ppm.mgr.util.formatter;sap.ui.getCore().byId("salesStage").setValue("");for(var i=0;i<u.stageValues.length;i++){if(k==u.stageValues[i].SalesStageCode){sap.ui.getCore().byId("salesStage").setValue(u.stageValues[i].SalesStageDescription);break}}if(s.ForecastRelevance=="X")sap.ui.getCore().byId("forecastId").setState(true);else if(s.ForecastRelevance=="")sap.ui.getCore().byId("forecastId").setState(false);var x=parseFloat(s.ChanceOfSuccess)+"%";sap.ui.getCore().byId("chanceOfSucc").setValue(x);var w=new Date(s.StartDate.toDateString());sap.ui.getCore().byId("d1").setValue(v.displayDates(w));var y=new Date(s.ClosingDate.toDateString());sap.ui.getCore().byId("d2").setValue(v.displayDates(y));var z=sap.ui.getCore().byId("expRevId");z.setValue(v.displayNumbers(s.ExpectedSalesVolume));var A=(s.ExpectedSalesVolume*s.ChanceOfSuccess)/100;sap.ui.getCore().byId("wgtRevId").setValue(v.displayNumbers(A));var B=["empResp","empRespName","empRespEmail","empRespPhone"];var M=["mainContact","mainContactName","mcEmail","mcPhone"];if(d!=""){for(var i=-1,C;C=sap.ui.getCore().byId(B[++i]);)switch(B[i]){case"empResp":case"empRespName":C.setVisible(true);if(B[i]==="empRespName")C.setText(d);break;case"empRespEmail":case"empRespPhone":C.setVisible(false);break}}if(f!=""){for(var i=-1,C;C=sap.ui.getCore().byId(M[++i]);)switch(M[i]){case"mainContact":case"mainContactName":C.setVisible(true);if(M[i]==="mainContactName")C.setText(f);break;case"mcEmail":case"mcPhone":C.setVisible(false);break}}if(c!=undefined){for(var i=-1,D;D=c[++i];){var F=null,G=null,P=parseInt(D.PartnerFuntionCode);switch(P){case 14:F=sap.ui.getCore().byId(B[2]);G=sap.ui.getCore().byId(B[3]);break;case 15:F=sap.ui.getCore().byId(M[2]);G=sap.ui.getCore().byId(M[3]);break;default:break}if(P==14||P==15){if(D.Email&&D.Email!="")F.setVisible(true).setText(D.Email);if(D.Telephone&&D.Telephone!="")G.setVisible(true).setText(D.Telephone)}}}sap.ui.getCore().byId("accName").setText(g);this.selectedbubble=e.getParameter('item').key;if(sap.ui.Device.system.phone==false){var H=sap.ui.getCore().byId("poBar");this.overlappingBubbles=e.getParameter('item').overlappedbubbles;if(this.overlappingBubbles.length>1){sap.ui.getCore().byId("upBtn").setVisible(true);sap.ui.getCore().byId("downBtn").setVisible(true);H.addContentLeft(sap.ui.getCore().byId("oppDetails"));H.removeAllContentMiddle()}else{sap.ui.getCore().byId("upBtn").setVisible(false);sap.ui.getCore().byId("downBtn").setVisible(false);H.addContentMiddle(sap.ui.getCore().byId("oppDetails"));H.removeAllContentLeft()}}else{sap.ui.getCore().byId("upBtn").setVisible(true);sap.ui.getCore().byId("downBtn").setVisible(true)}if(this.extHookOpportunityPopover)this.extHookOpportunityPopover();a.openBy(e.getParameter('item').selected)},closePopover:function(){sap.ui.getCore().byId("po").close()},moveUp:function(){var v=this.byId("name").getValue();var a=this.byId("name").getValue2();var u=this.byId("name").getUnits();var F=[],l=[],b=[];var s=undefined,e=undefined,c=undefined;if(sap.ui.Device.system.phone==true){var t=this.getView().getModel("TimeIntervals");var O=this.getView().getModel("Opportunities").oData;for(var i=v;i<=a;i++){l[i-v]=u[i].getValue();b[i-v]=u[i].getKey();if(i==v)s=u[i].getKey();if(i==a)e=t.oData[i].TimeTo}for(var i=0;i<O.length;i++)if((O[i].ClosingDate>=s)&&(O[i].ClosingDate<=e))F.push(O[i]);for(var i=0;i<F.length;i++)if(F[i].Guid===this.selectedbubble){c=i+1;if(c>=F.length)c=0}var d=this.byId("chart_sim");d.setSelection(F[c].Guid)}else{for(var i=0;i<this.overlappingBubbles.length;i++)if(this.overlappingBubbles[i].id===this.selectedbubble){c=i+1;if(c>=this.overlappingBubbles.length)c=0}var d=this.byId("chart_sim");d.setSelection(this.overlappingBubbles[c].id)}},moveDown:function(){var O=this.getView().getModel("Opportunities").oData;var t=this;var v=this.byId("name").getValue();var a=this.byId("name").getValue2();var u=this.byId("name").getUnits();var F=[],l=[],b=[];var s=undefined,e=undefined,c=undefined;var d=this.getView().getModel("TimeIntervals");if(sap.ui.Device.system.phone==true){for(var i=v;i<=a;i++){l[i-v]=u[i].getValue();b[i-v]=u[i].getKey();if(i==v)s=u[i].getKey();if(i==a)e=d.oData[i].TimeTo}for(var i=0;i<O.length;i++)if((O[i].ClosingDate>=s)&&(O[i].ClosingDate<=e))F.push(O[i]);for(var i=0;i<F.length;i++)if(F[i].Guid===t.selectedbubble){c=i-1;if(c<0)c=F.length-1}var f=this.byId("chart_sim");f.setSelection(F[c].Guid)}else{for(var i=0;i<t.overlappingBubbles.length;i++)if(t.overlappingBubbles[i].id===t.selectedbubble){c=i-1;if(c<0)c=t.overlappingBubbles.length-1}var f=this.byId("chart_sim");f.setSelection(t.overlappingBubbles[c].id)}},toAccountApp:function(){var f=sap.ushell&&sap.ushell.Container&&sap.ushell.Container.getService;var c=f&&f("CrossApplicationNavigation");var a=isNaN(parseInt(this.pAccountId))?this.pAccountId:parseInt(this.pAccountId).toString();var t=c&&c.hrefForExternal({target:{semanticObject:"Account",action:"MyAccounts"},appSpecificRoute:["&","detail","AccountCollection('"+a+"')"].join("/"),})||"";this.closePopover();window.location=t},toOppApp:function(){var f=sap.ushell&&sap.ushell.Container&&sap.ushell.Container.getService;var c=f&&f("CrossApplicationNavigation");var t=c&&c.hrefForExternal({target:{semanticObject:"Opportunity",action:"manageOpportunity"},params:{guid:this.guidVal}})||"";this.closePopover();window.location=t},toContactApp:function(){var f=sap.ushell&&sap.ushell.Container&&sap.ushell.Container.getService;var c=f&&f("CrossApplicationNavigation");var a=isNaN(parseInt(this.pAccountId))?this.pAccountId:parseInt(this.pAccountId).toString();var C=isNaN(parseInt(this.pContactId))?this.pContactId:parseInt(this.pContactId).toString();var t=c&&c.hrefForExternal({target:{semanticObject:"ContactPerson",action:"MyContacts"},params:{accountID:a,contactID:C,}})||"";this.closePopover();window.location=t},closeListORG:function(e){var f=this.byId("facetFilter");var F=f.getLists();for(var i=0;i<F.length;i++){if(F[i].getKey()=="org")continue;var I=F[i].getItems();for(var j=0;j<I.length;j++){I[j].setSelected(false)}F[i].getBinding("items").filter([])}f.rerender();var O=this.OpportunitiesAllForFacetFilter;var s=e.getParameter("selectedItems").length;if(s==0){var m=new sap.ui.model.json.JSONModel(O);this.getView().setModel(m,"Opportunities");this.filteredOpportunities=O;this.showTopNOpp();this.calculateProgress();return}var a=[];for(var i=0;i<s;i++)a[i]=e.getParameter("selectedItems")[i].getKey();var b=[];var d=e.getSource().getModel("OppOrgData").oData.values;for(var i=0;i<a.length;i++){for(var j=0;j<d.length;j++){if(a[i]==d[j].Id){for(var r=0;r<d[j].Opportunities.length;r++){b.push(d[j].Opportunities[r])}}}}this.filteredOpportunities=b;this.showTopNOpp();this.calculateProgress()},showBubbleChart:function(e){this.getView().byId("barChartPanel").setVisible(false);this.getView().byId("sSP1").setVisible(true);this.getView().byId("chart_sim").setVisible(true);this.getView().byId("name").setVisible(true);this.getView().byId("opportunitySlider").setVisible(true)},showBarChart:function(e){this.chart=this.getView().byId("fvbChart");var t=this;if(sap.ui.Device.orientation.landscape)t.chart.setHeight(0.6*window.innerHeight+"px");$(window).on("orientationchange",function(h){if(h.orientation=="landscape"){t.chart.setHeight(0.6*window.innerHeight+"px")}else if(h.orientation=="portrait"){t.chart.setHeight("100%")}});this.getView().byId("sSP1").setVisible(false);this.getView().byId("chart_sim").setVisible(false);this.getView().byId("name").setVisible(false);this.getView().byId("barChartPanel").setVisible(true);this.getView().byId("opportunitySlider").setVisible(false);var o=this.OpportunitiesAll_chart;for(var a=0;a<o.length;a++)this.data.results[a]=o[a];this.chart.setShowPopover(false);this.chart.setModel(this.formatOdata(),"opportunityGraph");var f=new sap.viz.ui5.data.FlattenedDataset();var d=new sap.viz.ui5.data.DimensionDefinition({axis:1,name:this.oBundle.getText("OPPORTUNITY_ITEM"),value:'{opportunityGraph>SalesOrganizationUnitText}'});var m=new sap.viz.ui5.data.MeasureDefinition({name:this.oBundle.getText("LBL_TARGET"),value:'{opportunityGraph>SalesTarget}'});var b=new sap.viz.ui5.data.MeasureDefinition({name:this.oBundle.getText("LBL_OD_WEIGHTEDREVENUE"),value:'{opportunityGraph>WeightedRevenue}'});var c=new sap.viz.ui5.data.MeasureDefinition({name:this.oBundle.getText("LBL_EXPECTED"),value:'{opportunityGraph>ExpectedSalesVolume}'});f.addDimension(d);f.addMeasure(m);f.addMeasure(b);f.addMeasure(c);f.bindData({path:"opportunityGraph>/results"});this.chart.setDataset(f);var g=t.getView().getModel('SalesPipelineSetting').oData.CurrencyCode;var C={dataLabel:{visible:true,position:"inside"},interaction:{supportLassoEvent:false,selectability:{mode:"single"},},xAxis:{title:{visible:true,text:this.oBundle.getText("LBL_ORG")}},yAxis:{title:{visible:true,text:this.oBundle.getText("LBL_REVENUE_BAR_CHART",[g])}},};this.chart.setAdvancedChartSettings(C)},_filterOpportunitiesBasedOnOrg:function(O,i,a){var c=new Object(),I=true;for(var w=-1,s;s=O[++w];)if(s.Id==a[i].SalesOrganizationUnit){s.ExpectedSalesVolume+=parseFloat(a[i]["ExpectedSalesVolume"]);s.WeightedRevenue+=parseFloat(a[i]["ExpectedSalesVolume"])*(parseFloat(a[i]["ChanceOfSuccess"])/100);a[i].SalesStageDescription=this._getSalesStage(a[i]);s.Opportunities.push(a[i]);I=false;break}if(I){c.ExpectedSalesVolume=parseFloat(a[i]["ExpectedSalesVolume"]);c.WeightedRevenue=parseFloat(a[i]["ExpectedSalesVolume"])*(parseFloat(a[i]["ChanceOfSuccess"])/100);if(a[i].SalesOrganizationUnitText=="")a[i].SalesOrganizationUnitText=this.oBundle.getText("LBL_OTHERS");c.SalesOrganizationUnitText=a[i].SalesOrganizationUnitText;c.Id=a[i].SalesOrganizationUnit;c.Opportunities=[];a[i].SalesStageDescription=this._getSalesStage(a[i]);c.Opportunities.push(a[i]);O.push(c)}},_initSalesTargetToJsonData:function(l,O){for(var j=-1,c;c=O[++j];){c.WeightedRevenue=parseFloat(c.WeightedRevenue.toFixed(2));c.ExpectedSalesVolume=parseFloat(c.ExpectedSalesVolume.toFixed(2));if(c.Id==""||c.SalesTarget<=0)c.SalesTarget="";else{for(var i=-1,d;d=l[++i];)if(c.Id==d.SalesOrganizationUnit){c.SalesTarget=parseFloat(d.Revenue);break}}}},formatOdata:function(){var O=[];for(var i=0;i<this.Opportunities.length;i++)this._filterOpportunitiesBasedOnOrg(O,i,this.Opportunities);this._initSalesTargetToJsonData(this.OrganizationSalesTargets,O);this.graphDataToShow={results:O};var M=new sap.ui.model.json.JSONModel(this.graphDataToShow);M.setDefaultBindingMode(sap.ui.model.BindingMode.OneWay);return M},onSelectDataPoint:function(e){if(e.getParameter("srcEvent").sId=="deselectData")return;var E=e.getParameter('popover'),s=e.getParameter('selectedItem');E.setPlacement(sap.m.PlacementType.Auto).getContent()[0].getParent().addStyleClass('overflowx');E.removeAllContent();var l=[],L=undefined,S=Object.keys(s.data)[1];var a=this.oBundle.getText("LBL_TARGET"),b=this.oBundle.getText("LBL_OD_WEIGHTEDREVENUE"),c=this.oBundle.getText("LBL_EXPECTED"),d=this.oBundle.getText("BTN_TBT_CLOSE"),D=this.oBundle.getText("OPPORTUNITY_ITEM");var M=new sap.ui.model.json.JSONModel();var p=undefined;var f=this.getView().getModel('SalesPipelineSetting').oData.CurrencyCode;if(S==b||S==c){p=this.oBundle.getText("LBL_ALLTO_SELECTED");for(var i=-1,C;C=this.graphDataToShow.results[++i];)if(C["SalesOrganizationUnitText"]==s.data[D]){for(var j=-1,o;o=C.Opportunities[++j];){var g={};g["title"]=o["Description"];g["value"]=o["SalesStageDescription"];if(S==b){var h=parseFloat(o["ExpectedSalesVolume"]);var k=parseFloat(o["ChanceOfSuccess"])/100;g["Revenue"]=sap.ca.ui.model.format.AmountFormat.FormatAmountShortWithCurrency(h*k,f,2)}else g["Revenue"]=sap.ca.ui.model.format.AmountFormat.FormatAmountShortWithCurrency(parseFloat(o["ExpectedSalesVolume"]),f,2);g["guId"]=o["Guid"];g["opportunityId"]=o["Id"];l.push(g)}break}M.setData({results:l});M.setDefaultBindingMode(sap.ui.model.BindingMode.OneWay);L=new sap.m.List({mode:sap.m.ListMode.SingleSelectMaster,select:jQuery.proxy(this.selectOppNav,this,l),items:{path:"popoverGraph>/results",template:new sap.m.ObjectListItem({title:"{popoverGraph>title}",firstStatus:new sap.m.ObjectStatus({text:"{popoverGraph>Revenue}",}),secondStatus:new sap.m.ObjectStatus({text:"{popoverGraph>value}",}),attributes:[new sap.m.ObjectAttribute({text:S==b?b:c}),new sap.m.ObjectAttribute({text:this.oBundle.getText("LBL_SALESSTAGE")})]})}})}else if(S==a){p=this.oBundle.getText("SALESTARGET_ITEM");l.push({"SalesTarget":sap.ca.ui.model.format.AmountFormat.FormatAmountShortWithCurrency(s.data[S],f,2)});M.setData({results:l});L=new sap.m.List({mode:sap.m.ListMode.SingleSelectMaster,items:{path:"popoverGraph>/results",template:new sap.m.ObjectListItem({firstStatus:new sap.m.ObjectStatus({text:"{popoverGraph>SalesTarget}",}),attributes:[new sap.m.ObjectAttribute({text:p})]})}})}var H=new sap.m.Bar({contentMiddle:[new sap.m.Label({text:p})]});var F=new sap.m.Bar({contentLeft:[new sap.m.Button({text:this.oBundle.getText("BTN_VIEW_DETAILS"),press:jQuery.proxy(this.enablePopoverFooter,this,s.data[D])})],contentRight:[new sap.m.Button({text:d,press:jQuery.proxy(this.enablePopoverFooter,this,s.data[D])})]});this.chart.setPopoverFooter(F);E.setCustomHeader(H);L.setModel(M,"popoverGraph");E.addContent(L);var m=[E.getId(),"popover","cont"].join("-");$("#"+m).css("overflow-y",'auto');E.openBy(e.getParameter('srcEvent').getParameter('data')[0].target)},enablePopoverFooter:function(s,e){e.getSource().getParent().getParent().close();if(e.getSource().sParentAggregationName=="contentLeft"){this.showBubbleChart(e);this.getView().byId("sSP2").setSelectedKey("SalesPipeline");this.byId("filterButton").setEnabled(true);this.getView().byId("FilterPanel").setVisible(true);var f=this.byId("facetFilter");for(var i=-1,c;c=f.getLists()[++i];){if(c.getKey()=="org"){for(var j=-1,C;C=c.getItems()[++j];)if(C.getText()==s){C.setSelected(true);break}break}else{for(var j=-1,C;C=c.getItems()[++j];)C.setSelected(false);c.getBinding('items').filter([])}}f.rerender();for(var i=-1,o;o=this.graphDataToShow.results[++i];)if(o["SalesOrganizationUnitText"]==s)this.filteredOpportunities=o.Opportunities;this.showTopNOpp();var m=new sap.ui.model.json.JSONModel(this.filteredOpportunities);this.getView().setModel(m,"Opportunities");this.calculateProgress()}},selectOppNav:function(l,e){var s=e.getParameter('listItem').getBindingContext('popoverGraph').sPath;var r=s.split("/");var a=r[r.length-1];var b=l[a];this.guidVal=b["guId"];this.toOppApp();this.popover.close()},renderTopNSlider:function(e){if(!this.oFragmentList.topNSlider){this.oFragmentList.topNSlider=new sap.ui.xmlfragment('cus.crm.ppm.mgr.view.opportunitySlider',this);this.oFragmentList.topNSlider.setModel(this.getView().getModel("i18n"),"i18n")}this.oFragmentList.topNSlider.openBy(e.getSource())},_setTopNSliderLabel:function(m,v){var c=sap.ui.getCore();if(v==undefined)v=m;if(m>0){c.byId('opportunitySlider').setEnabled(true).setMin(1).setMax(m).setValue(v);if(m>1){c.byId('exLostCheck').setEnabled(true);c.byId('exWonCheck').setEnabled(true)}if(m>v){var n=this.oBundle.getText("LBL_NOOFTO_SELECTED",v);c.byId('sliderLabel').setText(n)}else{var a=this.oBundle.getText("LBL_ALLTO_SELECTED");c.byId('sliderLabel').setText(a)}}else{c.byId('opportunitySlider').setMin(0).setMax(0).setValue(0).setEnabled(false);var b=this.oBundle.getText("LBL_NOTO_SELECTED");c.byId('sliderLabel').setText(b);if(!(c.byId('exLostCheck').getSelected()||c.byId('exWonCheck').getSelected())){c.byId('exLostCheck').setEnabled(false);c.byId('exWonCheck').setEnabled(false)}}},_isFilteredStatus:function(o){var e=sap.ui.getCore().byId('exLostCheck').getSelected();var a=sap.ui.getCore().byId('exWonCheck').getSelected();if(e==true||a==true){var t=this._getBTCode(o);if(e==true&&t=="LOST")return true;if(a==true&&t=="WINN")return true}return false},_getCurrFilteredOpp:function(l){var d=this.getView().byId("chart_sim");var c=d._xAxis.xStart;var e=d._xAxis.xEnd;l.sort(function(a,b){return b.ExpectedSalesVolume-a.ExpectedSalesVolume});var f=l.length;for(var i=0;i<f;i++){var g=l[i].ClosingDate;if(!((c<=g)&&(g<=e))){l.splice(i,1);i--;f--;continue}if(this._isFilteredStatus(l[i])){l.splice(i,1);i--;f--}}return l},_getTopNOpp:function(i,a){var b=false;var s=sap.ui.getCore().byId('opportunitySlider');var c=sap.ui.getCore().byId('opportunitySlider').getValue();var d=sap.ui.getCore().byId('opportunitySlider').getMax();if(this.getView().byId('sSP2').getSelectedItem().getKey()=="Top10Opportunities")b=true;var l=this._getCurrFilteredOpp(this.OpportunitiesAll_chart.slice(0));var n=l.length;if(b){if(c>=10)c=10;if(n>10)n=10;if(s.getMax()==c)c=n;this._setTopNSliderLabel(n,c);l=l.slice(0,c)}else if((c==d)||(c>=n)||(n==c)||(c==0))this._setTopNSliderLabel(n);else{this._setTopNSliderLabel(n,c);l=l.slice(0,c)}return l},showTopNOpp:function(e){var i=false,a=false,I=true;if(e!=undefined){var c=e.getSource();if(oContrl.sId=="opportunitySlider")i=true;if(c.sId=='exLostCheck'||e.getSource().sId=='exWonCheck')a=true;var s=this.getView().getModel("SalesPipelineSetting").oData,S=this.getView().byId("name");var d=s.StartOfPeriod,E=s.EndOfPeriod;var b=S.getUnits()[S.getValue()].getKey(),f=S.getUnits()[S.getValue2()].getKey();if(d>=f||E<=b)I=false}var l=this._getTopNOpp(i,a);var m=new sap.ui.model.json.JSONModel(l);this.getView().setModel(m,"Opportunities");this.calculateProgress();this.LoadFacetFilter()},LoadOrgData:function(s){var t=this;var S=function(o,r){var m=new sap.ui.model.json.JSONModel(o.results);t.getView().setModel(m,"OrganizationSalesTargets");t.OrganizationSalesTargets=o.results};var e=function(E){t.showErrorMsg(E,true)};this.oDataModel.read("OrganizationSalesTargets",null,null,s,S,e)},_initializeAllControllerFragments:function(){var i=this.getView().getModel("i18n");this.oFragmentList={};if(!this.oFragmentList.Opportunity){this.oFragmentList.Opportunity=new sap.ui.xmlfragment('cus.crm.ppm.mgr.view.Opportunity',this);this.oFragmentList.Opportunity.setModel(i,"i18n")}if(!this.oFragmentList.topNSlider){this.oFragmentList.topNSlider=new sap.ui.xmlfragment('cus.crm.ppm.mgr.view.opportunitySlider',this);this.oFragmentList.topNSlider.setModel(i,"i18n")}if(!this.oFragmentList.salesPeriodSettings){this.oFragmentList.salesPeriodSettings=new sap.ui.xmlfragment('cus.crm.ppm.mgr.view.salesPeriodSettings',this);this.oFragmentList.salesPeriodSettings.setModel(i,"i18n");this.oFragmentList.salesPeriodSettings.setModel(this.getView().getModel("PeriodicityTexts"),"PeriodicityTexts");this.oFragmentList.salesPeriodSettings.setModel(this.getView().getModel("CurrencyList"),"CurrencyList");this.oFragmentList.salesPeriodSettings.setModel(this.getView().getModel("YearRanges"),"YearRanges");if(sap.ui.Device.system.desktop||sap.ui.Device.system.tablet)this.oFragmentList.salesPeriodSettings.setContentWidth("30em")}if(!this.oFragmentList.appSettings){this.oFragmentList.appSettings=new sap.ui.xmlfragment('cus.crm.ppm.mgr.view.appSettings',this);this.oFragmentList.appSettings.setModel(i,"i18n");if(sap.ui.Device.system.desktop||sap.ui.Device.system.tablet){this.oFragmentList.appSettings.setContentWidth("30em")}}},_destroyAllControllerFragments:function(){if(this.oFragmentList)for(var f in this.oFragmentList)this.oFragmentList[f].destroy();this.oFragmentList=null},pressLinkToEmailOrCall:function(e){var c=sap.ui.getCore(),i=["mcEmail","empRespEmail","mcPhone","empRespPhone"],s=e.getSource();switch(s){case c.byId(i[0]):case c.byId(i[1]):sap.m.URLHelper.triggerEmail(s.getText());break;case c.byId(i[2]):case c.byId(i[3]):sap.m.URLHelper.triggerTel(s.getText());break}},_checkForPopoverArrow:function(e){var E=e.getSource(),i=[E.getId(),"popover","arrow"].join("-"),d=$("#"+i);if(d.hasClass("sapMPopoverArrRight"))d.removeClass("sapMPopoverArrRight").addClass("sapMPopoverArrLeft");else if(d.hasClass("sapMPopoverArrLeft"))d.removeClass("sapMPopoverArrLeft").addClass("sapMPopoverArrRight")}});
