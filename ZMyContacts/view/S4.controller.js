/*
 * Copyright (C) 2009-2014 SAP SE or an SAP affiliate company. All rights reserved
 */
(function(){'use strict';jQuery.sap.require("sap.ca.scfld.md.controller.BaseDetailController");jQuery.sap.require("sap.ca.ui.model.type.Date");jQuery.sap.require("sap.m.MessageToast");jQuery.sap.require("sap.m.MessageBox");jQuery.sap.require("cus.crm.mycontacts.formatter.ReleaseFormatter");jQuery.sap.require("cus.crm.mycontacts.util.Constants");jQuery.sap.require("cus.crm.mycontacts.util.Util");sap.ca.scfld.md.controller.BaseDetailController.extend("cus.crm.mycontacts.view.S4",{onInit:function(){this.fullScreenMode=false;this.editMode=true;this.oDataModel=this.getView().getModel();this.pictureModel=new sap.ui.model.json.JSONModel();this.getView().setModel(this.pictureModel,"pictureModel");this.customizingModel=new sap.ui.model.json.JSONModel({TitleCustomizing:[],AcademicTitleCustomizing:[]});this.getView().setModel(this.customizingModel,"Customizing");this._readCustomizing(this._refreshDropDownBoxes);var t=this;this.oRouter.attachRouteMatched(function(e){var a=e.getParameter("arguments");if(e.getParameter("name")==="subDetail"){t.fullScreenMode=false;t.editMode=(a.editPath.substring(0,3)!=="Old");t.filter=a.filter;t.sort=a.sort;t.isSearch=a.isSearch;t.search=a.search;t.accountID=a.accountID;t.contactID=a.contactID;t.itemCount=a.itemCount;t._cleanUp();if(t.editMode){var m=t.oConnectionManager.getModel();var c="/"+a.editPath;t._fillScreen(m,c)}else{t.oldContextPath=a.editPath.substring(3,a.editPath.length);t._setEmptyScreen()}}else{if(e.getParameter("name")==="edit"){t.fullScreenMode=true;t.editMode=true;t._cleanUp();var m=t.oDataModel;var c="/"+e.getParameter("arguments").contextPath;t._fillScreen(m,c)}else{if(e.getParameter("name")==="new"){t.fullScreenMode=true;t.editMode=false;t._cleanUp();t._setEmptyScreen("/"+a.accountContextPath)}}}})},_fillScreen:function(m,c){var C=m.getContext(c);this.getView().setModel(m);this.getView().setBindingContext(C);var t=this;if(!C.getObject()){m.createBindingContext(c,"",{expand:t._getExpandForDataBinding()+",Account,Account/Addresses"},function(){t._updateAddresses(C.getObject().accountID);t._updatePicture()},true)}else{t._updateAddresses(C.getObject().accountID);t._updatePicture()}},_setEmptyScreen:function(a){var c=this._getTemplateForContact();var d=this._getDependentRelations();for(var i in d){c[d[i]]=this._getTemplateForDependentObject("ContactCollection/"+d[i])}var n=new sap.ui.model.json.JSONModel({NewContact:c});n.setDefaultBindingMode(sap.ui.model.BindingMode.OneWay);this.getView().setModel(n);this.getView().setBindingContext(n.getContext("/NewContact"));if(this.fullScreenMode){if(a&&a.split("'").length>0){var m=this.oDataModel;var A=new sap.ui.model.Context(m,a);var o=A.getObject();var b=a.split("'")[1];if(!o){var t=this;m.createBindingContext(a,"",{expand:"MainAddress,Addresses"},function(){var o=m.getProperty(a);t._setDefaultCompany(o.accountID,o.fullName);t._updateAddresses(b)},true)}else{this._setDefaultCompany(o.accountID,o.fullName);this._updateAddresses(b)}}}else{this._adaptAddressFields(false,true)}},_getTemplateForContact:function(){var c=this._generateTemplateUsingMetadata("ContactCollection");c.isMyContact=false;c.isMainContact=false;if(c.birthDate=="")c.birthDate=null;return c},_generateTemplateUsingMetadata:function(p){var e=this.oDataModel.oMetadata._getEntityTypeByPath(p);var t={};for(var i in e.property){t[e.property[i].name]=""}return t},_setBusy:function(b){this.setBtnEnabled("saveButton",!b);this.setBtnEnabled("cancelButton",!b);if(!this.oBusyDialog)this.oBusyDialog=new sap.m.BusyDialog();if(b)this.oBusyDialog.open();else{var t=this;window.setTimeout(function(){t.oBusyDialog.close()},300)}},_cleanUp:function(){this.getView().setModel(null);this.pictureModel.setProperty("/Pictures",[]);this.pictureModel.setProperty("/PictureSrc",undefined);this.pictureModel.setProperty("/OldPictureSrc",undefined);this._setContactPictureEditable(true);this.byId("contactPicture").removeAllPictures();var l=this.byId("lastNameInput");l.setShowSuggestion(!this.editMode);this.byId('lastNameInput').setValueState(sap.ui.core.ValueState.None);var c=this.byId("companyValueHelp");c.setEnabled(!this.fullScreenMode&&!this.editMode);c.setEditable(!this.fullScreenMode&&!this.editMode);c.setShowSuggestion(!this.fullScreenMode&&!this.editMode);this.byId('companyValueHelp').setValueState(sap.ui.core.ValueState.None);var a=this.byId("addressSelect");a.setBindingContext(undefined);a.removeAllItems()},onPictureSelected:function(e){this._toggleContactPictureFieldStatus()},onRemoveContactPicture:function(e){if(!this.pictureModel.getProperty("/OldPictureSrc")){this.pictureModel.setProperty("/OldPictureSrc",this.pictureModel.getProperty("/PictureSrc"))}this._toggleContactPictureFieldStatus()},_toggleContactPictureFieldStatus:function(){this._setContactPictureEditable(!this.byId("contactPicture").getEditable())},_setContactPictureEditable:function(i){this.byId("contactPicture").setEditable(i);this.byId("removeContactPictureButton").setVisible(!i);if(i){this.byId("contactPicture").destroyPictures()}},_updatePicture:function(){var m=this.getView().getModel();var c=this.getView().getBindingContext();var p=m.getProperty("Photo",c);if(p){if(p.mimeType){var a=cus.crm.mycontacts.formatter.ReleaseFormatter.getRelativePathFromURL(p.__metadata.media_src);this.pictureModel.setProperty("/Pictures",[{src:a}]);this.pictureModel.setProperty("/PictureSrc",a);this._setContactPictureEditable(false)}}else{this._setContactPictureEditable(true)}},_sendPictureRequests:function(c,a){if(this._changeForPictureExists()){var m=this.oConnectionManager.getModel(),p=this.byId("contactPicture").getPictures(),P=(p&&p.length>0)?p[0]:undefined,t,d={},A={},b=p&&p.length>0&&P.isSourceDataUri(),e=this.pictureModel.getProperty("/OldPictureSrc")&&this.pictureModel.getProperty("/OldPictureSrc").length>0;if(b||e){t=m.oHeaders["x-csrf-token"];if(!t){m.refreshSecurityToken();t=m.oHeaders["x-csrf-token"]}if(e){d.pictureURL=this.pictureModel.getProperty("/OldPictureSrc");d.type="DELETE";d.oHeaders={"X-CSRF-Token":t,"If-Match":"*"};d.data=""}if(b){A.pictureURL=m.sServiceUrl+"/ContactCollection(contactID='"+c.contactID+"',accountID='"+c.accountID+"')/Attachments";A.type="POST";A.oHeaders={"Content-Type":P.getMimeType(),"Content-Encoding":"base64","Content-Disposition":'attachment; filename="'+P.getName()+'"',"slug":"isImage","X-CSRF-Token":t};A.data=P.getBase64Encoding()}var o=function(){this._updatePicture();this._onAfterSave(c,true,a)};if(e){if(b){this._sendPictureRequest(c,d,function(){this._sendPictureRequest(c,A,o)})}else{this._sendPictureRequest(c,d,o)}}else{this._sendPictureRequest(c,A,o)}}else{this._onAfterSave(c,true,a)}}else{this._onAfterSave(c,true,a)}},_sendPictureRequest:function(c,p,s){jQuery.ajax({url:p.pictureURL,type:p.type,headers:p.oHeaders,success:jQuery.proxy(s,this),error:jQuery.proxy(function(m){this.oBusyDialog.close();this._displayResponseErrorMessage(m,cus.crm.mycontacts.util.Util.geti18NText("UPDATE_PHOTO_ERROR"))},this),dataType:"json",data:p.data})},_changeForPictureExists:function(){var p=this.pictureModel.getProperty("/PictureSrc");var o=this.pictureModel.getProperty("/OldPictureSrc");var P=this.byId("contactPicture").getPictures();if((!p&&P.length>0&&P[0].getMimeType())||o){return true}return false},displayAccount:function(e){if(!this._accountSelectDialog){this._accountSelectDialog=sap.ui.xmlfragment("cus.crm.mycontacts.view.AccountSelectDialog",this);var f=[];f.push(new sap.ui.model.Filter("category",sap.ui.model.FilterOperator.NE,"1"));this._accountSelectDialog.bindAggregation("items",{path:'/AccountCollection',template:this._accountSelectDialog.getItems()[0].clone(),parameters:{expand:'MainAddress'},filters:f,sorter:new sap.ui.model.Sorter("name1",false,this.groupAccount),});this._accountSelectDialog.setModel(this.oConnectionManager.getModel());this._accountSelectDialog.setModel(e.getSource().getModel("i18n"),"i18n");this.getView().getModel().attachRequestSent(function(){if(this._list){this._list.setNoDataText(cus.crm.mycontacts.util.Util.geti18NText("LOADING_TEXT"))}},this._accountSelectDialog);this.getView().getModel().attachRequestCompleted(function(){if(this._list){this._list.setNoDataText(cus.crm.mycontacts.util.Util.geti18NText("NO_DATA_TEXT"))}},this._accountSelectDialog)}else{this._accountSelectDialog._list.getBinding("items").filter([])}this._accountSelectDialog.open(this.getView().getModel().getProperty("/Account"))},selectAccount:function(e){var s=e.getParameter("selectedItem");if(s){var S=s.getBindingContext().getObject();this._setCompany(S.accountID,S.fullName);this._updateAddresses(S.accountID)}this.closeAccountSelectDialog(e)},closeAccountSelectDialog:function(e){if(e.getSource().getBinding("items").aFilters.length){e.getSource().destroyItems()}},searchAccount:function(e){var v=e.getParameter("value");if(v===""){e.getParameter("itemsBinding").filter([])}else{if(v!==undefined){e.getParameter("itemsBinding").filter([new sap.ui.model.Filter("name1",sap.ui.model.FilterOperator.Contains,v)])}}},groupAccount:function(c){var t=c.getProperty("name1");if(t&&typeof t==="string"){return t.charAt(0).toUpperCase()}return""},_updateAddresses:function(a){var m=this.oDataModel;var A=new sap.ui.model.Context(m,"/AccountCollection('"+a+"')");var o=A.getObject();var u=function(o){if(o.category!=cus.crm.mycontacts.util.Constants.accountCategoryPerson){this._setAddressSelect(o.accountID);this.byId("addressSelect").setEnabled(true)}else{this._adaptAddressFields(false,true);this.byId("addressSelect").setEnabled(false)}};if(!o){var b=A.getPath();var t=this;m.createBindingContext(b,"",{expand:"MainAddress,Addresses"},function(){var o=m.getProperty(b);u.call(t,o)},true)}else{u.call(this,o)}},_setAddressSelect:function(a){var m=this.oDataModel;var c=this.getView().getBindingContext();var A=new sap.ui.model.Context(m,"/AccountCollection('"+a+"')");var s=this.byId('addressSelect');s.unbindProperty("selectedKey");s.unbindAggregation("items");if(s&&a&&a.length>0){var b=m.getProperty(c.getPath()+"/WorkAddress/addressNumber");if(b){this._adaptAddressFields(true,false);this._bindAddressSelect(A,b)}else{if(this.editMode){this._adaptAddressFields(false,false);this._bindAddressSelect(A,b)}else{var t=this;cus.crm.mycontacts.util.Util.readODataObject(A,"MainAddress",function(d){b=d.addressNumber;t._adaptAddressFields(b!="",false);t._bindAddressSelect(A,b)})}}}},_bindAddressSelect:function(a,b){var s=this.byId('addressSelect');s.setModel(this.oConnectionManager.getModel());s.bindAggregation("items",{path:a.getPath()+"/Addresses",template:new sap.ui.core.Item({key:"{addressNumber}",text:"{path: 'address', formatter:'cus.crm.mycontacts.formatter.ReleaseFormatter.addressFormatter'}"})});s.insertItem(new sap.ui.core.Item({key:"",text:""}),0);if(b){s.bindProperty("selectedKey",b);s.setSelectedKey(b);if(!this.editMode&&this.fullScreenMode)this._setDefaultAddressNumberInput(b);else this._setAddressNumberInput(b)}},onAddressSelectInputFieldChanged:function(e){var a=e.getParameter("selectedItem").getProperty('key');this._setAddressNumberInput(a);this._adaptAddressFields(a!="",false)},_setDefaultAddressNumberInput:function(a){this.getView().getModel().setProperty(this.getView().getBindingContext().getPath()+"/WorkAddress/addressNumber",a);this._setAddressNumberInput(a)},_setAddressNumberInput:function(a){var b=this.getView().byId("WorkAddress.addressNumberInput");if(b)b.setValue(a)},_adaptAddressFields:function(a,e){var f=this.byId("editForm");if(!f)return;var F=f.getContent();var v=this.getView().getId();for(var i in F){var o=F[i];var b=o.getId();var r=new RegExp(v+"--WorkAddress.[A-z0-9]+Input","g");if(r.test(b)){o.setEnabled(a);if(e)o.setValue("")}if(b==v+"--addressSelect"){if(e)o.setSelectedKey("")}}},_checkSaveNeeded:function(){var c=this.getView().getBindingContext();var C=c.getObject();var n={};var a=false,b=false,d=false;a=this._fillNewObject(C,n,"");if(a)return true;b=this._changesForDependentRelationsExists();if(b)return true;d=this._changeForPictureExists();if(d)return true;else return false},_checkSavePossible:function(){var i=true;if(!this.editMode){if(!this.byId("accountIDInput").getValue()){this.byId('companyValueHelp').setValueState(sap.ui.core.ValueState.Error);i=false}}if(this.byId("lastNameInput").getValue().length===0){this.byId('lastNameInput').setValueState(sap.ui.core.ValueState.Error);i=false}if(!i)sap.m.MessageBox.alert(cus.crm.mycontacts.util.Util.geti18NText("MSG_MANDATORY_FIELDS"));return i},_fillNewObject:function(s,t,f){var c=false;var i="";for(var k in s){i=this.getView().getId()+"--"+f+k+"Input";if(typeof s[k]!="object"||k=="birthDate")t[k]=s[k];var I=this.byId(i);if(I){var n="";if(I.getDateValue){n=I.getValue();if(n==""){n=null}else{var d=sap.ui.core.format.DateFormat.getDateInstance({style:"medium"});var D=d.parse(n);if(D){var N=new Date();N.setUTCFullYear(D.getFullYear());N.setUTCMonth(D.getMonth());N.setUTCDate(D.getDate());N.setUTCHours(0);N.setUTCMinutes(0);N.setUTCSeconds(0);N.setUTCMilliseconds(0);n=N}else{n=null}}}else if(I.getSelectedKey)n=I.getSelectedKey();else if(I.getValue)n=I.getValue();if(n&&n.getTime){if(!t[k]||n.getTime()!=t[k].getTime()){c=true;t[k]=n}}else if(t[k]!=n){c=true;t[k]=n}}}return c},_getExpandForDataBinding:function(){var e='Photo';var d=this._getDependentRelations();for(var i in d){e=e+","+d[i]}return e},_getDependentRelations:function(){var d=["WorkAddress"];var D=[];if(this.extHookGetDependentCustomRelations)D=this.extHookGetDependentCustomRelations();for(var i in D){d.push(D[i])}return d},_getTemplateForDependentObject:function(r){return this._generateTemplateUsingMetadata("ContactCollection/"+r)},_changesForDependentRelationsExists:function(s){var m=this.oDataModel;var c=this.getView().getBindingContext();var a=false;var d=this._getDependentRelations();for(var i in d){var D=m.getProperty(c+"/"+d[i]);if(!s)D=c.getProperty(d[i]);if(!D)D=this._getTemplateForDependentObject("ContactCollection/"+d[i]);var n={};a=this._fillNewObject(D,n,d[i]+".");if(a)return a}return a},_adaptContactWithDependentRelationsBeforeCreate:function(n){var d=this._getDependentRelations();for(var i in d){var D=this._getTemplateForDependentObject("ContactCollection/"+d[i]);var N={};var c=this._fillNewObject(D,N,d[i]+".");if(c)n[d[i]]=N}},onSaveButtonPressed:function(e){this._saveData(false)},_saveData:function(f){var e=null;if(f)e="*";if(!this.byId('addressSelect').getSelectedKey()){this._adaptAddressFields(false,true)}if(!this._checkSavePossible())return;this._setBusy(true);var m=this.getView().getModel();var c=this.getView().getBindingContext();var C=c.getObject();var n={};var a=false,b=false;a=this._fillNewObject(C,n,"");b=this._changesForDependentRelationsExists("saveMode");if(!a&&!b&&!this._changeForPictureExists()){sap.m.MessageToast.show(cus.crm.mycontacts.util.Util.geti18NText("NO_CHANGE"));this._setBusy(false);this._onAfterSave(C,false,a)}else{var B,r;var d=[];var t=this;if(this.editMode){if(a){r=c.sPath;B=m.createBatchOperation(r,"PUT",n,{sETag:e});d.push(B)}if(b){this._createBatchOperationForDependentRelations(d,e)}if(!a&&!b&&this._changeForPictureExists()){this._sendPictureRequests(C,a)}else{cus.crm.mycontacts.util.Util.sendBatchChangeOperations(this.oDataModel,d,function(){t._sendPictureRequests(C,a);sap.m.MessageToast.show(cus.crm.mycontacts.util.Util.geti18NText("UPDATE_SUCCESS"))},function(E){t._onAfterSave(null,false,a,E)})}}else{r="/ContactCollection";B=this.oDataModel.createBatchOperation(r,"POST",n);if(b){this._adaptContactWithDependentRelationsBeforeCreate(n)}d.push(B);cus.crm.mycontacts.util.Util.sendBatchChangeOperations(this.oDataModel,d,function(g){t._sendPictureRequests(g,a);t.getView().setBindingContext(new sap.ui.model.Context(m,"/ContactCollection(contactID='"+g.contactID+"',accountID='"+g.accountID+"')"));sap.m.MessageToast.show(cus.crm.mycontacts.util.Util.geti18NText("CREATION_SUCCESS"))},function(E){t._onAfterSave(null,false,a,E)})}}},_onAfterSave:function(r,c,a,e){this._setBusy(false);if(e){if(this["_onAfterSaveHandleErrorCode_"+e.statusCode])this["_onAfterSaveHandleErrorCode_"+e.statusCode]();else sap.m.MessageBox.alert(e.message.value);return}var b=sap.ui.getCore().getEventBus();if(c&&this.editMode){var d="ContactCollection(contactID='"+r.contactID+"',accountID='"+r.accountID+"')";if(!a)cus.crm.mycontacts.util.Util.getRefreshUIObject(this.oConnectionManager.getModel(),"/"+d,this._getExpandForDataBinding()).refresh();b.publish("cus.crm.mycontacts","contactChanged",{contextPath:d})}if(!this.editMode)b.publish("cus.crm.mycontacts","contactCreated");if(this.fullScreenMode)window.history.back();else{if(this.editMode){var p={contextPath:"ContactCollection(contactID='"+r.contactID+"',accountID='"+r.accountID+"')",filter:this.filter,sort:this.sort,isSearch:this.isSearch,search:this.search,accountID:this.accountID,contactID:this.contactID,itemCount:this.itemCount};this.oRouter.navTo("detail2",p,true)}else{var d="ContactCollection(contactID='"+r.contactID+"',accountID='"+r.accountID+"')";var s=(r.firstName!="")?r.firstName+" "+r.lastName:r.lastName;this.oRouter.navTo("selected",{contextPath:d,name:s},true)}}},_onAfterSaveHandleErrorCode_412:function(){var t=this;sap.m.MessageBox.show(cus.crm.mycontacts.util.Util.geti18NText("MSG_CONFLICTING_DATA"),{title:cus.crm.mycontacts.util.Util.geti18NText("CONFIRM_TITLE"),actions:[sap.m.MessageBox.Action.YES,sap.m.MessageBox.Action.NO],onClose:function(c){if(c==sap.m.MessageBox.Action.YES){t._saveData(true)}else{var r=cus.crm.mycontacts.util.Util.getRefreshUIObject(t.getView().getModel(),t.getView().getBindingContext().sPath,t._getExpandForDataBinding());r.refresh(function(){t._setAddressSelect(t.getView().getBindingContext().getProperty("accountID"))})}},})},_createBatchOperationForDependentRelations:function(b,e){var m=this.getView().getModel();var c=this.getView().getBindingContext();var C=c.getObject();var d=this._getDependentRelations();for(var i in d){var D=m.getProperty(c+"/"+d[i]);var o=null;if(D)o=m.getContext("/"+C[d[i]]["__ref"]);var n={};var a=false;var f=false;if(!D||this._objectKeyIsInitial(D,"ContactCollection/"+d[i])){f=true;D=this._getTemplateForDependentObject(d[i]);if(D.contactID!=null&&D.contactID!=undefined)D.contactID=C.contactID;if(D.personID!=null&&D.personID!=undefined)D.personID=C.contactID;if(D.accountID!=null&&D.accountID!=undefined)D.accountID=C.accountID}a=this._fillNewObject(D,n,d[i]+".");var B,r;if(a){var h;if(f){h="POST";var E=this.oDataModel.oMetadata._getEntityTypeByPath("ContactCollection/"+d[i]);r=E.name+"Collection"}else{h="PUT";r=o.sPath}B=m.createBatchOperation(r,h,n,{sETag:e});b.push(B)}}},_objectKeyIsInitial:function(o,p){var e=this.oDataModel.oMetadata._getEntityTypeByPath(p);for(var i in e.key.propertyRef)if(o[e.key.propertyRef[i].name]!="")return false;return true},onCancelButtonPressed:function(){var c=this.getView().getBindingContext().getObject();if(!this._checkSaveNeeded()){this._onAfterCancel(c);return}sap.m.MessageBox.confirm(cus.crm.mycontacts.util.Util.geti18NText("CONFIRM_CANCEL"),jQuery.proxy(function(a){if(a==="OK"){this._onAfterCancel(c)}},this))},_onAfterCancel:function(c){if(this.fullScreenMode)window.history.back();else{if(jQuery.device.is.phone&&!this.editMode){this.oRouter.navTo("master",undefined,true)}else{var p={contextPath:this.editMode?"ContactCollection(contactID='"+c.contactID+"',accountID='"+c.accountID+"')":this.oldContextPath,filter:this.filter,sort:this.sort,isSearch:this.isSearch,search:this.search,accountID:this.accountID,contactID:this.contactID,itemCount:this.itemCount};this.oRouter.navTo("detail2",p,true)}}},_navBack:function(){if(this._checkSaveNeeded()){sap.m.MessageBox.confirm(cus.crm.mycontacts.util.Util.geti18NText("CONFIRM_CANCEL"),jQuery.proxy(function(c){if(c==="OK")window.history.back(1)},this))}else window.history.back(1)},_displayResponseErrorMessage:function(m,d){var M;if(m.response){M=jQuery.parseJSON(m.response.body).error.message.value}sap.m.MessageBox.alert(M||d)},_readCustomizing:function(c){var t=this;cus.crm.mycontacts.util.Util.sendBatchReadOperations(this.oDataModel,["CustomizingTitleCollection","CustomizingAcademicTitleCollection"],function(r){var T=r["CRM_BUPA_ODATA.CustomizingTitle"];T.unshift({title:"",titleDescription:"",person:"X",organization:"X",group:"X"});t.customizingModel.setProperty("/TitleCustomizing",T);var a=r["CRM_BUPA_ODATA.CustomizingAcademicTitle"];a.unshift({title:"",titleDescription:""});t.customizingModel.setProperty("/AcademicTitleCustomizing",a);if(c)c.call(t)})},_refreshDropDownBoxes:function(){var d=this._getIDForDropDownBoxes();for(var i in d){var D=this.byId(this.getView().getId()+"--"+d[i]);if(D){var b=D.getBinding("selectedKey");if(b){D.bindProperty("selectedKey",b.sPath)}}}},_getIDForDropDownBoxes:function(){return["titleIDInput","academicTitleIDInput"]},_setDefaultCompany:function(a,c){var m=this.getView().getModel();var b=this.getView().getBindingContext().getPath();m.setProperty(b+"/accountID",a);m.setProperty(b+"/company",c);this._setCompany(a,c)},_setCompany:function(a,c){var b=this.getView().byId("accountIDInput");if(b)b.setValue(a);var d=this.getView().byId("companyValueHelp");if(d)d.setValue(c)},onCompanySuggestItemSelected:function(e){var I=e.getParameter("selectedItem");var a=null;for(var i in I.getCustomData()){var c=I.getCustomData()[i];if(c.getKey()=="oAccount")a=c.getValue()}this._setCompany(a.accountID,a.fullName);this._updateAddresses(a.accountID)},onCompanyInputFieldChanged:function(e){this.byId('companyValueHelp').setValueState(sap.ui.core.ValueState.None);var c=e.getSource();this._setCompany("",c.getValue());this._adaptAddressFields(false,true);c.removeAllSuggestionItems();c.setFilterSuggests(false);var C=function(a){for(var i=0;i<a.length;i++){var A=a[i];if(A.fullName.toUpperCase()==c.getValue().toUpperCase()){this._setCompany(A.accountID,A.fullName)}var o=new sap.ui.core.CustomData({key:"oAccount",value:A});var I=new sap.ui.core.Item({text:A.fullName,customData:o});c.addSuggestionItem(I)}};this._readCompany(c.getValue(),C)},_readCompany:function(s,c){var t=this;var d=(s?500:0);window.clearTimeout(this.liveChangeTimer);if(d){this.liveChangeTimer=window.setTimeout(function(){t.oDataModel.read("/AccountCollection",null,'$top=10&$filter=category%20ne%20%27'+cus.crm.mycontacts.util.Constants.accountCategoryPerson+'%27%20and%20substringof(%27'+encodeURIComponent(s)+'%27,name1)',true,function(D,r){var a=jQuery.parseJSON(JSON.stringify(D));if(c)c.call(t,a.results)},function(e){jQuery.sap.log.error("Read failed in S4->_readCompany:"+e.response.body)})},d)}},_setContact:function(c,a){var b=this.getView().byId("contactIDInput");var t=this.getView().byId("titleIDInput");var d=this.getView().byId("academicTitleIDInput");var e=this.getView().byId("birthDateInput");if(c){if(b)b.setValue(c.accountID);var l=this.getView().byId("lastNameInput");if(l)l.setValue(c.name1);var f=this.getView().byId("firstNameInput");if(f)f.setValue(c.name2);if(t)t.setSelectedKey(c.titleID);if(d)d.setSelectedKey(c.academicTitleID);var D=cus.crm.mycontacts.formatter.ReleaseFormatter.formatMediumDate(c.birthDate);if(e)e.setValue(D.toString())}else{var o=b.getValue();if(!this.editMode&&o&&!a){t.setSelectedKey("");d.setSelectedKey("");e.setValue("")}b.setValue(a)}},onLastNameSuggestItemSelected:function(e){var I=e.getParameter("selectedItem");var c=null;for(var i in I.getCustomData()){var C=I.getCustomData()[i];if(C.getKey()=="oContact")c=C.getValue()}this._setContact(c,"")},onLastNameInputFieldChanged:function(e){this.byId('lastNameInput').setValueState(sap.ui.core.ValueState.None);if(this.editMode){this._setContact("",this.byId("contactIDInput").getValue())}else{this._setContact("","")}var l=e.getSource();l.removeAllSuggestionItems();l.setFilterSuggests(false);var c=function(C){for(var i=0;i<C.length;i++){var o=C[i];var a=new sap.ui.core.CustomData({key:"oContact",value:o});var I=new sap.ui.core.Item({text:o.fullName,customData:a});l.addSuggestionItem(I)}};this._readContact(l.getValue(),c)},onFirstNameInputFieldChanged:function(e){if(this.editMode){this._setContact("",this.byId("contactIDInput").getValue())}else{this._setContact("","")}},_readContact:function(s,c){var t=this;var d=(s?500:0);window.clearTimeout(this.liveChangeTimer);if(d){this.liveChangeTimer=window.setTimeout(function(){t.oDataModel.read("/AccountCollection",null,'$top=10&$filter=category%20eq%20%27'+cus.crm.mycontacts.util.Constants.accountCategoryPerson+'%27%20and%20substringof(%27'+encodeURIComponent(s)+'%27,name1)',true,function(D,r){var a=jQuery.parseJSON(JSON.stringify(D));if(c)c.call(t,a.results)},function(e){jQuery.sap.log.error("Read failed in S4->_readContact:"+e.response.body)})},d)}},getHeaderFooterOptions:function(){var t=this;return{sI18NFullscreenTitle:"DETAIL_TITLE",buttonList:[{sI18nBtnTxt:"S4_SAVE",sId:"saveButton",onBtnPressed:jQuery.proxy(this.onSaveButtonPressed,this)},{sI18nBtnTxt:"S4_CANCEL",sId:"cancelButton",onBtnPressed:jQuery.proxy(this.onCancelButtonPressed,this),},],onBack:t._getBackFunction(),oAddBookmarkSettings:{icon:"sap-icon://Fiori2/F0004"},}},_getBackFunction:function(){if(this.fullScreenMode||jQuery.device.is.phone){var t=this;return function(){t.onCancelButtonPressed()}}else return undefined},})}());
