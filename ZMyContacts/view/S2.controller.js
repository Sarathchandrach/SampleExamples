/*
 * Copyright (C) 2009-2014 SAP SE or an SAP affiliate company. All rights reserved
 */
(function(){'use strict';jQuery.sap.require("sap.ca.scfld.md.controller.BaseMasterController");sap.ca.scfld.md.controller.BaseMasterController.extend("cus.crm.mycontacts.view.S2",{sDefaultValue:"-1",iAccountID:undefined,iContactID:undefined,bToolbarInfo:false,aFilterKey:{sAll:"All",sMy:"My Contacts"},aSorterKey:{sLastName:"lastName",sFirstName:"firstName",sCompany:"company"},constructor:function(){this.bHasInit=true},onInit:function(){var s=this;this.oRouter=sap.ui.core.UIComponent.getRouterFor(this);this.oApplicationImplementation=sap.ca.scfld.md.app.Application.getImpl();this.oApplicationFacade=this.oApplicationImplementation.oConfiguration.oApplicationFacade;this.resourceBundle=this.oApplicationFacade.getResourceBundle();this._initHeaderFooterOptions();this._getParameters();this.oRouter.attachRouteMatched(this._handleRouteMatched,this);this.oApplicationImplementation.oMHFHelper.defineMasterHeaderFooter(this)},getHeaderFooterOptions:function(){return this.oHeaderFooterOptions},setListItem:function(i,n){var t=this;this._handleUnsavedChanges(function(){t._handleSetListItem(i,n)},function(){if(t.prevItem){var l=t.getList();l.removeSelections();l.setSelectedItem(t.prevItem,true)}})},_handleSetListItem:function(i,n){if(i){var l=this.getList(),p;l.removeSelections();l.setSelectedItem(i,true);if(!n){p={contextPath:i.getBindingContext().sPath.substr(1)};this.sContext=i.getBindingContext().sPath.substr(1);this._updateParameter(p);this.prevItem=i;this.oRouter.navTo("detail2",p,!jQuery.device.is.phone)}}},_handleUnsavedChanges:function(c,r){var C=sap.ca.scfld.md.app.Application.getImpl().oSplitContainer.getCurrentDetailPage();if(C&&C.getController()&&C.getController()._checkSaveNeeded){var o=C.getController();if(o.getView().getBindingContext()&&o._checkSaveNeeded()){var t=this;sap.m.MessageBox.confirm(cus.crm.mycontacts.util.Util.geti18NText("CONFIRM_CANCEL"),jQuery.proxy(function(a){if(a==="OK"){o.getView().setBindingContext(null);if(o._cleanUp&&o._setEmptyScreen){o.editMode=false;o._cleanUp();o._setEmptyScreen()}c()}else{r()}},t))}else{c()}}else{c()}},navToEmpty:function(){this.updateMasterTitle();this._showLoadingText(false);if(!jQuery.device.is.phone){this.oRouter.navTo("noData",{viewTitle:"DETAIL_TITLE",languageKey:"NO_ITEMS_AVAILABLE"},true)}},_showLoadingText:function(l){if(l){this.getList().setNoDataText(this.resourceBundle.getText("LOADING_TEXT"))}else{this.getList().setNoDataText(this.resourceBundle.getText("NO_DATA_TEXT"))}},applyBackendSearchPattern:function(){this._applyFilter()},handleSort:function(k){this._setSelectedSort(k);var s=this._createSorter(),l;l=this.getList().getBinding("items");if(l){l.aSorters=s;l.sort(s);if(!jQuery.device.is.portrait)l.attachChange(this._selectFirstElement,this)}},isBackendSearch:function(){return true},handleFilter:function(k){this._setSelectedFilter(k);this._applyFilter()},updateMasterTitle:function(){var n,s;n=this.getList().getBinding('items').getLength();s=this.oApplicationImplementation.oMHFHelper;s.setMasterTitle.apply(s,[this,n]);this._showLoadingText(true)},onAddButtonPressed:function(){var t=this;this._handleUnsavedChanges(function(){t._handleAdd()},function(){})},_handleAdd:function(){var p={editPath:"Old"+this.sContext};this._updateParameter(p);this.oRouter.navTo("subDetail",p,true)},_createSorter:function(){var s,S=this._getSelectedSort();switch(S){case this.aSorterKey.sCompany:s=[new sap.ui.model.Sorter(S,false,this._handleCompanyGroup),new sap.ui.model.Sorter("lastName",false,false)];break;case this.aSorterKey.sLastName:s=[new sap.ui.model.Sorter(S,false,this._handleLastNameGroup)];break;default:s=[new sap.ui.model.Sorter(S,false,this._handleFirstNameGroup)]}return s},_handleFirstNameGroup:function(c){var t=c.getProperty("firstName");if(t&&typeof t==="string"){return t.charAt(0).toUpperCase()}return""},_handleLastNameGroup:function(c){var t=c.getProperty("lastName");if(t&&typeof t==="string"){return t.charAt(0).toUpperCase()}return""},_handleCompanyGroup:function(c){return c.getProperty("company")},_getParameters:function(){var c,m,s;c=sap.ui.core.Component.getOwnerIdFor(this.getView());m=sap.ui.component(c);if(m&&m.getComponentData()){s=m.getComponentData().startupParameters;if(s){jQuery.sap.log.debug("startup parameters of CRM-MyContacts are "+JSON.stringify(s));if(s.accountID&&s.accountID[0]){this.iAccountID=s.accountID[0]}if(s.contactID&&s.contactID[0]){this.iContactID=s.contactID[0]}if(this.iAccountID||this.iContactID){this._setSelectedSort(this.aSorterKey.sLastName);this._setSelectedFilter(this.aFilterKey.sAll)}}}},_getFilters:function(){var f=[],i=this._getSelectedFilter()!==this.aFilterKey.sAll,s;s=this._getSearchText();f.push(new sap.ui.model.Filter("isMyContact",sap.ui.model.FilterOperator.EQ,i));if(this.iAccountID){f.push(new sap.ui.model.Filter("accountID",sap.ui.model.FilterOperator.EQ,this.iAccountID))}if(this.iContactID){f.push(new sap.ui.model.Filter("contactID",sap.ui.model.FilterOperator.EQ,this.iContactID))}if(s){f.push(new sap.ui.model.Filter("fullName",sap.ui.model.FilterOperator.Contains,s))}return f},_selectContextPath:function(e){var l=this.getList(),I,m,E,i,a,p,b;if(l){I=l.getItems()}this.byId("toolbarInfo").setVisible(this.bToolbarInfo);if(this.contextPath){if(I&&I.length>0){e.getSource().detachChange(this._selectContextPath,this);m=l.getModel();p="/"+this.contextPath;E=m.getProperty(p);if(E){if(this.bToolbarInfo){this._setToolbarInfoText(E.fullName,E.company)}for(i=0,a=I.length;i<a;i++){b=I[i].getBindingContext();if(b&&b.sPath===p){this.contextPath=undefined;this.setListItem(I[i],jQuery.device.is.phone);this._setFocus(l,I[i]);this.updateMasterTitle();return}}}else{if(l._oGrowingDelegate._iItemCount<this.getList().getBinding('items').getLength()){l._oGrowingDelegate.requestNewPage();e.getSource().attachChange(this._selectContextPath,this)}else{this.navToEmpty()}}}else{this.navToEmpty()}}},_selectFirstElement:function(e){var l=this.getList(),I=l.getItems(),i,a,b,E;e.getSource().detachChange(this._selectFirstElement,this);if(I.length>0){for(i=0,a=I.length;i<a;i++){b=I[i].getBindingContext();if(b&&b.sPath){this.setListItem(I[i],jQuery.device.is.phone);this.byId("toolbarInfo").setVisible(this.bToolbarInfo);if(this.bToolbarInfo){E=l.getModel().getProperty(b.sPath);if(E){this._setToolbarInfoText(E.fullName,E.company)}}this.updateMasterTitle();return}}}this.navToEmpty()},_initHeaderFooterOptions:function(){var t=this;this.oHeaderFooterOptions={sI18NMasterTitle:"MASTER_TITLE_FOR_MY_CONTACTS",buttonList:[],onBack:t._getBackFunction(),oFilterOptions:{aFilterItems:[{key:this.aFilterKey.sAll,text:this.resourceBundle.getText("ALL_CONTACTS")},{key:this.aFilterKey.sMy,text:this.resourceBundle.getText("MY_CONTACTS")}],sSelectedItemKey:this.aFilterKey.sMy,onFilterSelected:jQuery.proxy(this.handleFilter,this)},oSortOptions:{aSortItems:[{key:this.aSorterKey.sLastName,text:this.resourceBundle.getText("CONTACT_LAST_NAME")},{key:this.aSorterKey.sFirstName,text:this.resourceBundle.getText("CONTACT_FIRST_NAME")},{key:this.aSorterKey.sCompany,text:this.resourceBundle.getText("CONTACT_ACCOUNT")}],sSelectedItemKey:this.aSorterKey.sLastName,onSortSelected:jQuery.proxy(this.handleSort,this)},onAddPress:jQuery.proxy(this.onAddButtonPressed,this)}},_getSelectedFilter:function(){return this.oHeaderFooterOptions.oFilterOptions.sSelectedItemKey},_setSelectedFilter:function(k){if(this.oHeaderFooterOptions){this.oHeaderFooterOptions.oFilterOptions.sSelectedItemKey=k;switch(k){case this.aFilterKey.sAll:this.oHeaderFooterOptions.sI18NMasterTitle="MASTER_TITLE";break;default:this.oHeaderFooterOptions.sI18NMasterTitle="MASTER_TITLE_FOR_MY_CONTACTS";break}}},_getSelectedSort:function(){return this.oHeaderFooterOptions.oSortOptions.sSelectedItemKey},_setSelectedSort:function(k){if(this.oHeaderFooterOptions){this.oHeaderFooterOptions.oSortOptions.sSelectedItemKey=k}},_handleRouteMatched:function(e){var n=e.getParameter("name");switch(n){case"master":this._masterRouteMatched(e);break;case"selected":this._selectedRouteMatched(e);break}},_masterRouteMatched:function(e){var l=this.getList(),b,a;if(this.bHasInit){this.bHasInit=false;a=e.getParameter("arguments");this._initState(a);this._createBindAggregation();if(a.itemCount){l._oGrowingDelegate._iItemCount=a.itemCount}this.oApplicationImplementation.setModels(this);b=l.getBinding("items");if(this.contextPath){b.attachChange(this._selectContextPath,this)}else if(!this.editPath){b.attachChange(this._selectFirstElement,this)}this._oMasterListBinding=this.getList().getBinding("items")}},_initState:function(s){if(s){if(s.contextPath){this.contextPath=s.contextPath}if(s.editPath){this.editPath=s.editPath}if(s.filter){this._setSelectedFilter(s.filter)}if(s.sort){this._setSelectedSort(s.sort)}if(s.accountID&&s.accountID!==this.sDefaultValue){this.iAccountID=s.accountID;this.bToolbarInfo=true}if(s.contactID&&s.contactID!==this.sDefaultValue){this.iContactID=s.contactID;this.bToolbarInfo=true}if(s.itemCount&&s.itemCount!==this.sDefaultValue){this.iItemCount=parseInt(s.itemCount,0)}if(s.isSearch&&s.isSearch==="true"&&this._oControlStore&&this._oControlStore.oMasterSearchField){this._oControlStore.oMasterSearchField.setValue(s.search)}this.oApplicationImplementation.oMHFHelper.defineMasterHeaderFooter(this)}},_selectedRouteMatched:function(e){var a,l,b,f;a={contextPath:e.getParameter("arguments").contextPath,filter:this.aFilterKey.sAll,isSearch:"true",search:e.getParameter("arguments").name};this._initState(a);this.iAccountID=undefined;this.iContactID=undefined;l=this.getList();b=l.getBinding("items");if(b){b.aApplicationFilters=[];f=this._getFilters();b.filter(f);b.attachChange(this._selectContextPath,this)}},_createBindAggregation:function(){var t,f,s,l;t=this.getList().getItems()[0].clone();f=this._getFilters();s=this._createSorter();l=this.getList();l.bindAggregation("items",{path:'/ContactCollection',template:t,filters:f,sorter:s,parameters:{expand:'Photo,WorkAddress'}})},_getSearchText:function(){return this._oControlStore&&this._oControlStore.oMasterSearchField&&this._oControlStore.oMasterSearchField.getValue()},_updateParameter:function(p){var a=this.sDefaultValue,c=this.sDefaultValue,s=this.sDefaultValue,i=false;if(this.iAccountID){a=this.iAccountID}if(this.iContactID){c=this.iContactID}if(this._getSearchText()){s=this._getSearchText();i=true}p.filter=this._getSelectedFilter();p.sort=this._getSelectedSort();p.isSearch=i;p.search=s;p.accountID=a;p.contactID=c;p.itemCount=this.getList()._oGrowingDelegate._iItemCount},_setFocus:function(l,i){jQuery.sap.delayedCall(500,this,function(){this.getView().byId("page").getScrollDelegate().scrollTo(0,i.$().offset().top-l.$().offset().top)})},_handleToolBar:function(){this.byId("toolbarInfo").setVisible(false);this.bToolbarInfo=false;this.iAccountID=undefined;this.iContactID=undefined;this._applyFilter()},_setToolbarInfoText:function(c,a){if(this.iContactID&&this.iAccountID){this.byId("labelInfo").setText(this.resourceBundle.getText('FILTERED_BY',[c+", "+a]))}else if(this.iContactID){this.byId("labelInfo").setText(this.resourceBundle.getText('FILTERED_BY',[c]))}else if(this.iAccountID){this.byId("labelInfo").setText(this.resourceBundle.getText('FILTERED_BY',[a]))}},_applyFilter:function(){var f=this._getFilters(),l;l=this.getList().getBinding("items");if(l){l.aApplicationFilters=[];l.filter(f);if(jQuery.device.is.portrait){var t=this;l.attachChange(function(){t._showLoadingText(false)})}else{l.attachChange(this._selectFirstElement,this)}this.updateMasterTitle()}},_getBackFunction:function(){return function(){var c=sap.ca.scfld.md.app.Application.getImpl().oSplitContainer.getCurrentDetailPage();if(c&&c.getControllerName()=="cus.crm.mycontacts.view.S4"){var C=c.getController();C._navBack()}else{window.history.back(1)}}}})}());
