/*
 * Copyright (C) 2009-2014 SAP SE or an SAP affiliate company. All rights reserved
 */
jQuery.sap.require("sap.ca.scfld.md.controller.BaseMasterController");jQuery.sap.require("hcm.mgr.approve.timesheet.utility.Parser");jQuery.sap.require("sap.ca.ui.utils.busydialog");jQuery.sap.require("sap.ca.ui.message.message");sap.ca.scfld.md.controller.BaseMasterController.extend("hcm.mgr.approve.timesheet.view.S2",{extHookDisplayEmployeeList:null,extHookDisplayCostAssignmentList:null,onInit:function(){sap.ca.scfld.md.controller.BaseMasterController.prototype.onInit.call(this);this.oBundle=this.oApplicationFacade.getResourceBundle();this.oDataModel=this.oApplicationFacade.getODataModel();this.readEmployeeListData(true);this.selection="";var s=this;this.oRouter.attachRouteMatched(function(e){if(e.getParameter("name")==="masterDetail"){if(e.getParameter("arguments").contextPath===undefined){if(this.selection=="Employee"){s.readEmployeeListData(false)}else if(this.selection=="CA"){s.readCostAssisgnmentListData(false)}}}},this)},resolveHash:function(e){return decodeURIComponent(e.getParameter("arguments").contextPath)},setListItem:function(i){this.selection=i.getBindingContext(this.modelName).getPath().split("/")[1];this.index=i.getBindingContext(this.modelName).getPath().split("/")[2];if(i!==undefined){i.setSelected(true);this.oRouter.navTo("detail",{contextPath:encodeURIComponent(i.getBindingContext(this.sModelName).getPath())},!jQuery.device.is.phone)}},applySearchPatternToListItem:function(i,f){if(f.substring(0,1)==="#"){var t=f.substr(1);var d=i.getBindingContext().getProperty("Name").toLowerCase();return d.indexOf(t)===0}else{if(f===""){return true}var p=i.getBindingContext().sPath.split("/")[1];if(p=="Employee")var I=i.getBindingContext().getModel().getData().Employee;else var I=i.getBindingContext().getModel().getData().CA;for(var k in I){var v=I[k];if(typeof v=="string"){if(v.toLowerCase().indexOf(f)!=-1){return true}}}if((i.getIntro()&&i.getIntro().toLowerCase().indexOf(f)!=-1)||(i.getTitle()&&i.getTitle().toLowerCase().indexOf(f)!=-1)||(i.getNumber()&&i.getNumber().toLowerCase().indexOf(f)!=-1)||(i.getNumberUnit()&&i.getNumberUnit().toLowerCase().indexOf(f)!=-1)||(i.getFirstStatus()&&i.getFirstStatus().getText().toLowerCase().indexOf(f)!=-1)||(i.getSecondStatus()&&i.getSecondStatus().getText().toLowerCase().indexOf(f)!=-1)){return true}var a=i.getAttributes();for(var j=0;j<a.length;j++){if(a[j].getText().toLowerCase().indexOf(f)!=-1){return true}}return false}},getHeaderFooterOptions:function(){var t=this;return{sI18NMasterTitle:"MASTER_TITLE",onRefresh:function(s,r){var a=function(d,R){hcm.mgr.approve.timesheet.utility.Parser.setCachedData(d);if(r){r()}if(t.selection==="Employee"||t.selection=="")t.displayEmployeeList(d,false);else t.displayCostAssignmentList(d,false)};var o=function(e){sap.ca.ui.message.showMessageBox({type:sap.ca.ui.message.Type.ERROR,message:e.message,details:e.response.body})};t.oDataModel.read("Time_Pending",null,null,false,a,jQuery.proxy(o,this));return-1},oGroupOptions:{aGroupItems:[{text:"{i18n>TSA_PEOPLE}",key:"PEOPLE"},{text:"{i18n>TSA_COST_ASSGNT}",key:"Cost Assignment"}],onGroupSelected:function(k){if(k=="PEOPLE"){t.readEmployeeListData(true)}else{t.readCostAssisgnmentListData(true)}}},}},readEmployeeListData:function(i){sap.ca.ui.utils.busydialog.requireBusyDialog();var o=function(d,r){hcm.mgr.approve.timesheet.utility.Parser.setCachedData(d);this.displayEmployeeList(d,i);sap.ca.ui.utils.busydialog.releaseBusyDialog()};var a=function(e){sap.ca.ui.message.showMessageBox({type:sap.ca.ui.message.Type.ERROR,message:e.message,details:e.response.body})};this.oDataModel.read("Time_Pending",null,null,true,jQuery.proxy(o,this),jQuery.proxy(a,this))},displayEmployeeList:function(d,i){var l=this.getList();l.destroyItems();var m=d.results;var E=hcm.mgr.approve.timesheet.utility.Parser.EmployeeData(m);var a=E.length;this.oApplicationFacade.oApplicationImplementation.oMHFHelper.setMasterTitle(this,a);if(a>0){var t=new Object();t.Employee=E;t.PeopleVisible=true;t.CostVisible=false;var b=new sap.ui.model.json.JSONModel();b.setData(t);l.setModel(b);l.bindAggregation("items",{path:"/Employee",template:new sap.m.ObjectListItem({type:"Active",title:"{EmpName}",number:"{Completion}",numberUnit:"{i18n>TSA_COMPLETED}",numberState:"{NumberState}",attributes:[new sap.m.ObjectAttribute({text:"{Posname}"}),new sap.m.ObjectAttribute({text:"{No_Week}"})],press:jQuery.proxy(this._handleItemPress,this)})});var l=this.getList();this.registerMasterListBind(l);if(i)this.selectInitialEmployeeItem();else this.selectIndexedValue()}else{this.noDataRouting()}if(this.extHookDisplayEmployeeList){this.extHookDisplayEmployeeList()}},selectIndexedValue:function(){if(!jQuery.device.is.phone){var i=this.retrieveIndexedItem(this.index);if(i){this.setListItem(i)}else{this.conditionalSelection()}}},retrieveIndexedItem:function(i){var l=this.getView().byId("list");var I=l.getItems()[i];return I},conditionalSelection:function(){var l=this.getView().byId("list");var a=l.getItems().length;if(a==1){var i=this.retrieveIndexedItem(0);this.setListItem(i)}else if(a>1){var i=this.retrieveIndexedItem(this.index-1);this.setListItem(i)}else{this.noDataRouting()}},noDataRouting:function(){var l=this.getList();l.removeAllItems();l.setShowNoData(true);l.setNoDataText(this.oBundle.getText("NO_ITEMS_AVAILABLE"));this.oApplicationFacade.oApplicationImplementation.oMHFHelper.setMasterTitle(this,0);if(!sap.ui.Device.system.phone){this.navToEmptyView()}},selectInitialEmployeeItem:function(){if(!jQuery.device.is.phone){var l=this.getList();var f=l.getItems()[0];if(f!==undefined)this.setListItem(f)}},selectInitialCostItem:function(){if(!jQuery.device.is.phone){var l=this.getList();var f=l.getItems()[0];if(f!==undefined)this.setListItem(f)}},readCostAssisgnmentListData:function(i){sap.ca.ui.utils.busydialog.requireBusyDialog();var o=function(d,r){hcm.mgr.approve.timesheet.utility.Parser.setCachedData(d);this.displayCostAssignmentList(d,i);sap.ca.ui.utils.busydialog.releaseBusyDialog()};var a=function(e){sap.ca.ui.message.showMessageBox({type:sap.ca.ui.message.Type.ERROR,message:e.message,details:e.response.body})};this.oDataModel.read("Time_Pending",null,null,true,jQuery.proxy(o,this),jQuery.proxy(a,this))},displayCostAssignmentList:function(d,i){var l=this.getList();l.destroyItems();var m=d.results;var C=hcm.mgr.approve.timesheet.utility.Parser.CostAssignmentData(m);if(C.length>0){var t=new Object();t.CA=C;t.CostVisible=true;t.PeopleVisible=false;var a=new sap.ui.model.json.JSONModel();a.setData(t);l.setModel(a);this.oApplicationFacade.oApplicationImplementation.oMHFHelper.setMasterTitle(this,C.length);l.bindAggregation("items",{path:"/CA",template:new sap.m.ObjectListItem({type:"Active",title:"{Cotype}:{Codesc}",number:"{No_People}",numberUnit:"{i18n>TSA_PEOPLE}",press:jQuery.proxy(this._handleItemPress,this)})});var l=this.getList();this.registerMasterListBind(l);if(i)this.selectInitialCostItem();else this.selectIndexedValue()}else{this.noDataRouting()}if(this.extHookDisplayCostAssignmentList){this.extHookDisplayCostAssignmentList()}},_submit:function(e){var o=this.getView().byId("list");var s=o.getSwipedItem();var a="cats='";var d=s.getBindingContext().getModel();var p=s.getBindingContext().getPath();o.swipeOut();var b=d.getProperty(p);var c=p.split("/")[1];var h;var P;if(c=="Employee")h=b.Weeks;else h=b.Peoples;for(var g=0;g<h.length;g++){if(c=="Employee")P=b.Pernr;else P=h[g].Pernr;var f=h[g].Days;for(var j=0;j<f.length;j++){a+=P+","+f[j].Counter+","+f[j].Status+","+f[j].RejectionReason+"/"}a+="'";var i="Cats_Action?"+a;var k=function(D,r){sap.ca.ui.message.showMessageToast(this.oBundle.getText("CATS_SUCCESS_MESSAGE"));if(c=="Employee")this.readEmployeeListData(false);else if(c=="CA")this.readCostAssisgnmentListData(false)};var l=function(E){sap.ca.ui.message.showMessageBox({type:sap.ca.ui.message.Type.ERROR,message:E.message,details:E.response.body})};this.oDataModel.create(i,null,null,jQuery.proxy(k,this),jQuery.proxy(l,this))}}});
