/*
 * Copyright (C) 2009-2014 SAP SE or an SAP affiliate company. All rights reserved
 */
jQuery.sap.require("sap.ca.ui.dialog.factory");jQuery.sap.require("sap.ca.scfld.md.controller.BaseDetailController");jQuery.sap.require("hcm.mgr.approve.timesheet.utility.Parser");jQuery.sap.require("sap.ca.ui.message.message");sap.ca.scfld.md.controller.BaseDetailController.extend("hcm.mgr.approve.timesheet.view.S3",{extHookShowWeekData:null,extHookShowPeopleData:null,onInit:function(){sap.ca.scfld.md.controller.BaseDetailController.prototype.onInit.call(this);this.oBundle=this.oApplicationFacade.getResourceBundle();this.oDataModel=this.oApplicationFacade.getODataModel();this.self=this;this.selection="";this.busyDialog=new sap.m.BusyDialog({customIcon:sap.ca.ui.images.images.Flower});hcm.mgr.approve.timesheet.utility.Parser.setControllerInstance(this);this.oRouter.attachRouteMatched(function(e){if(e.getParameter("name")==="detail"){this.busyDialog.open();var a=decodeURIComponent(e.getParameter("arguments").contextPath);this.selection=a.split("/")[1];var v=a.split("/")[2];var b=hcm.mgr.approve.timesheet.utility.Parser.getCachedData();var o=function(D,r){var t=hcm.mgr.approve.timesheet.utility.Parser.getControllerInstance();var f=D.results;var g=new Object();var E="";var C="";t.model=new sap.ui.model.json.JSONModel();if(t.selection==="Employee"){E=hcm.mgr.approve.timesheet.utility.Parser.EmployeeData(f);t.busyDialog.close();g.Employee=E;g.Employee[v].CostVisible=false;g.Employee[v].PeopleVisible=true;t.model.setData(g.Employee[v]);t.getView().byId("operations").setVisible(true);t.getView().byId("cost").setVisible(false)}else{C=hcm.mgr.approve.timesheet.utility.Parser.CostAssignmentData(f);t.busyDialog.close();g.CA=C;g.CA[v].CostVisible=true;g.CA[v].PeopleVisible=false;t.model.setData(g.CA[v]);t.getView().byId("cost").setVisible(true);t.getView().byId("operations").setVisible(false)}t.getView().setModel(t.model,"DetailModel")};var d=function(E){this.processError(E)};if(b){o(b,this)}else{this.oDataModel.read("Time_Pending",null,null,true,jQuery.proxy(o,this),jQuery.proxy(d,this))}}},this);this.oNotesList=new sap.m.List({inset:true});var n=new sap.m.VBox({items:[this.oNotesList]});var c=function(t){this.oPopoverNotes.close()};this.oPopoverNotes=new sap.m.ResponsivePopover({placement:sap.m.PlacementType.Bottom,title:this.oBundle.getText("TSA_DETAILS"),showHeader:true,content:[n],beginButton:new sap.m.Button({text:this.oBundle.getText("TSA_ACCEPT"),press:jQuery.proxy(c,this)})});this.fetchRejectionReasons()},fetchRejectionReasons:function(){var t=this;var o=function(d,r){t._setRejection(d,r)};var a=function(e){this.processError(e)};this.oDataModel.read("Rej_Reason",null,null,true,jQuery.proxy(o,this),jQuery.proxy(a,this))},_setRejection:function(d){var t=this;var h=this.self;this.oReasons=d;var o=new sap.ui.model.json.JSONModel(this.oReasons);var T=this.oBundle.getText("TSA_TIT_REJECTION_REASON");this.oDialog=new sap.m.SelectDialog({title:T});var i=new sap.m.StandardListItem({title:"{Text}",type:"Active",});this.oDialog.attachConfirm(function(e){var s=e.getParameter("id");if(s){var l=e.getParameters().selectedContexts[0].sPath;var a=l.split("/");var b=a[2];t._onTap(b,e)}});this.oDialog.attachCancel(function(e){var p="";var d="";var m="";if(this.selection==="Employee"){m="WeekModel"}else{m="PeopleModel"}p=h.getView().getModel(m).oData.selectedPath;d=h.getView().getModel(m).oData.Days[p];d.Status="A";t.switched.setState(true);d.RejectionReason="";d.RejectionReasonText="";h.getView().getModel(m).getData().Days[p]=d},this);this.oDialog.attachSearch(function(e){var v=e.getParameter("value");var f=new sap.ui.model.Filter("Text",sap.ui.model.FilterOperator.Contains,v);var b=e.getSource().getBinding("items");b.filter([f])});this.oDialog.setModel(o);this.oDialog.bindAggregation("items","/results",i)},_onTap:function(l,e){var m="";if(this.selection=="Employee"){m="WeekModel"}else{m="PeopleModel"}var p=this.getView().getModel(m).oData.selectedPath;var d=this.getView().getModel(m).oData.Days[p];var a=this.oDialog.getModel().oData.results[l];d.RejectionReason=a.Reason;d.RejectionReasonText=a.Text;this.getView().getModel(m).oData.Days[p]=d},showWeekData:function(e){var t=e.oSource.mProperties.text;var s=e.oSource.oPropagatedProperties.oBindingContexts.DetailModel.sPath;var h=this.getView().oModels.DetailModel.oData.Weeks;var i=s.substring("7");var a=h[i];if(t===this.oBundle.getText("TSA_HIDE")){a.DayVisible=false;a.DayVisibleText=this.oBundle.getText("TSA_SHOW")}else if(t===this.oBundle.getText("TSA_SHOW")){a.DayVisible=true;a.DayVisibleText=this.oBundle.getText("TSA_HIDE")}var w=new sap.ui.model.json.JSONModel();var d=this.getView().getModel("DetailModel").getData();d.selectedWeek=a;w.setData(d);e.oSource.oParent.setModel(w,"DetailModel");var b=new sap.ui.model.json.JSONModel();b.setData(a);this.getView().setModel(b,"WeekModel");e.oSource.oParent.setModel(b,"WeekModel");if(this.extHookShowWeekData){this.extHookShowWeekData()}},showPeopleData:function(e){var t=e.oSource.mProperties.text;var s=e.oSource.oPropagatedProperties.oBindingContexts.DetailModel.sPath;var h=this.getView().oModels.DetailModel.oData.Peoples;var i=s.substring("9");var a=h[i];if(t===this.oBundle.getText("TSA_HIDE")){a.DayVisible=false;a.DayVisibleText=this.oBundle.getText("TSA_SHOW")}else if(t===this.oBundle.getText("TSA_SHOW")){a.DayVisible=true;a.DayVisibleText=this.oBundle.getText("TSA_HIDE")}var w=new sap.ui.model.json.JSONModel();var d=this.getView().getModel("DetailModel").getData();d.selectedWeek=a;w.setData(d);e.oSource.oParent.setModel(w,"DetailModel");var b=new sap.ui.model.json.JSONModel();b.setData(a);this.getView().setModel(b,"PeopleModel");e.oSource.oParent.setModel(b,"PeopleModel");if(this.extHookShowPeopleData){this.extHookShowPeopleData()}},displayNotesEmployee:function(e){var n=[];var i=new sap.m.StandardListItem({title:"{title}",description:"{description}"});var d=this.getView().getModel("DetailModel").getData();var p=e.oSource.oPropagatedProperties.oBindingContexts.WeekModel.sPath;var a=p.split("/")[2];var w=e.oSource.oPropagatedProperties.oBindingContexts.DetailModel.sPath.split("/")[2];var s=d.Weeks[w].Days[a];n.push({"title":this.oBundle.getText("TSA_COST_ASSGNT"),"description":s.Cotype+"-"+s.Codesc});if(s.CatsText!==""){n.push({"title":this.oBundle.getText("TSA_NOTE"),"description":s.CatsText})}if(s.RejectionReasonText!==""){n.push({"title":this.oBundle.getText("TSA_REJECTION_REASON"),"description":s.RejectionReasonText})}if(s.Lgart!==""){n.push({"title":this.oBundle.getText("TSA_WAGE_TYPE"),"description":s.Lgart})}if(s.Lstar!==""){n.push({"title":this.oBundle.getText("TSA_ACTIVITY_TYPE"),"description":s.Lstar})}var b=new sap.ui.model.json.JSONModel();d.EmployeeNotes=n;b.setData(d);this.oNotesList.bindAggregation("items","/EmployeeNotes",i);this.oNotesList.setModel(b);this.oPopoverNotes.setPlacement(sap.m.PlacementType.Left);this.oPopoverNotes.openBy(sap.ui.getCore().byId(e.mParameters.id))},displayNotesCost:function(e){var n=[];var i=new sap.m.StandardListItem({title:"{title}",description:"{description}"});var d=this.getView().getModel("DetailModel").getData();var p=e.oSource.oPropagatedProperties.oBindingContexts.PeopleModel.sPath;var a=p.split("/")[2];var w=e.oSource.oPropagatedProperties.oBindingContexts.DetailModel.sPath.split("/")[2];var s=d.Peoples[w].Days[a];n.push({"title":this.oBundle.getText("TSA_COST_ASSGNT"),"description":d.Cotype+"-"+d.Codesc});if(s.CatsText!==""){n.push({"title":this.oBundle.getText("TSA_NOTE"),"description":s.CatsText})}if(s.RejectionReasonText!==""){n.push({"title":this.oBundle.getText("TSA_REJECTION_REASON"),"description":s.RejectionReasonText})}if(s.Lgart!==""){n.push({"title":this.oBundle.getText("TSA_WAGE_TYPE"),"description":s.Lgart})}if(s.Lstar!==""){n.push({"title":this.oBundle.getText("TSA_ACTIVITY_TYPE"),"description":s.Lstar})}var b=new sap.ui.model.json.JSONModel();d.CostNotes=n;b.setData(d);this.oNotesList.bindAggregation("items","/CostNotes",i);this.oNotesList.setModel(b);this.oPopoverNotes.setPlacement(sap.m.PlacementType.Left);this.oPopoverNotes.openBy(sap.ui.getCore().byId(e.mParameters.id))},updateStatus:function(e){var s=e.oSource.oPropagatedProperties.oBindingContexts.DetailModel.sPath;var h=this.getView().oModels.DetailModel.oData.Weeks;var i=s.substring("7");var a=h[i];var d=this.getView().getModel("DetailModel").getData();d.selectedWeek=a;var w=new sap.ui.model.json.JSONModel();w.setData(a);this.getView().setModel(w,"WeekModel");var p=e.oSource.oPropagatedProperties.oBindingContexts.WeekModel.sPath.split("/")[2];var b=e.oSource.oPropagatedProperties.oBindingContexts.WeekModel.oModel.oData.Days[p];var c=b.Status;this.switched=e.oSource;var n=(c==="A")?"R":"A";this.status=c;b.Status=n;var m=this.getView().getModel("WeekModel").oData;m.selectedPath=p;this.getView().getModel("WeekModel").oData=m;if(n==="A"){b.RejectionReason="";b.RejectionReasonText="";e.oSource.oPropagatedProperties.oBindingContexts.WeekModel.oModel.oData.Days[p]=b}else{this.oDialog.open()}},updateStatus_CA:function(e){var s=e.oSource.oPropagatedProperties.oBindingContexts.DetailModel.sPath;var h=this.getView().oModels.DetailModel.oData.Peoples;var i=s.substring("9");var a=h[i];var d=this.getView().getModel("DetailModel").getData();d.selectedWeek=a;var w=new sap.ui.model.json.JSONModel();w.setData(a);this.getView().setModel(w,"PeopleModel");var p=e.oSource.oPropagatedProperties.oBindingContexts.PeopleModel.sPath.split("/")[2];var b=e.oSource.oPropagatedProperties.oBindingContexts.PeopleModel.oModel.oData.Days[p];var c=b.Status;this.switched=e.oSource;var n=(c==="A")?"R":"A";this.status=c;b.Status=n;var m=this.getView().getModel("PeopleModel").oData;m.selectedPath=p;this.getView().getModel("PeopleModel").oData=m;if(n==="A"){b.RejectionReason="";b.RejectionReasonText="";e.oSource.oPropagatedProperties.oBindingContexts.WeekModel.oModel.oData.Days[p]=b}else{this.oDialog.open()}},getHeaderFooterOptions:function(){var t=this;return{sI18NDetailTitle:"TSA_APP",oEditBtn:{sI18nBtnTxt:"TSA_SUBMIT",onBtnPressed:function(e){t.openDialog(e)}},oAddBookmarkSettings:{title:t.oBundle.getText("TSA_APP"),icon:"sap-icon://entry-request"},onBack:jQuery.proxy(function(){var d=sap.ui.core.routing.History.getInstance().getDirection(this.oRouter.getURL("master"));if(d==="Backwards"){window.history.go(-1)}else{this.oRouter.navTo("master")}},this)}},openDialog:function(e){var t=this.self;var a=this.oBundle.getText("TSA_CONF");var s=this.selection;var c=function(r){if(r){if(r.isConfirmed==true){if(s==="Employee")t.peopleSubmit();else t.costSubmit()}}};sap.ca.ui.dialog.confirmation.open({question:a,title:this.oBundle.getText("TSA_CONF_HEADER"),confirmButtonLabel:this.oBundle.getText("TSA_ACCEPT")},jQuery.proxy(c,this))},peopleSubmit:function(){var s="cats='";var a=this.getView().getModel("DetailModel").oData;for(var i=0;i<a.Weeks.length;i++){var r=a.Weeks[i].Days;for(var j=0;j<r.length;j++){s+=a.Pernr+","+r[j].Counter+","+r[j].Status+","+r[j].RejectionReason+"/"}}s+="'";var c="Cats_Action?"+s;var o=function(d,R){hcm.mgr.approve.timesheet.utility.Parser.setCachedData(d);sap.ca.ui.message.showMessageToast(this.oBundle.getText("CATS_SUCCESS_MESSAGE"));this.self.oRouter.navTo("master")};var b=function(e){this.processError(e)};this.oDataModel.create(c,null,null,jQuery.proxy(o,this),jQuery.proxy(b,this))},costSubmit:function(){var s="cats='";var a=this.getView().getModel("DetailModel").oData;for(var i=0;i<a.Peoples.length;i++){var r=a.Peoples[i].Days;for(var j=0;j<r.length;j++){s+=a.Peoples[i].Pernr+","+r[j].Counter+","+r[j].Status+","+r[j].RejectionReason+"/"}}s+="'";var c="Cats_Action?"+s;var o=function(d,R){hcm.mgr.approve.timesheet.utility.Parser.setCachedData(null);sap.ca.ui.message.showMessageToast(this.oBundle.getText("CATS_SUCCESS_MESSAGE"));this.self.oRouter.navTo("master")};var b=function(e){this.processError(e)};this.oDataModel.create(c,null,null,jQuery.proxy(o,this),jQuery.proxy(b,this))},isMainScreen:function(){return true},processError:function(e){var a=jQuery.parseJSON(e.valueOf().response.body);var b=a.error.message.value;var m="";var c=a.error.innererror;var l=c.errordetails.length;for(var i=0;i<l;i++){m=m+c.errordetails[i].message+"\n"}sap.ca.ui.message.showMessageBox({type:sap.ca.ui.message.Type.ERROR,message:b,details:m})},});
