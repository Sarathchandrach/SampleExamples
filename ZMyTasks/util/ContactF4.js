/*
 * Copyright (C) 2009-2014 SAP SE or an SAP affiliate company. All rights reserved
 */
jQuery.sap.declare("cus.crm.mytasks.util.ContactF4");jQuery.sap.require("cus.crm.mytasks.util.Formatter");jQuery.sap.require("cus.crm.mytasks.util.Util");cus.crm.mytasks.util.ContactF4={create:function(c){var C=cus.crm.mytasks.util,o=C.Util,a=C.Formatter,b=a.getResourceBundle(),t=b.getText("DETAILS_VALUE_HELP_CON_TITLE"),n=b.getText("SEARCH_LIST_NODATA_GENERIC"),d=this.getValueHelp();jQuery.sap.log.debug("Contact F4 help title: "+t);var s=jQuery.proxy(this._searchOnContacts,this,this.getFilterString()),l=jQuery.proxy(this._liveSearchOnContacts,this,this.getFilterString()),f=jQuery.proxy(this._confirmContact,this,c);d.setTitle(t);d.setNoDataText(n);d.setModel(o.getSearchModel());d.attachSearch(s);d.attachLiveChange(l);d.attachConfirm(f);d._list.setInfoToolbar(this.getDialogInfoToolBar())},getId:function(){if(!this._contactID)this._contactID="";return this._contactID},setId:function(v){this._contactID=v;return this},getName:function(){if(!this._contactName)this._contactName="";return this._contactName},setName:function(v){this._contactName=v;return this},_getLIItem:function(){var l=new sap.m.StandardListItem({title:"{"+this.getFilterString()+"}",description:"{parts:['company', 'function'], formatter: 'cus.crm.mytasks.util.Formatter.getContactF4Description'}",active:true});return l},getListItemTemplate:function(){if(!this._oListItem)this._oListItem=this._getLIItem();return this._oListItem},getFilterString:function(){if(!this._sFilterString)this._sFilterString="fullName";return this._sFilterString},getValueHelp:function(){if(!this._oDialog)this._oDialog=new sap.m.SelectDialog();return this._oDialog},getDialogInfoToolBar:function(){if(!this._oInfoTB)this._oInfoTB=new sap.m.Toolbar({active:true,content:[new sap.m.Label({text:""}),new sap.m.ToolbarSpacer(),new sap.ui.core.Icon({src:"sap-icon://decline"})],press:jQuery.proxy(this._pressInfoToolbar,this)});return this._oInfoTB},__setFilterText:function(e){var d=this.getValueHelp(),D=d._list.getInfoToolbar();if(d.data("accountid")){var f=cus.crm.mytasks.util.Formatter.getResourceBundle().getText("DETAILS_VALUE_HELP_FILTERED_BY")+" "+d.data("accounttext");D.getContent()[0].setText(f);D.setVisible(true)}else{D.setVisible(false)}},_onRequestCompleted:function(p,e){var t=jQuery.proxy(this.__setFilterText,this);setTimeout(t,5)},triggerSearch:function(p){cus.crm.mytasks.util.Util.logObjectToConsole("Contact F4 Help sValue: ",p);var f=[],d=this.getValueHelp(),i=d.getBinding('items');if(p.accountid&&p.accountid!==""){d.data('accountid',p.accountid).data('accounttext',p.accounttext);f.push(new sap.ui.model.Filter("accountID",sap.ui.model.FilterOperator.EQ,p.accountid))}else d.data('accountid',null).data('accounttext',null);if(p.contactid&&p.contactid!=="")d.data('contactid',p.contactid);else d.data('contactid',null);if(p.searchvalue&&p.searchvalue!=="")f.push(new sap.ui.model.Filter(this.getFilterString(),sap.ui.model.FilterOperator.Contains,p.searchvalue));var r=jQuery.proxy(this._onRequestCompleted,this,p);if(!d.bRequestHandlerAttached){d.getModel().attachRequestCompleted(null,r);d.bRequestHandlerAttached=true}if(!i){jQuery.sap.log.debug("accountid filled for contact F4 help");var P="/ContactCollection",l={path:P,template:this.getListItemTemplate(),filters:f};jQuery.sap.log.debug("Contact F4 Binding Path: "+P);d.bindAggregation("items",l)}else{i.aApplicationFilters=[];i.filter(f,sap.ui.model.FilterType.Application)}},_searchOnContacts:function(a,e){jQuery.sap.log.debug("in do search");var f=[],v=e.getParameter("value"),d=this.getValueHelp(),A=d&&d.data?d.data("accountid"):null;this.__commonSearch(f,e.getParameter("itemsBinding"),A,a,v)},_liveSearchOnContacts:function(a,e){jQuery.sap.log.debug("in do search");var f=[],v=e.getParameter("value"),d=this.getValueHelp(),A=d&&d.data?d.data("accountid"):null;if(v.length==0||(v&&v.length>3))this.__commonSearch(f,e.getParameter("itemsBinding"),A,a,v)},__commonSearch:function(f,i,a,A,v){if(a)f.push(new sap.ui.model.Filter("accountID",sap.ui.model.FilterOperator.EQ,a));if(v&&v!=="")f.push(new sap.ui.model.Filter(A,sap.ui.model.FilterOperator.Contains,v));if(!i){var p="/ContactCollection",l={path:p,template:this.getListItemTemplate(),filters:f};jQuery.sap.log.debug("Contact F4 Binding Path: "+p);this.getValueHelp().bindAggregation("items",l)}else{i.aApplicationFilters=[];i.filter(f,sap.ui.model.FilterType.Application)}},_pressInfoToolbar:function(e){var d=this.getValueHelp(),i=d.getBinding("items"),f=[],s=d._oDialog.getSubHeader().getContentMiddle()[0].getValue();d._list.getInfoToolbar().setVisible(false);d.data('accountid',null).data('accounttext',null);if(s&&s!=="")f.push(new sap.ui.model.Filter(this.getFilterString(),sap.ui.model.FilterOperator.Contains,s));if(!i){var p="/ContactCollection",l={path:p,template:this.getListItemTemplate(),filters:f};jQuery.sap.log.debug("Contact F4 Binding Path: "+p);d.bindAggregation("items",l)}else{i.aApplicationFilters=[];i.filter(f,sap.ui.model.FilterType.Application)}},_confirmContact:function(c,e){var v=c.getView(),s=e.getParameter("selectedItem"),C=cus.crm.mytasks.util;if(s){var o=s.getBindingContext().getObject();C.Util.logObjectToConsole("Contact Data: ",o);this.setId(o.contactID).setName(o[this.getFilterString()]);if(this.getName()==="")this.setName(o.contactID);v.byId("contactInput").setValue(this.getName());jQuery.sap.log.debug("ContactId = "+this.getId());jQuery.sap.log.debug("ContactName = "+this.getName());this._setAccountIfNotSetAlready(c,o)}},_setAccountIfNotSetAlready:function(c,C){if(c instanceof sap.ca.scfld.md.controller.BaseFullscreenController){var o=cus.crm.mytasks.util.AccountF4,a=c.getView().byId("accountInput");if(a.getValue()===""){o.setId(C.accountID).setName(C.company);if(o.getName()==="")o.setName(C.accountID);a.setValue(o.getName());jQuery.sap.log.debug("AccountId = "+o.getId());jQuery.sap.log.debug("AccountName = "+o.getName())}}},};
