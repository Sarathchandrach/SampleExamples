/*
 * Copyright (C) 2009-2014 SAP SE or an SAP affiliate company. All rights reserved
 */
jQuery.sap.declare("cus.crm.mytasks.util.Attachments");jQuery.sap.require("cus.crm.mytasks.util.Formatter");jQuery.sap.require("cus.crm.mytasks.util.Schema");cus.crm.mytasks.util.Attachments={NAVLINK:"Attachments",OverviewPage:{showOrHidePanel:function(v){var f=v.byId("attachmentOverview"),F=v.byId("attachmentData"),c=cus.crm.mytasks.util.Schema;if(c.getServiceVersion()==1&&c.getServiceSchemaVersion()>=4){F.setVisible(true);if(sap.ui.version<"1.22"){f.preventEdits(true);f.setEditMode(false);f.setShowAttachmentsLabelInEditMode(false)}else{f.preventEdits(true);f.setDeleteEnabled(false);f.setShowAttachmentsLabel(false)}}else F.setVisible(false)},bindData:function(c,p){var t={},v=c.getView(),m=v.getModel(),C=cus.crm.mytasks.util;var f=v.byId("attachmentOverview"),r=C.Formatter.getResourceBundle(),a=v.byId("attachmentData"),o=C.Attachments;if(p.bExpandCall){t.paths=c.oOverviewTask[o.NAVLINK]["__list"]||[];t.controlval=[];for(var i=-1,P;P=t.paths[++i];)t.controlval.push(o.buildFileDescriptorForObject(m.getObject('/'+P)))}else{t=o._addDataToODataModel(m,p.curResults)}o._aPaths=t.paths;f.setModel(new sap.ui.model.json.JSONModel({Attachments:t.controlval}));a.setHeaderText(r.getText("S4_TASK_ATTACHMENTS",[t.paths.length]))}},EditPage:{showOrHidePanel:function(v){var f=v.byId("attachmentEdit"),c=cus.crm.mytasks.util,F=v.byId("attachmentEditData"),C=c.Attachments,m=v.getModel(),o=c.Schema,p=v.getBindingContext().getPath();if(o.getServiceVersion()==1&&o.getServiceSchemaVersion()>=4){if(p==="/new")F.setVisible(false);else{F.setVisible(true);if(sap.ui.version<"1.22"){f.setEditMode(true);f.setShowAttachmentsLabelInEditMode(false)}else{f.setDeleteEnabled(true);f.setShowAttachmentsLabel(false)}f.setUploadUrl([m.sServiceUrl,p.substr(1),C.NAVLINK].join("/"));if(f.getUploadEnabled()){f.setXsrfToken(C.getXSRFToken(m));f.setEncodeUrl("/sap/bc/ui2/encode_file"+(m.aUrlParams&&m.aUrlParams.length>0?"?"+m.aUrlParams.join("&"):""))}}}else F.setVisible(false)},bindData:function(c,p){var C=cus.crm.mytasks.util,v=c.getView(),m=v.getModel(),f=v.byId("attachmentEdit"),r=C.Formatter.getResourceBundle(),a=v.byId("attachmentEditData"),t={Attachments:[]},o=C.Attachments;for(var i=-1,P;P=o._aPaths[++i];)t.Attachments.push(o.buildFileDescriptorForObject(m.getObject('/'+P)));f.setModel(new sap.ui.model.json.JSONModel(t));if(t.Attachments.length==0){a.setHeaderText(r.getText("S4_TASK_ATTACHMENTS","0"))}else a.setHeaderText(r.getText("S4_TASK_ATTACHMENTS",t.Attachments.length));f.setCustomHeader("slug",c.oSavedTask.Guid.replace(/-/g,''))},uploadFileToTask:function(c,C){if(c instanceof sap.ca.scfld.md.controller.BaseFullscreenController){var o=cus.crm.mytasks.util,v=c.getView(),f=v.byId("attachmentEdit"),a=o.Attachments,A=v.byId("attachmentEditData");f.commitFileUpload(a.buildFileDescriptorForObject(C,"POST"));var b=f.getModel().getProperty('/'+a.NAVLINK);A.setHeaderText(o.Formatter.getResourceBundle().getText("S4_TASK_ATTACHMENTS",[b.length]))}},renameFileOfTask:function(c,p){if(c instanceof sap.ca.scfld.md.controller.BaseFullscreenController){var m=c.getView().getModel();if(p){m.setHeaders(p.headers);var s=function(d,r){this.getView().byId("attachmentEdit").commitPendingRenames();var R=cus.crm.mytasks.util.Formatter.getResourceBundle();sap.m.MessageToast.show(R.getText("S3_RENAME_ATTACHMENT_SUCCESS"))},e=function(E){this.getView().byId("attachmentEdit").abandonPendingRenames();var C=cus.crm.mytasks.util,o={msg:C.Formatter.getResourceBundle().getText("S3_RENAME_ATTACHMENT_FAILED")};C.Util.onRequestFailed(E,"Renaming of a file attachment FAILED!",o)};m.update(p.path,p.entry,null,jQuery.proxy(s,c),jQuery.proxy(e,c),false)}}},deleteFileFromTask:function(c,C){if(c instanceof sap.ca.scfld.md.controller.BaseFullscreenController){var m=c.getView().getModel(),u=C.mediaURL;if(!u)u=C.url;var d=u.split("/"),p=[d[d.length-2],d[d.length-1]].join("/"),s=function(P,D,r){if(P){var o=cus.crm.mytasks.util,v=P.controller.getView(),R=o.Formatter.getResourceBundle(),f=v.byId("attachmentEdit");f.removeFile(P.curAttachment.fileId);var a=f.getModel().getProperty('/'+o.Attachments.NAVLINK);v.byId("attachmentEditData").setHeaderText(R.getText("S4_TASK_ATTACHMENTS",[a.length]))}},e=function(E){cus.crm.mytasks.util.Util.onRequestFailed(E,"DELETE Attachment FAILED!")};m.remove(p,null,jQuery.proxy(s,this,{controller:c,curAttachment:C}),e)}},},_aPaths:[],buildFileDescriptorForObject:function(c,m){var C=cus.crm.mytasks.util.Formatter;var o={name:c.Name,url:c.Url?c.Url:C.formatAttachmentURL(c.__metadata.media_src),uploadedDate:c.CreatedAt,contributor:c.CreatedBy,mimeType:c.MimeType,fileId:c.Documentid,fileExtension:C.formatMimeType(c.MimeType),mediaURL:C.formatAttachmentURL(c.__metadata.media_src),docClass:c.Documentclass,taskGuid:c.HeaderGuid},d=o.name.split(".");if(d.length>1){var D=d.pop();o.fileExtension=/[a-z]/.test(D)?D.toLowerCase():D.toUpperCase()}o.name=[d.join("."),o.fileExtension].join(".");if(m==="POST"){o.uploadedDate=new Date(parseInt(o.uploadedDate.substr(6)));o.name=decodeURIComponent(o.name)}return o},_addDataToODataModel:function(m,a){var d=undefined,p=undefined;var A=[],r=[];for(var i=-1,c;c=a[++i];){d=c.__metadata.id.split("/");p=d[d.length-1];A.push(p);r.push(cus.crm.mytasks.util.Attachments.buildFileDescriptorForObject(c));m.oData[p]=c}return{paths:A,controlval:r}},getXSRFToken:function(m){var c=cus.crm.mytasks.util,C="";if(!m)m=c.Schema.getModel()||c.Util.getMainModel();if(m.getSecurityToken)C=m.getSecurityToken();else{m.refreshSecurityToken();C=m.oServiceData.securityToken}return C},};
