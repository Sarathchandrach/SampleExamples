/*
 * Copyright (C) 2009-2014 SAP SE or an SAP affiliate company. All rights reserved
 */
jQuery.sap.declare("cus.crm.mytasks.util.Util");jQuery.sap.require("cus.crm.mytasks.util.AppConfig");jQuery.sap.require("cus.crm.mytasks.util.Formatter");jQuery.sap.require("cus.crm.mytasks.util.TechnicalInfoUtil");jQuery.sap.require("cus.crm.mytasks.util.PriorityListUtil");jQuery.sap.require("cus.crm.mytasks.util.StatusListUtil");cus.crm.mytasks.util.Util={MAIN_MODEL_NAME:"cus.crm.mytasks",CUST_MODEL_NAME:"cus.crm.mytasks.customizing",isBusyDialog:false,busyDialogReleaseID:undefined,busyDialogOpenID:undefined,busyDialog:new sap.m.BusyDialog({customIcon:sap.ca.ui.images.images.Flower}),dummyString:"Operation successfull: Executing F4-Help(Account/Contact/Employee) oData service.",logObjectToConsole:function(m,o,s){var c=cus.crm.mytasks.util.AppConfig.getConfiguration(),n="console",d=window[n],i=c.isDebug;var l;if(i&&d){l=d;if("info"==s)l.info(m,o);else if("warning"==s)l.warn(m,o);else if("error"==s)l.error(m,o);else l.log(m,o)}else{l=jQuery.sap.log;try{var a=m+JSON.stringify(o);if("info"==s)l.info(a);else if("warning"==s)l.warning(a);else if("error"==s)l.error(a);else l.debug(a)}catch(e){var S="Error while writing object to log, run app with param 'debugmode=true' for console logging";l.debug(S,e)}}},createEmptyTaskObject:function(c,p){var C=cus.crm.mytasks.util,o=C.PriorityListUtil,d=o.getDefaultPrio(),a=C.Formatter;var t={"Id":"","Description":p.desc?p.desc:"","Priority":p.priority?p.priority:d,"Private":false,"Completed":false,"ContactId":p.contactID?p.contactID:"","ContactName":p.contactName?p.contactName:"","AccountId":p.accountID?p.accountID:"","AccountName":p.accountName?p.accountName:"","Note":p.note?p.note:"","DueDate":a.getCurrentDate(),"ResponsibleId":"","ResponsibleName":"",};if(c.getServiceVersion()==1&&c.getServiceSchemaVersion()>=2){if(p.procType&&p.procType!=="noProcType")t.TransactionType=p.procType;if(c.getServiceSchemaVersion()>=3){if(p.predecessorGUID)t.PredecessorGUID=p.predecessorGUID;if(p.ProcessTypeDescription)t.ProcessTypeDescription=p.ProcessTypeDescription;t.UserStatusCode=C.StatusListUtil.getInitialStatus().statID}else if(p.predecessorID)t.PredecessorID=p.predecessorID}a.eraseTime(t.DueDate);this.setDefaultValues(t);this.logObjectToConsole("New Task: ",t);return t},setDefaultValues:function(t){},assureDescription:function(t){var d=(""===t.Description),r=cus.crm.mytasks.util.Formatter.getResourceBundle();if(d)t.Description=r.getText("NEW_TASK_TITLE")},getMainModel:function(){var m=sap.ui.getCore().getModel(cus.crm.mytasks.util.Util.MAIN_MODEL_NAME);if(m==undefined){m=new sap.ui.model.json.JSONModel();sap.ui.getCore().setModel(m,cus.crm.mytasks.util.Util.MAIN_MODEL_NAME)}return m},setMainModel:function(m){sap.ui.getCore().setModel(m,cus.crm.mytasks.util.Util.MAIN_MODEL_NAME)},getCustomizingModel:function(){var c=sap.ui.getCore(),C=c.getModel(cus.crm.mytasks.util.Util.CUST_MODEL_NAME);if(!C){C=new sap.ui.model.json.JSONModel();c.setModel(C,cus.crm.mytasks.util.Util.CUST_MODEL_NAME)}return C},bindCustomizingModel:function(v){if(!v.getModel(cus.crm.mytasks.util.Util.CUST_MODEL_NAME)){var c=cus.crm.mytasks.util.Util.getCustomizingModel();v.setModel(c,cus.crm.mytasks.util.Util.CUST_MODEL_NAME)}},requestBusyDialog:function(){if(cus.crm.mytasks.util.Util.isBusyDialog||cus.crm.mytasks.util.Util.busyDialogOpenID)jQuery.sap.log.debug("Busy Dialog already opened");else{jQuery.sap.log.debug("Busy Dialog open triggered");cus.crm.mytasks.util.Util.busyDialogOpenID=jQuery.sap.delayedCall(750,this,function(){cus.crm.mytasks.util.Util.openBusyDialogDelayed()})}if(cus.crm.mytasks.util.Util.busyDialogReleaseID){jQuery.sap.clearDelayedCall(cus.crm.mytasks.util.Util.busyDialogReleaseID);cus.crm.mytasks.util.Util.busyDialogReleaseID=undefined;jQuery.sap.log.debug("Release Busy Dialog canceled")}},releaseBusyDialog:function(f){if(cus.crm.mytasks.util.Util.isBusyDialog&&!cus.crm.mytasks.util.Util.busyDialogReleaseID){jQuery.sap.log.debug("Busy Dialog release triggered");cus.crm.mytasks.util.Util.busyDialogReleaseID=jQuery.sap.delayedCall(250,this,function(){cus.crm.mytasks.util.Util.releaseBusyDialogDelayed()})}else jQuery.sap.log.debug("Busy Dialog already released");if(cus.crm.mytasks.util.Util.busyDialogOpenID){jQuery.sap.clearDelayedCall(cus.crm.mytasks.util.Util.busyDialogOpenID);cus.crm.mytasks.util.Util.busyDialogOpenID=undefined;jQuery.sap.log.debug("Open Busy Dialog canceled")}},releaseBusyDialogDelayed:function(){cus.crm.mytasks.util.Util.isBusyDialog=false;cus.crm.mytasks.util.Util.busyDialogReleaseID=undefined;cus.crm.mytasks.util.Util.busyDialog.close();jQuery.sap.log.debug("Busy Dialog released")},openBusyDialogDelayed:function(){cus.crm.mytasks.util.Util.isBusyDialog=true;cus.crm.mytasks.util.Util.busyDialogOpenID=undefined;cus.crm.mytasks.util.Util.busyDialog.open();jQuery.sap.log.debug("Busy Dialog opened")},getSearchModel:function(){if(!this.oSearchModel){var c=cus.crm.mytasks.util,a=c.AppConfig.getConfiguration();if(a.isMock){this.oSearchModel=new sap.ui.model.json.JSONModel();this.oSearchModel.loadData(a.mockModelPath,"",true)}else{this.oSearchModel=c.Schema.getModel()||c.Util.getMainModel();var r=function(e){var m=e.getSource(),C=cus.crm.mytasks.util.Util;C.releaseBusyDialog();C.logObjectToConsole(C.dummyString,m)},R=function(e){jQuery.sap.log.debug("Firing Search oData");cus.crm.mytasks.util.Util.requestBusyDialog()},f=function(e){cus.crm.mytasks.util.Util.onRequestFailed(e,oCUU.dummyString)};this.oSearchModel.attachRequestCompleted(jQuery.proxy(r,this)).attachRequestSent(jQuery.proxy(R,this)).attachRequestFailed(jQuery.proxy(f,this))}}return this.oSearchModel},onRequestFailed:function(e,m,f){var c=cus.crm.mytasks.util,C=c.Util,o=c.Formatter,a=c.AppConfig,d=undefined,M=undefined,l=undefined;if(m)l=m;else l="oData request failed";C.logObjectToConsole(l,e,"error");var p='"message":{"lang":"[^"]+","value":"(.+?)"[},]',r=new RegExp(p);if(e&&e.response&&e.response.body){var b=a.getConfiguration();if(b.isDebug)d=e.response.body;var R=e.response.body.match(r);if(Array.isArray(R))M=R[1]}if(!M)M=o.getResourceBundle().getText("GENERIC_ERROR");if(f&&f.sv&&f.sv===1){if(typeof f.ssv==="number"&&f.ssv>=3)d=f.msg}else if(f&&f.msg){d=M;M=f.msg;if(M==="")M=o.getResourceBundle.getText("S3_RENAME_ATTACHMENT_FAILED")}sap.ca.ui.message.showMessageBox({type:sap.ca.ui.message.Type.ERROR,message:M,details:d});cus.crm.mytasks.util.Util.releaseBusyDialog()},saveTaskAndUpdateTaskList:function(i,t,v,s,e,a){var m=v.getModel(),p="",M="";this.assureDescription(t);this._checkForMaxLength(t);p=i?"/Tasks":v.getBindingContext().getPath();M=i?"POST":"MERGE";m.addBatchChangeOperations([m.createBatchOperation(p,M,t)]);m.submitBatch(s,e,a)},_checkForMaxLength:function(t){var c=cus.crm.mytasks.util.Schema,p=["AccountName","ContactName","ResponsibleName"];for(var i=-1,P;P=p[++i];)t[P]=t[P].substr(0,c._getPropertyInfoOfEntity("Task",P).maxLength)},_onDeleteTaskError:function(e){if(this.navFromAccounts||this.bIsBookmarkUsed){var d=sap.ushell.Container.getService("URLParsing").getHash(location).split("/"),v=this.getView(),c=new sap.ui.model.Context(v.getModel(),'/'+d[d.length-1]);v.setBindingContext(c)}cus.crm.mytasks.util.Util.onRequestFailed(e,"Operation failed: Delete Task")},_onDeleteTaskSuccess:function(t,d,r,e){var c=cus.crm.mytasks.util,C=c.Util,o=c.Formatter;if(e&&e.length>0)this._checkFor412StatusCode(e[0],"Operation failed: Delete Task");else{C.logObjectToConsole("Operation successful: Delete Task",t);var m=o.getResourceBundle().getText("DETAILS_DELETE_CONFIRMATION",["'"+t.Description+"'"]);sap.m.MessageToast.show(m,{closeOnBrowserNavigation:false});if(this.navFromAccounts){this.navFromAccounts=false;sap.ui.getCore().getEventBus().publish("cus.crm.mytasks","taskDeleted")}this._navBack();C.releaseBusyDialog()}},deleteTaskAndUpdateTaskList:function(t,c){var v=c.getView(),m=v.getModel(),s=jQuery.proxy(this._onDeleteTaskSuccess,c,t),e=jQuery.proxy(this._onDeleteTaskError,c),p=v.getBindingContext().getPath(),M="DELETE";m.addBatchChangeOperations([m.createBatchOperation(p,M,t)]);if(c.navFromAccounts||c.bIsBookmarkUsed)v.unbindContext();m.submitBatch(s,e,true)},getAllPrerequisites:function(m,p,c){var r=[],C=cus.crm.mytasks.util;if(!m)m=C.Util.getMainModel()||C.Schema.getModel();for(var i=0,j=p.length;i<j;i++)r.push(m.createBatchOperation(p[i],"GET"));if(r.length>0){m.addBatchReadOperations(r);m.submitBatch(c.success,c.error,c.async)}},getDeferredObject:function(c,n){var o=null;if(c&&c!==""&&n&&n!==""){var C=cus.crm.mytasks.util,m=C.Schema.getModel(),r;switch(n){case C.Attachments.NAVLINK:case C.DocumentHistory.NAVLINK:case"TaskStatuses":case"TaskLogSet":r=[m.sServiceUrl,c,n].join("/");o={"__deferred":{"uri":C.Formatter.formatAttachmentURL(r)}};break;default:break}}return o}};
