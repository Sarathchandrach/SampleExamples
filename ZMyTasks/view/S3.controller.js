/*
 * Copyright (C) 2009-2014 SAP SE or an SAP affiliate company. All rights reserved
 */
jQuery.sap.require("sap.ca.scfld.md.controller.BaseFullscreenController");jQuery.sap.require("sap.ca.scfld.md.controller.ScfldMasterController");sap.ca.scfld.md.controller.BaseFullscreenController.extend("cus.crm.mytasks.view.S3",{enterDueDatePressed:false,createdfromNotes:false,createdfromAccounts:false,bIsBookmarkUsed:false,bIsFollowupFromTasks:false,bIsFollowupFromOthers:false,oStatusDDLB:{bNotRetrieved:false,errorObj:null,},onInit:function(){jQuery.sap.log.debug("begin on init s3");sap.ca.scfld.md.controller.BaseFullscreenController.prototype.onInit.call(this);this._getApplicationModel().setProperty("/s3Controller",this);var c=cus.crm.mytasks.util,C=c.Util,o=c.ContactF4,v=this.getView(),a=c.EmployeeF4,b=c.AccountF4,s=undefined,m=v.getModel();if(!c.Schema.getServiceVersion())c.Schema.initServiceSchemaVersion(m,"Task");this.oSavedTask=this.oNewTask=undefined;b.create(this);o.create(this);a.create(this);var d=sap.ui.component(sap.ui.core.Component.getOwnerIdFor(this.getView()));if(d&&d.getComponentData())s=d.getComponentData().startupParameters;this.oRouter.attachRouteMatched(jQuery.proxy(this.handleNavigationWithTasks,this,s));C.logObjectToConsole("S3 View Model after init: ",m);var e={onsapenter:this._onEnterPressed};v.byId("dueDateInput").addEventDelegate(e,this);if(sap.ui.Device.system.phone)v.byId("TxtTypeInput").removeStyleClass("TaskTypePad").addStyleClass("TaskTypePadMobile");jQuery.sap.log.debug("end on init s3")},onBeforeRendering:function(){jQuery.sap.log.debug("on before render s3")},onAfterRendering:function(e){jQuery.sap.log.debug("on after render s3");if(this.oStatusDDLB.bNotRetrieved){cus.crm.mytasks.util.Util.onRequestFailed(this.oStatusDDLB.errorObj,"Operation failed: Read status customizing.");this.oStatusDDLB.errorObj=null;this.oStatusDDLB.bNotRetrieved=false}},onExit:function(){var c=cus.crm.mytasks.util,a=[c.AccountF4.getValueHelp(),c.ContactF4.getValueHelp(),c.EmployeeF4.getValueHelp()];for(var i=-1,C;C=a[++i];)for(var j in C.mEventRegistry)delete C.mEventRegistry[j]},handleNavigationWithTasks:function(s,e){this.onBeforeRendering();jQuery.sap.log.debug("on route matched s3");var c=cus.crm.mytasks.util,C=c.Schema,o=c.Util,v=this.getView(),b=c.Formatter.getResourceBundle(),r=e.getParameter("name"),a=e.getParameter("arguments"),p=undefined;var n=undefined,d=undefined,f=undefined,g=undefined,t=undefined;var P=this._checkIfPrerequisitesExist();switch(r){case"taskDetail":jQuery.sap.log.debug("S3 page called with task object");d=new sap.ui.model.Context(v.getModel(),'/'+a.contextPath);v.setBindingContext(d);this.oSavedTask=d.getObject();if(!this.oSavedTask){jQuery.sap.log.debug("S3 page called via bookmark");this._getTaskHeaderInfo();this.bIsBookmarkUsed=true;this.prepareNewTask(this.oSavedTask)}if(this.oSavedTask.Completed){var m=["'","'"].join(this.oSavedTask.Description),h=b.getText("LIST_COMPLETE_CONFIRMATION",[m]);sap.m.MessageToast.show(h,{closeOnBrowserNavigation:false})}this.initializeDetailsPage(this.oSavedTask);p={curType:typeof this.oSavedTask.PrivateAllowed,curValue:this.oSavedTask.PrivateAllowed};this._setPrivacyForTask(p,C,c.TechnicalInfoUtil);if(C.getServiceVersion()==1&&C.getServiceSchemaVersion()>=4)c.Attachments.EditPage.bindData(this);break;case"newTask":case"newTaskFromNote":case"newTaskWithAccount":jQuery.sap.log.debug("S3 page called with empty object");d=new sap.ui.model.Context(v.getModel(),'/new');v.setBindingContext(d);this._checkIfFollowupFromTasks();if(this.oParamsToPass){this.bIsFollowupFromTasks=true;t={accountID:this.oParamsToPass.AccountID,accountName:this.oParamsToPass.AccountName,contactID:this.oParamsToPass.ContactID,contactName:this.oParamsToPass.ContactName,desc:this.oParamsToPass.title,note:this.oParamsToPass.Note,predecessorID:this.oParamsToPass.taskId,predecessorGUID:this.oParamsToPass.taskGuid,priority:this.oParamsToPass.priority,procType:a.processType,ProcessTypeDescription:this.oParamsToPass.ProcessTypeDescription};p={curType:typeof this.oParamsToPass.privateFlag,curValue:this.oParamsToPass.privateFlag};this._setPrivacyForTask(p,C,c.TechnicalInfoUtil)}else if(s){if(s.createFromOppt&&s.createFromOppt[0]){this.bIsFollowupFromOthers=true;t={accountID:s.AccountId&&s.AccountId[0],contactID:s.ContactId&&s.ContactId[0],desc:s.title&&s.title[0],procType:a.processType};this._getPrerequisiteInfoForNewTask(P,t);if(C.getServiceVersion()==1&&C.getServiceSchemaVersion()>=2){if(C.getServiceSchemaVersion()>=3){t.predecessorGUID=s.opportunityGuid&&s.opportunityGuid[0];p={curType:typeof t.privateFlag,curValue:t.privateFlag};this._setPrivacyForTask(p,C,c.TechnicalInfoUtil)}else t.predecessorID=s.opportunityId&&s.opportunityId[0]}}else if(s.itemPaths&&cus.crm.notes&&cus.crm.notes.handler){this.createdfromNotes=true;t={accountID:f,accountName:g,note:(new cus.crm.notes.handler.ModelHandler()).getSectionsText(s.itemPaths),procType:a.processType};this._getPrerequisiteInfoForNewTask(P,t);if(C.getServiceVersion()==1&&C.getServiceSchemaVersion()>=3){p={curType:typeof t.privateFlag,curValue:t.privateFlag};this._setPrivacyForTask(p,C,c.TechnicalInfoUtil)}}else if(s.createFromAppt&&s.createFromAppt[0]){this.bIsFollowupFromOthers=true;t={accountID:s.AccountId&&s.AccountId[0],contactID:s.ContactId&&s.ContactId[0],desc:s.title&&s.title[0],procType:a.processType,predecessorGUID:s.appointmentGuid&&s.appointmentGuid[0],};this._getPrerequisiteInfoForNewTask(P,t);p={curType:typeof t.privateFlag,curValue:t.privateFlag};this._setPrivacyForTask(p,C,c.TechnicalInfoUtil)}else if(s.createFromAccount&&s.createFromAccount[0]){this.createdfromAccounts=true;t={accountID:s.accountID&&s.accountID[0],procType:a.processType,};this._getPrerequisiteInfoForNewTask(P,t);p={curType:typeof t.privateFlag,curValue:t.privateFlag};this._setPrivacyForTask(p,C,c.TechnicalInfoUtil)}else if(s.fromAccount&&s.fromAccount[0]){this.bIsFollowupFromTasks=true;t=this.oParamsToPass?{accountID:this.oParamsToPass.AccountID,accountName:this.oParamsToPass.AccountName,contactID:this.oParamsToPass.ContactID,contactName:this.oParamsToPass.ContactName,desc:this.oParamsToPass.title,note:this.oParamsToPass.Note,predecessorID:this.oParamsToPass.taskId,predecessorGUID:this.oParamsToPass.taskGuid,priority:this.oParamsToPass.priority,procType:a.processType,ProcessTypeDescription:this.oParamsToPass.ProcessTypeDescription}:{accountID:f,accountName:g,procType:a.processType,ProcessTypeDescription:j,note:n};this._getPrerequisiteInfoForNewTask(P,t);p=this.oParamsToPass?{curType:typeof this.oParamsToPass.privateFlag,curValue:this.oParamsToPass.privateFlag}:{curType:typeof t.privateFlag,curValue:t.privateFlag};this._setPrivacyForTask(p,C,c.TechnicalInfoUtil)}else{t={accountID:s.accountID&&s.accountID[0],accountName:a.accountName,procType:a.processType,note:n}}}else{var i=this._getApplicationModel().getProperty("/s2Controller"),j=i&&i.processTypeDesc,k=i&&i.processTypePrio;t={accountID:f,accountName:g,procType:a.processType,ProcessTypeDescription:j,priority:k,note:n};this._getPrerequisiteInfoForNewTask(P,t)}this.oNewTask=o.createEmptyTaskObject(C,t);this.prepareNewTask(this.oNewTask);this.initializeDetailsPage(this.oNewTask);break}o.releaseBusyDialog()},_onEnterPressed:function(e){var v=this.getView();if(e.srcControl==v.byId("accountInput"))this._onEnterPressedForAccount();else if(e.srcControl==v.byId("contactInput"))this._onEnterPressedForContact();else if(e.srcControl==v.byId("dueDateInput"))this._onEnterPressedForDueDate();else this._onEnterPressedForEmployee()},_setFullScreenTitle:function(t){var a=cus.crm.mytasks.util.Formatter.showTaskTitle(t.Description,t.Id);this._oControlStore.oTitle.setText(a)},onLifeChange:function(e){var t=jQuery(e.getSource().$()).children("textarea")[0];this.autoResize(t)},autoResize:function(t){t.style.overflow="auto";t.style.height="100%";t.style.height=t.scrollHeight+'px';t.style.overflow="hidden"},initializeDetailsPage:function(t){var c=cus.crm.mytasks.util,C=c.Util,v=this.getView(),o=c.AccountF4,a=c.ContactF4;C.logObjectToConsole("task: ",t);this._initHFOptions(v.getBindingContext());this._setFullScreenTitle(t);o.setId(t.AccountId).setName(t.AccountName?t.AccountName:t.AccountId);a.setId(t.ContactId).setName(t.ContactName?t.ContactName:t.ContactId);if(this._getApplicationModel().getProperty("/s4Controller")){v.byId("accountInput").setValue(o.getName());v.byId("contactInput").setValue(a.getName())}var d=v.byId("dueDateInput");if(!d._dateType)d._dateType=new sap.ca.ui.model.type.Date({style:"long",UTC:false});this.setBtnEnabled("assignTask",!v.byId("privateSwitch").getState());this._showOrHideStatusField(["statSelect","laStatSelect","hboxStatus",],t);this._showOrHideTransactionType(["laTypeInput","TxtTypeInput","TxtTypeHBox"]);c.Attachments.EditPage.showOrHidePanel(v)},_checkIfNewTask:function(t){var i=(t.Id==="");cus.crm.mytasks.util.Util.logObjectToConsole("task idIsEmpty="+i+"; ",t);return i},getTask:function(){var c=cus.crm.mytasks.util,C=c.Formatter,o=c.Util,v=this.getView(),a=c.Schema,b=v.getBindingContext(),s=undefined,t=null;if(b=="/new")t=jQuery.extend(this.oNewTask,{});else t=jQuery.extend(b.getObject(),{});o.logObjectToConsole("oTask: ",t);s=t.DueDate;t.Description=v.byId("descInput").getValue();t.DueDate=v.byId("dueDateInput").getValue();t.Priority=v.byId("prioSelect").getSelectedKey();t.Private=v.byId("privateSwitch").getState();t.Note=v.byId("noteTa").getValue();var A=this.getCurrentAccount(),d=this.getCurrentContact();t.AccountId=A.AccountId;t.AccountName=A.AccountName;t.ContactId=d.ContactId;t.ContactName=d.ContactName;if(a.getServiceVersion()==1){if(a.getServiceSchemaVersion()>=3)t.UserStatusCode=v.byId("statSelect").getSelectedKey();if(a.getServiceSchemaVersion()>=4&&b.getPath()!=="/new"){var n=[c.Attachments.NAVLINK,c.DocumentHistory.NAVLINK,"TaskLogSet","TaskStatuses"];for(var i=0,j=n.length;i<j;i++)t[n[i]]=o.getDeferredObject(b.getPath().substr(1),n[i])}}if(typeof t.DueDate==="string"&&t.DueDate!==""){var T=C.parseLongDate(t.DueDate);t.DueDate=T?T:s}if(C.getDiffInDays(s,t.DueDate)==0)t.DueDate=s;else if(t.DueDate==="")t.DueDate=null;if(this.extHookGetCustomFields)this.extHookGetCustomFields(t);return t},saveTask:function(e){var s=e.getSource(),t=this.getTask(),S=function(C,d,r,a){var o=cus.crm.mytasks.util,b=o.Util,R=o.Formatter.getResourceBundle();C.curBtn.setEnabled(true);if(a&&a.length>0)this._checkFor412StatusCode(a[0],"Operation failed: Update Task");else{b.logObjectToConsole("Operation successful: Update Task",C.curTask);var k=C.isFollowupActivity?"FOLLOWUP_TASK_SAVED":"CURRENT_TASK_SAVED";var i=this._checkIfNewTask(C.curTask),f=!i?C.curTask:d.__batchResponses[0].__changeResponses[0].data;sap.m.MessageToast.show(R.getText(k),{closeOnBrowserNavigation:false});this._showOverviewOrGoBack(this.getView(),{bINT:i,curTask:f,scenario:"CLICKEDSAVE"});b.releaseBusyDialog()}},E=function(b,o){cus.crm.mytasks.util.Util.onRequestFailed(o,"Operation failed: Update Task");b.setEnabled(true)},c={curTask:t,curBtn:s,isFollowupActivity:this.bIsFollowupFromOthers||this.bIsFollowupFromTasks?true:false},u={success:S,error:E,async:true};this._commonWayToSaveTask(c,u)},checkUIValues:function(t){var r={},c=cus.crm.mytasks.util.Formatter;r.hasErrors=false;r.messages=new Array();var d=this.getView().byId("dueDateInput").getValue(),D=c.parseLongDate(d);if(!D&&d!==""){var m=c.getResourceBundle().getText("DETAILS_MESSAGETEXT_DATE");r.messages.push(m);r.hasErrors=true}var a=this.getCurrentAccount().AccountName,b=this.getView().byId("accountInput").getValue();if(a!=b){var e=c.getResourceBundle().getText("DETAILS_MESSAGETEXT_ACCOUNT");r.messages.push(e);r.hasErrors=true}var f=this.getCurrentContact().ContactName,g=this.getView().byId("contactInput").getValue();if(f!=g){var h=c.getResourceBundle().getText("DETAILS_MESSAGETEXT_CONTACT");r.messages.push(h);r.hasErrors=true}if(this.extHookCheckUIValues)this.extHookCheckUIValues(r);return r},cancelTask:function(e){var c=cus.crm.mytasks.util.Util,v=this.getView();c.requestBusyDialog();if(this.oSavedTask){v.byId("descInput").setValue(this.oSavedTask.Description);this.setFormattedDueDate(this.oSavedTask.DueDate);v.byId("prioSelect").setSelectedKey(this.oSavedTask.Priority);v.byId("privateSwitch").setState(this.oSavedTask.Private);v.byId("accountInput").setValue(this.oSavedTask.AccountName);v.byId("contactInput").setValue(this.oSavedTask.ContactName);v.byId("noteTa").setValue(this.oSavedTask.Note);if(this.extHookCancelCustomFields)this.extHookCancelCustomFields(this.oSavedTask)}c.logObjectToConsole("old task: ",this.oSavedTask);this._showOverviewOrGoBack(v,{bINT:this.oSavedTask?false:true,curTask:this.oSavedTask||this.oNewTask,scenario:"CLICKEDCANCEL"});this.oSavedTask=this.oNewTask=undefined;c.releaseBusyDialog()},prepareNewTask:function(n){var v=this.getView(),c=cus.crm.mytasks.util.Schema;v.byId("descInput").setValue(n.Description);this.setFormattedDueDate(n.DueDate);v.byId("prioSelect").setSelectedKey(n.Priority);v.byId("privateSwitch").setState(n.Private);v.byId("accountInput").setValue(n.AccountName?n.AccountName:n.AccountId);v.byId("contactInput").setValue(n.ContactName?n.ContactName:n.ContactId);v.byId("noteTa").setValue(n.Note);if(c.getServiceVersion()==1&&c.getServiceSchemaVersion()>=3){v.byId("statSelect").setSelectedKey(n.UserStatusCode);v.byId("TxtTypeInput").setText(n.ProcessTypeDescription)}if(this.extHookPrepareCustomFields)this.extHookPrepareCustomFields(n)},_onEnterPressedForContact:function(){var i=this.getView().byId("contactInput");this.onF4Contact({getSource:function(){return i}})},onF4Contact:function(e){var i=e.getSource(),a=this.getCurrentAccount(),c=cus.crm.mytasks.util.ContactF4;c.getValueHelp().open(i.getValue());c.triggerSearch({accountid:a.AccountId,accounttext:a.AccountName,contactid:this.getCurrentContact().ContactId,searchvalue:i.getValue()})},getCurrentContact:function(){var v=this.getView(),c=v.byId("contactInput").getValue(),a=v.getBindingContext().getObject()?v.getBindingContext().getObject():this.oNewTask,C=cus.crm.mytasks.util,o=C.Util,b=C.ContactF4;o.logObjectToConsole("active task: ",a);if(c==="")b.setId("").setName("");else if(this.__onlyOneContactSuggested){var s=jQuery.extend({},this.__onlyOneContactSuggested,true);if((s[b.getFilterString()]||s.contactID).toLowerCase()===c.toLowerCase()){b.setId(s.contactID).setName(s[b.getFilterString()]);if(b.getName()==="")b.setName(s.contactID);v.byId("contactInput").setValue(b.getName());b._setAccountIfNotSetAlready(this,s)}this.__onlyOneContactSuggested=undefined}return{ContactId:b.getId(),ContactName:b.getName()}},openBusinessCardContact:function(d,r){var c=cus.crm.mytasks.util,C=c.Util,o=c.Formatter;var a={};a.title=o.getResourceBundle().getText("DETAILS_BCARD_CONTACT");a.name=d.fullName;a.imgurl=o.photoUrlFormatter(d.Photo);a.department=d.department;a.companyname=d.company;if(d.WorkAddress){var w=d.WorkAddress;a.companyaddress=w.address;a.contactemail=w.email;a.contactphone=w.phone;a.contactmobile=w.mobilePhone}var b=new sap.ca.ui.quickoverview.EmployeeLaunch(a),O=this.getView().byId("showContact");b.openBy(O);C.releaseBusyDialog()},_onEnterPressedForAccount:function(){var i=this.getView().byId("accountInput");this.onF4Account({getSource:function(){return i}})},onF4Account:function(e){var i=e.getSource(),c=cus.crm.mytasks.util,C=c.AccountF4;C.getValueHelp().open(i.getValue());C.triggerSearch(i.getValue())},getCurrentAccount:function(){var v=this.getView(),a=v.getBindingContext().getObject()?v.getBindingContext().getObject():this.oNewTask,i=v.byId("accountInput").getValue(),c=cus.crm.mytasks.util,C=c.Util,o=c.AccountF4;C.logObjectToConsole("active task: ",a);if(i==="")o.setId("").setName("");else if(this.__onlyOneAccountSuggested){var s={id:this.__onlyOneAccountSuggested.accountID,name:this.__onlyOneAccountSuggested[o.getFilterString()]||this.__onlyOneAccountSuggested.accountID};if(s.name.toLowerCase()===i.toLowerCase()){o.setId(s.id).setName(s.name);v.byId("accountInput").setValue(o.getName())}this.__onlyOneAccountSuggested=undefined}return{AccountId:o.getId(),AccountName:o.getName()}},openBusinessCardCompany:function(d,r){var c=cus.crm.mytasks.util,v=this.getView(),a=c.AccountF4.getFilterString(),C=c.Util,o=c.Formatter;C.logObjectToConsole("open Business card with this data: ",d);var A={};A.title=o.getResourceBundle().getText("DETAILS_BCARD_ACCOUNT");A.imgurl=o.logoUrlFormatter(d.Logo);A.companyname=d[a];if(d.MainAddress){var m=d.MainAddress;A.companyphone=m.phone;A.companyaddress=m.address}if(d.MainContact){var M=d.MainContact,b=M.WorkAddress;A.maincontactname=M.fullName;if(b){A.maincontactphone=b.phone;A.maincontactmobile=b.mobilePhone;A.maincontactemail=b.email}}var e=new sap.ca.ui.quickoverview.CompanyLaunch(A),O=v.byId("showAccount");e.openBy(O);C.releaseBusyDialog()},_onEnterPressedForEmployee:function(){var i=this._oDlAssignTask.getContent()[1];this.onF4Employee({getSource:function(){return i}})},onF4Employee:function(e){var i=e.getSource(),c=cus.crm.mytasks.util.EmployeeF4;c.getValueHelp().open(i.getValue());c.triggerSearch(i.getValue())},_confirmEmployeeFromValueHelp:function(e){var E=this._oDlAssignTask,s=E.getContent()[1].getValue(),c=cus.crm.mytasks.util,r=c.Formatter.getResourceBundle(),C=c.EmployeeF4;if(s!=="")if(s===C.getName()){E.close();this.assignTaskToEmployee()}else sap.ca.ui.message.showMessageToast(r.getText("DETAILS_VALIDATION_TITLE"));else sap.ca.ui.message.showMessageToast(r.getText("DETAILS_VALIDATION_TITLE"))},selectAssignTask:function(e){var c=cus.crm.mytasks.util,C=c.TechnicalInfoUtil,o=c.Formatter,r=o.getResourceBundle();C.read(this.getView());if(!this._oDlAssignTask){this._oDlAssignTask=new sap.m.Dialog({title:r.getText("DETAILS_ASSIGNTO_TITLE"),content:[new sap.m.Label({text:r.getText("DETAILS_ASSIGNTO_TEXT")}),new sap.m.Input({showValueHelp:true,valueHelpRequest:jQuery.proxy(function(e){this.onF4Employee(e)},this)})],beginButton:new sap.m.Button({text:r.getText("DIALOG_ASSIGNTO_BUTTON_OK"),press:jQuery.proxy(this._confirmEmployeeFromValueHelp,this)}),endButton:new sap.m.Button({text:r.getText("DIALOG_ASSIGNTO_BUTTON_CANCEL"),press:jQuery.proxy(function(e){this._oDlAssignTask.getContent()[1].setValue("");this._oDlAssignTask.close()},this)})});this._oDlAssignTask.getContent()[1].addEventDelegate({onsapenter:this._onEnterPressed},this);this._oDlAssignTask.addStyleClass("sapUiPopupWithPadding")}this._oDlAssignTask.open()},assignTaskToEmployee:function(){var c=cus.crm.mytasks.util,C=c.Util,o=c.EmployeeF4,t=this.getTask(),a=c.Formatter,b=c.TechnicalInfoUtil,f=b.getEmployeeName(),d=sap.ca.ui.model.format.DateFormat.getDateInstance({style:"medium"}),F=d.format(new Date());C.requestBusyDialog();t.ResponsibleId=o.getId();var n=a.getResourceBundle().getText("DETAILS_ASSIGNTO_FORWARDED_BY_WITH_DATE",[f,F]),i=this._checkIfNewTask(t),p=t.Note;if(t.Note!=="")t.Note=[t.Note,n].join("\n");else t.Note=n;C.logObjectToConsole("task to assign: ",t);var s=function(h,D,r,E){var c=cus.crm.mytasks.util,C=c.Util,R=c.Formatter.getResourceBundle(),o=c.EmployeeF4;this._oDlAssignTask.getContent()[1].setValue("");if(E&&E.length>0)this._checkFor412StatusCode(E[0],"Operation failed: Assign Task");else{C.logObjectToConsole("Operation successful: Assign Task",h.curTask);var m=["'","'"].join(o.getName()),j=R.getText("DETAILS_ASSIGNTO_CONFIRMATION",[m]);sap.m.MessageToast.show(j,{closeOnBrowserNavigation:false});var I=this._checkIfNewTask(h.curTask),k=!I?h.curTask:D.__batchResponses[0].__changeResponses[0].data;this._showOverviewOrGoBack(this.getView(),{bINT:I,curTask:k,scenario:"CLICKEDASSIGNTO"});C.releaseBusyDialog()}},e=function(h,E){var c=cus.crm.mytasks.util,C=c.Util,j=C.getCustomizingModel();C.onRequestFailed(E,"Operation failed: Assign Task");h.curTask.Note=h.prevNote;h.curTask.ResponsibleId=j.getProperty("/techInfo/ResponsibleId");h.curTask.ResponsibleName=j.getProperty("/techInfo/ResponsibleName")},g={curTask:t,prevNote:p};C.saveTaskAndUpdateTaskList(i,g.curTask,this.getView(),jQuery.proxy(s,this,g),jQuery.proxy(e,this,g),true)},_onEnterPressedForDueDate:function(){this.enterDueDatePressed=true},formatDateManually:function(e){var d=undefined,a=this.getView().byId("dueDateInput");d=a._validateDate(e.getParameter("newValue"));if(d)this.setFormattedDueDate(d);else if(this.enterDueDatePressed)this.enterDueDatePressed=false},setFormattedDueDate:function(d){var f=cus.crm.mytasks.util.Formatter.formatDate(d);this.getView().byId("dueDateInput").setDateValue(d).setValue(f)},onShowAccount:function(e){var c=cus.crm.mytasks.util,C=c.Util,a=this.getCurrentAccount(),b=c.Formatter.getResourceBundle(),i=this.getView().byId("accountInput").getValue();if(a.AccountName!==i){sap.ca.ui.message.showMessageBox({type:sap.ca.ui.message.Type.WARNING,message:b.getText("DETAILS_VALIDATION_TITLE"),details:b.getText("DETAILS_MESSAGETEXT_ACCOUNT")})}else if(a.AccountId!==""){C.requestBusyDialog();var p="/AccountCollection('"+a.AccountId+"')",P={"$expand":""},E=function(o){cus.crm.mytasks.util.Util.onRequestFailed(o,"Operation failed: Read data for business card. ")},s=function(d,r){cus.crm.mytasks.util.Util.logObjectToConsole("Operation successful: Read data for business card. ",d);this.openBusinessCardCompany(d,r)},m=this.getView().getModel();P["$expand"]=this.extHookGetS3AccountPhoto?this.extHookGetS3AccountPhoto()?["MainAddress","MainContact/WorkAddress","Logo"].join(","):["MainAddress","MainContact/WorkAddress"].join(","):["MainAddress","MainContact/WorkAddress","Logo"].join(",");jQuery.sap.log.debug("oData request to be fired:"+p);m.read(p,null,P,true,jQuery.proxy(s,this),jQuery.proxy(E,this))}},onShowContact:function(e){var c=cus.crm.mytasks.util,C=c.Util,b=c.Formatter.getResourceBundle(),o=this.getCurrentContact(),a=this.getCurrentAccount(),i=this.getView().byId("contactInput").getValue();if(o.ContactName!==i){sap.ca.ui.message.showMessageBox({type:sap.ca.ui.message.Type.WARNING,message:b.getText("DETAILS_VALIDATION_TITLE"),details:b.getText("DETAILS_MESSAGETEXT_CONTACT")})}else if(o.ContactId!==""){C.requestBusyDialog();var p="/ContactCollection(contactID='"+o.ContactId+"',accountID='"+a.AccountId+"')",P={"$expand":""},E=function(d){cus.crm.mytasks.util.Util.onRequestFailed(d,"Operation failed: Read data for business card of Contact. ")},s=function(d,r){var c=cus.crm.mytasks.util;c.Util.logObjectToConsole("Operation successful: Read data for business card of Contact. ",d);if(d.accountID!==""&&d.contactID!=="")this.openBusinessCardContact(d,r);else{sap.m.MessageToast.show(c.Formatter.getResourceBundle().getText("S3_ACCOUNT_CONTACT_NOREL"));c.Util.releaseBusyDialog()}},m=this.getView().getModel();P["$expand"]=this.extHookGetS3ContactPhoto?this.extHookGetS3ContactPhoto()?["WorkAddress","Photo"].join(","):"WorkAddress":["WorkAddress","Photo"].join(",");jQuery.sap.log.debug("oData request to be fired:"+p);m.read(p,null,P,true,jQuery.proxy(s,this),jQuery.proxy(E,this))}},_navToOriginatingApp:function(a){if(a){var c={contextPath:a.sPath};switch(a.sScenario){case"CLICKEDASSIGNTO":if(this.bIsBookmarkUsed)this.bIsBookmarkUsed=false;if(this.createdfromAccounts)this.createdfromAccounts=false;this._navBack();break;case"CLICKEDSAVE":if(this.bIsBookmarkUsed){this.bIsBookmarkUsed=false;this._navBack()}else if(this.createdfromAccounts){this.createdfromAccounts=false;this._navBack()}else this.oRouter.navTo("taskOverview",c,true);break;case"CLICKEDCANCEL":default:if(a.bIsNewTask){if(this.createdfromNotes){this.createdfromNotes=false;this._navBack()}else if(this.bIsFollowupFromTasks){if(this.bIsBookmarkUsed)this.bIsBookmarkUsed=false;this.bIsFollowupFromTasks=false;this.oParamsToPass=undefined;this._navBack()}else{if(this.bIsBookmarkUsed)this.bIsBookmarkUsed=false;if(this.bIsFollowupFromOthers)this.bIsFollowupFromOthers=false;this._navBack()}}else{if(this.bIsBookmarkUsed){this.bIsBookmarkUsed=false;this._navBack()}else this.oRouter.navTo("taskOverview",c,true)}break}}},_initHFOptions:function(c){var C={sId:"cancelTask",sI18nBtnTxt:"DETAILS_BUTTONS_CANCEL",onBtnPressed:jQuery.proxy(this.cancelTask,this),},a={sId:"assignTask",sI18nBtnTxt:"DETAILS_BUTTONS_ASSIGNTO",onBtnPressed:jQuery.proxy(this.selectAssignTask,this),};var o={oEditBtn:{sId:"saveTask",sI18nBtnTxt:"DETAILS_BUTTONS_SAVE",onBtnPressed:jQuery.proxy(this.saveTask,this),},buttonList:[C,a],bSuppressBookmarkButton:true,sI18NFullscreenTitle:"NEW_TASK_PAGE_TITLE",onBack:jQuery.proxy(this.navBackEditOrCreate,this),},b=cus.crm.mytasks.util.Schema;if(!b.getServiceVersion())b.initServiceSchemaVersion(this.getView().getModel(),"Task");var s=c.getPath().search("Tasks")!==-1?"detail":"new";if(this.extHookCustomizeS3HFOptions)this.extHookCustomizeS3HFOptions(o,s);this.setHeaderFooterOptions(o)},_getApplicationModel:function(){var a=this.oApplicationFacade.getApplicationModel("controllers");if(!a){var m=new sap.ui.model.json.JSONModel({s2Controller:undefined,s3Controller:this,s4Controller:undefined,});this.oApplicationFacade.setApplicationModel("controllers",m);a=this.oApplicationFacade.getApplicationModel("controllers")}return a},_checkIfPrerequisitesExist:function(){var c=cus.crm.mytasks.util,C=c.Util.getCustomizingModel(),p=[];if(!C.getProperty("/techInfo")&&!C.getProperty("/prioList"))p=c.Schema.getServiceVersion()==1&&c.Schema.getServiceSchemaVersion()>=4?["TechnicalDetails","UserPriorities"]:["retrieveTaskTech","retrieveTaskPrioCustomizing"];else p=[];return p},_setPrivacyForTask:function(p,c,C){var P=undefined,e=undefined,b=undefined;if(p.curType==="undefined")C.setPrivacyForSelectedTask(false);else{try{P=Array.isArray(p.curValue)?p.curValue[0]:p.curValue;b=jQuery.parseJSON(P)}catch(E){e=E}if(typeof e!=="undefined")C.setPrivacyForSelectedTask(false);else if(typeof b==="boolean")C.setPrivacyForSelectedTask(b);else C.setPrivacyForSelectedTask(false)}},_showOrHideTransactionType:function(s){var c=cus.crm.mytasks.util.Schema,v=this.getView();for(var i=0,j=s.length;i<j;i++)v.byId(s[i]).setVisible(false);if(c.getServiceVersion()==1&&c.getServiceSchemaVersion()>=3)for(var i=0,j=s.length;i<j;i++)v.byId(s[i]).setVisible(true)},_showOrHideStatusField:function(s,t){var c=cus.crm.mytasks.util,C=c.Schema,v=this.getView(),o=c.StatusListUtil;for(var i=0,j=s.length;i<j;i++)v.byId(s[i]).setVisible(false);if(C.getServiceVersion()==1){var I=this._checkIfNewTask(t);if(C.getServiceSchemaVersion()>=4){c.Util.bindCustomizingModel(v);if(I){var a=c.Util.getCustomizingModel(),S=a.getProperty("/masterStatusSet/"+t.TransactionType);a.setProperty("/statList",jQuery.extend([],S,true));o.setInitialStatus(a);v.byId("statSelect").setSelectedKey(o.getInitialStatus().statID)}else v.byId("statSelect").setSelectedKey(t.UserStatusCode)}else if(C.getServiceSchemaVersion()>=3){var b=this._getApplicationModel().getProperty("/s2Controller"),p=undefined,k=undefined;if(b&&b.oStatusDDLB&&!b.oStatusDDLB.bNotRetrieved){p={procType:t.TransactionType,guid:t.Guid,bIsNew:I};if(!p.bIsNew||this.bIsFollowupFromTasks||this.createdfromNotes){o.getStatusValues(this,p);k=this.bIsFollowupFromTasks||this.createdfromNotes?o.getInitialStatus().statID:t.UserStatusCode;v.byId("statSelect").setSelectedKey(k)}}else{p={procType:t.TransactionType,guid:t.Guid,bIsNew:I};o.getStatusValues(this,p);k=p.bIsNew?o.getInitialStatus().statID:t.UserStatusCode;v.byId("statSelect").setSelectedKey(k);if(this.oStatusDDLB.bNotRetrieved){c.Util.onRequestFailed(this.oStatusDDLB.errorObj,"Operation failed: Read status customizing.");this.oStatusDDLB.errorObj=null;this.oStatusDDLB.bNotRetrieved=false}}}for(var i=0,j=s.length;i<j;i++)v.byId(s[i]).setVisible(true)}},_commonWayToSaveTask:function(c,u){var C=cus.crm.mytasks.util,o=C.Util,a=C.Formatter;o.requestBusyDialog();c.curBtn.setEnabled(false);o.logObjectToConsole("task to save: ",c.curTask);var r=this.checkUIValues(c.curTask),t=a.getResourceBundle().getText("DETAILS_VALIDATION_TITLE");if(r.hasErrors){sap.ca.ui.message.showMessageBox({type:sap.ca.ui.message.Type.ERROR,message:t,details:r.messages.toString()});c.curBtn.setEnabled(true);o.releaseBusyDialog()}else{var i=this._checkIfNewTask(c.curTask);jQuery.sap.log.debug("Assure description of Task if it a new task!");o.saveTaskAndUpdateTaskList(i,c.curTask,this.getView(),jQuery.proxy(u.success,this,c),jQuery.proxy(u.error,this,c.curBtn),u.async)}},createFollowUpObject:function(e){var i=!this._checkIfExistingTaskModified(this.oSavedTask),b=cus.crm.mytasks.util.Formatter.getResourceBundle(),B=e.getSource().getText();if(i){var q=b.getText("DETAILS_FOLLOWUP_MESSAGE"),o={icon:sap.m.MessageBox.Icon.QUESTION,title:b.getText("DETAILS_FOLLOWUP_TITLE"),actions:[sap.m.MessageBox.Action.YES,sap.m.MessageBox.Action.NO,sap.m.MessageBox.Action.CANCEL],onClose:jQuery.proxy(this._confirmOnFollowup,this,B)};sap.m.MessageBox.confirm(q,o)}else this._confirmOnFollowup(B,undefined)},_confirmOnFollowup:function(f,a){var c=cus.crm.mytasks.util.Util;c.requestBusyDialog();if(a){switch(a){case sap.m.MessageBox.Action.YES:var s=function(o,d,r,E){var b=cus.crm.mytasks.util,c=b.Util;o.curBtn.setEnabled(true);if(E&&E.length>0)c.onRequestFailed(E[0],"Operation failed: Update Task");else{c.logObjectToConsole("Operation successful: Update Task",o.curTask);var R=b.Formatter.getResourceBundle(),m=R.getText("CURRENT_TASK_SAVED");sap.m.MessageToast.show(m,{closeOnBrowserNavigation:false});c.releaseBusyDialog();this._performFollowUp(o)}},e=function(b,E){cus.crm.mytasks.util.Util.onRequestFailed(E,"Operation failed: Update Task");b.setEnabled(true)},C={curTask:this.getTask(),curBtn:this.getPage().getFooter().getContentRight()[0],followupType:f,},u={success:s,error:e,async:false,};this._commonWayToSaveTask(C,u);break;case sap.m.MessageBox.Action.NO:this._performFollowUp({curTask:this.oSavedTask,followupType:f});break;case sap.m.MessageBox.Action.CANCEL:default:c.releaseBusyDialog();break}}else this._performFollowUp({curTask:this.oSavedTask,followupType:f})},_performFollowUp:function(c){var p=undefined,C=cus.crm.mytasks.util,o=C.Formatter,b=o.getResourceBundle(),s=["DETAILS_BUTTONS_FOLLOWUP_TASK","DETAILS_BUTTONS_FOLLOWUP_OPPT","DETAILS_BUTTONS_FOLLOWUP_APPT"],a=[];for(var i=0;i<s.length;i++)a.push(b.getText(s[i]));switch(c.followupType){case a[0]:p="TaskFollowupTransTypes";break;case a[1]:p="OpptFollowupTransTypes";break;case a[2]:p="AppFollowupTransTypes";break}if(p){var t=undefined,P={key:"",value:"",privateEnabled:"",},v=this.getView(),m=v.getModel(),S=function(D,r){t=D.results;cus.crm.mytasks.util.Util.releaseBusyDialog()},e=function(f,E){var C=cus.crm.mytasks.util,g=C.Schema,r=C.Formatter.getResourceBundle(),M=["'","'"].join(f.curTask.Description),F={sv:g.getServiceVersion(),ssv:g.getServiceSchemaVersion(),msg:r.getText("FOLLOWUP_ERROR_MSG",[M])};C.Util.onRequestFailed(E,"Operation Failed: Read Transaction Types for '"+f.followupType+"'.",F)},d={Guid:m.formatValue(c.curTask.Guid,o.EDM_GUID),TransactionType:m.formatValue(c.curTask.TransactionType,o.EDM_STRING)};m.read(p,null,d,false,jQuery.proxy(S,this),jQuery.proxy(e,this,c));if(!this._oDlFollowupTT){this._oDlFollowupTT=new sap.ui.xmlfragment("cus.crm.mytasks.view.FollowupDialog",this);this._oDlFollowupTT.setModel(v.getModel("i18n"),"i18n")}if(Array.isArray(t))if(t.length==1){P.key=t[0].ProcessTypeCode;P.value=t[0].Description;P.privateEnabled=t[0].PrivateFlag}else{this._oDlFollowupTT.setModel(new sap.ui.model.json.JSONModel(t),"FollowupTypes");this._oDlFollowupTT._sFollowupType=c.followupType;this._oDlFollowupTT.open()}if(P.key!=="")this._onSelectedFollowUpType(P,c)}else jQuery.sap.log.debug("## Incorrect way to perform a Follow up ##")},_checkIfExistingTaskModified:function(t){var r=true,v=this.getView(),d=v.byId("descInput").getValue(),D=v.byId("dueDateInput").getValue(),p=v.byId("prioSelect").getSelectedKey(),P=v.byId("privateSwitch").getState(),a=v.byId("accountInput").getValue(),c=v.byId("contactInput").getValue(),n=v.byId("noteTa").getValue();var C=cus.crm.mytasks.util,o=C.Formatter.getDateFormatter(),b=C.Schema,s=undefined;r=r&&d===t.Description&&p===t.Priority&&P===t.Private&&a===(t.AccountName?t.AccountName:t.AccountId)&&c===(t.ContactName?t.ContactName:t.ContactId)&&n===t.Note;if(b.getServiceVersion()==1&&b.getServiceSchemaVersion()>=3){s=v.byId("statSelect").getSelectedKey();r=r&&s===t.UserStatusCode}r=t.DueDate?r&&D===o.format(t.DueDate):r&&""===D;return r},navBackEditOrCreate:function(e){var i=this.oSavedTask?!this._checkIfExistingTaskModified(this.oSavedTask):true,r=cus.crm.mytasks.util.Formatter.getResourceBundle(),q=r.getText("NAVBACK_WARNING_MESSAGE"),o={icon:sap.m.MessageBox.Icon.WARNING,title:r.getText("NAVBACK_WARNING_TITLE"),actions:[sap.m.MessageBox.Action.OK,sap.m.MessageBox.Action.CANCEL],onClose:jQuery.proxy(function(a){if(a===sap.m.MessageBox.Action.OK)this.cancelTask();else jQuery.sap.log.debug("Nav Back cancelled")},this)};if(i)sap.m.MessageBox.confirm(q,o);else this.cancelTask()},privatizeTask:function(e){this.setBtnEnabled("assignTask",!e.getParameter("state"))},_getPrerequisiteInfoForNewTask:function(p,t){var f,e,c=cus.crm.mytasks.util,m=this.getView().getModel(),C=c.Formatter,o=c.Schema;if(o.getServiceVersion()==1)if(o.getServiceSchemaVersion()>=4){if(typeof t.ProcessTypeDescription==="undefined")p.push("TransactionTypes");if(!c.Util.getCustomizingModel().getProperty("/masterStatusSet"))p.push("UserStatuses")}else if(o.getServiceSchemaVersion()>=3){if(typeof t.ProcessTypeDescription==="undefined")p.push("TaskTransTypes")}if(t.accountID)p.push(["AccountCollection(",")"].join(m.formatValue(t.accountID,C.EDM_STRING)));if(t.contactID){f=m.formatValue(t.contactID,C.EDM_STRING);e=jQuery.sap.encodeURL("contactID eq "+f);p.push("ContactCollection?$filter="+e)}var s=function(t,d,r,a){var c=cus.crm.mytasks.util;if(a&&a.length>0)c.Util.onRequesFailed(a[0],"Prerequisite Info READ Failed!");else{for(var i=-1,b;b=d.__batchResponses[++i];)switch(i){case 0:c.TechnicalInfoUtil.parseTechInfoOData(b.data);break;case 1:c.PriorityListUtil.parsePrioListOData(b.data);break;case 2:for(var j=-1,T;T=b.data.results[++j];)if(T.ProcessTypeCode===t.procType){t.ProcessTypeDescription=T.Description;t.privateFlag=T.PrivateFlag;if(c.Schema.getServiceVersion()==1&&c.Schema.getServiceSchemaVersion()>=4)t.priority=T.Priority;break}c.TechnicalInfoUtil.setPrivacyForSelectedTask(t.privateFlag);break;default:if(b.data.__metadata)t.accountName=b.data[c.AccountF4.getFilterString()]?b.data[c.AccountF4.getFilterString()]:t.accountID;else{if(b.data.results[0].__metadata.type.search("Contact")!==-1)t.contactName=b.data.results[0][c.ContactF4.getFilterString()]?b.data.results[0][c.ContactF4.getFilterString()]:t.contactID;else c.StatusListUtil.setStatusValuesAgainstTransactionType(jQuery.extend([],b.data.results,true))}break}}},E=function(a){cus.crm.mytasks.util.Util.onRequesFailed(a,"Prerequisite Info READ Failed!")};c.Util.getAllPrerequisites(m,p,{success:jQuery.proxy(s,this,t),error:E,async:false});c.Util.bindCustomizingModel(this.getView())},_getTaskHeaderInfo:function(){var v=this.getView(),c=cus.crm.mytasks.util,p=this._checkIfPrerequisitesExist(),C=v.getBindingContext(),P=C.getPath().substr(1);p.splice(0,0,P);if(c.Schema.getServiceVersion()==1&&c.Schema.getServiceSchemaVersion()>=4&&!this.oSavedTask)p.push([P,c.Attachments.NAVLINK].join("/"),[P,"TaskStatuses"].join("/"));var s=function(d,r,E){var c=cus.crm.mytasks.util;if(E&&E.length>0)c.Util.onRequestFailed(E[0],"Prerequisites READ plus Bookmark READ failed!");else{var v=this.getView(),C=v.getBindingContext(),k=C.getPath().substr(1);for(var i=-1,o;o=d.__batchResponses[++i];)switch(i){case 0:v.getModel().oData[k]=jQuery.extend({},o.data,true);this.oSavedTask=C.getObject();break;case 1:if(c.Schema.getServiceVersion()==1&&c.Schema.getServiceSchemaVersion()>=4)c.TechnicalInfoUtil.parseTechInfoOData({retrieveTaskTech:jQuery.extend({},o.data.results[0],true)});else c.TechnicalInfoUtil.parseTechInfoOData(o.data);break;case 2:c.PriorityListUtil.parsePrioListOData(o.data);break;case 3:c.Attachments._aPaths=c.Attachments._addDataToODataModel(v.getModel(),o.data.results)["paths"];break;case 4:c.StatusListUtil.bindStatusValuesToTask(C.getModel(),{bExpandCall:false,curResults:o.data.results});break;default:break}}},e=function(E){cus.crm.mytasks.util.Util.onRequestFailed(E,"Prerequisites READ plus Bookmark READ failed!")};c.Util.getAllPrerequisites(v.getModel(),p,{success:jQuery.proxy(s,this),error:e,async:false})},_checkIfFollowupFromTasks:function(){var o=this._getApplicationModel().getProperty("/s4Controller");if(o&&o.oParamsToPass){this.oParamsToPass=jQuery.extend(o.oParamsToPass,{});o.oParamsToPass=undefined}},_showOverviewOrGoBack:function(v,p){var g=undefined,c=cus.crm.mytasks.util.Formatter,m=v.getModel();if(typeof p.curTask.Guid==="undefined"&&typeof p.curTask.PredecessorGUID!=="undefined")g=p.curTask.PredecessorGUID;else g=p.curTask.Guid;var a={sScenario:p.scenario,bIsNewTask:p.bINT,sPath:g?["Tasks(",")"].join(m.formatValue(g,c.EDM_GUID)):undefined};if(p.bINT&&(p.scenario==="CLICKEDSAVE"||p.scenario==="CLICKEDASSIGNTO"))m.oData[a.sPath]=p.curTask;if(this.createdfromAccounts)sap.ui.getCore().getEventBus().publish("cus.crm.mytasks","taskCreated");this._navToOriginatingApp(a)},liveChangeAccount:function(e){var a=e.getSource(),c=a.getValue();a.removeAllSuggestionItems();if(a.setFilterSuggests)a.setFilterSuggests(false);var t=function(c){var s=function(D,r){var a=this.getView().byId("accountInput");for(var i=0;i<D.results.length;i++){var A=D.results[i],b=A[cus.crm.mytasks.util.AccountF4.getFilterString()]||A.accountID,o={key:"taskAccount",value:A},I={text:b,customData:new sap.ui.core.CustomData(o)};a.setShowSuggestion(true);a.addSuggestionItem(new sap.ui.core.Item(I))}this.__onlyOneAccountSuggested=D.results.length==1?D.results[0]:undefined},m=this.getView().getModel(),E=function(o){cus.crm.mytasks.util.Util.onRequestFailed(o,"Read of Suggestion items for account failed")},C=cus.crm.mytasks.util,f=[m.formatValue(c,C.Formatter.EDM_STRING),C.AccountF4.getFilterString()].join(","),p={"$top":10,"$filter":["substringof(",")"].join(f)};m.read("/AccountCollection",null,p,true,jQuery.proxy(s,this),E)};var d=c!==""?500:0;clearTimeout(this._fnTimeOut);if(d!==0){this._fnTimeOut=setTimeout(jQuery.proxy(t,this,c),d)}},suggestedAccountSelected:function(e){var i=e.getParameter("selectedItem"),a=i.getCustomData()[0].getValue(),c=cus.crm.mytasks.util.AccountF4,A=a[c.getFilterString()]||a.accountID;c.setId(a.accountID).setName(A);e.getSource().setValue(A)},liveChangeContact:function(e){var c=e.getSource(),C=c.getValue();c.removeAllSuggestionItems();if(c.setFilterSuggests)c.setFilterSuggests(false);var t=function(C){var s=function(D,r){var c=this.getView().byId("contactInput");for(var i=0;i<D.results.length;i++){var a=D.results[i],b=a[cus.crm.mytasks.util.ContactF4.getFilterString()]||a.contactID,g={key:"taskContact",value:a},I={text:b,customData:new sap.ui.core.CustomData(g)};c.setShowSuggestion(true);c.addSuggestionItem(new sap.ui.core.Item(I))}this.__onlyOneContactSuggested=D.results.length==1?D.results[0]:undefined},E=function(a){cus.crm.mytasks.util.Util.onRequestFailed(a,"Read of Suggestion items for contact failed")},o=cus.crm.mytasks.util,m=this.getView().getModel(),f=[m.formatValue(C,o.Formatter.EDM_STRING),o.ContactF4.getFilterString()].join(","),p={"$top":10,"$filter":["substringof(",")"].join(f)};m.read("/ContactCollection",null,p,true,jQuery.proxy(s,this),E)};var d=C!==""?500:0;clearTimeout(this._fnTimeOutC);if(d!==0){this._fnTimeOutC=setTimeout(jQuery.proxy(t,this,C),d)}},suggestedContactSelected:function(e){var c=cus.crm.mytasks.util.ContactF4,i=e.getParameter("selectedItem"),C=i.getCustomData()[0].getValue(),s=C[c.getFilterString()]||C.contactID;c.setId(C.contactID).setName(s);e.getSource().setValue(s);c._setAccountIfNotSetAlready(this,C)},onUploadFile:function(e){var a=e.getParameter("d");if(!a)a=e.getParameters();cus.crm.mytasks.util.Attachments.EditPage.uploadFileToTask(this,a)},onRenameFile:function(e){var a=e.getParameter("d");if(!a)a=e.getParameters();var d=(a.mediaURL||a.url).split("/");var p={path:d[d.length-2],entry:{Name:a.newFilename+a.parsedFileExtension,Documentid:a.fileId,Documentclass:a.docClass,HeaderGuid:a.taskGuid}};var P=[d[d.length-2],d[d.length-1]].join("/"),o={entry:{newfilename:a.newFilename+a.parsedFileExtension,fileId:a.fileId,fileExtension:a.fileExtension},headers:{newfilename:a.newFilename},path:P};cus.crm.mytasks.util.Attachments.EditPage.renameFileOfTask(this,o)},onDeleteFile:function(e){var a=e.getParameter("d");if(!a)a=e.getParameters();cus.crm.mytasks.util.Attachments.EditPage.deleteFileFromTask(this,a)},onFileUploadFailed:function(e){var h=e.getParameter("exception").message;var j=e.getParameter("response").response(),E=j.jqXHR.responseJSON&&j.jqXHR.responseJSON.error;sap.ca.ui.message.showMessageBox({type:sap.ca.ui.message.Type.ERROR,message:h,details:E&&E.message.value})},onBeforeFileUpload:function(e){var a=e.getParameters(),f=a.name,d=f.split(".");if(d.length>1&&d[d.length-1]==="rar")this.getView().getModel().setHeaders({"Content-Type":"application/x-rar-compressed"})},onSaveClicked:function(e){if(sap.ui.version<"1.21.1"){}else jQuery.sap.log.debug("## Event has been deprecated from UI5 1.21.1 onwards")},onCancelClicked:function(e){if(sap.ui.version<"1.21.1"){}else jQuery.sap.log.debug("## Event has been deprecated from UI5 1.21.1 onwards")},_checkFor412StatusCode:function(e,l){var c=cus.crm.mytasks.util,b=c.Formatter.getResourceBundle();if(e.response.statusCode==="412"){jQuery.sap.log.debug("412 error occurred during"+l);var C=function(a){var c=cus.crm.mytasks.util;c.Util.requestBusyDialog();this.oSavedTask=undefined;this._getTaskHeaderInfo();this.prepareNewTask(this.oSavedTask);this.initializeDetailsPage(this.oSavedTask);var p={curType:typeof this.oSavedTask.PrivateAllowed,curValue:this.oSavedTask.PrivateAllowed};this._setPrivacyForTask(p,c.Schema,c.TechnicalInfoUtil);c.Util.releaseBusyDialog()},o={icon:sap.m.MessageBox.Icon.ERROR,title:b.getText("S3_412_TITLE"),actions:[sap.m.MessageBox.Action.OK],onClose:jQuery.proxy(C,this),};sap.m.MessageBox.show(b.getText("S3_412_ERRORMSG"),o);c.Util.releaseBusyDialog()}else c.Util.onRequestFailed(e,l)},});
