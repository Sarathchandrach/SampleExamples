/*
 * Copyright (C) 2009-2014 SAP SE or an SAP affiliate company. All rights reserved
 */
jQuery.sap.require("cus.crm.notes.control.SectionList");jQuery.sap.require("cus.crm.notes.handler.ModelHandler");jQuery.sap.require("sap.ca.scfld.md.controller.BaseDetailController");jQuery.sap.require("sap.ca.ui.model.type.Date");jQuery.sap.require("sap.ca.ui.model.type.DateTime");jQuery.sap.require("sap.ca.ui.model.type.Time");jQuery.sap.require("sap.ca.ui.message.message");jQuery.sap.require("cus.crm.notes.util.Schema");jQuery.sap.require("cus.crm.notes.util.Util");jQuery.sap.require("sap.ca.ui.JS.jquery-ui-widget");jQuery.sap.require("sap.ca.ui.JS.jquery-iframe-transport");jQuery.sap.require("sap.ca.ui.JS.jquery-fileupload");sap.ca.scfld.md.controller.BaseDetailController.extend("cus.crm.notes.view.S3",{oModelHandler:null,onExit:function(){this.oModelHandler.onExit();if(this.oCreateAppointmentDialog){this.oCreateAppointmentDialog.destroy()}if(this.oCreateTaskDialog){this.oCreateTaskDialog.destroy()}if(this.oContactSelectDialog){this.oContactSelectDialog.destroy()}if(this.oAddToDialog){this.oAddToDialog.destroy()}if(this.oAccountSelectDialog){this.oAccountSelectDialog.destroy()}if(this.oDataLossDialog){this.oDataLossDialog.destroy()}},onInit:function(){sap.ca.scfld.md.controller.BaseDetailController.prototype.onInit.call(this);this.oModelHandler=new cus.crm.notes.handler.ModelHandler();this.oModelHandler.networkErrorCallback=jQuery.proxy(this.openNetworkErrorDialog,this);this.oModelHandler.exceptionCallback=jQuery.proxy(this.openExceptionDialog,this);this.oModel=this.getView().getModel();this.oRouter.attachRouteMatched(jQuery.proxy(function(e){if(e.getParameter("name")==="detail"){this.oModelHandler.attachView(e.getParameter("arguments").contextPath,this.getView());if(this.getView().getModel().getProperty("/"+e.getParameter("arguments").contextPath)){this._saveETag(this.getView().getModel().getProperty("/"+e.getParameter("arguments").contextPath).Etag)}else{this.oModel.read("/NoteHeaders",null,null,false,function(d,r){for(var k=0;k<d.results.length;k++){if("NoteHeaders('"+d.results[k].NoteGuid+"')"==e.getParameter("arguments").contextPath)if(this._saveETag){this._saveETag(d.results[k].Etag)}else{this.sETag=d.results[k].Etag}}})}this._oSectionList.removeSelections(true);this.oHeaderFooterOptions.sDetailTitle=this.oModelHandler.getTeaserText();this.setHeaderFooterOptions(this.oHeaderFooterOptions);this._iTextAreaToFocus=0;this._iTextAreaToFocusCursorPos=0;jQuery.sap.delayedCall(20,this,function(){if(this.noDataFlag){this.noDataFlag=false;this._oSectionList.invalidate()}})}else if(e.getParameter("name")==="noData"){this.noDataFlag=true}},this),this);this._iAutoSaveTimeout=30000;this._iAutoSaveID=-1;this._bWaitingToAutoSave=false;this._isBlurCalled=false;this._oSectionList=this.byId("sectionList");this._iTextAreaToFocus=-1;this._iTextAreaToFocusCursorPos=-1;this._oListOnAfterRenderingDelegate={onAfterRendering:function(){if(this._oSectionList.getItems().length>0&&this._iTextAreaToFocus>=0){setTimeout(jQuery.proxy(this.handleFocus,this),150)}}};this._oSectionList.addEventDelegate(this._oListOnAfterRenderingDelegate,this);var t=this;this.oHeaderFooterOptions3UI={buttonList:[{sI18nBtnTxt:this._get_i18n_Text("DETAIL_BUTTON_DELETE"),onBtnPressed:function(e){t.displayDataLoss(e)}},{sI18nBtnTxt:this._get_i18n_Text("DETAIL_BUTTON_ADDTO"),onBtnPressed:function(e){t.openAddToDialog(e)}},{sI18nBtnTxt:this._get_i18n_Text("DETAIL_BUTTON_CREATEAPPOINTMENT"),onBtnPressed:function(e){t.navToAppointments(e)},},{sI18nBtnTxt:this._get_i18n_Text("DETAIL_BUTTON_CREATETASK"),onBtnPressed:function(e){t.navToTasks(e)}}],oJamOptions:{oShareSettings:{object:{id:"",share:""}},fGetShareSettings:function(){return{object:{id:"",share:t._getSelectedText()}}}},oEmailSettings:{fGetMailBody:function(){return t._getSelectedText()}},oAddBookmarkSettings:{icon:"sap-icon://Fiori2/F0006"},sDetailTitle:""};this.oHeaderFooterOptions4UI={buttonList:[{sI18nBtnTxt:this._get_i18n_Text("DETAIL_BUTTON_DELETE"),onBtnPressed:function(e){t.displayDataLoss(e)}},{sI18nBtnTxt:this._get_i18n_Text("DETAIL_BUTTON_ADDTO"),onBtnPressed:function(e){t.openAddToDialog(e)}},{sI18nBtnTxt:this._get_i18n_Text("DETAIL_BUTTON_CREATEAPPOINTMENT"),onBtnPressed:function(e){t.navToAppointmentDialog(e)},},{sI18nBtnTxt:this._get_i18n_Text("DETAIL_BUTTON_CREATETASK"),onBtnPressed:function(e){t.navToTaskDialog(e)}}],oJamOptions:{oShareSettings:{object:{id:"",share:""}},fGetShareSettings:function(){return{object:{id:"",share:t._getSelectedText()}}}},oEmailSettings:{fGetMailBody:function(){return t._getSelectedText()}},oAddBookmarkSettings:{icon:"sap-icon://Fiori2/F0006"},sDetailTitle:""};this.sBackendVersion=cus.crm.notes.util.Schema._getServiceSchemaVersion(this.oModel,"NoteHeader");this.oVersioningModel=new sap.ui.model.json.JSONModel({});this._loadVersionSpecificUI(this.sBackendVersion);if(this.extHookGetHeaderFooterOptions)this.extHookGetHeaderFooterOptions(oHeaderFooterOptions);this.setHeaderFooterOptions(this.oHeaderFooterOptions)},_loadVersionSpecificUI:function(b){if(parseFloat(b)>=2){this.oHeaderFooterOptions=this.oHeaderFooterOptions4UI}else{this.oHeaderFooterOptions=this.oHeaderFooterOptions3UI}},_loadWave3UI:function(){},_loadWave4UI:function(){},handleFocus:function(){var $=this._oSectionList.getItems()[this._iTextAreaToFocus].$().find("textarea");$.focus();$.prop("selectionStart",this._iTextAreaToFocusCursorPos);$.prop("selectionEnd",this._iTextAreaToFocusCursorPos)},navToSubview:function(){this.oRouter.navTo("subDetail",{contextPath:this.getView().getBindingContext().sPath.substr(1)})},navToEmpty:function(){this.oRouter.navTo("noData")},destroy:function(){if(sap.ca.scfld.md.controller.BaseDetailController.prototype.destroy){sap.ca.scfld.md.controller.BaseDetailController.prototype.destroy.apply(this)}this._oSectionList.removeEventDelegate(this._oListOnAfterRenderingDelegate);if(this._oNetworkErrorMessageDialog)this._oNetworkErrorMessageDialog.destroy();if(this.oSharingDialogComponent)this.oSharingDialogComponent.destroy()},checkEtag:function(f){this.bForceUpdate=f;var n=parseFloat(this.sBackendVersion);var e=null;if(n>=2.0){e={sETag:((f)?"*":null)}}else{f=false}this.oETag=e},handleSectionChange:function(e){if(!this._isBlurCalled){this._cancelAutoSave();var p=e.getSource().getBindingContext("json").getPath();this.checkEtag(false);this.oModelHandler.updateSection(p,false,this.oETag,this);this.refreshDetailTitle();sap.ui.getCore().getEventBus().publish("cus.crm.notes","SectionChanged",{context:true})}else{this._isBlurCalled=false}},handleSectionLiveChange:function(e){this.checkEtag(false);var t=e.getSource();var p=t.getBindingContext("json").getPath();var a=t.getValue();var s=a.indexOf("\n\n");var d=t.getDomRef();var b=$(d).find("textarea");var c=undefined;if(s!=-1){var l=this.getView().byId("sectionList");var i=l.indexOfItem(t.getParent());this._cancelAutoSave();this._iTextAreaToFocus=i+1;this._iTextAreaToFocusCursorPos=0;sap.ui.getCore().getEventBus().publish("cus.crm.notes","SectionChanged",{context:true});this.oModelHandler.splitSection(p,s);this.refreshDetailTitle();setTimeout(this.enableScrolling(this.getPage().getScrollDelegate()),50)}else{this._iTextAreaToFocusCursorPos=b.prop("selectionStart");b[0].style.overflow="auto";b[0].style.height="100%";b[0].style.height=b[0].scrollHeight+'px';b[0].style.overflow="hidden";if(!this._bWaitingToAutoSave){this._bWaitingToAutoSave=true;this._iAutoSaveID=setTimeout(jQuery.proxy(function(){this._autoSave(t)},this),this._iAutoSaveTimeout)}}},enableScrolling:function(s){s.onBeforeRendering();s.onAfterRendering()},handleDeleteSection:function(){if(this.oDataLossDialog)this.oDataLossDialog.close();var l=this.getView().byId("sectionList"),a=l.getItems(),I=undefined;if(1===1){var b=[];for(var i=a.length-1;i>=0;i--){if(a[i].getSelected()==true){I=i-1;var p=a[i].getBindingContext("json").getPath();b.push(p)}}if(I<0){this._iTextAreaToFocus=0}else{this._iTextAreaToFocus=I}if(b.length===0||b.length===a.length||a===0){sap.ui.getCore().getEventBus().publish("cus.crm.notes","DeleteNote",{path:this.getView().getBindingContext().getPath()});this.oModelHandler.oJSONModel.getData().navNoteSection=[];if(jQuery.device.is.phone){this._navBack()}}else{this.oModelHandler.deleteSections(b);this.refreshDetailTitle()}this._oSectionList.removeSelections(true)}},cancelDeleteSection:function(){this.oDataLossDialog.close()},mergeHandler:function(e){this._cancelAutoSave();var p=e.getSource().getBindingContext("json").getPath();var f=null;var s=null;var l=this.getView().byId("sectionList");var a=l.getItems();switch(e.getParameter("Key")){case"backspace":s=p;for(var i=1;i<a.length;i++){if(a[i].getBindingContext("json").getPath()==s){f=a[i-1].getBindingContext("json").getPath();this._iTextAreaToFocus=i-1;this._iTextAreaToFocusCursorPos=a[i-1].$().find("textarea").val().length;a[i].setSelected(false)}}break;case"delete":f=p;for(var i=0;i<a.length-1;i++){if(a[i].getBindingContext("json").getPath()==f){s=a[i+1].getBindingContext("json").getPath();this._iTextAreaToFocus=i;this._iTextAreaToFocusCursorPos=a[i].$().find("textarea").val().length;a[i+1].setSelected(false)}}break}if(f!=null&&s!=null){this.oModelHandler.mergeSection(f,s);this.refreshDetailTitle()}setTimeout(this.enableScrolling(this.getPage().getScrollDelegate()),50)},_autoSave:function(t){var p=t.getBindingContext("json").getPath();this.checkEtag(false);this.oModelHandler.updateSection(p,false,this.oETag,this);this.refreshDetailTitle();this._bWaitingToAutoSave=false},_cancelAutoSave:function(){clearTimeout(this._iAutoSaveID);this._bWaitingToAutoSave=false},displayDataLoss:function(e){if(!this.oDataLossDialog){this.oDataLossDialog=sap.ui.xmlfragment("cus.crm.notes.view.DataLossDialog",this);this.oDataLossDialog.setModel(this.getView().getModel());this.oDataLossDialog.setModel(this.getView().getModel("i18n"),"i18n")}var l=this.getView().byId("sectionList"),a=l.getSelectedItems().length;if(a>=1){this.oDataLossDialog.getContent()[0].getContent()[0].setText(sap.ca.scfld.md.app.Application.getImpl().getResourceBundle().getText("DELETE_SELECTED_NOTE_QUESTION"))}else{this.oDataLossDialog.getContent()[0].getContent()[0].setText(sap.ca.scfld.md.app.Application.getImpl().getResourceBundle().getText("DELETE_ALL_NOTE_QUESTION"))}this.oDataLossDialog.open()},navToAppointmentDialog:function(e){this.oActionSheet=sap.ui.xmlfragment("cus.crm.notes.view.ProcessTypeDialog",this);this.oActionSheet.setModel(this.getView().getModel("i18n"),"i18n");var m=this.getView().getModel();var j=new sap.ui.model.json.JSONModel();var d;m.read(((parseFloat(this.sBackendVersion)>=3)?"ApptTransactionTypeSet":"ApptTransactionTypes"),null,null,false,function(D,r){d={ProcessTypes:r.data.results}});this.appointmentFlag=true;if(d.ProcessTypes.length==0){this.appointmentFlag=false;sap.ca.ui.message.showMessageBox({type:sap.ca.ui.message.Type.ERROR,message:sap.ca.scfld.md.app.Application.getImpl().getResourceBundle().getText("FOLLOWUPERROR"),details:sap.ca.scfld.md.app.Application.getImpl().getResourceBundle().getText("FOLLOWUPERROR")})}else if(d.ProcessTypes.length==1){this.onlyOneAppointmentProcessType=true;this.processType=d.ProcessTypes[0].ProcessTypeCode;this.ProcessTypeDescription=d.ProcessTypes[0].Description;this.privateFlag=d.ProcessTypes[0].PrivateFlag;this.selectProcess()}else{j.setData(d);this.oActionSheet.setModel(j,"json");this.oActionSheet._searchField.setPlaceholder(sap.ca.scfld.md.app.Application.getImpl().getResourceBundle().getText("SEARCH"));this.oActionSheet._list.setGrowingScrollToLoad(true);this.oActionSheet._dialog.setVerticalScrolling(true);this.oActionSheet.open()}},navToTaskDialog:function(e){this.oActionSheet=sap.ui.xmlfragment("cus.crm.notes.view.ProcessTypeDialog",this);this.oActionSheet.setModel(this.getView().getModel("i18n"),"i18n");var m=this.getView().getModel();var j=new sap.ui.model.json.JSONModel();var d;m.read(((parseFloat(this.sBackendVersion)>=3)?"TaskTransactionTypeSet":"TaskTransactionTypes"),null,null,false,function(D,r){d={ProcessTypes:r.data.results}});this.appointmentFlag=false;if(d.ProcessTypes.length==0){sap.ca.ui.message.showMessageBox({type:sap.ca.ui.message.Type.ERROR,message:sap.ca.scfld.md.app.Application.getImpl().getResourceBundle().getText("FOLLOWUPERROR"),details:sap.ca.scfld.md.app.Application.getImpl().getResourceBundle().getText("FOLLOWUPERROR")})}else if(d.ProcessTypes.length==1){this.onlyOneTaskProcessType=true;this.processType=d.ProcessTypes[0].ProcessTypeCode;this.ProcessTypeDescription=d.ProcessTypes[0].Description;this.privateFlag=d.ProcessTypes[0].PrivateFlag;this.selectProcess()}else{j.setData(d);this.oActionSheet.setModel(j,"json");this.oActionSheet._searchField.setPlaceholder(sap.ca.scfld.md.app.Application.getImpl().getResourceBundle().getText("SEARCH"));this.oActionSheet._list.setGrowingScrollToLoad(true);this.oActionSheet._dialog.setVerticalScrolling(true);this.oActionSheet.open()}},searchProcess:function(e){var v=e.getParameter("value");if(v!==undefined){e.getParameter("itemsBinding").filter([new sap.ui.model.Filter("Description",sap.ui.model.FilterOperator.Contains,v)])}},selectProcess:function(e){var i=this._getSelectedItemPaths();if(!(this.onlyOneAppointmentProcessType||this.onlyOneTaskProcessType)){var s=e.getParameter("selectedItem");if(s){this.processType=s.data("ProcessTypeCode");this.ProcessTypeDescription=s.data("ProcessTypeDescription");this.privateFlag=s.data("PrivateFlag")}}var f=sap.ushell&&sap.ushell.Container&&sap.ushell.Container.getService;this.oCrossAppNavigator=f&&f("CrossApplicationNavigation");if(this.appointmentFlag){var t=this.oCrossAppNavigator&&this.oCrossAppNavigator.hrefForExternal({target:{semanticObject:"Appointment",action:"myAppointments"},params:{"processType":this.processType,"createFromNote":"X","itemPaths":i,}})||"";window.location=t;this.appointmentFlag=false}else{var c=this.getView().getBindingContext();var t=this.oCrossAppNavigator&&this.oCrossAppNavigator.hrefForExternal({target:{semanticObject:"Task",action:"manageTasks"},appSpecificRoute:["&","newTask",this.processType].join("/"),params:{"processType":this.processType,"createFromNote":"X","itemPaths":i}})||"";window.location=t;this.appointmentFlag=false}},navToAppointments:function(e){var i=this._getSelectedItemPaths();var f=sap.ushell&&sap.ushell.Container&&sap.ushell.Container.getService;this.oCrossAppNavigator=f&&f("CrossApplicationNavigation");var t=this.oCrossAppNavigator&&this.oCrossAppNavigator.hrefForExternal({target:{semanticObject:"Appointment",action:"myAppointments"},params:{"createFromNote":"X","itemPaths":i}})||"";window.location=t},navToTasks:function(e){var i=this._getSelectedItemPaths();var f=sap.ushell&&sap.ushell.Container&&sap.ushell.Container.getService;this.oCrossAppNavigator=f&&f("CrossApplicationNavigation");var t=this.oCrossAppNavigator&&this.oCrossAppNavigator.hrefForExternal({target:{semanticObject:"Task",action:"manageTasks"},params:{"createFromNote":"X","itemPaths":i}})||"";window.location=t},_get_i18n_Text:function(t){return this.oApplicationFacade.getResourceBundle().getText(t)},_getSelectedText:function(){var i=this._getSelectedItemPaths();var s=this.oModelHandler.getSectionsText(i);return s},_getSelectedItemPaths:function(){var l=this.getView().byId("sectionList");var a=l.getItems();var A=[];var I=[];var s=true;var p=null;for(var i=0;i<a.length;i++){p=a[i].getBindingContext("json").getPath();if(a[i].getSelected()){s=false;I.push(p)}if(s){A.push(p)}}if(s){I=A}return I},refreshDetailTitle:function(){this._setDetailTitel(null,null,{context:this.oModelHandler.getFirstSectionText()})},_setDetailTitel:function(c,e,d){if(d.context===""){d.context=this._get_i18n_Text("DETAIL_TITLE")}this.oHeaderFooterOptions.sDetailTitle=d.context;this.setHeaderFooterOptions(this.oHeaderFooterOptions)},openDialog:function(d,f,m,b,g,F){d=this.getDialog(d,f);if(g){d._list.setGrowing(true);d._list.setGrowingScrollToLoad(true);d._list.setGrowingThreshold(20)}this.bindAggregation(d,b,F);d.setModel(this.getView().getModel());d.setModel(this.getView().getModel("i18n"),"i18n");d.setModel(m,"model");if(F){d.open(F.oValue1)}else{d.open()}return d},getDialog:function(d,f){if(!d){d=sap.ui.xmlfragment(f,this)}return d},bindAggregation:function(d,b,f){var F=[];if(f){F.push(f)}if(b){d.bindAggregation("items",{path:b,template:d.getBindingInfo("items").template,filters:F})}else{if(F.length>0){d.getBinding("items").filter(F)}}},createEntry:function(e,b){var t=this;var m=this.getView().getModel();jQuery.sap.require("sap.m.MessageToast");var a=this._get_i18n_Text("MSG_CREATION_OBJECT_SUCCESS");if(b==="/Appointments"){a=this._get_i18n_Text("MSG_UPDATING_APPOINTMENT_SUCCESS")}else{if(b==="/Tasks"){a=this._get_i18n_Text("MSG_UPDATING_TASK_SUCCESS")}}m.create(b,e,null,function(){sap.m.MessageToast.show(a)},jQuery.proxy(function(){sap.m.MessageToast.show(t._get_i18n_Text("MSG_CREATION_OBJECT_FAILED"))}));m.refresh()},doSelectDialogSearch:function(d,f){var s=d._searchField.getProperty("value");var i=new sap.ui.model.Filter(f,sap.ui.model.FilterOperator.Contains,s);d.getBinding("items").filter([i])},updateProperty:function(d,p,P){if(d){var m=d.getModel('model');m.setProperty(p,P);d.setModel(m,'model')}},openNetworkErrorDialog:function(e){sap.ca.ui.message.showMessageBox({type:sap.ca.ui.message.Type.ERROR,message:this._get_i18n_Text("NETWORK_ERROR_MSG"),details:e},jQuery.proxy(this.okNetworkErrorDialog,this))},okNetworkErrorDialog:function(e){var t=this;var s=jQuery.proxy(function(){sap.m.MessageToast.show(t._get_i18n_Text("MSG_SYNCHRONIZATION_SUCCEEDED"),{at:sap.ui.core.Popup.Dock.CenterCenter})});this.oModelHandler.retryBatchOperations(s)},openExceptionDialog:function(e){sap.ca.ui.message.showMessageBox({type:sap.ca.ui.message.Type.ERROR,message:this._get_i18n_Text("EXCEPTION_ERROR_MSG"),details:e},jQuery.proxy(this.okExceptionDialog,this))},okExceptionDialog:function(e){var t=this;var s=jQuery.proxy(function(){sap.m.MessageToast.show(t._get_i18n_Text("MSG_CHANGES_DISCARDED"),{at:sap.ui.core.Popup.Dock.CenterCenter})});this.oModelHandler.discardBatchOperations(s)},openAddToDialog:function(e){this.getView().getModel().setCountSupported(true);var m=new sap.ui.model.json.JSONModel();var d={text:this._getSelectedText()};m.setData(d);this.oAddToDialog=this.openDialog(this.oAddToDialog,"cus.crm.notes.view.AddToDialog",m)},getOpportunityList:function(){return sap.ui.getCore().byId("opportunityList")},doSearchOpportunity:function(e){var f=e.getParameters().query;var b=this.getOpportunityList().getBinding("items");var d=new sap.ui.model.Filter("Description",sap.ui.model.FilterOperator.Contains,f);var F=[d];b.filter(F)},cancelAddToDialog:function(e){this.closeAddToDialog()},closeAddToDialog:function(){this.oAddToDialog.close();this.oAddToDialog.destroy();this.oAddToDialog=undefined;this.getView().getModel().setCountSupported(false)},navigateToOpportunities:function(e){var n=this.oAddToDialog.getContent()[0];n.to("page2","slide",e.getSource().getBindingContext())},navigateFromOpportunities:function(e){var n=this.oAddToDialog.getContent()[0];n.back(e.getSource().getBindingContext())},triggerOkButtonVisibility:function(e){if(e.getParameter('fromId')=='page2'){this.oAddToDialog.destroyBeginButton()}else{this.oAddToDialog.setBeginButton(new sap.m.Button({text:this._get_i18n_Text('ADD_TO_OK'),enabled:false,press:jQuery.proxy(function(){this.okAddToDialog()},this)}))}},handleOpportunityPress:function(e){var i=e.getSource().getSelected();e.getSource().setSelected(!i);if(i==false){this.oAddToDialog.getBeginButton().setEnabled(true)}else{this.oAddToDialog.getBeginButton().setEnabled(false)}},okAddToDialog:function(e){var m=this.getView().getModel();var p=null;var E=null;var t=this;var o=this.getOpportunityList();var s=o.getSelectedItems();for(var i=0;i<s.length;i++){p={fnSuccess:jQuery.proxy(function(){sap.m.MessageToast.show(t._get_i18n_Text("MSG_UPDATING_OPPORTUNITY_SUCCEEDED").replace("{0}",s[i].getProperty("title")))}),fnError:jQuery.proxy(function(){sap.m.MessageToast.show(t._get_i18n_Text("MSG_UPDATING_OPPORTUNITY_FAILED").replace("{0}",s[i].getProperty("title")))})};E={Guid:s[i].getBindingContext().getProperty('Guid'),Content:this.oAddToDialog.getModel('model').getData().text};m.update(s[i].getBindingContext().getPath(),E,p)}this.closeAddToDialog()},displayAccounts:function(e){var m=e.getSource().getModel('model');var a=m.getData().accountName;var f=null;var b="/AccountCollection";if(a){f=new sap.ui.model.Filter("name1",sap.ui.model.FilterOperator.Contains,a)}this.oAccountSelectDialog=this.openDialog(this.oAccountSelectDialog,"cus.crm.notes.view.AccountSelectDialog",m,b,true,f)},doSearchAccount:function(e){this.doSelectDialogSearch(e.getSource(),"name1")},selectAccount:function(e){var d=null;if(this.oCreateAppointmentDialog&&this.oCreateAppointmentDialog.isOpen())d=this.oCreateAppointmentDialog;else if(this.oCreateTaskDialog&&this.oCreateTaskDialog.isOpen())d=this.oCreateTaskDialog;if(d){if(e.getParameter("selectedItem").data("id")!=d.getModel('model').getData().accountId){this.updateProperty(d,"/contactEntered",false);this.updateProperty(d,"/contactId","");this.updateProperty(d,"/contactName","")};var h='#accountHorizontalLayout'+d.getModel('model').getData().id;cus.crm.notes.util.DomHelper.replaceCssClassById(h,'customSelectField','customSelectFieldRemoveIcon');this.updateProperty(d,"/accountEntered",true);this.updateProperty(d,"/accountId",e.getParameter("selectedItem").data("id"));this.updateProperty(d,"/accountName",e.getParameter("selectedItem").getProperty('title'));d.getModel('model').refresh()}},deleteAccount:function(e){var d=null;if(this.oCreateAppointmentDialog&&this.oCreateAppointmentDialog.isOpen())d=this.oCreateAppointmentDialog;else if(this.oCreateTaskDialog&&this.oCreateTaskDialog.isOpen())d=this.oCreateTaskDialog;if(d){var h='#accountHorizontalLayout'+d.getModel('model').getData().id;cus.crm.notes.util.DomHelper.replaceCssClassById(h,'customSelectFieldRemoveIcon','customSelectField');this.updateProperty(d,"/accountEntered",false);this.updateProperty(d,"/accountId","");this.updateProperty(d,"/accountName","");var c='#contactHorizontalLayout'+d.getModel('model').getData().id;cus.crm.notes.util.DomHelper.replaceCssClassById(c,'customSelectFieldRemoveIcon','customSelectField');this.updateProperty(d,"/contactEntered",false);this.updateProperty(d,"/contactId","");this.updateProperty(d,"/contactName","");d.getModel('model').refresh()}},displayContacts:function(e){var m=e.getSource().getModel('model');var a=m.getData().accountId;var b=m.getData().accountName;var c=m.getData().contactName;var f=null;var B=null;var s=false;if(a&&a!==""){B="/AccountCollection('"+a+"')/Contacts";s=true}else{B="/ContactCollection"}if(c){f=new sap.ui.model.Filter("lastName",sap.ui.model.FilterOperator.Contains,c)}this.oContactSelectDialog=this.openDialog(this.oContactSelectDialog,"cus.crm.notes.view.ContactSelectDialog",m,B,true,f);this.oContactSelectDialog._list.setInfoToolbar(new sap.m.Toolbar({visible:s,active:true,content:[new sap.m.Label({text:this._get_i18n_Text("CONTACT_SEARCH_FILTERED")+": "+b})]}))},removeContactFilter:function(e){e.getSource().setVisible(false);e.getSource().getParent().bindAggregation("items",{path:"/ContactCollection",template:e.getSource().getParent().getBindingInfo("items").template,filters:e.getSource().getParent().getBindingInfo("items").filters})},doSearchContact:function(e){this.doSelectDialogSearch(e.getSource(),"lastName")},selectContact:function(e){var d=null;if(this.oCreateAppointmentDialog&&this.oCreateAppointmentDialog.isOpen())d=this.oCreateAppointmentDialog;else if(this.oCreateTaskDialog&&this.oCreateTaskDialog.isOpen())d=this.oCreateTaskDialog;if(d){var h='#contactHorizontalLayout'+d.getModel('model').getData().id;cus.crm.notes.util.DomHelper.replaceCssClassById(h,'customSelectField','customSelectFieldRemoveIcon');this.updateProperty(d,"/contactEntered",true);this.updateProperty(d,"/contactId",e.getParameter("selectedItem").data("id"));this.updateProperty(d,"/contactName",e.getParameter("selectedItem").getProperty('title'));if(d.getModel('model').getData().accountId==null||d.getModel('model').getData().accountId==""){this.updateProperty(d,"/accountFieldWidth","22rem");this.updateProperty(d,"/accountEntered",true);this.updateProperty(d,"/accountId",e.getParameter("selectedItem").data("accountId"));this.updateProperty(d,"/accountName",e.getParameter("selectedItem").data("accountName"))}d.getModel('model').refresh()}},deleteContact:function(e){var d=null;if(this.oCreateAppointmentDialog&&this.oCreateAppointmentDialog.isOpen())d=this.oCreateAppointmentDialog;else if(this.oCreateTaskDialog&&this.oCreateTaskDialog.isOpen())d=this.oCreateTaskDialog;if(d){var h='#contactHorizontalLayout'+d.getModel('model').getData().id;cus.crm.notes.util.DomHelper.replaceCssClassById(h,'customSelectFieldRemoveIcon','customSelectField');this.updateProperty(d,"/contactEntered",false);this.updateProperty(d,"/contactId","");this.updateProperty(d,"/contactName","");d.getModel('model').refresh()}},handleSectionAddPicture:function(e){var l=this.getView().byId("sectionList");var a=l.getItems();var u=null;var p=null;var s=0;for(var i=0;i<a.length;i++){if(a[i].getSelected()){s++;p=a[i].getBindingContext("json").getPath();u=this.oModelHandler.getSectionAttachmentUploadUrl(p)}}if(s===0){}else if(s===1){this.uploadFile(u)}else{sap.ca.ui.message.showMessageBox({type:sap.ca.ui.message.Type.ERROR,message:this._get_i18n_Text("MSG_SELECT_ONE_SECTION")})}},uploadFile:function(u){var h=this.getView().getId()+'--addPicture'+'-capture';var H=jQuery("#"+h);H.fileupload({multipart:false,url:u,type:"PUT",add:jQuery.proxy(function(e,d){this.onAdd(e,d)},this),done:jQuery.proxy(function(e,d){this.uploadDone(e,d)},this),fail:jQuery.proxy(function(e,d){this.handleUploadFailure(e,d)},this),beforeSend:jQuery.proxy(function(x,d){this._setRequestHeaders(x)},this)});jQuery.sap.domById(h).click()},onAfterRendering:function(e){},_setRequestHeaders:function(x){x.setRequestHeader("Accept","application/json");if(this.getXsrfToken()){x.setRequestHeader('x-csrf-token',this.getXsrfToken())}},getXsrfToken:function(){var t=this.getView().getModel().getHeaders()['x-csrf-token'];if(!t){this.getView().getModel().refreshSecurityToken(function(e,o){t=o.headers['x-csrf-token']},function(){sap.ca.ui.message.showMessageBox({type:sap.ca.ui.message.Type.ERROR,message:'Could not get XSRF token',details:''})},false)}return t},handleUploadFailure:function(e,d){},onAdd:function(e,d){d.submit()},uploadDone:function(e,d){this.oModelHandler.readSections()},_saveETag:function(e){this.sETag=e}});
