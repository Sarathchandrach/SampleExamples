/*
 * Copyright (C) 2009-2014 SAP SE or an SAP affiliate company. All rights reserved
 */
jQuery.sap.require("sap.ca.scfld.md.controller.ScfldMasterController");jQuery.sap.require("cus.crm.notes.handler.ModelHandler");jQuery.sap.require("sap.ca.ui.model.type.Date");jQuery.sap.require("sap.ca.ui.message.message");jQuery.sap.require("cus.crm.notes.util.Util");sap.ca.scfld.md.controller.ScfldMasterController.extend("cus.crm.notes.view.S2",{oModelHandler:null,onInit:function(){var v=this.getView();this.oModelHandler=new cus.crm.notes.handler.ModelHandler();v.getModel()._isRefreshNeeded=function(r){if(r.requestUri.indexOf("$batch")!=-1&&r.async==true){return false}return sap.ui.model.odata.ODataModel.prototype._isRefreshNeeded(r)};this.oSortingOptions={alphabetical:{path:"TeaserText",descending:false},date:{path:"ChangedAt",descending:true},};this.oDefaultSorting=this.oSortingOptions.date;this.oCurrentSorting=this.oDefaultSorting;var b=sap.ui.getCore().getEventBus();b.subscribe("cus.crm.notes","SectionChanged",this.handleSectionChanged,this);b.subscribe("cus.crm.notes","DeleteNote",this.handleDeleteNote,this);this.bSectionChanged=false;this.bHeaderAdded=false;this.bHeaderAddedListed=false;this.bSelectFirstItemAfterChange=false;this.bSelectFirstItemAfterAdd=false;this.bRequestCompleted=false;this.bFilterActive=false;v.getModel().attachRequestSent(this.handleRequestSent,this);v.getModel().attachRequestCompleted(this.handleRequestCompleted,this);this.oMHFHelper=this.oApplicationFacade.oApplicationImplementation.oMHFHelper;this.fnSuperHandleMasterSearch=this.oMHFHelper.handleMasterSearch;this.oMHFHelper.handleMasterSearch=jQuery.proxy(function(c,e){var s=jQuery.extend({},e);this.oModelHandler.emptyBatchCallback=jQuery.proxy(function(){this.oModelHandler.emptyBatchCallback=function(){};this.fnSuperHandleMasterSearch.call(this.oMHFHelper,c,s)},this)},this);this.bPreventSetStoredSelectedItem=false;this.fnSuperSetStoredSelectedItem=this.oApplicationFacade.oApplicationImplementation.setStoredSelectedItem;this.oApplicationFacade.oApplicationImplementation.setStoredSelectedItem=jQuery.proxy(function(c){if(this.bPreventSetStoredSelectedItem){this.bPreventSetStoredSelectedItem=false}else{this.fnSuperSetStoredSelectedItem.call(this.oApplicationImplementation,this)}},this);this.getList().getBinding("items").attachChange(this.handleMasterListChanged,this);sap.ca.ui.utils.busydialog.releaseBusyDialog()},onExit:function(){this.checkDeleteAddedNote();var b=sap.ui.getCore().getEventBus();b.unsubscribe("cus.crm.notes","SectionChanged",this.handleSectionChanged,this);b.unsubscribe("cus.crm.notes","DeleteNote",this.handleDeleteNote,this);this.getView().getModel().detachRequestCompleted(this.handleRequestCompleted,this);this.getView().getModel().detachRequestSent(this.handleRequestSent,this);this.getList().getBinding("items").detachChange(this.handleMasterListChanged,this);this._oMasterListBinding.detachChange(this._onMasterListChanged,this);this.oMHFHelper.handleMasterSearch=this.fnSuperHandleMasterSearch;this.oApplicationFacade.oApplicationImplementation.setStoredSelectedItem=this.fnSuperSetStoredSelectedItem},onDataLoaded:function(){sap.ca.scfld.md.controller.ScfldMasterController.prototype.onDataLoaded.call(this);if(!this.bRequestCompleted){if(this.getList().getItems().length===0){this.addNote()}}this.bRequestCompleted=false;if(this.getList().getItems().length===0){this.navToEmptyView()}},setListItem:function(i){if(i===null){return}var p=i.getBindingContext().getPath();this.selectedNoteGuid=i.getModel().getProperty(p).NoteGuid;sap.ca.scfld.md.controller.ScfldMasterController.prototype.setListItem.call(this,i);if(!this.bIsReturningFromAddInSearch)this.checkDeleteAddedNote();else this.bIsReturningFromAddInSearch=false},applySearchPatternToListItem:function(i,f){if(f.substring(0,1)==="#"){var t=f.substr(1);var d=i.getBindingContext().getProperty("Name").toLowerCase();return d.indexOf(t)===0}else{return sap.ca.scfld.md.controller.ScfldMasterController.prototype.applySearchPatternToListItem.call(null,i,f)}},applyBackendSearchPattern:function(f,b){this.checkDeleteAddedNote();this.bSelectFirstItemAfterChange=true;this.bFilterActive=(f!="");if(f!=""){var t=new sap.ui.model.Filter("TeaserText",sap.ui.model.FilterOperator.Contains,f);var F=[t];b.filter(F)}else{var F=[];b.filter(F)}},isBackendSearch:function(){return true},applyFilterFromContext:function(c){},getHeaderFooterOptions:function(){var h={sI18NMasterTitle:"MASTER_TITLE",sI18NSearchFieldPlaceholder:this.get_i18n_Text("NOTE_SEARCH_PLACEHOLDER"),oSortOptions:{aSortItems:[{key:this.oSortingOptions.alphabetical.path,text:this.get_i18n_Text("SORTING_POPOVER_ALPHABETICAL")},{key:this.oSortingOptions.date.path,text:this.get_i18n_Text("SORTING_POPOVER_DATE")}],sSelectedItemKey:this.oCurrentSorting.path,onSortSelected:jQuery.proxy(this.handleSort,this)},onAddPress:jQuery.proxy(this.handleAddPress,this)};if(this.extHookGetHeaderFooterOptions)this.extHookGetHeaderFooterOptions(h);return h},navToEmptyView:function(){var l=this.getList();l.removeSelections();this.oRouter.navTo("noData",{viewTitle:"DETAIL_TITLE",languageKey:"NO_ITEMS_AVAILABLE"},true);return this},handleMasterListChanged:function(e){var l=this.getList();if(l.getItems().length>0){if(this.bSelectFirstItemAfterChange){l.removeSelections(true);if(jQuery.device.is.phone){l.getItems()[0].setSelected(true)}else{this.selectFirstItem()}this.bSelectFirstItemAfterChange=false;this.bPreventSetStoredSelectedItem=true}else if(this.bSelectFirstItemAfterAdd){this.selectFirstItem();this.bSelectFirstItemAfterAdd=false;this.bPreventSetStoredSelectedItem=true}}},handleRequestSent:function(){this.getList().setNoDataText(this.get_i18n_Text("LOADING_TEXT"))},handleRequestCompleted:function(){this.bRequestCompleted=true;if(this.bFilterActive){this.getList().setNoDataText(this.get_i18n_Text("NO_MATCHING_ITEMS"))}else{this.getList().setNoDataText(this.get_i18n_Text("NO_DATA_TEXT"))}},handleAddPress:function(){this.oModelHandler.emptyBatchCallback=jQuery.proxy(function(){this.oModelHandler.emptyBatchCallback=function(){};this.addNote()},this)},handleSort:function(k){if(k===this.oSortingOptions.alphabetical.path){this.oCurrentSorting=this.oSortingOptions.alphabetical}else{this.oCurrentSorting=this.oSortingOptions.date}this.updateSorting(this.oCurrentSorting.path,this.oCurrentSorting.descending,false)},handleSectionChanged:function(c,e,d){this.bSectionChanged=d;if(this.bSectionChanged){this.bSectionChanged=false;this.bHeaderAdded=false;this.bHeaderAddedListed=false;this.sAddedNoteGuid=undefined}},handleDeleteNote:function(c,e,d){var m=this.getView().getModel();var n=m.getData(d.path).NoteGuid;if(n===this.sAddedNoteGuid){this.sAddedNoteGuid=undefined}this.addDeleteNoteOperation(m,d.path);if(this.getList().getItems()&&this.getList().getItems().length===1&&!this.bFilterActive){this.addCreateNoteOperation(m)}var E=jQuery.proxy(function(){sap.ca.ui.message.showMessageBox({type:sap.ca.ui.message.Type.ERROR,message:this.get_i18n_Text("MSG_DELETION_NOTE_FAILED"),details:this.get_i18n_Text("MSG_LONG_DELETION_OBJECT_FAILED")})},this);m.submitBatch(jQuery.proxy(function(D,r,a){if(a.length>0){E.call()}else{this.successBatchAdd(D,1);this.getList().getBinding("items").refresh();this.bSelectFirstItemAfterChange=true}},this),E,false)},get_i18n_Text:function(t){return this.oApplicationFacade.getResourceBundle().getText(t)},updateSorting:function(p,d,r){var l=this.getList();var b=l.getBinding("items");var s=new sap.ui.model.Sorter(p,d);b.sort([s]);if(r)b.refresh()},addNote:function(){if(this.bFilterActive){if(this._oMasterListBinding!==undefined){this._oControlStore.oMasterSearchField.clear();this.handleSort(this.oSortingOptions.date.path);this.bIsReturningFromAddInSearch=(this.getList().getItems().length>0)}}var m=this.getView().getModel();this.addCreateNoteOperation(m);var e=jQuery.proxy(function(){sap.ca.ui.message.showMessageBox({type:sap.ca.ui.message.Type.ERROR,message:this.get_i18n_Text("MSG_CREATION_NOTE_FAILED"),details:this.get_i18n_Text("MSG_LONG_CREATION_NOTE_FAILED")})},this);m.submitBatch(jQuery.proxy(function(d,r,E){if(E.length>0){e.call()}else{this.successBatchAdd(d,0);this.getList().getBinding("items").refresh();this.bSelectFirstItemAfterAdd=true}},this),e,false)},successBatchAdd:function(d,b){if(!d.__batchResponses[b]){return}var D=d.__batchResponses[b].__changeResponses[0].data;var a=D.NoteGuid;if(this.sAddedNoteGuid===undefined){this.sAddedNoteGuid=a;this.sAddedNoteGuidStore=undefined}else{this.sAddedNoteGuidStore=a}this.bHeaderAdded=true;this.oModelHandler.injectFirstSectionFromMaster(this.getView().getModel(),a)},addDeleteNoteOperation:function(m,p){var c=[];var P={};var e={};var o=m.createBatchOperation(p,"DELETE",e,P);c.push(o);m.addBatchChangeOperations(c)},addCreateNoteOperation:function(m){var c=[];var p={};var e={};e.TeaserType="T";e.TeaserText="";var o=m.createBatchOperation('/NoteHeaders',"POST",e,p);c.push(o);m.addBatchChangeOperations(c)},checkDeleteAddedNote:function(){if(this.bHeaderAddedListed&&!this.bSectionChanged){this.bHeaderAddedListed=false;var m=undefined;var p=undefined;var l=this.getView().byId("list");var a=l.getItems();for(var i=0;i<a.length;i++){var b=a[i].getBindingContext().getProperty().NoteGuid;if(b===this.sAddedNoteGuid){m=a[i].getBindingContext().getModel();p=a[i].getBindingContext().getPath();break}}if(m===undefined){if(this.bFilterActive===true){this.bHeaderAddedListed=true}return}var P={fnSuccess:function(){},fnError:jQuery.proxy(function(){sap.ca.ui.message.showMessageBox({type:sap.ca.ui.message.Type.ERROR,message:this.get_i18n_Text("MSG_DELETION_NOTE_FAILED"),details:this.get_i18n_Text("MSG_LONG_DELETION_OBJECT_FAILED")})},this)};m.remove(p,P);this.getList().getBinding("items").refresh();if(this.sAddedNoteGuidStore===undefined){this.sAddedNoteGuid=undefined;this.bHeaderAddedListed=false}else{this.sAddedNoteGuid=this.sAddedNoteGuidStore;this.sAddedNoteGuidStore=undefined;this.bHeaderAddedListed=true}this.bSectionChanged=false}else if(this.bHeaderAdded){this.bHeaderAddedListed=true;this.bHeaderAdded=false}},});
