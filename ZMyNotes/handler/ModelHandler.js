/*
 * Copyright (C) 2009-2014 SAP SE or an SAP affiliate company. All rights reserved
 */
jQuery.sap.declare("cus.crm.notes.handler.ModelHandler");jQuery.sap.require("cus.crm.notes.util.Util");sap.ui.base.ManagedObject.extend("cus.crm.notes.handler.ModelHandler",{oDataModel:{},oJSONModel:{},oJSONModels:[],aBatchStacks:[],isProcessing:false,sContextBindingPath:"",globalStepSize:100,maxSequenceNumber:9999,retryWaitingTime:5000,batchOperationsWaitingTime:100,maxRetryBatchOperations:10,retryBatchOperationsCount:0,retrySuccessFunction:null,stopBatchProcessing:false,constructor:function(){if(typeof cus.crm.notes.handler.ModelHandler.__instance==="object"){return cus.crm.notes.handler.ModelHandler.__instance}cus.crm.notes.handler.ModelHandler.__instance=this;setTimeout(jQuery.proxy(this.processBatchOperations,this),this.batchOperationsWaitingTime)},addBatchOperations:function(b){this.aBatchStacks.push(b)},getFirstBatchOperations:function(){if(this.aBatchStacks.length==0){return null}return this.aBatchStacks[0]},hasBatchOperations:function(){if(this.aBatchStacks.length==0){return false}return true},deleteFirstBatchOperations:function(){if(this.aBatchStacks.length>0){this.aBatchStacks.shift()}},retryBatchOperations:function(s){this.retrySuccessFunction=s;this.isProcessing=false},discardBatchOperations:function(s){this.aBatchStacks.length=0;this.isProcessing=false;this.readSections();s.apply(this)},updateBatchOperations:function(){for(var i=0;i<this.aBatchStacks.length;i++){var b=this.aBatchStacks[i];for(var j=0;j<b.length;j++){if(b[j].requestUri.indexOf("NoteSections")==0){if(b[j].method==="PUT"||b[j].method==="DELETE"){b[j].requestUri="NoteSections(SectionGuid='"+b[j].data.SectionGuid+"',NoteGuid='"+b[j].data.NoteGuid+"')"}}}}},processBatchOperations:function(){try{var b=this.getFirstBatchOperations();if(b){if(!this.isProcessing){this.isProcessing=true;try{for(var i=0;i<b.length;i++){this.oDataModel.addBatchChangeOperations([b[i]])}this.oDataModel.submitBatch(jQuery.proxy(this.processBatchResults,this),jQuery.proxy(this.handleNetworkError,this),true)}catch(e){this.handleBatchOperationException(e)}}}else{this.emptyBatchCallback()}}catch(e){this.handleBatchOperationException(e)}finally{if(!this.stopBatchProcessing){setTimeout(jQuery.proxy(this.processBatchOperations,this),this.batchOperationsWaitingTime)}}},processBatchResults:function(d,r,E){try{if(E&&E.length>0){if(E[0].response.statusCode=="412"){cus.crm.notes.util.Util.show412ErrorDialog(this,jQuery.proxy(function(){cus.crm.notes.util.Util.refreshHeaderETag(this.sContextBindingPath,this.os3Controller);this.oJSONModel.refresh();this.readSections();this.os3Controller.refreshDetailTitle()},this))}else this.handleBatchResultsError(E);return}if(d.__batchResponses[0].__changeResponses[0].statusCode=="204"&&this.isTeaserTextUpdate){var b=[];var B=this.oDataModel.createBatchOperation("","PUT",this.oSection);B.requestUri="NoteSections(SectionGuid='"+this.oSection.SectionGuid+"',NoteGuid='"+this.oSection.NoteGuid+"')";b.push(B);this.addBatchOperations(b);this.isTeaserTextUpdate=false}var b=this.getFirstBatchOperations();for(var i=0;i<b.length;i++){if(d.__batchResponses[i].__changeResponses[0].statusCode!="201"){}if(b[i].requestUri.indexOf("NoteSections")==0){if(b[i].method==="POST"){b[i].data.SectionGuid=d.__batchResponses[i].__changeResponses[0].data.SectionGuid}}}this.deleteFirstBatchOperations();this.updateBatchOperations();this.oDataModel.refresh();this.oJSONModel.refresh();this.isProcessing=false;if(this.retrySuccessFunction){this.retrySuccessFunction.apply(this);this.retrySuccessFunction=null}}catch(e){this.handleBatchResultsException(e)}},emptyBatchCallback:function(){},networkErrorCallback:function(e){this.retryBatchOperations()},handleNetworkError:function(e){if(this.retryBatchOperationsCount<=this.maxRetryBatchOperations){this.retryBatchOperationsCount++;this.batchOperationsWaitingTime=this.retryWaitingTime;this.retryBatchOperations()}else{this.retryBatchOperationsCount=0;this.batchOperationsWaitingTime=100;var E=e.message;if(e.response){E+=" - "+e.response.statusText}this.networkErrorCallback(E)}},exceptionCallback:function(e){this.discardBatchOperations()},handleBatchOperationException:function(e){this.exceptionCallback(e.message)},handleBatchResultsException:function(e){this.exceptionCallback(e.message)},handleBatchResultsError:function(e){var E=e[0].message;if(e[0].response){E+=" - "+e[0].response.statusText}this.exceptionCallback()},attachView:function(n,v){this.sContextBindingPath=n;this.oView=v;this.oDataModel=v.getModel();this.oJSONModel=this.oJSONModels[this.sContextBindingPath];if(!this.oJSONModel){this.oJSONModel=new sap.ui.model.json.JSONModel();this.oJSONModels[this.sContextBindingPath]=this.oJSONModel;this.readSections()}v.setBindingContext(new sap.ui.model.Context(this.oDataModel,'/'+this.sContextBindingPath));var N=v.getBindingContext().getProperty("NoteGuid");if(N){if(this.oJSONModel.getData().navNoteSection.length===0){this.createFirstSection(N)}}v.setModel(this.oJSONModel,"json")},injectFirstSectionFromMaster:function(m,n){var N="NoteHeaders('"+n+"')";this.oDataModel=m;this.oJSONModel=new sap.ui.model.json.JSONModel({navNoteSection:[]});this.oJSONModels[N]=this.oJSONModel;this.createFirstSection(n)},read:function(r,u){var c=new sap.ui.model.Context(this.oDataModel,'/'+this.sContextBindingPath);this.oDataModel.read(r,c,u,false,jQuery.proxy(this.readCompleted,this,r))},readCompleted:function(p,d){if(p){switch(p){case"navNoteSection":d.navNoteSection=d.results;break;default:break}}this.oJSONModel.setData(d);this.oJSONModel.updateBindings()},createSection:function(n,c){var b=[];var u=undefined;var s={NoteGuid:n,ContentType:"T",ContentText:c,SequenceNumber:this.getLastSectionSequenceNumber()};this.oJSONModel.getData().navNoteSection.push(s);this.oJSONModel.refresh();if(this.oJSONModel.getData().navNoteSection.indexOf(s)==0){u=this.updateTeaserText();if(u!==undefined){b.push(u)}}b.push(this.oDataModel.createBatchOperation("/NoteSections","POST",s));this.addBatchOperations(b)},readSections:function(){var u={};this.read("navNoteSection",u)},updateSection:function(b,c,e,o){this.os3Controller=o;var s=this.oJSONModel.getProperty(b);this.oSection=s;var B=[];var u=undefined;if(c){s.ContentText=c}if(this.oJSONModel.getData().navNoteSection.indexOf(s)==0){u=this.updateTeaserText(e);if(u!==undefined){this.isTeaserTextUpdate=true;B.push(u)}}var a=this.oDataModel.createBatchOperation("","PUT",s);if(!this.isTeaserTextUpdate){a.requestUri="NoteSections(SectionGuid='"+s.SectionGuid+"',NoteGuid='"+s.NoteGuid+"')";B.push(a)}this.addBatchOperations(B)},deleteSections:function(b){var d=null;var B=[];var s=null;var a=null;var u=undefined;if(b&&b.length>0){for(var i=0;i<b.length;i++){s=this.oJSONModel.getProperty(b[i]);a=this.oJSONModel.getData().navNoteSection.indexOf(s);this.oJSONModel.getData().navNoteSection.splice(a,1);if(a==0){u=this.updateTeaserText();if(u!==undefined){B.push(u)}}d=this.oDataModel.createBatchOperation("","DELETE",s);d.requestUri="NoteSections(SectionGuid='"+s.SectionGuid+"',NoteGuid='"+s.NoteGuid+"')";B.push(d)}this.oJSONModel.refresh();this.addBatchOperations(B)}},splitSection:function(b,s){var S=this.oJSONModel.getProperty(b);var u=S.ContentText.substring(0,s);var l=S.ContentText.substring(s+2,S.ContentText.length);var n=this.getSectionSequenceNumber(S.SequenceNumber);var B=[];var a=undefined;S.ContentText=u;if(this.oJSONModel.getData().navNoteSection.indexOf(S)==0){a=this.updateTeaserText();if(a!==undefined){B.push(a)}}var N={NoteGuid:S.NoteGuid,ContentType:"T",ContentText:l,SequenceNumber:n,};this.oJSONModel.getData().navNoteSection.push(N);this.oJSONModel.getData().navNoteSection.sort(this.sectionSorter);this.oJSONModel.refresh();var U=this.oDataModel.createBatchOperation("","PUT",S);U.requestUri="NoteSections(SectionGuid='"+S.SectionGuid+"',NoteGuid='"+S.NoteGuid+"')";B.push(U);var c=this.oDataModel.createBatchOperation("/NoteSections","POST",N);B.push(c);this.addBatchOperations(B)},mergeSection:function(f,s){var F=this.oJSONModel.getProperty(f);var S=this.oJSONModel.getProperty(s);var b=[];var u=undefined;F.ContentText=F.ContentText+S.ContentText;var i=this.oJSONModel.getData().navNoteSection.indexOf(S);this.oJSONModel.getData().navNoteSection.splice(i,1);this.oJSONModel.refresh();if(this.oJSONModel.getData().navNoteSection.indexOf(F)==0){u=this.updateTeaserText();if(u!==undefined){b.push(u)}}var B=this.oDataModel.createBatchOperation("","PUT",F);B.requestUri="NoteSections(SectionGuid='"+F.SectionGuid+"',NoteGuid='"+F.NoteGuid+"')";b.push(B);var d=this.oDataModel.createBatchOperation("","DELETE",S);d.requestUri="NoteSections(SectionGuid='"+S.SectionGuid+"',NoteGuid='"+S.NoteGuid+"')";b.push(d);this.addBatchOperations(b)},createFirstSection:function(n){var b=[];var s={NoteGuid:n,ContentType:"T",ContentText:"",SequenceNumber:this.getLastSectionSequenceNumber()};this.oJSONModel.getData().navNoteSection.push(s);this.oJSONModel.refresh();b.push(this.oDataModel.createBatchOperation("/NoteSections","POST",s));this.addBatchOperations(b)},getFirstSectionText:function(){var f=this.oJSONModel.getData().navNoteSection[0];if(!f){return null}return f.ContentText},getSectionText:function(b){return this.oJSONModel.getProperty(b).ContentText},getSectionsText:function(b){var s='';var c='';for(var i=0;i<b.length;i++){c=this.getSectionText(b[i]);if(s!=''&&c!=''){s+='\n\n'}s+=c};return s},getSectionAttachmentUploadUrl:function(b){var s=this.oJSONModel.getProperty(b);var u=null;if(s.navAttachment){u=s.navAttachment.__metadata.edit_media}else{var c=new sap.ui.model.Context(this.oDataModel,"/NoteSections(SectionGuid='"+s.SectionGuid+"',NoteGuid='"+s.NoteGuid+"')");var U={$expand:"navAttachment"};this.oDataModel.read("/",c,U,false,jQuery.proxy(function(s){u=s.navAttachment.__metadata.edit_media},this))}return u},getSectionSequenceNumber:function(s){var S=this.oJSONModel.getData().navNoteSection;var n=null;var N=null;for(var i=0;i<S.length;i++){N=S[i].SequenceNumber;if(n==null||N<n){if(N>s){n=N}}}if(!n){return this.getLastSectionSequenceNumber()}if(Math.abs(s-n)==1){s=this.reorderSequenceNumber(s);return this.getSectionSequenceNumber(s)}return Math.round((s+n)/2)},getLastSectionSequenceNumber:function(){var s=this.oJSONModel.getData().navNoteSection;var l=0;var n=null;for(var i=0;i<s.length;i++){n=s[i].SequenceNumber;if(n>=l){l=n}}l=l+this.globalStepSize;if(l>this.maxSequenceNumber){this.globalStepSize=Math.round(this.globalStepSize/2);this.reorderSequenceNumber();l=this.globalStepSize*(s.length+1)}return l},reorderSequenceNumber:function(o){var s=this.oJSONModel.getData().navNoteSection;var b=[];var B=null;var S=undefined;var a=undefined;for(var i=0;i<s.length;i++){S=s[i].SequenceNumber;s[i].SequenceNumber=(i+1)*this.globalStepSize;if(o&&o===S){a=s[i].SequenceNumber}B=this.oDataModel.createBatchOperation("","PUT",s[i]);B.requestUri="NoteSections(SectionGuid='"+s[i].SectionGuid+"',NoteGuid='"+s[i].NoteGuid+"')";b.push(B)}this.addBatchOperations(b);return a},getTeaserText:function(){if(this.oJSONModel.getData().navNoteSection.length==0){return null}return this.oJSONModel.getData().navNoteSection[0].ContentText},updateTeaserText:function(e){if(this.oJSONModel.getData().navNoteSection.length==0){return}var s=this.oJSONModel.getData().navNoteSection[0];var h=this.oDataModel.getProperty("/"+this.sContextBindingPath);if(s.ContentText==h.TeaserText){return}h.TeaserText=s.ContentText;var b=this.oDataModel.createBatchOperation("/"+this.sContextBindingPath,"PUT",h,e);this.oDataModel.setProperty("/"+this.sContextBindingPath+"/TeaserText",h.TeaserText);this.oDataModel.sChangeKey=null;return b},sectionSorter:function(s,S){return s.SequenceNumber-S.SequenceNumber},stopBatchProcess:function(){this.stopBatchProcessing=true},onExit:function(){},});
