/*
 * Copyright (C) 2009-2014 SAP SE or an SAP affiliate company. All rights reserved
 */
jQuery.sap.require("cus.crm.lead.util.formatter");jQuery.sap.require("sap.ca.scfld.md.controller.BaseMasterController");jQuery.sap.require("sap.ca.scfld.md.controller.ScfldMasterController");jQuery.sap.require("cus.crm.lead.util.schema");jQuery.sap.require("cus.crm.lead.util.Util");sap.ca.scfld.md.controller.ScfldMasterController.extend("cus.crm.lead.view.S2",{numberOfLeads:0,sPath:"",bAppLaunched:false,accountID:undefined,bFilterOpen:false,onInit:function(){sap.ca.scfld.md.controller.BaseMasterController.prototype.onInit.call(this);var v=this.getView();var s=this;var c=sap.ui.core.Component.getOwnerIdFor(this.getView());var m=sap.ui.component(c);this.oModel=this.byId('list').getModel();if(m&&m.getComponentData()&&m.getComponentData().startupParameters){jQuery.sap.log.debug("startup parameters are "+JSON.stringify(m.getComponentData().startupParameters));if(undefined!=m.getComponentData().startupParameters.accountID){this.accountID=m.getComponentData().startupParameters.accountID[0]}else if(m.getComponentData().startupParameters.leadID!=null){this.leadID=m.getComponentData().startupParameters.leadID[0]}}this.oResourceBundle=sap.ca.scfld.md.app.Application.getImpl().AppI18nModel.getResourceBundle();var l=this.getList();this.oShowSheet=sap.ui.xmlfragment(this.createId("showLeadFragment"),"cus.crm.lead.view.showMaxHit",this);this.oAppImpl=sap.ca.scfld.md.app.Application.getImpl();this.oTemplate=l.getItems()[0].clone();var a=this.getFilters();l.bindAggregation("items",{path:'/Leads',template:this.oTemplate,filters:a});var M=this.getView().getModel();M.bRefreshAfterChange=false;var b=function(e){if(this.accountID!==undefined){var L=this.getList().getBinding('items');if(L&&L.getLength()>0)this.setAccountName();else this.accountID=undefined}var n=this.getList().getBinding('items').getLength();if(typeof cus.crm.myaccounts!=='undefined'&&typeof cus.crm.myaccounts.NavigationHelper!=='undefined'&&typeof cus.crm.myaccounts.NavigationHelper.qty!=='undefined'){if(cus.crm.myaccounts.NavigationHelper.qty>n&&typeof this.accountID!=='undefined'){sap.ca.ui.message.showMessageToast(this.oApplicationFacade.getResourceBundle().getText("LIST_FILTERED_BY_MYITEMS",[n,cus.crm.myaccounts.NavigationHelper.qty]))};cus.crm.myaccounts.NavigationHelper.qty=undefined}};if(this.oModel)this.oModel.attachRequestCompleted(jQuery.proxy(b,this));this.oPopOverSort=this.byId('popoverSorter');this.oPopOverFilter=this.byId('popoverFilter');this.sFilterSelectedItemKey="ALL";this.sSortSelectedItemKey="EndDate";this.sBackendVersion=cus.crm.lead.util.schema._getServiceSchemaVersion(this.oModel,"Lead")},onBeforeRendering:function(){this.getView().getModel('controllers').getData().s2Controller=this},getFilters:function(){var f=[];if(undefined!=this.accountID){f.push(new sap.ui.model.Filter("ProspectNumber",sap.ui.model.FilterOperator.EQ,this.accountID))}if(undefined!=this.leadID){f.push(new sap.ui.model.Filter("Id",sap.ui.model.FilterOperator.EQ,this.leadID))}return f},showPopupforsort:function(e){this.oPopOverSort.setModel(e.getSource().getModel());this.oPopOverSort.openBy(e.getSource())},showPopupforfilter:function(e){this.oPopOverFilter.setModel(e.getSource().getModel());this.oPopOverFilter.openBy(e.getSource())},handleErrors:function(e){sap.ca.ui.utils.busydialog.releaseBusyDialog();jQuery.sap.log.error(JSON.stringify(e));sap.ca.ui.message.showMessageBox({type:sap.ca.ui.message.Type.ERROR,message:e.message,details:JSON.parse(e.response.body).error.message.value},function(r){})},onShow:function(e){var t=this;var m=this.getView().getModel();var a;m.read((parseFloat(this.sBackendVersion)>=4)?"RetrieveMaxHitSet":"RetrieveMaxHit",null,null,false,function(d,r){a={RetrieveMaxHit:((parseFloat(t.sBackendVersion)>=4)?d.results[0]:r.data.RetrieveMaxHit)}});this.oldValue=a.RetrieveMaxHit.MaxHitNumber;this.oShowSheet.setModel(this.getView().getModel("i18n"),"i18n");var j=new sap.ui.model.json.JSONModel();j.setData(a);this.oShowSheet.setModel(j,"showJson");this.oShowSheet.open()},closeShow:function(e){this.oShowSheet.close()},saveMaxHit:function(e){var m=this.getView().getModel();var v=this.oShowSheet.getContent()[1].getValue();if(v!=this.oldValue)m.create("UpdateMaxHit",null,{success:jQuery.proxy(function(){this.oModel.bRefreshAfterChange=false;this.oModel.refresh()},this),error:jQuery.proxy(function(E){this.handleErrors(E);this.oModel.bRefreshAfterChange=false},this),async:true,urlParameters:["MaxHitNumber='"+v+"'"]});this.oShowSheet.close()},getHeaderFooterOptions:function(){var t=this;var s=this.getView();var l=this.getList().getItems();var n=0;if(this.getList().getBinding('items'))n=this.getList().getBinding('items').getLength();var h={onBack:jQuery.proxy(this.onBack,this),sI18NMasterTitle:this.oApplicationFacade.getResourceBundle().getText("MASTER_TITLE",n),oSortOptions:{sSelectedItemKey:this.sSortSelectedItemKey,aSortItems:[{text:sap.ca.scfld.md.app.Application.getImpl().getResourceBundle().getText('ClosingDateAscending'),key:"EndDate"},{text:sap.ca.scfld.md.app.Application.getImpl().getResourceBundle().getText('ClosingDateDescending'),key:"EndDate2"},{text:sap.ca.scfld.md.app.Application.getImpl().getResourceBundle().getText('AccountAscending'),key:"ProspectName"},{text:sap.ca.scfld.md.app.Application.getImpl().getResourceBundle().getText('AccountDescending'),key:"ProspectName2"},{text:sap.ca.scfld.md.app.Application.getImpl().getResourceBundle().getText('StatusAscending'),key:"UserStatusText"},{text:sap.ca.scfld.md.app.Application.getImpl().getResourceBundle().getText('StatusDescending'),key:"UserStatusText2"}],onSortSelected:function(k){t.applySort(k);t.sSortSelectedItemKey=k}},oFilterOptions:{sSelectedItemKey:this.sFilterSelectedItemKey,aFilterItems:[{text:sap.ca.scfld.md.app.Application.getImpl().getResourceBundle().getText('ALL'),key:"ALL"},{text:sap.ca.scfld.md.app.Application.getImpl().getResourceBundle().getText('OPEN'),key:"I1002"}],onFilterSelected:jQuery.proxy(function(k){var f=[];this.sFilterSelectedItemKey=k;this.getList().setNoDataText(this.oResourceBundle.getText('LOADING'));f=this.getFilters();var a=this._oControlStore.oMasterSearchField.getValue();if(a&&a.length>0)f.push(new sap.ui.model.Filter("Description","EQ",a));if(k==="I1002"){f.push(new sap.ui.model.Filter("UserStatusText","EQ","I1002"));this.bFilterOpen=true}else this.bFilterOpen=false;var b=this.getList().getBinding('items');b.aApplicationFilters=[f];this.oAppImpl.oMHFHelper.refreshList(this)},this)},aAdditionalSettingButtons:[{sI18nBtnTxt:sap.ca.scfld.md.app.Application.getImpl().getResourceBundle().getText('LIST_SETTING'),sId:"BTN_SHOW",sIcon:"sap-icon://settings",onBtnPressed:function(k){jQuery.proxy(t.onShow(k),this)}},]};if(this.extHookGetHeaderFooterOptions){this.extHookGetHeaderFooterOptions(h)}return h},applySort:function(k){if(k==="ProspectName2"||k==="UserStatusText2"||k==="EndDate2"){if(k==="ProspectName2"){k="ProspectName"}else if(k==="UserStatusText2"){k="UserStatusText"}else k="EndDate";var s=new sap.ui.model.Sorter(k,true,false)}else var s=new sap.ui.model.Sorter(k,false,false);this.getView().byId('list').getBinding("items").aSorters=[];this.getView().byId('list').getBinding("items").aSorters=[s];this.getView().byId('list').getBinding("items").sort(s)},onSort:function(e){this.oPopOverSort.setModel(e.getSource().getModel());this.oPopOverSort.openBy(e.getSource())},onFilter:function(e){this.oPopOverFilter.setModel(e.getSource().getModel());this.oPopOverFilter.openBy(e.getSource())},isBackendSearch:function(){return true},applyBackendSearchPattern:function(f,b){this.getList().setNoDataText(this.oResourceBundle.getText('LOADING'));var F=[];F=this.getFilters();b.aApplicationFilters=[];if(this.bFilterOpen)F.push(new sap.ui.model.Filter("UserStatusText",sap.ui.model.FilterOperator.EQ,"I1002"));if(f&&f.length>0)F.push(new sap.ui.model.Filter("Description",sap.ui.model.FilterOperator.Contains,f));b.aApplicationFilters=[];b.filter(F)},applyFilterPatternToListItem:function(I,f){var l=this.getList().getItems();if(f.toUpperCase()=="ALL"){for(var i=0;i<l.length;i++){l[i].setVisible(true)}this.setListItem(l[0])}else{var c;for(var i=0;i<l.length;i++){var v=this.searchFilterPattern(l[i],f);if(v==true){c=i}l[i].setVisible(v)}this.setListItem(l[c])}},setListItem:function(i){if(!this.bAppLaunched){this.prevItem=i}this.oItem=i;this.getList().removeSelections();if(this.prevItem)this.getList().setSelectedItem(this.prevItem);var c=sap.ca.scfld.md.app.Application.getImpl().oSplitContainer.getCurrentDetailPage();var e=this.getView().getModel('controllers').getData().s4Controller;if(this.bAppLaunched&&c&&e&&(e.getView()===c)){var s=this.getS4Controller();if(s&&s.pageNeedsUpdate()){sap.ca.ui.dialog.confirmation.open({question:this.oResourceBundle.getText('DATA_LOSS'),title:this.oResourceBundle.getText('WARNING'),confirmButtonLabel:this.oResourceBundle.getText('CONTINUE')},jQuery.proxy(this.datalossDismissed,this));return}}this.goToDetailPage(i)},goToDetailPage:function(i){if(i===undefined)return;this.prevItem=i;var l=this.getList();l.removeSelections();i.setSelected(true);l.setSelectedItem(i,true);this.sPath=i.getBindingContext().sPath;if(this.bAppLaunched&&this.getS3Controller())this.oRouter.attachRouteMatched(this.getS3Controller().routeMatched,this.getS3Controller());this.oRouter.navTo("detail",{contextPath:i.getBindingContext().sPath.substr(1)},!jQuery.device.is.phone)},datalossDismissed:function(r){var s=this.getS4Controller();this.getList().getModel().clearBatch();if(r.isConfirmed===false){if(this.prevItem)this.getList().setSelectedItem(this.prevItem);return}if(s)s.deleteBuffer=[];this.goToDetailPage(this.oItem)},searchFilterPattern:function(i,f){var I=i.getBindingContext().getProperty();if(I.SystemStatusCode.toUpperCase()==f.toUpperCase()){return true}else return false},applySortPatternToListItem:function(s){var l=this.getList().getItems();if(s=="Status"){for(var i=0;i<l.length;i++){for(var j=0;j<l.length-i-1;j++){if(l[j].getBindingContext().getProperty().UserStatusText<l[j+1].getBindingContext().getProperty().UserStatusText){var t=l[j];l[j]=l[j+1];l[j+1]=t}}}for(var i=0;i<l.length;i++){this.getList().addItem(l[i])}this.setListItem(l[0])}else if(s=="Account"){for(var i=0;i<l.length;i++){for(var j=0;j<l.length-i-1;j++){if(l[j].getBindingContext().getProperty().ProspectName.toString()<l[j+1].getBindingContext().getProperty().ProspectName.toString()){var t=l[j];l[j]=l[j+1];l[j+1]=t}}}for(var i=0;i<l.length;i++){this.getList().addItem(l[i])}this.setListItem(l[0])}else if(s=="Closing Date"){for(var i=0;i<l.length;i++){for(var j=0;j<l.length-i-1;j++){if(l[j].getBindingContext().getProperty().EndDate<l[j+1].getBindingContext().getProperty().EndDate){var t=l[j];l[j]=l[j+1];l[j+1]=t}}}for(var i=0;i<l.length;i++){this.getList().addItem(l[i])}this.setListItem(l[0])}},sortbyGroup:function(e){var i=e.getParameters().listItem;if(i.getTitle()=="Closing Date"){this.sortClosingDate()}else if(i.getTitle()=="Status"){this.sortStatus()}else if(i.getTitle()=="Account"){this.sortAccount()}},sortClosingDate:function(){this.applySort("Closing Date")},sortStatus:function(){this.applySort("Status")},sortAccount:function(){this.applySort("Account")},groupItems:function(c){return this.currentSort.sPath==="CustomerName"?c.getProperty("CustomerName"):c.getProperty(this.currentSort.sPath).charAt(0)},leadRejected:function(){var s=this.getView().getModel('controllers').getData().s3Controller;if(s&&s.bRejectLead){var i=this.byId('list').getItems();if(i.length>0){this.setListItem(i[0]);s.bRejectLead=false}else if(s.nLeads===1){this.oRouter.navTo("noData",{viewTitle:"DETAIL_TITLE",languageKey:"NO_ITEMS_AVAILABLE"});s.bRejectLead=false}}if(s&&s.bRejectLead==false)this.byId('list').getBinding('items').detachChange(this.leadRejected,this)},leadAccepted:function(){var s=this.getView().getModel('controllers').getData().s3Controller;if(s&&s.bAcceptLead){var a=this.byId('list').getItems();if(a.length>0){var m=this.byId('list').getModel();var p="/"+"Leads(guid'"+s.sHeaderGuid+"')";var c=this.byId('list').getModel().getContext(p);var i;s.byId('info').getModel('json').setData(JSON.parse(JSON.stringify(m.getData(p))))}}if(s&&s.bAcceptLead==false)this.byId('list').getBinding('items').detachChange(this.leadAccepted,this)},editSaved:function(){var i;var d;var s=this.getView().getModel('controllers').getData().s4Controller;if(s.bNavOnUpdate===true){var p="/"+"Leads(guid'"+s.headerGuid+"')";var m=this.byId('list').getModel();var c=m.getContext(p);var a=this.byId('list').getItems();for(i=0;i<a.length;i++){if(c===a[i].getBindingContext()){a[i].setSelected(true);if(jQuery.device.is.phone)this.setListItem(a[i]);s.bNavOnUpdate=false}}}if(s.bNavOnUpdate===false)this.byId('list').getBinding('items').detachChange(this.editSaved,this)},getS3Controller:function(){return this.getView().getModel('controllers').getData().s3Controller},getS4Controller:function(){return this.getView().getModel('controllers').getData().s4Controller},onDataLoaded:function(){if(!this.bAppLaunched){this.getList().getBinding('items').attachChange(this.leadsRefreshed,this);this.bAppLaunched=true}},leadsRefreshed:function(){var s=this.getS3Controller();if(s!==null){if(s.bAcceptLead===true){var p="/"+s.sPath;var d=JSON.parse(JSON.stringify(this.oModel.getContext(p).getObject()));s.byId('info').getModel('json').setData(d);s.bAcceptLead=false}if(s.bRejectLead===true){if(this.getList().getItems().length>0){this.setListItem(this.getList().getItems()[0]);s.bRejectLead=false}}}if(this.getList().getBinding('items').getLength()===0){this.getList().setNoDataText(this.oResourceBundle.getText('NO_LEAD_ERROR'));if(this.accountID!==undefined)this.navToEmptyView()}else{var i=this.getList().getSelectedItem();if(i&&this.getSplitContainer().getCurrentDetailPage().sViewName==="sap.ca.scfld.md.view.empty"){if(!jQuery.device.is.phone&&this.getS3Controller())this.oRouter.attachRouteMatched(this.getS3Controller().routeMatched,this.getS3Controller());this.oRouter.navTo("detail",{contextPath:i.getBindingContext().sPath.substr(1)},!jQuery.device.is.phone)}}},navToEmptyView:function(){if(this.s4Controller){if(this.s4Controller.bNavOnUpdate&&(this.s4Controller.bHeaderUpdateSuccess||this.s4Controller.bContactUpdateSuccess||this.s4Controller.bUserUpdateSuccess)){this.s4Controller.bNavOnUpdate=false;this.bHeaderUpdateSuccess=this.bStatusUpdateSuccess=this.bContactUpdateSuccess=false}return}this.getList().setNoDataText(this.oResourceBundle.getText('NO_LEAD_ERROR'));this.oRouter.navTo("noData")},closeToolbar:function(e){var f=[];this.byId('toolbarAccountInfo').setVisible(false);this.accountID=undefined;this.getList().getBinding('items').aApplicationFilters=[];f=this.getFilters();if(this.bFilterOpen)f.push(new sap.ui.model.Filter("UserStatusText","EQ","I1002"));var s=this._oControlStore.oMasterSearchField.getValue();if(s&&s.length>0)f.push(new sap.ui.model.Filter("Description","EQ",s));this.getList().getBinding('items').aApplicationFilters=f;this.oAppImpl.oMHFHelper.refreshList(this)},setAccountName:function(){this.byId('toolbarAccountInfo').setVisible(true);this.byId('labelAccountInfo').setText(this.oResourceBundle.getText('FILTER_BY')+" "+this.getList().getItems()[0].getBindingContext().getObject().ProspectName)},applyFilterFromContext:function(c){this.sContext=c;var l=this.getList();if(l.attachUpdateFinished){l.attachUpdateFinished(null,this.onGrowingFinished,this)}if(this.getS3Controller())this.oRouter.attachRouteMatched(this.getS3Controller().routeMatched,this.getS3Controller());this.oRouter.navTo("detail",{contextPath:c.substr(1)},!jQuery.device.is.phone)},onBack:function(e){var c=sap.ca.scfld.md.app.Application.getImpl().oSplitContainer.getCurrentDetailPage();var a=this.getView().getModel('controllers').getData().s4Controller;if(c&&a&&(a.getView()===c)){if(a.pageNeedsUpdate()){this.getList().getModel().clearBatch();sap.ca.ui.dialog.confirmation.open({question:sap.ca.scfld.md.app.Application.getImpl().getResourceBundle().getText('DATA_LOSS'),title:sap.ca.scfld.md.app.Application.getImpl().getResourceBundle().getText('WARNING'),confirmButtonLabel:sap.ca.scfld.md.app.Application.getImpl().getResourceBundle().getText('CONTINUE')},jQuery.proxy(this.dataLossForExit,this));return}}window.history.back(1)},dataLossForExit:function(r){if(r.isConfirmed===true){window.history.back(1)}},onGrowingFinished:function(e){if(this.sContext){var l=this.getList();var a=l.getItems();for(var i=0;i<a.length;i++){if(this.sContext===a[i].getBindingContextPath()){a[i].setSelected(true);this.sContext=null;l.detachUpdateFinished(this.onGrowingFinished,this);this.prevItem=a[i]}else{a[i].setSelected(false)}}}}});
