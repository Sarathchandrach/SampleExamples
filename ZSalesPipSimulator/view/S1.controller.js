/*
 * Copyright (C) 2009-2014 SAP SE or an SAP affiliate company. All rights reserved
 */
jQuery.sap.require("sap.ca.scfld.md.controller.BaseFullscreenController");jQuery.sap.require("sap.m.MessageToast");jQuery.sap.require("sap.ui.core.format.NumberFormat");jQuery.sap.require("sap.ca.scfld.md.controller.BaseMasterController");jQuery.sap.require("sap.ca.ui.message.message");sap.ca.scfld.md.controller.BaseFullscreenController.extend("cus.crm.salespipeline.sim.view.S1",{onInit:function(){sap.ca.scfld.md.controller.BaseFullscreenController.prototype.onInit.call(this);this._initControllerVariables();this.loadData();this._initializeAllControllerFragments();var f=this.getView().byId("butChangelog");var a=this.getView().byId("butSave");var b=this.getView().byId("butReset");if(sap.ui.Device.system.phone){f.setIcon("sap-icon://activities");a.setIcon("sap-icon://save");b.setIcon("sap-icon://undo")}else{f.setText(this.oBundle.getText("BTN_SHOW_CHANGELOG"));a.setText(this.oBundle.getText("BTN_SAVE_OPPORT"));b.setText(this.oBundle.getText("BTN_RESET"))}if(sap.ui.Device.browser.BROWSER.INTERNET_EXPLORER==sap.ui.Device.browser.name&&sap.ui.Device.browser.version<10){var s=this.getView().byId("hlOppSlider");s.removeStyleClass("alignRight");s.addStyleClass("alignRightIE9")}sap.ui.getCore().byId("poPage").addStyleClass("sapUiStdPage");this.getView().byId("page").addStyleClass("sapUiStdPage");this.disableTextSelection();window.addEventListener("orientationchange",function(){if(sap.ui.getCore().byId("po").isOpen())sap.ui.getCore().byId("po").close()},false)},_initControllerVariables:function(){this.oDataModel=this.oApplicationFacade.getODataModel();this.oBundle=this.oApplicationFacade.getResourceBundle();this.oApplicationFacade.oApplicationImplementation.oCurController.FullCtrl=this;this.aChangeablePropsTexts=[{"property":"StartDate","displayText":this.oBundle.getText("LBL_OD_STARTDATE")},{"property":"ClosingDate","displayText":this.oBundle.getText("LBL_OD_ENDDATE")},{"property":"ExpectedSalesVolume","displayText":this.oBundle.getText("LBL_OD_EXPECTEDREVENUEHEADER")},{"property":"ForecastRelevance","displayText":this.oBundle.getText("LBL_OD_FORECASTRELEVANCE")},{"property":"SalesStageCode","displayText":this.oBundle.getText("LBL_OD_SALESSTAGE")},{"property":"ChanceOfSuccess","displayText":this.oBundle.getText("LBL_OD_CHANCEOFSUCCESS")},{"property":"UserStatusCode","displayText":this.oBundle.getText("LBL_OD_STATUS")}];this._iServiceSchemaVersion=this._getServiceSchemaVersion(this.oDataModel,"Opportunity");this._iServiceVersion=this._getServiceVersion(this.oDataModel,"Opportunity");this.viewType={};this.iChangeStartDate=0;this.iChangeEndDate=0;this.arrStatusPros=[];this.arrStagesPros=[];this.ptGroup={};this.reRenderTopNSlider=true;this.oNavParams={"toOppApp":"","toContactApp":"","toAccountApp":"","telCall":"","sendMail":""};this.iChangeCOS=0;this.iChangeExpRev=0;this.oFragmentList={}},onBeforeRendering:function(){this.defineButtons();this.calculateProgress()},disableTextSelection:function(){this.getView().byId('page').allowTextSelection(false);this.getView().byId('objectHeader').allowTextSelection(false);sap.ui.getCore().byId('po').allowTextSelection(false);sap.ui.getCore().byId('dlAppSettings').allowTextSelection(false);sap.ui.getCore().byId('dlSalesPeriodSet').allowTextSelection(false);sap.ui.getCore().byId('changeLogDialog').allowTextSelection(false);sap.ui.getCore().byId('popup').allowTextSelection(false)},onExit:function(){if(this.getView().byId("acButAppS")!=undefined)this.getView().byId("acButAppS").destroy();this._destroyAllControllerFragments()},getServiceVersion:function(){return this._iServiceVersion},getServiceSchemaVersion:function(){return this._iServiceSchemaVersion},_getEntityAnnotation:function(m,a,e){var M=m.getServiceMetadata();if(M&&M.dataServices&&M.dataServices.schema&&M.dataServices.schema.length>0&&M.dataServices.schema[0].entityType){var E=M.dataServices.schema[0].entityType;for(var i=-1,c;c=E[++i];)if(e===c.name&&c.extensions)for(var j=-1,C;C=c.extensions[++j];)if(C.name===a)return C.value}return null},_getServiceSchemaVersion:function(m,e){var v=this._getEntityAnnotation(m,"service-schema-version",e);return(v!=null)?parseInt(v):1},_getServiceVersion:function(m,e){var v=this._getEntityAnnotation(m,"service-version",e);return(v!=null)?parseInt(v):1},defineButtons:function(){var a=new sap.m.Button("acButAppS",{press:jQuery.proxy(this.selectActSetting,this),icon:"sap-icon://settings",text:this.oBundle.getText("BTN_APPSETTINGS"),});if(sap.ui.version<"1.19.0"){var s=null;var f=this.getView().byId("masterFooter");f.destroyContentLeft();s=sap.ushell.services.AppConfiguration.getSettingsControl();s.setText("").setWidth("");s.setMenuItems([a]);f.addContentLeft(s)}else{sap.ushell.services.AppConfiguration.addApplicationSettingsButtons([a])}},showErrorMsg:function(e,i){var a=null,m=null;if(e.response){a=jQuery.parseJSON(e.response.body).error;var b=a.code.split("/");if(b.length==2)m=a.message.value;else{if(i)m=this.oBundle.getText("LBL_FAILEDREAD");else m=this.oBundle.getText("LBL_FAILEDUPDATE")}}else m=e.message;var c=a.message.value;sap.ca.ui.message.showMessageBox({type:sap.ca.ui.message.Type.ERROR,message:m,details:c})},formatChangeLog:function(n,a,b){var u=cus.crm.salespipeline.sim.util.formatter;switch(n){case"StartDate":return u.dispCLDate(a);case"ClosingDate":return u.dispCLDate(a);case"ExpectedSalesVolume":return u.displayNumbers(a);case"ForecastRelevance":if(a)return true;else return false;case"ChanceOfSuccess":return parseFloat(a)+"%";case"SalesStageCode":for(var i=0;i<this.arrStagesPros.length;i++)if(this.arrStagesPros[i].guidVal==b){var s=this.arrStagesPros[i].Stages;for(var k=0;k<s.length;k++)if(a==s[k].SalesStageCode){return s[k].SalesStageDescription;break}break}case"UserStatusCode":for(var i=0;i<this.arrStatusPros.length;i++)if(this.arrStatusPros[i].HeaderGuid==b){var S=this.arrStatusPros[i].Statuses;for(var k=0;k<S.length;k++)if(a==S[k].UserStatusCode){return S[k].UserStatusText;break}break}default:return a}},unformatChangeLog:function(n,a,b){var u=cus.crm.salespipeline.sim.util.formatter;switch(n){case"StartDate":return u.revCLDate(a);case"ClosingDate":return u.revCLDate(a);case"ExpectedSalesVolume":return u.reverseNumbers(a);case"ForecastRelevance":if(a)return'X';else return' ';case"SalesStageCode":for(var i=0;i<this.arrStagesPros.length;i++)if(this.arrStagesPros[i].guidVal==b){var s=this.arrStagesPros[i].Stages;for(var k=0;k<s.length;k++)if(a==s[k].SalesStageDescription){return s[k].SalesStageCode;break}break}case"UserStatusCode":for(var i=0;i<this.arrStatusPros.length;i++)if(this.arrStatusPros[i].HeaderGuid==b){var S=this.arrStatusPros[i].Statuses;for(var k=0;k<S.length;k++)if(a==S[k].UserStatusText){return S[k].UserStatusCode;break}break}case"ChanceOfSuccess":var o=a.split("%");return o[0]}},batchRead:function(){var t=this;var R=[this.oDataModel.createBatchOperation("SalesPipelineSettings","GET"),this.oDataModel.createBatchOperation("PeriodicityTexts","GET"),this.oDataModel.createBatchOperation("TimeIntervals","GET"),this.oDataModel.createBatchOperation("YearRanges","GET"),this.oDataModel.createBatchOperation("Currencies","GET"),this.oDataModel.createBatchOperation("Opportunities","GET"),this.oDataModel.createBatchOperation("UserStatusCodes","GET"),this.oDataModel.createBatchOperation("SalesStages","GET")];this.oDataModel.addBatchReadOperations(R);this.oDataModel.setHeaders({"X-REQUESTED-WITH":"XMLHttpRequest"});var s=function(d,o){var b=d.__batchResponses;for(var a=0;a<b.length;a++){if(parseInt(b[a].statusCode)!==200){t.showErrorMsg(b[a],true);break}var c=b[a].data.results;var M=new sap.ui.model.json.JSONModel();switch(a){case 0:c[0].STP2=c[0].SalesTargetPeriodicity;M.setData(c[0]);t.getView().setModel(M,"SalesPipelineSetting");t.oAppSettings=c[0];t.copysetting("SettingsForDisplay");var C=t.getView().byId("chart_sim");C.setMaxBubbleValue(c[0].OpportunityMaxValue);C.setMinBubbleValue(c[0].OpportunityMinValue);C.setBubbleStepValue(c[0].OpportunityStepValue);break;case 1:M.setData(c);t.getView().setModel(M,"PeriodicityTexts");break;case 2:var T=c;var f=T;if(T.length>100){f=[];var r=0;for(var l=0,m=T.length;l<m;l+=2){f[r]=T[l];r++}f[r]=T[T.length-1]}M.setData(f);t.getView().setModel(M,"TimeIntervals");var g=[];var h=[];var k=t.getView().getModel("TimeIntervals").oData;var n={"value":"","value2":""};var C=t.getView().byId("chart_sim");var p=t.getView().getModel('SalesPipelineSetting').oData;var q=p.SalesTargetPeriodicity;if(k.length==1){n.value=0;n.value2=k.length-1;if(n.value2==0){n.value2=1;k.push(k[0]);M.setData(k);t.getView().setModel(M,"TimeIntervals")}var u=new sap.ui.model.json.JSONModel(n);t.getView().setModel(u,"sliderValue");for(var i=0,j=k.length;i<j;i++){g[i]=k[i].Label;h[i]=k[i].TimeFrom}C.setXStart(h[0]);C.setXEnd(k[k.length-1].TimeTo)}else{var v=new Date(),j=0;v.setHours(0);v.setMinutes(0);v.setSeconds(0);v.setMilliseconds(0);v=cus.crm.salespipeline.sim.util.formatter.convFromSixZeros(v);if(T.length>100){for(;j<T.length-1;j++){if((v>=T[j].TimeFrom)&&(v<=T[j].TimeTo)){break}}j=parseInt(j/2)}else{for(;j<k.length-1;j++){if((v>=k[j].TimeFrom)&&(v<=k[j].TimeTo)){break}}}if(j==k.length-1){if(v.getFullYear()<new Date(k[1].TimeFrom).getFullYear()){j=0}if(v.getFullYear()>new Date(k[1].TimeFrom).getFullYear()){switch(q){case"1":j=k.length-5;break;case"2":j=k.length-4;break;case"3":j=k.length-2;break;case"4":j=k.length-2;break}}}n.value=j;switch(q){case"1":n.value2=j+4;break;case"2":n.value2=j+3;break;case"3":n.value2=j+1;break;case"4":n.value2=j+1;break}if(n.value2>=k.length){n.value2=k.length-1;switch(q){case"1":n.value=k.length-5;break;case"2":n.value=k.length-4;break;case"3":n.value=k.length-2;break;case"4":n.value=k.length-2;break}}if(n.value2==n.value){n.value2=n.value+1;k.push(k[n.value]);M.setData(k);t.getView().setModel(M,"TimeIntervals")}for(var i=n.value;i<=n.value2;i++){g[i-n.value]=k[i].Label;h[i-n.value]=k[i].TimeFrom;if(i==n.value)C.setXStart(k[i].TimeFrom);if(i==n.value2)C.setXEnd(k[i].TimeTo)}}t.getView().setModel(new sap.ui.model.json.JSONModel(n),"sliderValues");t.getView().byId("name").setValue(n.value);t.getView().byId("name").setValue2(n.value2);t.getView().setModel(new sap.ui.model.json.JSONModel(h),"xLabelValues");t.getView().setModel(new sap.ui.model.json.JSONModel(g),"xLabelTexts");break;case 3:M.setData(c);t.getView().setModel(M,"YearRanges");break;case 4:M.setData(c);t.getView().setModel(M,"CurrencyList");break;case 5:var w=c;var x=t.getView().getModel("SalesPipelineSetting").oData.CurrencyCode;var y=[];var I=0;for(var i=0;i<w.length;i++)if(w[i].CurrencyCode!=x){var z=false;for(var j=0;j<y.length;j++)if(y[j]==w[i].CurrencyCode){z=true;break}if(!z)y.push(w[i].CurrencyCode);I++;w.splice(i--,1)}var A=null,B=null,D="";var E=t.oBundle;if(y.length==1){if(I==1)A=E.getText("LBL_ONE_CURR");else A=E.getText("LBL_MULTI_CURR",I);D+=y[0];B=E.getText("LBL_MAINTAIN_CURR",D)}else if(y.length>1){A=E.getText("LBL_MULTI_CURR",I);var F=y.length-1;for(var i=0;i<F;i++)D+=y[i]+", ";D+=y[F];B=E.getText("LBL_MAINTAIN_CURR",D)}if(y.length>0)sap.ca.ui.message.showMessageBox({type:sap.ca.ui.message.Type.INFO,message:A+" "+B});M.setData(w);t.getView().setModel(M,"Opportunities");t.Opportunities=w;t.initChangedata();t.copyOpportunities("OpportunitiesOld");break;case 6:for(var i=0;i<c.length;i++){var G=c[i];if(!t.ptGroup[G.ProcessType]){t.ptGroup[G.ProcessType]=new Object({"StatusProfile":"","StatusCodes":[],"BusinessTxn":[],});t.ptGroup[G.ProcessType].StatusProfile=G.StatusProfile}t.ptGroup[G.ProcessType].StatusCodes.push(G.StatusCode);t.ptGroup[G.ProcessType].BusinessTxn.push(G.BusinessTransactionCode)}break}}};var e=function(E){t.showErrorMsg(E,true)};this.oDataModel.refreshSecurityToken();this.oDataModel.submitBatch(s,e,false)},initChangedata:function(){this.changeData={"discardcount":0,"changescount":0,"opportunity":[]};this.changeDataOld={"discardcount":0,"changescount":0,"opportunity":[]};this.changelogModel=new sap.ui.model.json.JSONModel(this.changeData);if(!this.oFragmentList.changeLogDialog){this.oFragmentList.changeLogDialog=new sap.ui.xmlfragment('cus.crm.salespipeline.sim.view.changeLogDialog',this);this.oFragmentList.changeLogDialog.setModel(this.getView().getModel("i18n"),"i18n");if(sap.ui.Device.system.desktop||sap.ui.Device.system.tablet)this.oFragmentList.changeLogDialog.setContentWidth("30em");if(sap.ui.version>"1.21.0"){var c=this.oFragmentList.changeLogDialog.getContent()[0].getFooter().getContentLeft();for(var i=-1,b;b=c[++i];)b.setWidth("32%")}}this.oFragmentList.changeLogDialog.setModel(this.changelogModel,"changeModel1");this.getView().setModel(this.changelogModel,"changeModel1")},updateChangedData:function(k,a){var d=this.getView().getModel("Opportunities").oData;if(arguments.length==1){for(var i=0;i<d.length;i++)if(d[a].key==k)a=i}var n=d[a];var o={};var b=this.getView().getModel("OpportunitiesOld").oData;for(var c in b)if(b[c].Id==n.Id)o=b[c];var e={"items":[],"Name":n.Description,"key":n.Guid,};var E={};var I=false;for(var i=-1,C;C=this.aChangeablePropsTexts[++i];){I=false;if(n[C.property]==null||o[C.property]==null){if(n[C.property]!=o[C.property])I=true}else{if(C.property=="ExpectedSalesVolume"){n[C.property]=Math.round(n[C.property]).toFixed(2);o[C.property]=Math.round(o[C.property]).toFixed(2)}if(n[C.property].valueOf()!=o[C.property].valueOf())I=true}if(I){switch(C.property){case"ClosingDate":E={"checked":false,"text":C.property,"propertyText":C.displayText,"OldValue":this.formatChangeLog(C.property,o[C.property],e.key),"NewValue":this.formatChangeLog(C.property,n[C.property],e.key),"StartDate":this.formatChangeLog(C.property,o["StartDate"],e.oldStartDate),};for(var z=-1,f;f=e.items[++z];)if(f.text=="StartDate"){E.StartDate=f.NewValue;break}break;default:E={"checked":false,"text":C.property,"propertyText":C.displayText,"OldValue":this.formatChangeLog(C.property,o[C.property],e.key),"NewValue":this.formatChangeLog(C.property,n[C.property],e.key)};break}e.items.push(E)}}var g=false;for(var i=-1,h;h=this.changeData.opportunity[++i];)if(h.key==e.key&&e.items.length!=0){if(e.items.length>0){g=true;this.changeData.changescount+=e.items.length-h.items.length;this.changeData.opportunity.splice(i,1,e)}else{this.changeData.changescount-=h.items.length;this.changeData.opportunity.splice(i,1)}break}if(!g&&e.items.length!=0){this.changeData.opportunity.push(e);this.changeData.changescount+=e.items.length}this.getView().getModel("changeModel1").refresh();this.oFragmentList.changeLogDialog.getModel("changeModel1").refresh()},loadData:function(){this.batchRead();this.setMinMax();var y=null,a=null;if(sap.ui.Device.system.phone){y=new sap.ui.model.json.JSONModel([0,50,100]);a=new sap.ui.model.json.JSONModel(["0%","50%","100%"])}else{var v=[0,20,40,60,80,100];var t=["0%","20%","40%","60%","80%","100%"];y=new sap.ui.model.json.JSONModel(v);a=new sap.ui.model.json.JSONModel(t)}this.getView().setModel(y,"yLabelValues");this.getView().setModel(a,"yLabelTexts")},copysetting:function(m){var s=new Object({});s=this.getView().getModel("SalesPipelineSetting").oData;var M=new sap.ui.model.json.JSONModel(s);if(m=="SettingsForDisplay")M.setDefaultBindingMode(sap.ui.model.BindingMode.OneWay);this.getView().setModel(M,m)},copyOpportunities:function(m){var O=[];var o=this.getView().getModel("Opportunities");if(o!=undefined){jQuery.extend(true,O,o.oData);var M=new sap.ui.model.json.JSONModel(O);this.getView().setModel(M,m)}},LoadSalesPipelineSettings:function(s){var t=this;this.oAppSettings=false;var S=function(d,r){d.results[0].STP2=t.viewType;var m=new sap.ui.model.json.JSONModel(d.results[0]);t.getView().setModel(m,"SalesPipelineSetting");t.oAppSettings=d.results[0];t.copysetting("SettingsForDisplay");var c=t.getView().byId("chart_sim");c.setMaxBubbleValue(d.results[0].OpportunityMaxValue);c.setMinBubbleValue(d.results[0].OpportunityMinValue);c.setBubbleStepValue(d.results[0].OpportunityStepValue)};var e=function(E){t.showErrorMsg(E,true)};this.oDataModel.read("SalesPipelineSettings",null,null,s,S,e)},LoadOpportunities:function(s){var t=this;t.Opportunities=false;var S=function(d,r){var a=d.results;var b=t.getView().getModel("SalesPipelineSetting").oData.CurrencyCode;var m=[];var I=0;for(var i=0;i<a.length;i++)if(a[i].CurrencyCode!=b){var c=false;for(var j=0;j<m.length;j++)if(m[j]==a[i].CurrencyCode){c=true;break}if(!c)m.push(a[i].CurrencyCode);I++;a.splice(i--,1)}var f=null,g=null,h="",k=t.oBundle;if(m.length==1){if(I==1)f=k.getText("LBL_ONE_CURR");else f=k.getText("LBL_MULTI_CURR",I);h+=m[0];g=k.getText("LBL_MAINTAIN_CURR",h)}else if(m.length>1){f=k.getText("LBL_MULTI_CURR",I);var l=m.length-1;for(var i=0;i<l;i++)h+=m[i]+", ";h+=m[l];g=k.getText("LBL_MAINTAIN_CURR",h)}if(m.length>0)sap.ca.ui.message.showMessageBox({type:sap.ca.ui.message.Type.INFO,message:f+" "+g});var M=new sap.ui.model.json.JSONModel(a);t.getView().setModel(M,"Opportunities");t.Opportunities=a};var e=function(E){t.showErrorMsg(E,true)};t.oDataModel.read("Opportunities",null,null,s,S,e);t.initChangedata();t.copyOpportunities("OpportunitiesOld")},LoadTimeIntervals:function(s,p){var t=this;var f=null;if(p){f=[];f[0]="$filter=PeriodicityType eq '"+p+"'"}var S=function(d,R){var T=d.results;var a=T;if(T.length>100){a=[];var r=0;for(var l=0;l<T.length;l+=2){a[r]=T[l];r++}a[r]=T[T.length-1]}var m=new sap.ui.model.json.JSONModel(a);t.getView().setModel(m,"TimeIntervals");var b=[];var c=[];var g=t.getView().getModel("TimeIntervals").oData;var h={"value":"","value2":""};var C=t.getView().byId("chart_sim");if(g.length==1){h.value=0;h.value2=g.length-1;if(h.value2==0){h.value2=1;g.push(g[0]);m.setData(g);t.getView().setModel(m,"TimeIntervals")}var M=new sap.ui.model.json.JSONModel(h);t.getView().setModel(M,"sliderValue");for(var i=0,j=g.length;i<j;i++){b[i]=g[i].Label;c[i]=g[i].TimeFrom}C.setXStart(c[0]);C.setXEnd(g[g.length-1].TimeTo)}else{var k=new Date(),j=0;k.setHours(0);k.setMinutes(0);k.setSeconds(0);k.setMilliseconds(0);k=cus.crm.salespipeline.sim.util.formatter.convFromSixZeros(k);if(T.length>100){for(;j<T.length-1;j++){if((k>=T[j].TimeFrom)&&(k<=T[j].TimeTo)){break}}j=parseInt(j/2)}else{for(;j<g.length-1;j++){if((k>=g[j].TimeFrom)&&(k<=g[j].TimeTo)){break}}}if(j==g.length-1){if(k.getFullYear()<new Date(g[1].TimeFrom).getFullYear()){j=0}if(k.getFullYear()>new Date(g[1].TimeFrom).getFullYear()){switch(p){case"1":j=g.length-5;break;case"2":j=g.length-4;break;case"3":j=g.length-2;break;case"4":j=g.length-2;break}}}h.value=j;switch(p){case"1":h.value2=j+4;break;case"2":h.value2=j+3;break;case"3":h.value2=j+1;break;case"4":h.value2=j+1;break}if(h.value2>=g.length){h.value2=g.length-1;switch(p){case"1":h.value=g.length-5;break;case"2":h.value=g.length-4;break;case"3":h.value=g.length-2;break;case"4":h.value=g.length-2;break}}if(h.value2==h.value){h.value2=h.value+1;g.push(g[h.value]);m.setData(g);t.getView().setModel(m,"TimeIntervals")}for(var i=h.value;i<=h.value2;i++){b[i-h.value]=g[i].Label;c[i-h.value]=g[i].TimeFrom;if(i==h.value)C.setXStart(g[i].TimeFrom);if(i==h.value2)C.setXEnd(g[i].TimeTo)}}t.getView().byId("name").setValue(h.value);t.getView().byId("name").setValue2(h.value2);m=new sap.ui.model.json.JSONModel(c);t.getView().setModel(m,"xLabelValues");m=new sap.ui.model.json.JSONModel(b);t.getView().setModel(m,"xLabelTexts")};var e=function(E){t.showErrorMsg(E,true)};t.oDataModel.read("TimeIntervals",null,f,s,S,e)},LoadPeriodicityTexts:function(s){var t=this;var S=function(d,r){var m=new sap.ui.model.json.JSONModel(d.results);t.getView().setModel(m,"PeriodicityTexts")};var e=function(E){t.showErrorMsg(E,true)};t.oDataModel.read("PeriodicityTexts",null,null,s,S,e)},LoadYearRanges:function(s){var t=this;var S=function(d,r){var m=new sap.ui.model.json.JSONModel(d.results);t.getView().setModel(m,"YearRanges")};var e=function(E){t.showErrorMsg(E,true)};t.oDataModel.read("YearRanges",null,null,true,S,e)},LoadCurrencyList:function(s){var t=this;var S=function(d,r){var m=new sap.ui.model.json.JSONModel(d.results);t.getView().setModel(m,"CurrencyList")};var e=function(E){t.showErrorMsg(E,true)};t.oDataModel.read("Currencies",null,null,true,S,e)},_getBTCode:function(o){var p=undefined,b="";for(var a in this.ptGroup)if(a==o.ProcessType){p=this.ptGroup[a];break}if(p!=undefined&&o.UserStatusCode!=undefined)for(var j=0;j<p.StatusCodes.length;j++)if(p.StatusCodes[j]==o.UserStatusCode){b=p.BusinessTxn[j];break}return b},calculateProgress:function(){var S=this.getView().getModel("SalesPipelineSetting").oData;var a=S.StartOfPeriod;var b=S.EndOfPeriod;var o=this.getView().getModel("Opportunities");if(o!=undefined){var O=o.oData;var P=0.0;var T=null;var u=cus.crm.salespipeline.sim.util.formatter;var c=0.0;for(var i=0;i<O.length;i++){var d=O[i].ClosingDate>=a;var e=O[i].ClosingDate<=b;var f=true;var t=this._getBTCode(O[i]);if(t=='LOST')f=false;if(d&&e&&f)c+=((O[i].ExpectedSalesVolume*O[i].ChanceOfSuccess)/100)}var g=this.getView().byId("pg");var L=this.getView().byId("objectStatus");L.addStyleClass("progressBarText");if(S.SalesTarget>0)P=(c/S.SalesTarget)*100;P=Math.round(P);var v=u.displayNumbersShort(Math.ceil(c));var h=u.displayNumbersShort(Math.ceil(S.SalesTarget));T=v+" "+this.oBundle.getText("LBL_OF")+" "+h;if(P>=100)g.setPercentValue(100);else g.setPercentValue(P);g.setDisplayValue(P+"%");L.setText(T+" ("+S.CurrencyCode+")")}},showSettings:function(e){if(!this.oFragmentList.settingsDialog){this.oFragmentList.settingsDialog=new sap.ui.xmlfragment("cus.crm.salespipeline.sim.view.settingsDialog",this);this.oFragmentList.settingsDialog.setModel(this.getView().getModel("i18n"),"i18n")}this.getView().byId("actSettings").openBy(e.getSource())},showChangeLog:function(e){if(!this.oFragmentList.changeLogDialog){this.oFragmentList.changeLogDialog=new sap.ui.xmlfragment('cus.crm.salespipeline.sim.view.changeLogDialog',this);this.oFragmentList.changeLogDialog.setModel(this.getView().getModel("i18n"),"i18n");this.oFragmentList.changeLogDialog.setModel(this.getView().getModel("changeModel1"),"changeModel1")}this.setDiscardButton(this.changeData.discardcount);this.setSelectAllCheckbox(this.changeData.discardcount,this.changeData.changescount);this.oFragmentList.changeLogDialog.open()},selectActSetting:function(e){this.copysetting("SettingsForSave");var s=this.getView().getModel("SettingsForSave"),n={};n["SalesTarget"]=s.oData.SalesTarget;n["CurrencyCode"]=s.oData.CurrencyCode;n["SalesTargetPeriodicity"]=s.oData.SalesTargetPeriodicity;n["TimeFrom"]=s.oData.TimeFrom;n["TimeTo"]=s.oData.TimeTo;this.oSalesSettings=n;if(this.oFragmentList.SalesTargetDialog)this.oFragmentList.SalesTargetDialog.setModel(s,"SettingsForSave");this.oFragmentList.settingsDialog.open()},selectDlgSetting:function(e){this.oFragmentList.settingsDialog.close();var l=this.oFragmentList.settingsDialog.getContent()[0];if(l.getItems()[0].isSelected())this.oFragmentList.SalesTargetDialog.open();l.getSelectedItem().setSelected(false)},closeAppSettDialog:function(e){this.oFragmentList.settingsDialog.close()},resetAllOpp:function(e){if(!this.oFragmentList.resetDialog){this.oFragmentList.resetDialog=new sap.ui.xmlfragment("cus.crm.salespipeline.sim.view.resetDialog",this);this.oFragmentList.resetDialog.setModel(this.getView().getModel("i18n"),"i18n");if(sap.ui.Device.system.desktop||sap.ui.Device.system.tablet)this.oFragmentList.resetDialog.setContentWidth("30em")}this.isNavButtonClicked=!(this.getView().byId("butReset")==e.getSource());if(this.getView().byId("butSave").getVisible()){this.oFragmentList.resetDialog.open();sap.ui.getCore().byId('RefreshDialog').allowTextSelection(false)}else this._navBack()},refreshDlg:function(e){this.oFragmentList.resetDialog.close();if(sap.ui.getCore().byId("rfButOK")==e.getSource()){if(this.oNavParams.toOppApp!="")window.location=this.oNavParams.toOppApp;else if(this.oNavParams.toContactApp!="")window.location=this.oNavParams.toContactApp;else if(this.oNavParams.toAccountApp!="")window.location=this.oNavParams.toAccountApp;else if(this.oNavParams.telCall!="")sap.m.URLHelper.triggerTel(this.oNavParams.telCall);else if(this.oNavParams.sendMail!="")sap.m.URLHelper.triggerMail(this.oNavParams.sendMail);else if(!this.isNavButtonClicked){this.LoadOpportunities(false);this.getView().getModel("Opportunities").refresh();this.setMinMax();this.resetChangeLog();this.showTopNOpp()}else this._navBack()}this.oNavParams={"toOppApp":"","toContactApp":"","toAccountApp":"","telCall":"","sendMail":"",}},navBack:function(e){var s=this.getView().getModel("SettingsForSave").oData;s["SalesTarget"]=this.oSalesSettings.SalesTarget;s["CurrencyCode"]=this.oSalesSettings.CurrencyCode;s["SalesTargetPeriodicity"]=this.oSalesSettings.SalesTargetPeriodicity;s["TimeFrom"]=this.oSalesSettings.TimeFrom;s["TimeTo"]=this.oSalesSettings.TimeTo;this.oFragmentList.SalesTargetDialog.close();this.oFragmentList.settingsDialog.open()},TimespanChange:function(e){var s=sap.ui.getCore().byId("sFrom");var a=sap.ui.getCore().byId("sTo");var t=[],b=[];for(var i=-1,c;c=a.getItems()[++i];){var p=parseInt(c.getText());t.push(new Object({"dispText":p?p:c.getText(),"key":c.getKey()}))}for(var i=-1,c;c=s.getItems()[++i];){var p=parseInt(c.getText());b.push(new Object({"dispText":p?p:c.getText(),"key":c.getKey()}))}var d=e.getParameter("selectedItem").getText();d=parseInt(d)?parseInt(d):d;if(s==e.getSource()){for(var i=0;i<b.length;i++)if(d==b[i]["dispText"])break;var o=a.getSelectedItem().getText();var f=new Object({"key":a.getSelectedKey(),"dispText":parseInt(o)?parseInt(o):o});if(!(d<=f["dispText"]))a.setSelectedKey(t[i]["key"])}else{for(var i=0;i<t.length;i++)if(d==t[i]["dispText"])break;var o=s.getSelectedItem().getText();var f=new Object({"key":s.getSelectedKey(),"dispText":parseInt(o)?parseInt(o):o});if(!(f["dispText"]<=d))s.setSelectedKey(b[i]["key"])}},setMinMax:function(){var o=this.getView().getModel("Opportunities");if(o!=undefined){var O=o.oData;var e=[];for(var i=0;i<O.length;i++)e.push(parseFloat(O[i].ExpectedSalesVolume));e.sort(function(a,b){return a-b});var c=this.getView().byId("chart_sim");this.minOpp=0.25*e[0];this.maxOpp=3*e[O.length-1];c.setMinBubbleValue(this.minOpp);c.setMaxBubbleValue(this.maxOpp)}},checkValue:function(e){var c=e.getSource(),u=cus.crm.salespipeline.sim.util.formatter;var p=u.reverseNumbers(c.getValue());c.setValue(u.displayNumbers(p))},saveAppSetChange:function(e){var t=this,c=e.getSource();this.reRenderTopNSlider=true;var u=cus.crm.salespipeline.sim.util.formatter;var E=this.getView().getModel("SettingsForSave").oData;if(c==sap.ui.getCore().byId("spButSave")){E.TimeFrom=new Date(E.TimeFrom);E.TimeTo=new Date(E.TimeTo);this.viewType=E.STP2;delete E.STP2;var v=sap.ui.getCore().byId("iST").getValue();E.SalesTarget=u.reverseNumbers(v)+".0";var p={};p.bMerge=false;p.fnSuccess=function(){if(sap.ui.getCore().byId("spButSave")==c)t.oFragmentList.SalesTargetDialog.close();sap.ca.ui.message.showMessageToast(t.oBundle.getText("LBL_SUCCESSUPDATE"));t.LoadSalesPipelineSettings(false);t.LoadOpportunities(false);t.setMinMax();t.LoadTimeIntervals(false,t.viewType);t.calculateProgress()};p.fnError=function(o){t.showErrorMsg(o,false)};var a="/SalesPipelineSettings('"+E.UserName+"')";this.oDataModel.update(a,E,p)}else{E["SalesTarget"]=this.oSalesSettings.SalesTarget;E["CurrencyCode"]=this.oSalesSettings.CurrencyCode;E["SalesTargetPeriodicity"]=this.oSalesSettings.SalesTargetPeriodicity;E["TimeFrom"]=this.oSalesSettings.TimeFrom;E["TimeTo"]=this.oSalesSettings.TimeTo;this.oFragmentList.SalesTargetDialog.close()}},cancelAppSetChange:function(e){var s=this.getView().getModel("SettingsForSave").oData;s["SalesTarget"]=this.oSalesSettings.SalesTarget;s["CurrencyCode"]=this.oSalesSettings.CurrencyCode;s["SalesTargetPeriodicity"]=this.oSalesSettings.SalesTargetPeriodicity;s["TimeFrom"]=this.oSalesSettings.TimeFrom;s["TimeTo"]=this.oSalesSettings.TimeTo;if(sap.ui.getCore().byId("spButCancel")==e.getSource())this.oFragmentList.SalesTargetDialog.close()},onDiscardAllChecked:function(e){this.changeData.discardcount=0;for(var i=-1,c;c=this.changeData.opportunity[++i];)for(var j=-1,C;C=c.items[++j];){C.checked=e.getParameter('selected');if(C.checked)this.changeData.discardcount+=1}this.setDiscardButton(this.changeData.discardcount);this.getView().getModel("changeModel1").refresh();this.oFragmentList.changeLogDialog.getModel("changeModel1").refresh();this.getView().getModel("Opportunities").refresh()},onDiscardChecked:function(e){if(e.getParameter('selected'))this.changeData.discardcount+=1;else this.changeData.discardcount-=1;this.setDiscardButton(this.changeData.discardcount);this.setSelectAllCheckbox(this.changeData.discardcount,this.changeData.changescount);this.getView().getModel("changeModel1").refresh();this.oFragmentList.changeLogDialog.getModel("changeModel1").refresh()},setDiscardButton:function(d){var D=this.oBundle.getText("BTN_CL_DISCARD"),s=this.oBundle.getText("BTN_SAVE_OPPORT");var b=sap.ui.getCore().byId("discardBtn"),a=sap.ui.getCore().byId("saveBtn");if(d>0){D=this.oBundle.getText("BTN_CL_DISCARDSEL")+" ("+d+")";s+=" ("+d+")";b.setEnabled(true);a.setEnabled(true)}else{b.setEnabled(false);a.setEnabled(false)}b.setText(D);a.setText(s)},setSelectAllCheckbox:function(d,c){var a=sap.ui.getCore().byId("cbAllChanges");if(c==0){a.setEnabled(false);a.setSelected(false);return}else a.setEnabled(true);if(d<c)a.setSelected(false);else a.setSelected(true)},resetChangeLog:function(){for(var i=this.changeData.opportunity.length-1;i>=0;i--)this.changeData.opportunity.splice(i,1);this.changeData.changescount=0;this.changeData.discardcount=0;this.setDiscardButton(this.changeData.discardcount);this.setSelectAllCheckbox(this.changeData.discardcount,this.changeData.changescount);this.getView().getModel("changeModel1").refresh();this.oFragmentList.changeLogDialog.getModel("changeModel1").refresh();this.getView().getModel("Opportunities").refresh()},resetChangeLog2:function(){for(var i=this.changeData.opportunity.length-1;i>=0;i--){for(var j=this.changeData.opportunity[i].items.length-1;j>=0;j--)if(this.changeData.opportunity[i].items[j].checked==true)this.changeData.opportunity[i].items.splice(j,1);if(this.changeData.opportunity[i].items.length==0)this.changeData.opportunity.splice(i,1)}if(sap.ui.getCore().byId("cbAllChanges").getSelected()==true)this.oFragmentList.changeLogDialog.close();this.changeData.changescount-=this.changeData.discardcount;this.changeData.discardcount=0;this.setDiscardButton(this.changeData.discardcount);this.setSelectAllCheckbox(this.changeData.discardcount,this.changeData.changescount);this.getView().getModel("changeModel1").refresh();this.oFragmentList.changeLogDialog.getModel("changeModel1").refresh();this.getView().getModel("Opportunities").refresh()},onDiscard:function(){var o=this.getView().getModel("Opportunities").oData;for(var i=-1,c;c=this.changeData.opportunity[++i];){for(var j=c.items.length,C;C=c.items[--j];)if(C.checked==true){for(var k=-1,O;O=o[++k];)if(O.Guid==c.key)O[C.text]=this.unformatChangeLog(C.text,C.OldValue,c.key);c.items.splice(j,1)}if(c.items.length==0)this.changeData.opportunity.splice(i,1)}if(sap.ui.getCore().byId("cbAllChanges").getSelected()==true)sap.ui.getCore().byId("changeLogDialog").close();this.changeData.changescount-=this.changeData.discardcount;this.changeData.discardcount=0;this.setDiscardButton(this.changeData.discardcount);this.setSelectAllCheckbox(this.changeData.discardcount,this.changeData.changescount);this.getView().getModel("changeModel1").refresh();this.oFragmentList.changeLogDialog.getModel("changeModel1").refresh();this.getView().getModel("Opportunities").refresh();this.calculateProgress()},onClose:function(){for(var i=0;i<this.changeData.opportunity.length;i++)for(var j=0;j<this.changeData.opportunity[i].items.length;j++)this.changeData.opportunity[i].items[j].checked=false;this.changeData.discardcount=0;this.setDiscardButton(this.changeData.discardcount);sap.ui.getCore().byId("cbAllChanges").setSelected(false);this.oFragmentList.changeLogDialog.close();this.getView().getModel("changeModel1").refresh();this.oFragmentList.changeLogDialog.getModel("changeModel1").refresh()},dualsliderchange:function(){var c=this.getView().byId("chart_sim");var v=arguments[0].getParameter("value");var a=arguments[0].getParameter("value2");var u=this.getView().byId("name").getUnits();var t=this.getView().getModel("TimeIntervals");var l=[];var b=[];for(var i=v;i<=a;i++){l[i-v]=u[i].getValue();b[i-v]=u[i].getKey();if(i==v)c.setXStart(u[i].getKey());if(i==a)c.setXEnd(t.oData[i].TimeTo)}c.setXLabelTexts(l);c.setXLabelValues(b)},onPeriodicityChange:function(e){this.LoadTimeIntervals(true,e.getSource().getSelectedKey());this.reRenderTopNSlider=true},bubblechange:function(e){var O=this.getView().getModel("Opportunities").oData;for(var i=0;i<O.length;i++)if(O[i].Guid==e.getParameter('item')['key']){if(e.getParameter('item')['z']){O[i].ExpectedSalesVolume=e.getParameter('item')['z']}else{O[i].ChanceOfSuccess=e.getParameter('item')['y'];O[i].ClosingDate=e.getParameter('item')['x']}this.updateChangedData(e.getParameter('item')['key'],i)}var m=new sap.ui.model.json.JSONModel(O);this.getView().setModel(m,"Opportunities");this.calculateProgress()},bubbleclick:function(e){this.iChangeStartDate=0;this.iChangeEndDate=0;var a=this.oFragmentList.opportunityPopover;a.close();var m=this.oDataModel;m.setCountSupported(false);var o=this.getView().getModel("Opportunities").oData;this.guidVal=e.getParameter('item').key;var t=this;var p,b,c,d,f,g,h;var k,l,n,q,r,s,u;sap.ui.getCore().byId("mainContact").setVisible(false);sap.ui.getCore().byId("empResp").setVisible(false);var A=this.getView().getModel("OpportunitiesOld").oData;for(var i=0;i<o.length;i++){if(A[i].Guid===this.guidVal){this.actualStartDate=A[i].StartDate;this.actualEndDate=A[i].ClosingDate;this.actualExpRevval=A[i].ExpectedSalesVolume}if(o[i].Guid===this.guidVal){this.selOpp=o[i];f=this.selOpp.UserStatusCode;b=this.selOpp.SalesStageCode;p=this.selOpp.ProcessType;g=this.selOpp.CurrencyCode;r=this.selOpp.EmployeeName;s=this.selOpp.ContactPersonName;u=this.selOpp.ContactPersonID;h=this.selOpp.AccountName;this.pAccountId=this.selOpp.AccountID;this.pContactId=this.selOpp.ContactPersonID;n=this.selOpp.Id;q=this.selOpp.Description;break}}sap.ui.getCore().byId("OppId").setText(n);sap.ui.getCore().byId("OppDescription").setText(q);var v=" ("+g+")";var L=sap.ui.getCore().byId("lblExpRev");var w=sap.ui.getCore().byId("lblWgtRev");L.setText(this.oBundle.getText("LBL_OD_EXPECTEDREVENUE")+v);w.setText(this.oBundle.getText("LBL_OD_WEIGHTEDREVENUE")+v);var y=[m.createBatchOperation("OpportunityStatuses?$filter="+jQuery.sap.encodeURL("HeaderGuid eq guid'"+this.guidVal+"'"),"GET"),m.createBatchOperation("SalesStages?$filter="+jQuery.sap.encodeURL("ProcessType eq '"+p+"'"),"GET"),m.createBatchOperation("Opportunities(guid'"+this.guidVal+"')?$expand=SalesTeam","GET")];m.addBatchReadOperations(y);m.setHeaders({"X-REQUESTED-WITH":"XMLHttpRequest"});this.selOpp.StatusEmpty=true;this.selOpp.SalesStageEmpty=true;var S=function(N,O){var P=N.__batchResponses;for(var i=0;i<P.length;i++){if(parseInt(P[i].statusCode)!==200){t.showErrorMsg(P[i],true);break}else switch(i){case 0:var Q=new sap.ui.model.json.JSONModel(P[i].data.results);var R=sap.ui.getCore().byId("status1");R.setModel(Q,"StatusMgt");var T=null,U=false;for(var j=-1,V;V=t.arrStatusPros[++j];)if(P[i].data.results[0].HeaderGuid==V.HeaderGuid){U=true;break}if(!U){T=new Object({"HeaderGuid":P[i].data.results[0].HeaderGuid,"StatusProfile":P[i].data.results[0].StatusProfile,"Statuses":P[i].data.results});t.arrStatusPros.push(T)}var W=null;for(var j=-1;W=R.getItems()[++j];)if(W.getKey()==f){t.selOpp.StatusEmpty=false;break}if(t.selOpp.StatusEmpty)R.setSelectedItem(R.getItems()[0]);else R.setSelectedItem(W);break;case 1:var X=new sap.ui.model.json.JSONModel(P[i].data.results);var Y=sap.ui.getCore().byId("salesStage1");Y.setModel(X,"SalesOpp");var Z=null,U=false;for(var j=-1,$;$=t.arrStagesPros[++j];)if(t.guidVal==$.guidVal){U=true;break}if(!U){Z=new Object({"guidVal":t.guidVal,"ProcessType":P[i].data.results[0].ProcessType,"Stages":P[i].data.results});t.arrStagesPros.push(Z)}var W=null;for(var j=-1;W=Y.getItems()[++j];)if(W.getKey()==b){t.selOpp.SalesStageEmpty=false;break}if(t.selOpp.SalesStageEmpty)Y.setSelectedItem(Y.getItems()[0]);else Y.setSelectedItem(W);break;case 2:l=P[i].data.SalesTeam.results;break}}};var E=function(j){t.showErrorMsg(j,true)};m.submitBatch(S,E,false);var z=cus.crm.salespipeline.sim.util.formatter;if(this.selOpp.ForecastRelevance=="X")sap.ui.getCore().byId("forecastId").setState(true);else if(this.selOpp.ForecastRelevance=="")sap.ui.getCore().byId("forecastId").setState(false);var x=parseFloat(this.selOpp.ChanceOfSuccess)+"%";sap.ui.getCore().byId("chanceOfSucc").setValue(x);var B=new Date(this.selOpp.StartDate.toDateString());sap.ui.getCore().byId("d1").setValue(z.displayDates(B));sap.ui.getCore().byId("calStart").setCurrentDate(B.toDateString());var C=new Date(this.selOpp.ClosingDate.toDateString());sap.ui.getCore().byId("d2").setValue(z.displayDates(C));sap.ui.getCore().byId("calEnd").setCurrentDate(C.toDateString());var D=sap.ui.getCore().byId("expRevId");D.setValue(z.displayNumbers(Math.round(this.selOpp.ExpectedSalesVolume)));var F=(this.selOpp.ExpectedSalesVolume*this.selOpp.ChanceOfSuccess)/100;sap.ui.getCore().byId("wgtRevId").setValue(z.displayNumbers(F));if(l!=undefined){for(var i=-1,G;G=l[++i];){switch(parseInt(G.PartnerFuntionCode)){case 14:sap.ui.getCore().byId("empResp").setVisible(true);sap.ui.getCore().byId("empRespName").setText(G.PartnerName);if(G.Email!=undefined&&G.Email!=""){var H=sap.ui.getCore().byId("empRespEmail");H.setVisible(true);H.setText(G.Email)}if(G.Telephone!=undefined&&G.Telephone!=""){var I=sap.ui.getCore().byId("empRespPhone");I.setVisible(true);I.setText(G.Telephone)}break;case 15:sap.ui.getCore().byId("mainContact").setVisible(true);sap.ui.getCore().byId("mainContactName").setText(G.PartnerName);if(G.Email!=undefined&&G.Email!=""){var M=sap.ui.getCore().byId("mcEmail");M.setVisible(true);M.setText(G.Email)}if(G.Telephone!=undefined&&G.Telephone!=""){var J=sap.ui.getCore().byId("mcPhone");J.setVisible(true);J.setText(G.Telephone)}break;default:break}}}sap.ui.getCore().byId("accName").setText(h);t.selectedbubble=e.getParameter('item').key;if(sap.ui.Device.system.phone){sap.ui.getCore().byId("upBtn").setVisible(true);sap.ui.getCore().byId("downBtn").setVisible(true)}else{t.overlappingBubbles=e.getParameter('item').overlappedbubbles;var K=sap.ui.getCore().byId("poBar");if(t.overlappingBubbles.length>1){sap.ui.getCore().byId("upBtn").setVisible(true);sap.ui.getCore().byId("downBtn").setVisible(true);K.addContentLeft(sap.ui.getCore().byId("oppDetails"));K.removeAllContentMiddle()}else{sap.ui.getCore().byId("upBtn").setVisible(false);sap.ui.getCore().byId("downBtn").setVisible(false);K.addContentMiddle(sap.ui.getCore().byId("oppDetails"));K.removeAllContentLeft()}}if(this.extHookOpportunityPopover)this.extHookOpportunityPopover();a.openBy(e.getParameter('item').selected)},cancelChangeOpp:function(){this.oFragmentList.opportunityPopover.close()},moveUp:function(){var t=this;var n=this.getView().byId("name");var v=n.getValue();var a=n.getValue2();var u=n.getUnits();var F=[];var l=[];var b=[];var s=null;var e=null;var c=this.getView().byId("chart_sim");var d=0;if(sap.ui.Device.system.phone==true){var f=this.getView().getModel("TimeIntervals");var O=this.getView().getModel("Opportunities").oData;for(var i=v;i<=a;i++){l[i-v]=u[i].getValue();b[i-v]=u[i].getKey();if(i==v)s=u[i].getKey();if(i==a)e=f.oData[i].TimeTo}for(var i=0;i<O.length;i++)if((O[i].ClosingDate>=s)&&(O[i].ClosingDate<=e)){F.push(O[i])}for(var i=0;i<F.length;i++)if(F[i].Guid===t.selectedbubble){d=i+1;if(d>=F.length)d=0}c.setSelection(F[d].Guid)}else{for(var i=0;i<t.overlappingBubbles.length;i++)if(t.overlappingBubbles[i].id===t.selectedbubble){d=i+1;if(d>=t.overlappingBubbles.length)d=0}c.setSelection(t.overlappingBubbles[d].id)}},moveDown:function(){var t=this;var v=this.getView().byId("name").getValue();var a=this.getView().byId("name").getValue2();var u=this.getView().byId("name").getUnits();var F=[];var l=[];var b=[];var s=null;var e=null;var c=this.getView().getModel("TimeIntervals");var O=this.getView().getModel("Opportunities").oData;var d=this.getView().byId("chart_sim");var f=0;if(sap.ui.Device.system.phone==true){for(var i=v;i<=a;i++){l[i-v]=u[i].getValue();b[i-v]=u[i].getKey();if(i==v)s=u[i].getKey();if(i==a)e=c.oData[i].TimeTo}for(var i=0;i<O.length;i++)if((O[i].ClosingDate>=s)&&(O[i].ClosingDate<=e)){F.push(O[i])}for(var i=0;i<F.length;i++)if(F[i].Guid===t.selectedbubble){f=i-1;if(f<0)f=F.length-1}d.setSelection(F[f].Guid)}else{for(var i=0;i<t.overlappingBubbles.length;i++)if(t.overlappingBubbles[i].id===t.selectedbubble){f=i-1;if(f<0)f=t.overlappingBubbles.length-1}d.setSelection(t.overlappingBubbles[f].id)}},submitChangeOpp:function(e){var O=this.getView().getModel("Opportunities").oData;var p=sap.ui.getCore().byId("expRevId").getValue();for(var i=0;i<O.length;i++){if(O[i].Guid==this.guidVal){if(this.iChangeStartDate==1)O[i].StartDate=this.currStartDate;if(this.iChangeEndDate==1)O[i].ClosingDate=this.currEndDate;if(this.iChangeCOS==0){O[i].ChanceOfSuccess=parseFloat(this.unformatChangeLog("ChanceOfSuccess",sap.ui.getCore().byId("chanceOfSucc").getValue()))}if(this.compose(p)!=this.actualExpRevval&&this.iChangeExpRev==0){if(isNaN(this.compose(p)))O[i].ExpectedSalesVolume=this.actualExpRevval;else O[i].ExpectedSalesVolume=this.compose(p)}else this.selOpp.ExpectedSalesVolume=this.actualExpRevval;if(!this.selOpp.SalesStageEmpty)O[i].SalesStageCode=sap.ui.getCore().byId("salesStage1").getSelectedKey();if(!this.selOpp.StatusEmpty)O[i].UserStatusCode=sap.ui.getCore().byId("status1").getSelectedKey();if(sap.ui.getCore().byId("forecastId").getState())O[i].ForecastRelevance="X";else O[i].ForecastRelevance="";this.updateChangedData(this.guidVal,i);this.oFragmentList.opportunityPopover.close();this.getView().getModel("Opportunities").refresh();this.calculateProgress()}}},saveAllOpp:function(){var t=this,a=true,e=[],b={};var s=function(r){sap.ca.ui.message.showMessageToast(t.oBundle.getText("LBL_SUCCESSUPDATE"));t.LoadOpportunities(false);t.getView().getModel("Opportunities").refresh();t.setMinMax();t.resetChangeLog();t.showTopNOpp()};var E=function(l){t.showErrorMsg(l,false)};for(var i=0;i<this.changeData.opportunity.length;i++){var o=0;var c=new Object({"Guid":"",});for(var j=0;j<this.changeData.opportunity[i].items.length;j++){var d=this.changeData.opportunity[i].items[j];if("UserStatusCode"==this.changeData.opportunity[i].items[j].text){var S=new Object({"HeaderGuid":"","StatusProfile":"","UserStatusCode":""});S.HeaderGuid=this.changeData.opportunity[i].key;for(var k=0;k<t.arrStatusPros.length;k++)if(t.arrStatusPros[k].HeaderGuid==S.HeaderGuid){S.StatusProfile=t.arrStatusPros[k].StatusProfile;break}S.UserStatusCode=this.unformatChangeLog(d.text,d.NewValue,S.HeaderGuid);var f="/OpportunityStatuses(StatusProfile='"+S.StatusProfile+"',UserStatusCode='"+S.UserStatusCode+"',HeaderGuid=guid'"+S.HeaderGuid+"')";this.oDataModel.addBatchChangeOperations([this.oDataModel.createBatchOperation(f,"MERGE",S,null)]);continue}else if(o==0){c.Guid=this.changeData.opportunity[i].key;o++}switch(this.changeData.opportunity[i].items[j].text){case"ChanceOfSuccess":c.ChanceOfSuccess=this.unformatChangeLog(d.text,d.NewValue);break;case"ClosingDate":if(typeof d.NewValue==="string"){var n=this.unformatChangeLog("ClosingDate",d.NewValue,this.changeData.opportunity[i].key);var g=this.unformatChangeLog("ClosingDate",d.StartDate,this.changeData.opportunity[i].key);if(n<g){a=false;b={};b["opportunityName"]=this.changeData.opportunity[i].Name;b["opportunityKey"]=this.changeData.opportunity[i].key;e.push(b)}else{c.ClosingDate=this.unformatChangeLog(d.text,d.NewValue)}}break;case"StartDate":if(typeof d.NewValue==="string"){c.StartDate=this.unformatChangeLog(d.text,d.NewValue)}break;case"ExpectedSalesVolume":c.ExpectedSalesVolume=this.unformatChangeLog(d.text,d.NewValue)+".0";c.CurrencyCode=this.getView().getModel("SalesPipelineSetting").oData.CurrencyCode;break;case"ForecastRelevance":c.ForecastRelevance=this.unformatChangeLog(d.text,d.NewValue);break;case"SalesStageCode":c.SalesStageCode=this.unformatChangeLog(d.text,d.NewValue,c.Guid);break}d=null}if(a)if(c.Guid!=""){var u="/Opportunities(guid'"+c.Guid+"')";this.oDataModel.addBatchChangeOperations([this.oDataModel.createBatchOperation(u,"MERGE",c,null)])}}if(a){this.oDataModel.setHeaders({"X-REQUESTED-WITH":"XMLHttpRequest"});this.oDataModel.submitBatch(s,E,false)}else{var h=this.oBundle.getText("LBL_ENDDATE_ERROR_LOPP")+": \n\n";for(var i=0;i<e.length;i++)h+=e[i].opportunityName+"\n";sap.ca.ui.message.showMessageBox({type:sap.ca.ui.message.Type.WARNING,message:h})}},changeLogSave:function(){var t=this,a=true,e=[],b={};var s=function(r){sap.ca.ui.message.showMessageToast(t.oBundle.getText("LBL_SUCCESSUPDATE"));t.setMinMax();t.resetChangeLog2();t.showTopNOpp()};var E=function(l){t.showErrorMsg(l,false)};for(var i=0;i<this.changeData.opportunity.length;i++){var o=0;var c=new Object({"Guid":"",});for(var j=0;j<this.changeData.opportunity[i].items.length;j++){if(this.changeData.opportunity[i].items[j].checked==true){var d=this.changeData.opportunity[i].items[j];if("UserStatusCode"==this.changeData.opportunity[i].items[j].text){var S=new Object({"HeaderGuid":"","StatusProfile":"","UserStatusCode":""});S.HeaderGuid=this.changeData.opportunity[i].key;for(var k=0;k<t.arrStatusPros.length;k++)if(t.arrStatusPros[k].HeaderGuid==S.HeaderGuid){S.StatusProfile=t.arrStatusPros[k].StatusProfile;break}S.UserStatusCode=this.unformatChangeLog(d.text,d.NewValue,S.HeaderGuid);var f="/OpportunityStatuses(StatusProfile='"+S.StatusProfile+"',UserStatusCode='"+S.UserStatusCode+"',HeaderGuid=guid'"+S.HeaderGuid+"')";this.oDataModel.addBatchChangeOperations([this.oDataModel.createBatchOperation(f,"MERGE",S,null)]);continue}else if(o==0){c.Guid=this.changeData.opportunity[i].key;o++}switch(this.changeData.opportunity[i].items[j].text){case"ChanceOfSuccess":c.ChanceOfSuccess=this.unformatChangeLog(d.text,d.NewValue);break;case"ClosingDate":if(typeof d.NewValue==="string"){var n=this.unformatChangeLog("ClosingDate",d.NewValue,this.changeData.opportunity[i].key);var g=this.unformatChangeLog("ClosingDate",d.StartDate,this.changeData.opportunity[i].key);if(n<g){a=false;b={};b["opportunityName"]=this.changeData.opportunity[i].Name;b["opportunityKey"]=this.changeData.opportunity[i].key;e.push(b)}else{c.ClosingDate=this.unformatChangeLog(d.text,d.NewValue)}}break;case"StartDate":if(typeof d.NewValue==="string"){c.StartDate=this.unformatChangeLog(d.text,d.NewValue)}break;case"ExpectedSalesVolume":c.ExpectedSalesVolume=this.unformatChangeLog(d.text,d.NewValue)+".0";c.CurrencyCode=this.getView().getModel("SalesPipelineSetting").oData.CurrencyCode;break;case"ForecastRelevance":c.ForecastRelevance=this.unformatChangeLog(d.text,d.NewValue);break;case"SalesStageCode":c.SalesStageCode=this.unformatChangeLog(d.text,d.NewValue,c.Guid);break}d=null}}if(a)if(c.Guid!=""){var u="/Opportunities(guid'"+c.Guid+"')";this.oDataModel.addBatchChangeOperations([this.oDataModel.createBatchOperation(u,"MERGE",c,null)])}}if(a){this.oDataModel.setHeaders({"X-REQUESTED-WITH":"XMLHttpRequest"});this.oDataModel.submitBatch(s,E,false)}else{var h=this.oBundle.getText("LBL_ENDDATE_ERROR_LOPP")+": \n\n";for(var i=0;i<e.length;i++)h+=e[i].opportunityName+"\n";sap.ca.ui.message.showMessageBox({type:sap.ca.ui.message.Type.WARNING,message:h})}},checkStartDate:function(e){var t=this;var p=e.getParameters(),c=e.getSource();var u=cus.crm.salespipeline.sim.util.formatter;var a=this.selOpp.StartDate;if(p.newValue!=undefined){var b=new Date(p.newValue);if(b.toDateString()=="Invalid Date"){c.setValue(u.displayDates(this.selOpp.StartDate));this.currStartDate=this.selOpp.StartDate}else{var d=new Date(sap.ui.getCore().byId('d2').getValue());var f=new Date(b);if(d<f){sap.ui.getCore().byId('d1').setValue(a);sap.ca.ui.message.showMessageBox({type:sap.ca.ui.message.Type.WARNING,message:t.oBundle.getText("LBL_STARTDATE_ERROR")});c.setValue(u.displayDates(a));this.currStartDate=u.convFromSixZeros(a)}else{b=u.convFromSixZeros(b);c.setValue(u.displayDates(b));this.currStartDate=b}}}else{var d=new Date(sap.ui.getCore().byId('d2').getValue());var f=new Date(p);if(d<f){sap.ui.getCore().byId('d1').setValue(a);sap.ca.ui.message.showMessageBox({type:sap.ca.ui.message.Type.WARNING,message:t.oBundle.getText("LBL_STARTDATE_ERROR")});c.setValue(u.displayDates(a));this.currStartDate=u.convFromSixZeros(a)}else{p=u.convFromSixZeros(p);c.setValue(u.displayDates(p));this.currStartDate=p}}if(this.currStartDate.toDateString()==this.actualStartDate.toDateString()){this.iChangeStartDate=0;this.selOpp.StartDate=this.actualStartDate}else if(this.currStartDate.toDateString()==this.selOpp.StartDate.toDateString())this.iChangeStartDate=0;else this.iChangeStartDate=1},checkEndDate:function(e){var t=this,c=e.getSource();var p=e.getParameters();var a=this.selOpp.ClosingDate;var u=cus.crm.salespipeline.sim.util.formatter;if(p.newValue!=undefined){var b=new Date(p.newValue);if(b.toDateString()=="Invalid Date"){c.setValue(u.displayDates(this.selOpp.EndDate));this.currEndDate=this.selOpp.EndDate}else{var s=new Date(sap.ui.getCore().byId('d1').getValue());var d=new Date(b);if(s>d){sap.ui.getCore().byId('d2').setValue(a);sap.ca.ui.message.showMessageBox({type:sap.ca.ui.message.Type.WARNING,message:t.oBundle.getText("LBL_ENDDATE_ERROR")});c.setValue(u.displayDates(a));this.currEndDate=u.convFromSixZeros(a)}else{b=u.convFromSixZeros(b);c.setValue(u.displayDates(b));this.currEndDate=b}}}else{var s=new Date(sap.ui.getCore().byId('d1').getValue());var d=new Date(p);if(s>d){sap.ui.getCore().byId('d2').setValue(a);sap.ca.ui.message.showMessageBox({type:sap.ca.ui.message.Type.WARNING,message:t.oBundle.getText("LBL_ENDDATE_ERROR")});c.setValue(u.displayDates(a));this.currEndDate=u.convFromSixZeros(a)}else{p=u.convFromSixZeros(p);c.setValue(u.displayDates(p));this.currEndDate=p}}if(this.currEndDate.toDateString()==this.actualEndDate.toDateString()){this.iChangeEndDate=0;this.selOpp.ClosingDate=this.actualEndDate}else if(this.currEndDate.toDateString()==this.selOpp.ClosingDate.toDateString())this.iChangeEndDate=0;else this.iChangeEndDate=1},showDD:function(e){var c=null,C=e.getSource();if(C==sap.ui.getCore().byId("d1"))c=sap.ui.getCore().byId("calStart");else if(C==sap.ui.getCore().byId("d2"))c=sap.ui.getCore().byId("calEnd");if(c.getVisible())c.setVisible(false);else c.setVisible(true)},closeOpport:function(e){sap.ui.getCore().byId("calStart").setVisible(false);sap.ui.getCore().byId("calEnd").setVisible(false)},changeStartDate:function(e){var c=e.getSource();if(c.getSelectedDates().length==1){c.setCurrentDate(c.getSelectedDates()[0]);var a=new Date(c.getCurrentDate());sap.ui.getCore().byId("d1").fireChange(a)}c.setVisible(false)},changeEndDate:function(e){var c=e.getSource();if(c.getSelectedDates().length==1){c.setCurrentDate(c.getSelectedDates()[0]);var a=new Date(c.getCurrentDate());sap.ui.getCore().byId("d2").fireChange(a)}c.setVisible(false)},changeExpectedSV:function(e){var c=e.getSource(),u=cus.crm.salespipeline.sim.util.formatter;var p=u.reverseNumbers(c.getValue());if(isNaN(p))sap.ca.ui.message.showMessageBox({type:sap.ca.ui.message.Type.WARNING,message:this.oBundle.getText("LBL_VAL_MSG")});else{if(p<this.minOpp){c.setValue(u.displayNumbers(this.minOpp));sap.ca.ui.message.showMessageBox({type:sap.ca.ui.message.Type.WARNING,message:this.oBundle.getText("LBL_VAL_MINEXPREV")})}else if(p>this.maxOpp){c.setValue(u.displayNumbers(this.maxOpp));sap.ca.ui.message.showMessageBox({type:sap.ca.ui.message.Type.WARNING,message:this.oBundle.getText("LBL_VAL_MAXEXPREV")})}else c.setValue(u.displayNumbers(p))}},changeCOS:function(e){var c=e.getSource(),s=c.getValue();var n="^[0-9]+$";var a="(\[0-9]{1,3})\%";if(isNaN(s))if(parseFloat(s)<0){c.setValue("0");sap.ca.ui.message.showMessageBox({type:sap.ca.ui.message.Type.INFO,message:this.oBundle.getText("LBL_VAL_MINCHANCE")})}if(parseFloat(s)>100){c.setValue("100");sap.ca.ui.message.showMessageBox({type:sap.ca.ui.message.Type.INFO,message:this.oBundle.getText("LBL_VAL_MAXCHANCE")})}var s=c.getValue();if(s.match(n)||s.match(a))this.iChangeCOS=0;else{this.iChangeCOS=1;sap.ca.ui.message.showMessageBox({type:sap.ca.ui.message.Type.WARNING,message:this.oBundle.getText("LBL_VAL_MSG")})}},changeSalesStage:function(e){var s=e.getParameter('selectedItem').getKey();var a=sap.ui.getCore().byId("salesStage1").getModel("SalesOpp").oData;for(var i=0;i<a.length;i++)if(a[i].SalesStageCode==s){sap.ui.getCore().byId("chanceOfSucc").setValue(parseFloat(a[i].ChanceOfSuccess)+"%");break}},compose:function(i){var u=cus.crm.salespipeline.sim.util.formatter;var c=u.reverseNumbers(i);return c+".00"},toAccountApp:function(){var f=sap.ushell&&sap.ushell.Container&&sap.ushell.Container.getService;var c=f&&f("CrossApplicationNavigation");var a=isNaN(parseInt(this.pAccountId))?this.pAccountId:parseInt(this.pAccountId).toString();var A=c&&c.hrefForExternal({target:{semanticObject:"Account",action:"MyAccounts"},appSpecificRoute:["&","detail","AccountCollection('"+a+"')"].join("/"),})||"";this.cancelChangeOpp();if(!this.getView().byId("butSave").getVisible())window.location=A;else{this.oNavParams.toAccountApp=A;this.oFragmentList.resetDialog.open()}},toOppApp:function(){var f=sap.ushell&&sap.ushell.Container&&sap.ushell.Container.getService;var c=f&&f("CrossApplicationNavigation");var o=c&&c.hrefForExternal({target:{semanticObject:"Opportunity",action:"manageOpportunity"},params:{guid:this.guidVal}})||"";this.cancelChangeOpp();if(!this.getView().byId("butSave").getVisible())window.location=o;else{this.oNavParams.toOppApp=o;this.oFragmentList.resetDialog.open()}},toContactApp:function(){var f=sap.ushell&&sap.ushell.Container&&sap.ushell.Container.getService;var c=f&&f("CrossApplicationNavigation");var a=isNaN(parseInt(this.pAccountId))?this.pAccountId:parseInt(this.pAccountId).toString();var C=isNaN(parseInt(this.pContactId))?this.pContactId:parseInt(this.pContactId).toString();var s=c&&c.hrefForExternal({target:{semanticObject:"ContactPerson",action:"MyContacts"},params:{accountID:a,contactID:C,}})||"";this.cancelChangeOpp();if(!this.getView().byId("butSave").getVisible())window.location=s;else{this.oNavParams.toContactApp=s;this.oFragmentList.resetDialog.open()}},renderTopNSlider:function(e){if(!this.oFragmentList.TopNSlider){this.oFragmentList.TopNSlider=new sap.ui.xmlfragment('cus.crm.salespipeline.sim.view.opportunitySlider',this);this.oFragmentList.TopNSlider.setModel(this.getView().getModel("i18n"),"i18n")}this.oFragmentList.TopNSlider.openBy(e.getSource())},_setTopNSliderLabel:function(m,v){var c=sap.ui.getCore();if(v==undefined)v=m;if(m>0){c.byId('opportunitySlider').setEnabled(true).setMin(1).setMax(m).setValue(v);if(m>1){c.byId('exLostCheck').setEnabled(true);c.byId('exWonCheck').setEnabled(true)}if(m>v){var n=this.oBundle.getText("LBL_NOOFTO_SELECTED",v);c.byId('sliderLabel').setText(n)}else{var a=this.oBundle.getText("LBL_ALLTO_SELECTED");c.byId('sliderLabel').setText(a)}}else{c.byId('opportunitySlider').setMin(0).setMax(0).setValue(0).setEnabled(false);var b=this.oBundle.getText("LBL_NOTO_SELECTED");c.byId('sliderLabel').setText(b);if(!(c.byId('exLostCheck').getSelected()||c.byId('exWonCheck').getSelected())){c.byId('exLostCheck').setEnabled(false);c.byId('exWonCheck').setEnabled(false)}}},_isFilteredStatus:function(o){var e=sap.ui.getCore().byId('exLostCheck').getSelected();var a=sap.ui.getCore().byId('exWonCheck').getSelected();if(e==true||a==true){var t=this._getBTCode(o);if(e==true){if(t=="LOST"){return true}}if(a==true){if(t=="WINN"){return true}}}return false},_getCurrFilteredOpp:function(l){var d=this.getView().byId("chart_sim");var c=d._xAxis.xStart;var e=d._xAxis.xEnd;l.sort(function(a,b){return b.ExpectedSalesVolume-a.ExpectedSalesVolume});var f=l.length;for(var i=0;i<f;i++){var g=l[i].ClosingDate;if(!((c<=g)&&(g<=e))){l.splice(i,1);i--;f--;continue}if(this._isFilteredStatus(l[i])){l.splice(i,1);i--;f--}}return l},_getTopNOpp:function(i,a){var s=sap.ui.getCore().byId('opportunitySlider');var b=sap.ui.getCore().byId('opportunitySlider').getValue();var l=this._getCurrFilteredOpp(this.Opportunities.slice(0));var n=l.length;if((b>=n)||(s.getMax()==b)||(b==0))this._setTopNSliderLabel(n);else{this._setTopNSliderLabel(n,b);l=l.slice(0,b)}return l},showTopNOpp:function(e){var i=false,a=false,I=true;if(e!=undefined){var c=e.getSource();if(c.sId=="opportunitySlider")i=true;if(c.sId=='exLostCheck'||e.getSource().sId=='exWonCheck')a=true;var s=this.getView().getModel("SalesPipelineSetting").oData,S=this.getView().byId("name");var d=s.StartOfPeriod,E=s.EndOfPeriod;var b=S.getUnits()[S.getValue()].getKey(),f=S.getUnits()[S.getValue2()].getKey();if(d>=f||E<=b)I=false}var l=this._getTopNOpp(i,a);var m=new sap.ui.model.json.JSONModel(l);this.getView().setModel(m,"Opportunities");this.copyOpportunities("OpportunitiesOld");if((i||a)&&I)this.calculateProgress()},_initializeAllControllerFragments:function(){var i=this.getView().getModel("i18n");if(!this.oFragmentList.TopNSlider){this.oFragmentList.TopNSlider=new sap.ui.xmlfragment('cus.crm.salespipeline.sim.view.opportunitySlider',this);this.oFragmentList.TopNSlider.setModel(i,"i18n")}if(!this.oFragmentList.SalesTargetDialog){this.oFragmentList.SalesTargetDialog=new sap.ui.xmlfragment("cus.crm.salespipeline.sim.view.SalesTargetDialog",this);this.oFragmentList.SalesTargetDialog.setModel(i,"i18n");this.oFragmentList.SalesTargetDialog.setModel(this.getView().getModel("PeriodicityTexts"),"PeriodicityTexts");this.oFragmentList.SalesTargetDialog.setModel(this.getView().getModel("CurrencyList"),"CurrencyList");this.oFragmentList.SalesTargetDialog.setModel(this.getView().getModel("YearRanges"),"YearRanges");if(sap.ui.Device.system.desktop||sap.ui.Device.system.tablet)this.oFragmentList.SalesTargetDialog.setContentWidth("30em")}if(!this.oFragmentList.opportunityPopover){this.oFragmentList.opportunityPopover=new sap.ui.xmlfragment("cus.crm.salespipeline.sim.view.opportunityPopover",this);this.oFragmentList.opportunityPopover.setModel(i,"i18n");this.oFragmentList.opportunityPopover.setModel(this.getView().getModel("SalesOpp"),"SalesOpp");this.oFragmentList.opportunityPopover.setModel(this.getView().getModel("StatusMgt"),"StatusMgt")}if(!this.oFragmentList.settingsDialog){this.oFragmentList.settingsDialog=new sap.ui.xmlfragment("cus.crm.salespipeline.sim.view.settingsDialog",this);this.oFragmentList.settingsDialog.setModel(i,"i18n");if(sap.ui.Device.system.desktop||sap.ui.Device.system.tablet)this.oFragmentList.settingsDialog.setContentWidth("30em")}if(!this.oFragmentList.resetDialog){this.oFragmentList.resetDialog=new sap.ui.xmlfragment("cus.crm.salespipeline.sim.view.resetDialog",this);this.oFragmentList.resetDialog.setModel(i,"i18n");if(sap.ui.Device.system.desktop||sap.ui.Device.system.tablet)this.oFragmentList.resetDialog.setContentWidth("30em")}},_destroyAllControllerFragments:function(){if(this.oFragmentList)for(var f in this.oFragmentList)this.oFragmentList[f].destroy();this.oFragmentList=null},pressLinkToEmailOrCall:function(e){var c=sap.ui.getCore(),i=["mcEmail","empRespEmail","mcPhone","empRespPhone"],s=e.getSource();switch(s){case c.byId(i[0]):case c.byId(i[1]):if(!this.getView().byId("butSave").getVisible())sap.m.URLHelper.triggerEmail(s.getText());else this.oNavParams.sendMail=s.getText();break;case c.byId(i[2]):case c.byId(i[3]):if(!this.getView().byId("butSave").getVisible())sap.m.URLHelper.triggerTel(s.getText());else this.oNavParams.telCall=s.getText();break}}});
