/*
 * Copyright (C) 2009-2014 SAP SE or an SAP affiliate company. All rights reserved
 */
jQuery.sap.require("sap.ca.scfld.md.controller.ScfldMasterController");sap.ca.scfld.md.controller.ScfldMasterController.extend("hcm.emp.mybenefits.view.S2",{onInit:function(){sap.ca.scfld.md.controller.ScfldMasterController.prototype.onInit.call(this);this.resourceBundle=this.oApplicationFacade.getResourceBundle();this.oDataModel=this.oApplicationFacade.getODataModel();hcm.emp.mybenefits.util.DataManager.init(this.oDataModel,this.resourceBundle);this.oRouter.attachRouteMatched(this._handleRouteMatched,this);this.masterListCntrl=this.byId("list");this.objBenfitsCollection=null;this._fnRefreshCompleted=null;this.dateChangeFlag=false;hcm.emp.mybenefits.util.DataManager.setCachedModelObjProp("benefitsPlan",{});this.byId("S2DatePicker").setDateValue(new Date());this._initData();this._isLocalRouting=false;this._isInitialized=false;this.flag=true;this.refreshFlag=false},setLeadSelection:function(){var i=this.masterListCntrl.getItems();if(i.length<1){if(!sap.ui.Device.system.phone){this.oRouter.navTo('noData',{viewTitle:'MB_APP_DETAIL_TITLE',languageKey:sap.ui.getCore().getConfiguration().getLanguage()},!jQuery.device.is.phone)}}else{var f=this._oApplicationImplementation.getFirstListItem(this);if(f){var a=f.getAttributes()[0].getText();if(a!="Show Details")this.setListItem(f)}}},_handleRouteMatched:function(e){if(e.getParameter("name")==="master"&&this._isLocalRouting==false){this._initData()}if(e.getParameter("name")==="master"&&this._isLocalRouting===true){this._isLocalRouting=false}},_initData:function(){var _=this;hcm.emp.mybenefits.util.DataManager.init(this.oDataModel,this.resourceBundle);if(!this.dateChangeFlag){var d=new Date();var a=('0'+d.getDate()).slice(-2).toString();var m=('0'+(d.getMonth()+1)).slice(-2).toString();var y=d.getFullYear();this.todayDate=a+"-"+m+", "+y;this.date=d;this.filterDate=a+m+y}this.filter=["$filter=AsOn eq '"+this.filterDate+"' and Type eq 'Enrolled'"];hcm.emp.mybenefits.util.DataManager.getMasterList(this.refreshFlag,this.dateChangeFlag,this.filter,function(o){var t=_.refreshFlag;_.objBenfitsCollection={"Benefits":o};hcm.emp.mybenefits.util.DataManager.setCachedModelObjProp("benefitsPlan",_.objBenfitsCollection);try{if(_.objBenfitsCollection){_.masterListCntrl.setModel(new sap.ui.model.json.JSONModel(_.objBenfitsCollection));_._isLocalRouting=true;this.oSorter=new sap.ui.model.Sorter("StatusCode",false,function(C){var s=C.getProperty("StatusCode").trim();return s});if(_.masterListCntrl.getItems().length>0)_.masterListCntrl.removeAllItems();_.masterListCntrl.bindItems({path:"/Benefits",template:new sap.m.ObjectListItem({type:"{device/listItemType}",title:"{PlanTypeText}",attributes:[new sap.m.ObjectAttribute({text:"{PlanSubTypeText}"}),new sap.m.ObjectAttribute({text:"{PlanOptionText}"})],firstStatus:new sap.m.ObjectStatus({text:"{StatusText}",state:"Error"}),press:jQuery.proxy(_._handleItemPress,_)}),sorter:this.oSorter});var I=0;jQuery.each(_.masterListCntrl.getItems(),function(i,l){if(!(l.getBindingContext())){_.masterListCntrl.removeItem(i-I);I=I+1}});if(o.length>=0||t){var L=new sap.m.ObjectListItem({type:"{device/listItemType}",title:"",attributes:[new sap.m.ObjectAttribute({text:_.resourceBundle.getText("MB_SHOW_DETAILS")}),new sap.m.ObjectAttribute({text:""})],firstStatus:new sap.m.ObjectStatus({text:"{StatusText}",state:"Error"})});_.masterListCntrl.addItem(L)}_.originalaItems=_.masterListCntrl.getItems();_.handleSort();_._bIsMasterRoute=true;var b=_.filterDate;_.refreshHeaderFooterForEditToggle();var f=b.substr(2,2)+"-"+b.substr(0,2)+"-"+b.substr(4,4);_.byId("S2DatePicker").setDateValue(new Date(f));if(_._fnRefreshCompleted){_._fnRefreshCompleted();sap.ca.ui.utils.busydialog.releaseBusyDialog()}}}catch(e){jQuery.sap.log.warning(e)}if(!jQuery.device.is.phone&&!_._isInitialized){_.registerMasterListBind(_.masterListCntrl);_._isInitialized=true}if(!jQuery.device.is.phone){if(t){for(var i=0;i<_.masterListCntrl.getItems().length;i++){var c=_.masterListCntrl.getItems()[i];if((c.getBindingContext())){var g=c.getBindingContext();var k=g.getProperty("PlanCategory");var h=g.getProperty("PlanTypeKey");var j=g.getProperty("PlanSubTypeKey");if(k==_.selectedItemKey1&&h==_.selectedItemKey2&&j==_.selectedItemKey3){_.setListItem(_.masterListCntrl.getItems()[i]);break}}}if(i==_.masterListCntrl.getItems().length)_.setLeadSelection();_.refreshFlag=false}else{_.setLeadSelection()}}},function(o){hcm.emp.mybenefits.util.DataManager.parseErrorMessages(o)})},setListItem:function(i){var s=i.getAttributes()[0].getText();if(s=="Show Details"){i.setVisible(false);this.flag=false;this.filter=["$filter=AsOn eq '"+this.filterDate+"' and Type eq 'Unenrolled'"];this.fetchUnEnrolled(this.filter)}if(undefined!==i.getBindingContext()){var b=i.getBindingContext();var p=b.getProperty("PlanCategory");var a=b.getProperty("Type");var v=this._chooseView(p,a);i.setSelected(true);this.getList().setSelectedItem(i,true);this.oRouter.navTo(v,{contextPath:encodeURIComponent(b.sPath.substr(1))},!jQuery.device.is.phone)}this._isLocalRouting=true;if(jQuery.device.is.phone){this.masterListCntrl.removeSelections()}},fetchUnEnrolled:function(f){var _=this;hcm.emp.mybenefits.util.DataManager.getbothMasterList(f,function(o){_.objBenfitsCollection=o;try{if(_.objBenfitsCollection){_.masterListCntrl.setModel(new sap.ui.model.json.JSONModel(_.objBenfitsCollection));var I=0;jQuery.each(_.masterListCntrl.getItems(),function(i,a){if(!(a.getBindingContext())){_.masterListCntrl.removeItem(i-I);I=I+1}});_.originalaItems=_.masterListCntrl.getItems();_.handleSort();_._bIsMasterRoute=true;var y=_.filterDate;_.refreshHeaderFooterForEditToggle();_.masterListCntrl.getInfoToolbar().getContent()[1].mProperties.value=y.substr(0,2)+"-"+y.substr(2,2)+"-"+y.substr(4,4);if(_._fnRefreshCompleted){_._fnRefreshCompleted();sap.ca.ui.utils.busydialog.releaseBusyDialog()}}if(!jQuery.device.is.phone){_.setLeadSelection()}}catch(e){jQuery.sap.log.warning(e)}},function(o){hcm.emp.mybenefits.util.DataManager.parseErrorMessages(o)})},_chooseView:function(p,a){var v="";if(a=="Enrolled"||a=="Pending"){switch(p){case"A":v="Health";break;case"B":v="Insurance";break;case"C":v="Savings";break;case"D":v="FSA";break;case"E":v="Miscellaneous";break;case"F":v="Savings";break}}else if(a=="Unenrolled"){v="Unenrolled"}return v},applySearchPatternToListItem:function(i,f){if(undefined!==i.getBindingContext())if(f.substring(0,1)==="#"){var t=f.substr(1),d=i.getBindingContext().getProperty("Name").toLowerCase();return d.indexOf(t)===0}else{if(f===""){return true}var I=i.getBindingContext().getProperty("PlanTypeText");if(I.toLowerCase().indexOf(f)!=-1){return true}return false}},applySearchPattern:function(f){var l=this.originalaItems,m=[],v,f=f.toLowerCase(),c=0;if(f!==""){for(var i=0;i<l.length;i++){v=this.applySearchPatternToListItem(l[i],f);if(v){m.push(l[i]);c++}}if(m.length==0){if(!sap.ui.Device.system.phone){this.oRouter.navTo('noData',{viewTitle:'MB_APP_DETAIL_TITLE',languageKey:sap.ui.getCore().getConfiguration().getLanguage()},!jQuery.device.is.phone)}}}else{m=this.originalaItems;c=this.originalaItems.length}this.handleSort(m);this.masterListCntrl.removeSelections();if(this._fnRefreshCompleted){this._fnRefreshCompleted();sap.ca.ui.utils.busydialog.releaseBusyDialog()}return c},handleChange:function(e){var D=e.getParameters().newValue;var v=D.split("-"),y=v[2],m=v[1],a=v[0],_=this;D=a+m+y;if(Number(D).toString()==="NaN"){var d=new Date();var b=('0'+d.getDate()).slice(-2).toString();var c=('0'+(d.getMonth()+1)).slice(-2).toString();var f=d.getFullYear();D=b+c+f}_.filterDate=D;_.tempDate=D;_.dateChangeFlag=true;_.flag=true;if(_._oControlStore.oMasterSearchField.getValue()){_._oControlStore.oMasterSearchField.clear()}_._initData();_.dateChangeFlag=false},handleSort:function(m){var s=this,I=0,l=this.byId("list"),S="StatusCode",g=true;jQuery.each(l.getItems(),function(i,a){if(!(a.getBindingContext())){l.removeItem(i-I);I=I+1}});var c=l.getItems();if(undefined!==m&&null!==m){c=m}else{c=this.originalaItems}c.sort(function(a,b){if(a.getBindingContext()){var v=a.getBindingContext().getProperty(S)}else{var v=null}if(b.getBindingContext()){var f=b.getBindingContext().getProperty(S)}else{var f=null}return s.compareFunction(v,f)});l.removeAllItems();var d=0;var G=0;var o,e;jQuery.each(c,function(i,a){if(a.getBindingContext()){var C=a.getBindingContext().getProperty("StatusCode")}else if(a.getAttributes()[0].getText()){if(a.getAttributes()[0].getText()=="Show Details"){C="2U"}}if(C===""){C="UnGrouped"}if(g&&((i===0)||C!=e)){if(i!==0){o.setCount(G)}e=C;o=new sap.m.GroupHeaderListItem({title:s.getGroupHeader(C),uppercase:false});l.insertItem(o,i+d);d=d+1;G=0}else if((g)&&((i+1)===c.length||((i+1)===c.length&&i===0))){G=G+1;o.setCount(G)}if(!s.flag&&(i+1)===c.length){if(""===o.mProperties.count)G=G+1;o.setCount(G)}G=G+1;l.addItem(a)})},compareFunction:function(a,b){if(b===null){return-1}if(a===null){return 1}if(typeof a==="string"&&typeof b==="string"){return a.toLocaleUpperCase().localeCompare(b.toLocaleUpperCase())}if(a<b){return-1}if(a>b){return 1}return 0},getGroupHeader:function(g){var r="";switch(g){case"0P":r=this.resourceBundle.getText("MB_LIST_HEADER_PENDING");break;case"1A":r=this.resourceBundle.getText("MB_LIST_HEADER_HEALTH");break;case"1B":r=this.resourceBundle.getText("MB_LIST_HEADER_INSURANCE");break;case"1C":r=this.resourceBundle.getText("MB_LIST_HEADER_SAVINGS");break;case"1D":r=this.resourceBundle.getText("MB_LIST_HEADER_FSA");break;case"1E":r=this.resourceBundle.getText("MB_LIST_HEADER_MISC");break;case"1F":r=this.resourceBundle.getText("MB_LIST_HEADER_STOCK");break;case"2U":r=this.resourceBundle.getText("MB_LIST_HEADER_UNENROLLED");break}return r},getViewSummary:function(){var v=this.getView(),d=v.byId('list').getInfoToolbar().getContent()[1].getValue(),a=d.split("-"),y=a[2],m=a[1],b=a[0],d=b+m+y;var p=this.oApplicationFacade.oApplicationImplementation.oConfiguration.getServiceList()[0].serviceUrl+"FileDataSet(FileKey='CONF_FORM',Date='"+d+"')/$value",q="?",c="&",s="",e="sap-client="+jQuery.sap.getUriParameters().get("sap-client");if(location.host.indexOf("localhost")!=-1){s="sap-server=gm6-http"+c}p+=q+s+e;sap.m.URLHelper.redirect(p,true)},getHeaderFooterOptions:function(){var l=this.byId("list");var c=l.getItems().length;jQuery.each(l.getItems(),function(i,I){if(!(I.getBindingContext())){c--}});return{sI18NMasterTitle:this.resourceBundle.getText("MB_MASTER_TITLE",[c]),buttonList:[{sI18nBtnTxt:this.resourceBundle.getText("MB_CONFIRMATION"),onBtnPressed:jQuery.proxy(function(e){this.getViewSummary(e)},this)},],onRefresh:jQuery.proxy(function(s,r){this.refreshFlag=true;this.flag=true;this._fnRefreshCompleted=r;hcm.emp.mybenefits.util.DataManager.setCachedModelObjProp("benefitsPlan",{});if(this.masterListCntrl.getSelectedItem()){var a=this.masterListCntrl.getSelectedItem().getBindingContext();this.selectedItemKey1=a.getProperty("PlanCategory");this.selectedItemKey2=a.getProperty("PlanTypeKey");this.selectedItemKey3=a.getProperty("PlanSubTypeKey")}if(s){this._oControlStore.oMasterSearchField.clear()}this._initData()},this),}},});
