/*
 * Copyright (C) 2009-2014 SAP SE or an SAP affiliate company. All rights reserved
 */
jQuery.sap.require("sap.ca.scfld.md.controller.BaseDetailController");jQuery.sap.require("sap.ca.ui.utils.busydialog");jQuery.sap.require("cus.crm.opportunity.util.schema");jQuery.sap.require("sap.m.MessageToast");jQuery.sap.require("cus.crm.opportunity.util.Formatter");jQuery.sap.require("cus.crm.opportunity.util.Util");sap.ca.scfld.md.controller.BaseDetailController.extend("cus.crm.opportunity.view.S5",{s3Controller:{},oSelectedEmployee:{},oSelectedAccount:{},oSelectedContact:{},s2Controller:{},ContextPath:"",processType:"",StatusProfile:"",UserStatusCode:"",UserStatusText:"",WinStatusCode:"",LostStatusCode:"",oldcosValue:"",OldvolumeValue:"",ContactCollection:[],Currencies:[],currencymessage:"",s3Controller_contact:"",accountf4open:"",partnerDeterminationMap:{},oPartnerFunctionsTemplate:new sap.m.StandardListItem({title:"{json>PartnerFunctionName}",key:"{json>PartnerFunctionCategory}"}),accountListItemTemplate2:new sap.m.StandardListItem({title:'{PartnersBasedOnType>account2FullName}',description:'{PartnersBasedOnType>account2ID}'}),accountListItemTemplate:new sap.m.ObjectListItem({title:'{json>name1}'}).addAttribute(new sap.m.ObjectAttribute({text:'{json>accountID}'})).addCustomData(new sap.ui.core.CustomData({key:'ID',value:'{json>accountID}'})),contactListItemTemplate:new sap.m.ObjectListItem({title:'{json>fullName}'}).addAttribute(new sap.m.ObjectAttribute({text:'{json>contactID}'})).addCustomData(new sap.ui.core.CustomData({key:'ID',value:'{json>contactID}'})),employeeListItemTemplate:new sap.m.ObjectListItem({title:'{json>fullName}'}).addAttribute(new sap.m.ObjectAttribute({text:'{json>employeeID}'})).addCustomData(new sap.ui.core.CustomData({key:'ID',value:'{json>employeeID}'})),accountListItemTemplate1:new sap.m.StandardListItem({title:'{PartnersBasedOnType>fullName}',description:'{PartnersBasedOnType>accountID}'}),contactListItemTemplate1:new sap.m.StandardListItem({title:'{PartnersBasedOnType>fullName}',description:'{PartnersBasedOnType>contactID}'}),employeeListItemTemplate1:new sap.m.StandardListItem({title:'{PartnersBasedOnType>fullName}',description:'{PartnersBasedOnType>employeeID}'}),onInit:function(){sap.ca.scfld.md.controller.BaseDetailController.prototype.onInit.call(this);var r=sap.ui.getCore().getConfiguration().getRTL();var c=(r)?"OpportunityRTL":"Opportunity";jQuery.sap.includeStyleSheet(jQuery.sap.getModulePath("cus.crm.opportunity.css."+c,".css"),"sap-ui-theme-sap.crm");var t=this;this.oResourceBundle=sap.ca.scfld.md.app.Application.getImpl().getResourceBundle();this.byId('productBasket').setModel(new sap.ui.model.json.JSONModel(),"json");this.byId('partnerBasket').setModel(new sap.ui.model.json.JSONModel(),"json");this.followUp=false;this.contactF4Fragment=new sap.ui.xmlfragment(this.createId("contactF4"),'cus.crm.opportunity.view.ContactF4',this);this.contactF4Fragment.setModel(new sap.ui.model.json.JSONModel(),"json");this.oI18nModel=this.getView().getModel('i18n');this.contactF4Fragment.setModel(this.oI18nModel,'i18n');this.oModel=this.getView().getModel();this.oAppImplementation=sap.ca.scfld.md.app.Application.getImpl();this.oDateFormatter=sap.ca.ui.model.format.DateFormat.getDateInstance({style:"medium"},new sap.ui.core.Locale(this.oAppImplementation.getResourceBundle().sLocale));this.sBackendVersion=cus.crm.opportunity.util.schema._getServiceSchemaVersion(this.oModel,"Opportunity");this.oVersioningModel=new sap.ui.model.json.JSONModel({BackendSchemaVersion:this.sBackendVersion});this.oVersioningModel.updateBindings();this.getView().setModel(this.oVersioningModel,"versioning");this._versionSpecificInitializations(this.sBackendVersion);this.oRouter.attachRouteMatched(function(e){if(e.getParameter("name")==="create"){this.followupOppt=false;this.ContextPath=e.getParameter("arguments").contextPath;this.processType=e.getParameter("arguments").processType;this._clear_data();var s=this.getView().getModel('controllers').getData().s3Controller;if(s===null){this.callController(s)}else{this.Currencies=s.Currencies;this.byId("currency").setModel(new sap.ui.model.json.JSONModel({Currencies:this.Currencies}),"json");this.ContactCollection=s.ContactCollection;this.s3Controller_contact=s;this.fill_dropDowns(s);if(parseFloat(this.sBackendVersion)>=4){var u=cus.crm.opportunity.util.Util;if(u.getPartnerFunctions()===null){u.fetchPartnerFunctions(this.oModel)}this.partnerDeterminationMap=u.getPartnerFunctions()}else{if(!this.partnerDeterminationMap[this.processType]){this.oModel.read("OpptPartnerFctTypes",null,["TransactionType='"+this.processType+"'"],false,jQuery.proxy(function(j,l){this.partnerDeterminationMap[this.processType]=l.data.results},this),jQuery.proxy(function(j){},this))}}}this.byId('inputEmpResponsible_S5').setValue("");this.oSelectedEmployee={};this.byId('datePickerStartDate').setValue(cus.crm.opportunity.util.Formatter.dateFormatter(new Date()));this.getView().byId('datePickerCloseDate').setValue(cus.crm.opportunity.util.Formatter.dateFormatter(new Date()));this.getView().byId("laTypeInput").setVisible(false);this.getView().byId("TxtTypeInput").setVisible(false);var p=null;var a=this.oApplicationFacade.getApplicationModel("s2Controller").getData().s2Controller;if(a!=null||a!=undefined){p=a.processTypeDesc;if(p!=null||parseFloat(this.sBackendVersion)>=3){this.getView().byId("laTypeInput").setVisible(true);this.getView().byId("TxtTypeInput").setVisible(true);this.getView().byId("TxtTypeInput").setText(p)}}if(this.extHookCustomLogicForAttachRouteMatch){this.extHookCustomLogicForAttachRouteMatch(e)}}else if(e.getParameter("name")==="fulScrCreateFollowup"){this.fullScreen=true;this.oHeaderFooterOptions.onBack=jQuery.proxy(this.onCancel,this);var S=this.getView().getModel("startupParameters");if(S&&S.oData){if(S.oData.parameters){for(var b in S.oData.parameters){if(S.oData.parameters[b].key=="processType"){this.processType=S.oData.parameters[b].value}if(S.oData.parameters[b].key=="StartDate"){this.StartDate=S.oData.parameters[b].value}if(S.oData.parameters[b].key=="title"){this.title=S.oData.parameters[b].value}if(S.oData.parameters[b].key=="appointmentGuid"){this.appointmentGuid=S.oData.parameters[b].value}if(S.oData.parameters[b].key=="Responsible"){this.Responsible=S.oData.parameters[b].value}if(S.oData.parameters[b].key=="AccountId"){this.AccountId=S.oData.parameters[b].value}if(S.oData.parameters[b].key=="ContactId"){this.contactId=S.oData.parameters[b].value}}}}this.ContextPath=e.getParameter("arguments").contextPath;var t=this;var B=[];var m=this.getView().getModel();var P="/AccountCollection('"+this.AccountId+"')";var d="/ContactCollection(contactID='"+this.contactId+"',accountID='"+this.AccountId+"')";var f="/EmployeeCollection('"+this.Responsible+"')";var g="/ProcessTypes";B.push(m.createBatchOperation(P,"GET"));B.push(m.createBatchOperation(d,"GET"));B.push(m.createBatchOperation(f,"GET"));B.push(m.createBatchOperation(g,"GET"));m.addBatchReadOperations(B);var h=4;var o=this;m.submitBatch(jQuery.proxy(function(R){t.AccountName=R.__batchResponses[0].data.fullName;t.ContactName=R.__batchResponses[1].data.fullName;t.ResponsibleTxt=R.__batchResponses[2].data.fullName;if(R.__batchResponses[3]){for(var i=0;i<R.__batchResponses[3].data.results.length;i++){if(R.__batchResponses[3].data.results[i].ProcessTypeCode===o.processType){o.ProcessTypeDescription=R.__batchResponses[3].data.results[i].Description;break}}}},this),jQuery.proxy(function(){},this),false);t.s3Controller=this.getView().getModel('controllers').getData().s3Controller;if(t.s3Controller===null){this.callController(t.s3Controller)}sap.ca.ui.utils.busydialog.requireBusyDialog();this.followUpView();sap.ca.ui.utils.busydialog.releaseBusyDialog()}else if(e.getParameter("name")==="fulScrOpptFollowup"){this.followupOppt=true;this.fullfollowupOppt=true;this.ContextPath=e.getParameter("arguments").contextPath;this.processType=e.getParameter("arguments").processType;var t=this;t.s3Controller=this.getView().getModel('controllers').getData().s3Controller;if(t.s3Controller===null){this.callController(t.s3Controller)}sap.ca.ui.utils.busydialog.requireBusyDialog();this.bindEditView();sap.ca.ui.utils.busydialog.releaseBusyDialog()}else if(e.getParameter("name")==="FollowupFromTask"){this.fullScreenFromTask=true;this.oHeaderFooterOptions.onBack=jQuery.proxy(this.onCancel,this);var S=this.getView().getModel("startupParameters");if(S&&S.oData){if(S.oData.parameters){for(var b in S.oData.parameters){if(S.oData.parameters[b].key=="AccountID"){this.AccountId=S.oData.parameters[b].value}if(S.oData.parameters[b].key=="ContactID"){this.contactId=S.oData.parameters[b].value}if(S.oData.parameters[b].key=="FUO"){this.FUO=S.oData.parameters[b].value}if(S.oData.parameters[b].key=="taskGuid"){this.taskGuid=S.oData.parameters[b].value}if(S.oData.parameters[b].key=="taskId"){this.taskId=S.oData.parameters[b].value}if(S.oData.parameters[b].key=="title"){this.title=S.oData.parameters[b].value}}}}this.ContextPath=e.getParameter("arguments").contextPath;this.processType=e.getParameter("arguments").processType;var t=this;var B=[];var m=this.getView().getModel();var k=[];k.push("/ProcessTypes");if(this.AccountId!=="")k.push("/AccountCollection("+m.formatValue(this.AccountId,"Edm.String")+")");if(this.contactId!==""){var F=m.formatValue(this.contactId,"Edm.String");var E=jQuery.sap.encodeURL("contactID eq "+F);k.push("/ContactCollection?$filter="+E)}for(var i=0;i<k.length;i++){B.push(m.createBatchOperation(k[i],"GET"))}m.addBatchReadOperations(B);var h=3;var o=this;m.submitBatch(jQuery.proxy(function(R){for(var j=0;j<R.__batchResponses.length;j++){switch(j){case 0:if(R.__batchResponses[0]){for(var i=0;i<R.__batchResponses[0].data.results.length;i++){if(R.__batchResponses[0].data.results[i].ProcessTypeCode===o.processType){o.ProcessTypeDescription=R.__batchResponses[0].data.results[i].Description}}}break;default:if(R.__batchResponses[j].data.__metadata)if(R.__batchResponses[j].data.__metadata.type.search("Account")!==-1)t.AccountName=R.__batchResponses[j].data.fullName;if(R.__batchResponses[j].data.results)if(R.__batchResponses[j].data.results[0].__metadata.type.search("Contact")!==-1)t.ContactName=R.__batchResponses[j].data.results[0].fullName;break}}},this),jQuery.proxy(function(){},this),false);t.s3Controller=this.getView().getModel('controllers').getData().s3Controller;if(t.s3Controller===null){this.callController(t.s3Controller)}sap.ca.ui.utils.busydialog.requireBusyDialog();this.fromTaskFollowUpView();sap.ca.ui.utils.busydialog.releaseBusyDialog()}else if(e.getParameter("name")==="createFollowup"){this.followupOppt=true;this.ContextPath=e.getParameter("arguments").contextPath;this.processType=e.getParameter("arguments").processType;sap.ca.ui.utils.busydialog.requireBusyDialog();this.bindEditView();sap.ca.ui.utils.busydialog.releaseBusyDialog()}},this);this.oAppImplementation=sap.ca.scfld.md.app.Application.getImpl();this.oNav=this.oAppImplementation.oAppNavigator;t=this;this.oHeaderFooterOptions={onBack:(jQuery.device.is.phone||this.fullScreen||this.fullScreenFromTask)?jQuery.proxy(this.onCancel,this):null,oEditBtn:{sId:"sv",sI18nBtnTxt:"SAVE",onBtnPressed:function(e){t.getController().onSave()},bDisabled:true,},buttonList:[{sI18nBtnTxt:"CANCEL",onBtnPressed:function(e){t.getController().onCancel()}}],};var t=this.getView();this.getView().byId('stagedropdown').attachChange(null,function(e){if(t.byId('statusdropdown').getSelectedKey()!=t.getController().WinStatusCode&&t.byId('statusdropdown').getSelectedKey()!=t.getController().LostStatusCode){var d=this.getModel("json").getData();var l=d.SalesStages.length;for(var i=0;i<l;i++){if(d.SalesStages[i].ProcessType===t.getController().processType&&d.SalesStages[i].SalesStageCode===e.getParameter("selectedItem").getKey()){t.byId("chanceofSuccess").setValue(Number(d.SalesStages[i].ChanceOfSuccess))}}}});this.getView().byId('statusdropdown').attachChange(null,function(e){if(t.getController().WinStatusCode===e.getParameter("selectedItem").getKey()){t.byId("chanceofSuccess").setValue(100)}if(t.getController().LostStatusCode===e.getParameter("selectedItem").getKey()){t.byId("chanceofSuccess").setValue(0)}});this.byId('datePickerCloseDate').attachBrowserEvent("keydown",jQuery.proxy(function(e){this.setValueState(sap.ui.core.ValueState.None)},this.byId('datePickerCloseDate')));this.byId('datePickerStartDate').attachBrowserEvent("keydown",jQuery.proxy(function(e){this.setValueState(sap.ui.core.ValueState.None)},this.byId('datePickerStartDate')));this.getView().byId('datePickerCloseDate').attachChange(null,function(e){var d=e.getParameter('newYyyymmdd');if(d!==null){var a=new Date(parseInt(d.substr(0,4)),parseInt(d.substr(4,2)-1),parseInt(d.substr(6,2)));this.byId('datePickerCloseDate').setValue(this.oDateFormatter.format(a))}this.byId('datePickerCloseDate').setValueState(sap.ui.core.ValueState.None);this.byId('datePickerStartDate').setValueState(sap.ui.core.ValueState.None)},this);this.getView().byId('datePickerStartDate').attachChange(null,function(e){this.byId('datePickerStartDate').setValueState(sap.ui.core.ValueState.None);this.byId('datePickerCloseDate').setValueState(sap.ui.core.ValueState.None);var d=e.getParameter('newYyyymmdd');if(d!==null){var a=new Date(parseInt(d.substr(0,4)),parseInt(d.substr(4,2)-1),parseInt(d.substr(6,2)));this.byId('datePickerStartDate').setValue(this.oDateFormatter.format(a))}},this)},_versionSpecificInitializations:function(b){var a=cus.crm.opportunity.util.schema._getEntityAnnotation(this.oModel,'service-schema-version','Account');this.accountF4Template=new sap.m.StandardListItem({title:(parseFloat(b)<=1)?"{parts:[{path:'name1'}],formatter : 'cus.crm.opportunity.util.Formatter.getAccountF4Title'}":"{parts:[{path:'fullName'}],formatter : 'cus.crm.opportunity.util.Formatter.getAccountF4Title'}",description:"{parts:[{path : 'accountID'},{path : 'MainAddress/city'},{path : 'MainAddress/country'}],formatter : 'cus.crm.opportunity.util.Formatter.formatAccountF4Description'}",active:true});this.accountF4Template.data("NAME",((a===null)?"{name1}":"{fullName}"));this.accountF4Template.data("ID","{accountID}");if(parseFloat(b)>=4){this.byId("tit1").setVisible(true)}else{this.byId("tit1").setVisible(false);this.byId("partnerBasket").setVisible(false)}},fill_dropDowns:function(s){var i,a;var j=new sap.ui.model.json.JSONModel();var b=new sap.ui.model.json.JSONModel();var c=new sap.ui.model.json.JSONModel();a=s.UserStatuses.length;var d={UserStatuses:[{BusinessTransaction:"",LanguageCode:"",ProcessType:this.processType,StatusProfile:"",UserStatusCode:"",UserStatusText:"",}]};var e="";for(i=0;i<a;i++){if(s.UserStatuses[i].ProcessType===this.processType){d.UserStatuses.push(s.UserStatuses[i]);if(parseFloat(this.sBackendVersion)>=3){if(s.UserStatuses[i].InitialStatus==true)e=s.UserStatuses[i].UserStatusCode}if(this.UserStatusCode===""&&s.UserStatuses[i].UserStatusCode!=""){this.UserStatusCode=s.UserStatuses[i].UserStatusCode;this.UserStatusText=s.UserStatuses[i].UserStatusText}if(s.UserStatuses[i].BusinessTransaction==="WINN"){this.getView().getController().WinStatusCode=s.UserStatuses[i].UserStatusCode}if(s.UserStatuses[i].BusinessTransaction==="LOST"){this.getView().getController().LostStatusCode=s.UserStatuses[i].UserStatusCode}this.StatusProfile=s.UserStatuses[i].StatusProfile}}j.setData(d);this.byId('statusdropdown').setModel(j,"json");this.byId('statusdropdown').setSelectedKey(e);var f={Priorities:[{LanguageCode:"",PriorityCode:"",PriorityText:"",}]};a=s.Priorities.length;for(i=0;i<a;i++){f.Priorities.push(s.Priorities[i])};b.setData(f);this.byId('priority_val').setModel(b,"json");a=s.SalesStages.length;var g=new Array();var h=new Array();var k;var l;var m;var n={SalesStages:[{ChanceOfSuccess:"",LanguageCode:"",ProcessType:this.processType,SalesStageCode:"",SalesStageDescription:"",SalesStageOrder:"",}]};for(i=0;i<a;i++){if(s.SalesStages[i].ProcessType===this.processType){n.SalesStages.push(s.SalesStages[i]);g.push(s.SalesStages[i].SalesStageOrder);h=g.sort();k=h[0];if(s.SalesStages[i].SalesStageOrder==k){l=s.SalesStages[i].SalesStageCode;m=Number(s.SalesStages[i].ChanceOfSuccess)}}}c.setData(n);this.byId('stagedropdown').setModel(c,"json");this.byId('stagedropdown').setSelectedKey(l);this.getView().byId("chanceofSuccess").setValue(m)},onAfterRendering:function(){cus.crm.opportunity.util.Formatter.resetFooterContentRightWidth(this)},onBeforeRendering:function(){this.getView().getModel("controllers").getData().s5Controller=this},getHeaderFooterOptions:function(){return this.oHeaderFooterOptions;var t=this;return{oPositiveAction:{sId:"sv",sI18nBtnTxt:"SAVE",onBtnPressed:function(){this.onSave()},},oNegativeAction:{sI18nBtnTxt:"CANCEL",onBtnPressed:function(e){this.onCancel()},},}},toDetail:function(){this.onCancel()},onCancel:function(){sap.ca.ui.dialog.confirmation.open({question:sap.ca.scfld.md.app.Application.getImpl().getResourceBundle().getText('DATA_LOSS'),title:sap.ca.scfld.md.app.Application.getImpl().getResourceBundle().getText('WARNING'),confirmButtonLabel:sap.ca.scfld.md.app.Application.getImpl().getResourceBundle().getText('CONTINUE')},jQuery.proxy(this.datalossDismissed,this))},datalossDismissed:function(r){if(r.isConfirmed===false)return;if(!this.followupOppt)var c=this.ContextPath;else var c="Opportunities(guid'"+this.ContextPath+"')";if(!jQuery.device.is.phone&&!this.fullScreen&&!this.fullScreenFromTask){this.oRouter.navTo("detail",{contextPath:c},!jQuery.device.is.phone)}else if(!jQuery.device.is.phone&&this.fullScreen){window.history.back()}else if(!jQuery.device.is.phone&&this.fullScreenFromTask){window.history.go(-2)}else this._navBack();this._clear_data();this._enableMasterFooter("")},onAddProduct:function(e){if(!this.oAddProductsFragment){this.oAddProductsFragment=sap.ui.xmlfragment("cus.crm.opportunity.view.ProductBasketDialog",this);this.oAddProductsFragment.setModel(new sap.ui.model.json.JSONModel(),"json");this.oAddProductsFragment.setModel(this.getView().getModel("i18n"),"i18n")}this.oAddProductsFragment.getBeginButton().setEnabled(false);this.oAddProductsFragment.getContent()[0].setNoDataText(this.oResourceBundle.getText('LOADING_TEXT'));this.oAddProductsFragment.getSubHeader().getContentLeft()[0].clear();this.oModel.read("Products",null,null,true,jQuery.proxy(function(o,r){if(r.data.results.length===0)this.oAddProductsFragment.getContent()[0].setNoDataText(this.oResourceBundle.getText('NO_DATA_TEXT'));this.oAddProductsFragment.getModel("json").setData({Products:r.data.results})},this),function(E){});this.oAddProductsFragment.open()},onSave:function(){var v=true;if(this.extHookOnSave){v=this.extHookOnSave()}if(!v){return}if(this.validateDates()===false)return;if((this.byId('inputMainContact').getValue()!==""&&this.contactId===undefined)){this.showContactF4();return}if(this.byId('inputMainContact').getValue()===""){this.contactId=undefined}if(this.validateSavePage()===false){sap.ca.ui.message.showMessageToast(sap.ca.scfld.md.app.Application.getImpl().getResourceBundle().getText('MANDAT_FIELD'));return}if(this.validateCurrency()===true){sap.ca.ui.dialog.confirmation.open({question:this.currencyMessage,title:sap.ca.scfld.md.app.Application.getImpl().getResourceBundle().getText('WARNING'),confirmButtonLabel:sap.ca.scfld.md.app.Application.getImpl().getResourceBundle().getText('CONTINUE')},jQuery.proxy(this.dataConfirm,this))}else this.dataConfirm({isConfirmed:true})},enableSaveBtn:function(e){if(this.byId("desc").getValue()!==""&&this.byId("customer").getValue()!==""&&this.byId("datePickerCloseDate").getValue()!==""){if(!this.followUp){this.setBtnEnabled("sv",true)}else{this.oHeaderFooterOptions.oEditBtn.bDisabled=false;this.followUp=false}}else{this.setBtnEnabled("sv",false)}if(this.extHookEnableSaveBtn){this.extHookEnableSaveBtn()}},dataConfirm:function(r){if(r.isConfirmed){if(this.WinStatusCode===this.byId('statusdropdown').getSelectedKey()){this.getView().byId("chanceofSuccess").setValue(100)}if(this.LostStatusCode===this.byId('statusdropdown').getSelectedKey()){this.getView().byId("chanceofSuccess").setValue(0)}var u="";var a="";if(this.byId('statusdropdown').getSelectedKey()==""){u=this.UserStatusCode;a=this.UserStatusText}else{u=this.byId('statusdropdown').getSelectedKey();a=this.byId('statusdropdown').getSelectedItem().getText()}var f=sap.ca.ui.model.format.DateFormat.getDateInstance({style:"medium"},new sap.ui.core.Locale(this.oAppImplementation.getResourceBundle().sLocale));var s=new Date(f.parse(this.byId('datePickerStartDate').getValue()));var e=new Date(f.parse(this.byId('datePickerCloseDate').getValue()));var b=s.getFullYear()+"-"+(s.getMonth()+1)+"-"+s.getDate()+"T00:00:00";var c=e.getFullYear()+"-"+(e.getMonth()+1)+"-"+e.getDate()+"T00:00:00";var d="00000000-0000-0000-0000-000000000000";var m=this.getView().getModel();var t=this;if(this.followupOppt){this.PredecessorGUID=this.ContextPath}else if(this.fullScreen){this.PredecessorGUID=this.appointmentGuid;this.accountId=this.AccountId}else if(this.fullScreenFromTask){this.PredecessorGUID=this.taskGuid;this.accountId=this.AccountID}else{this.PredecessorGUID=null}var E={Description:this.byId('desc').getValue(),ProcessType:this.processType,StartDate:b,ClosingDate:c,ExpectedSalesVolume:this.byId('volume').getValue(),SalesStageCode:this.byId('stagedropdown').getSelectedKey(),UserStatusCode:u,UserStatusText:a,PriorityCode:this.byId('priority_val').getSelectedKey(),PriorityText:this.byId('priority_val').getSelectedItem().getText(),ProspectName:this.byId('customer').getValue(),ProspectNumber:this.accountId,MainContactId:this.contactId,MainContactName:this.byId('inputMainContact').getValue(),ChanceOfSuccess:this.byId('chanceofSuccess').getValue(),ForecastRelevance:this.byId('Switch').getState(),CurrencyCode:this.byId('currency').getValue(),Guid:d,Statuses:[{HeaderGuid:d,StatusProfile:this.StatusProfile,UserStatusCode:u,UserStatusText:a,StatusOrderNumber:"01",}],Products:[],SalesTeam:[],};if(parseFloat(this.sBackendVersion)>=4.0){E.SalesOrganization=this.acc_salesorgid;E.SalesOrganizationDescription=this.acc_salesorgdesc;E.DistributionChannel=this.acc_dischaid;E.DistributionChannelDescription=this.acc_dischadesc;E.Division=this.acc_divid;E.DivisionDescription=this.acc_divdesc}if(parseFloat(this.sBackendVersion)>=2.0){E["EmployeeResponsibleNumber"]=this.oSelectedEmployee.employeeID}if(parseFloat(this.sBackendVersion)>=3.0){E["PredecessorGUID"]=this.PredecessorGUID}var p=this.getView().byId("productBasket").getModel("json").getData().Products;var i=0;if(p&&p.length){var l=p.length;var L;for(i=0;i<l;i++){L=p[i];var g={HeaderGuid:d,ProcessingMode:"A",ProductGuid:L.ProductGuid,ProductId:L.ProductId,ProductName:L.ProductName,Quantity:L.Quantity,TotalExpectedNetValue:L.TotalExpectedNetValue,Unit:L.Unit};if(this.extHookExtendProductEntry){this.extHookExtendProductEntry(g,L)}E.Products.push(g)}}if(parseFloat(this.sBackendVersion)>=4.0){if(this.getView().byId("partnerBasket").getModel("json").getData().SalesTeam){var h=this.getView().byId("partnerBasket").getModel("json").getData().SalesTeam}else{var h=""}if(h.length>0){var i=0;var P=this.participantsF4MultiselectFragment.getModel("json").getProperty("/PartnerFunctions");var j=this.participantsF4MultiselectFragment.getModel("PartnersBasedOnType");if(h&&h.length){var l=h.length;for(i=0;i<l;i++){var L=h[i];var k;for(var n=0;n<P.length;n++){if(P[n].PartnerFunctionName==L.PartnerFunction){k=P[n].PartnerFunctionCode}}var g={HeaderGuid:d,PartnerFunctionCode:k,PartnerNumber:L.Key,PartnerName:L.Name,PartnerFunctionText:L.PartnerFunction,};if(this.extHookExtendProductEntry){this.extHookExtendProductEntry(g,L)}if(this.extHookExtendProductEntry){this.extHookExtendProductEntry(g,L)}E.SalesTeam.push(g)}}var o=this.getView().byId("partnerBasket").getItems();for(var q=0;q<o.length;q++){this.getView().byId("partnerBasket").removeItem(o[q]);o[q].destroy()}this.participantsF4MultiselectFragment.getModel('json').getData().PartnerFunctions=this.partnerDeterminationMap[this.processType];var v=this.participantsF4MultiselectFragment.getModel("json").getProperty("/PartnerFunctions");for(var w=0;w<v.length;w++){if(this.participantsF4MultiselectFragment.getContent()[0].getPages()[0].getContent()[0].getItems()[w])this.participantsF4MultiselectFragment.getContent()[0].getPages()[0].getContent()[0].getItems()[w].setInfo(" ")}this.participantsF4MultiselectFragment.getModel("json").destroy();if(this.participantsF4MultiselectFragment.getModel("PartnersBasedOnType"))this.participantsF4MultiselectFragment.getModel("PartnersBasedOnType").destroy();this.participantsF4MultiselectFragment.getModel("SelectedPartnerCategory").destroy();this.byId('partnerBasket').getModel("json").updateBindings()}}if(this.extHookSaveOentry){this.extHookSaveOentry(E)}m.refreshSecurityToken();this.setBtnEnabled("sv",false);sap.ca.ui.utils.busydialog.requireBusyDialog();var x=this;m.create('/Opportunities',E,null,function(D,y){var z=t.getView().getModel("controllers").getData().s2Controller;if(z){z.opportunityID=D.Id}if(!x.fullScreen&&!x.fullScreenFromTask&&!x.fullfollowupOppt)t._enableMasterFooter(y.data.Guid);t.ContextPath="Opportunities(guid'"+y.data.Guid+"')";if(x.followupOppt||x.fullScreen||x.fullScreenFromTask){sap.ui.getCore().getEventBus().publish("cus.crm.opportunity","followUpOpportunityCreated",{contextPath:t.ContextPath});var A=sap.ca.scfld.md.app.Application.getImpl().getResourceBundle().getText('followupsuccessful');sap.m.MessageToast.show(A,{closeOnBrowserNavigation:false})}else sap.m.MessageToast.show(sap.ca.scfld.md.app.Application.getImpl().getResourceBundle().getText('SAVE_SUCCESS'));t._clear_data();sap.ca.ui.utils.busydialog.releaseBusyDialog();var B=t.ContextPath;if(!jQuery.device.is.phone&&(!x.fullScreen)&&(!x.fullScreenFromTask)&&(!x.fullfollowupOppt))t.oRouter.navTo("detail",{contextPath:B},true);else if(!jQuery.device.is.phone&&(x.fullScreen)){t.oRouter.navTo("display",{contextPath:B},true)}else if(!jQuery.device.is.phone&&(x.fullfollowupOppt)){t.oRouter.navTo("display",{contextPath:B},true)}else if(!jQuery.device.is.phone&&(x.fullScreenFromTask)){t.oRouter.navTo("display",{contextPath:B},true)}else t._navBack()},function(M){t.displayResponseErrorMessage(M,sap.ca.scfld.md.app.Application.getImpl().getResourceBundle().getText('SAVE_FAILED'));sap.ca.ui.utils.busydialog.releaseBusyDialog();t.setBtnEnabled("sv",true)})}else return;this.fullScreen=false;this.followupOppt=false;this.fullScreenFromTask=false;this.fullfollowupOppt=false},displayResponseErrorMessage:function(m,d){var M;if(m.response){M=jQuery.parseJSON(m.response.body).error.message.value}else M=d;sap.ca.ui.message.showMessageBox({type:sap.ca.ui.message.Type.ERROR,message:M,})},_enableMasterFooter:function(g){var s=this.getView().getModel('controllers').getData().s2Controller;s.setBtnEnabled("sort",true);s.setBtnEnabled("BTN_S2_ADD",true);s.setBtnEnabled("BTN_S2_SHOW",true);var d=this.byId('desc').getValue();if(d!=""){s.desc=d;s.nGuid=g;s.bCreateOppt=true;s._modifyListAfterCreate()}},callController:function(s){var m=this.getView().getModel();var b=[m.createBatchOperation("SalesStages","GET"),m.createBatchOperation("Priorities","GET"),m.createBatchOperation("UserStatuses","GET"),m.createBatchOperation("Currencies","GET")];if(parseFloat(this.sBackendVersion)>=4){var u=cus.crm.opportunity.util.Util;if(u.getPartnerFunctions()===null){b.push(m.createBatchOperation("PartnerFunctions","GET"))}}m.addBatchReadOperations(b);s={SalesStages:[],Priorities:[],UserStatuses:[],Currencies:[]};m.submitBatch(jQuery.proxy(function(r){if(r.__batchResponses[0].statusCode==="200"){s.SalesStages=r.__batchResponses[0].data.results}else this.handleErrors(r,true);if(r.__batchResponses[1].statusCode==="200"){s.Priorities=r.__batchResponses[1].data.results}else this.handleErrors(r,true);if(r.__batchResponses[2].statusCode==="200"){s.UserStatuses=r.__batchResponses[2].data.results}else this.handleErrors(r,true);if(r.__batchResponses[3].statusCode==="200"){this.Currencies=r.__batchResponses[3].data.results;this.byId("currency").setModel(new sap.ui.model.json.JSONModel({Currencies:this.Currencies}),"json")}else this.handleErrors(r,true);if(parseFloat(this.sBackendVersion)>=4){if(r.__batchResponses[4]&&r.__batchResponses[4].statusCode==="200"){var u=cus.crm.opportunity.util.Util;u.aggregatePartnerFunctions(r.__batchResponses[4].data.results);this.partnerDeterminationMap=u.getPartnerFunctions()}}this.fill_dropDowns(s)},this),jQuery.proxy(this.handleErrors,this),true)},_clear_data:function(){this.byId('desc').setValue("");this.byId('desc').setValueState(sap.ui.core.ValueState.None);this.byId('volume').setValue("");this.byId('inputMainContact').setValue("");this.byId('customer').setValue("");this.byId('customer').setValueState(sap.ui.core.ValueState.None);this.byId('currency').setValue("");this.byId('chanceofSuccess').setValue("");this.byId('datePickerStartDate').setValueState(sap.ui.core.ValueState.None);this.byId('datePickerCloseDate').setValueState(sap.ui.core.ValueState.None);this.byId('datePickerStartDate').setValue("");this.byId('datePickerCloseDate').setValue("");this.byId('statusdropdown').setSelectedKey();this.byId('priority_val').setSelectedKey("");this.byId('stagedropdown').setSelectedKey("");this.getView().byId("salesorganization_Text").setText("");this.getView().byId("salesOrganization").setValue("");this.getView().byId("distributionchannel_Text").setText("");this.getView().byId("division_Text").setText("");this.followUp=false;this.byId('Switch').setState(true);var d={Products:[],};this.byId('productBasket').getModel("json").setData(d);this.accountId=undefined;this.accountName="";var i=this.getView().byId("partnerBasket").getItems();for(var a=0;a<i.length;a++){this.getView().byId("partnerBasket").removeItem(i[a]);i[a].destroy()}if(this.participantsF4MultiselectFragment){var p=this.participantsF4MultiselectFragment.getContent()[0].getPages()[0].getContent()[0].getItems();if(p)for(var b=0;b<p.length;b++){this.participantsF4MultiselectFragment.getContent()[0].getPages()[0].getContent()[0].getItems()[b].setInfo(" ")}if(this.participantsF4MultiselectFragment.getModel("json"))this.participantsF4MultiselectFragment.getModel("json").destroy();if(this.participantsF4MultiselectFragment.getModel("PartnersBasedOnType"))this.participantsF4MultiselectFragment.getModel("PartnersBasedOnType").destroy();if(this.participantsF4MultiselectFragment.getModel("SelectedPartnerCategory"))this.participantsF4MultiselectFragment.getModel("SelectedPartnerCategory").destroy();this.byId('partnerBasket').getModel("json").updateBindings()}},onSearchProduct:function(e){this.oAddProductsFragment.getBeginButton().setEnabled(false);this.oAddProductsFragment.getContent()[0].removeSelections();this.oAddProductsFragment.getContent()[0].setNoDataText(this.oResourceBundle.getText('LOADING_TEXT'));this.oAddProductsFragment.getModel('json').setData({Products:[]});var f=[];var q=e.getParameter("query");if(q!==""){f.push("$filter=substringof('"+q+"',ProductDescription)")}this.oModel.read("Products",null,f,true,jQuery.proxy(function(o,r){if(r.data.results.length===0){this.oAddProductsFragment.getContent()[0].setNoDataText(this.oResourceBundle.getText('NO_DATA_TEXT'))}this.oAddProductsFragment.getModel('json').setData({Products:r.data.results})},this),jQuery.proxy(function(E){this.oAddProductsFragment.getContent()[0].setNoDataText(this.oResourceBundle.getText('NO_DATA_TEXT'))},this))},onCancelDialog:function(e){this.oAddProductsFragment.close();this.oAddProductsFragment.getContent()[0].removeSelections()},onAddDialog:function(e){var p=this.oAddProductsFragment.getContent()[0];var s=p.getSelectedItems();var a={Products:[]};var d=this.byId('productBasket').getModel("json").getData();if(d&&d.hasOwnProperty("Products"))a.Products=d.Products;var i=0;var l=s.length;var L;for(i=0;i<l;i++){L=s[i];var t=L.getBindingContext("json").getObject();var b={ItemGuid:"",ProcessingMode:"",ProductGuid:t.ProductGuid,ProductId:t.ProductId,ProductName:t.ProductDescription,Quantity:"1",Unit:t.Unit,};if(this.extHookExtendProductEntryOnAdd){this.extHookExtendProductEntryOnAdd(b,t)}a.Products.push(b)}var c=new sap.ui.model.json.JSONModel(a);this.byId('productBasket').setModel(c,"json");this.byId('productBasket').getModel("json").setData(a);p.removeSelections();e.getSource().getParent().close()},deleteProduct:function(e){var d=e.getSource().getModel("json").getData();var p=e.getSource().getBindingContext("json").getObject();var i;var l=d.Products.length;var s=this.getView().getController();for(i=0;i<l;i++)if(p===d.Products[i]){d.Products.splice(i,1)}s.byId('productBasket').getModel("json").setData(d)},showContactF4:function(e){var m=this.getView().getModel();this.contactF4Fragment.getContent()[0].removeSelections();this.contactF4Fragment.setModel(new sap.ui.model.json.JSONModel());this.contactF4Fragment.setModel(this.getView().getModel("i18n"),"i18n");this.contactF4Fragment.getContent()[0].setNoDataText(sap.ca.scfld.md.app.Application.getImpl().getResourceBundle().getText('LOADING_TEXT'));var t=this.contactF4Fragment.getContent()[0].getInfoToolbar();var a=t.getContent()[0];t.setVisible(false);var s=this.byId('inputMainContact')._lastValue;var T=s.split('/');var b=T[0].replace(/\s+$/,"");this.contactF4Fragment.getSubHeader().getContentLeft()[0].setValue(b);this.contactF4Fragment.open();var j=new sap.ui.model.json.JSONModel();this.contactF4Fragment.setModel(j,"json");if(this.accountId!==""&&this.acoundId!==null&&this.accountId!==undefined){t.setVisible(true);a.setText(sap.ca.scfld.md.app.Application.getImpl().getResourceBundle().getText('FILTER')+" "+this.accountName);m.read("/AccountCollection(accountID='"+this.accountId+"')/Contacts",null,["$filter=substringof('"+b+"'"+",fullName)"],true,jQuery.proxy(function(o,r){this.contactF4Fragment.getModel('json').setData({ContactCollection:r.data.results});if(r.data.results.length===0)this.contactF4Fragment.getContent()[0].setNoDataText(sap.ca.scfld.md.app.Application.getImpl().getResourceBundle().getText('NO_CONTACTS'))},this),jQuery.proxy(function(E){this.contactF4Fragment.getModel('json').setData({ContactCollection:[]});this.contactF4Fragment.getContent()[0].setNoDataText(sap.ca.scfld.md.app.Application.getImpl().getResourceBundle().getText('NO_CONTACTS'))},this))}else{t.setVisible(false);this.contactF4Fragment.getModel('json').setData({ContactCollection:[]});this.contactF4Fragment.getContent()[0].setNoDataText(sap.ca.scfld.md.app.Application.getImpl().getResourceBundle().getText('LOADING_TEXT'));m.read("ContactCollection",null,["$filter=substringof('"+b+"'"+",fullName)"],true,jQuery.proxy(function(o,r){this.contactF4Fragment.getModel('json').setData({ContactCollection:r.data.results});if(r.data.results.length===0)this.contactF4Fragment.getContent()[0].setNoDataText(sap.ca.scfld.md.app.Application.getImpl().getResourceBundle().getText('NO_CONTACTS'))},this),jQuery.proxy(function(E){this.contactF4Fragment.getContent()[0].setNoDataText(sap.ca.scfld.md.app.Application.getImpl().getResourceBundle().getText('NO_CONTACTS'))},this))}},showAccountF4:function(e){if(!this._accountSelectDialog){this._accountSelectDialog=new sap.ui.xmlfragment("cus.crm.opportunity.view.AccountSelectDialog",this);this._accountSelectDialog.setModel(this.getView().getModel());this._accountSelectDialog.setModel(this.getView().getModel("i18n"),"i18n");this._accountSelectDialog._searchField.setPlaceholder(sap.ca.scfld.md.app.Application.getImpl().getResourceBundle().getText("SEARCH"));this._accountSelectDialog._list.setGrowingScrollToLoad(true);this._accountSelectDialog._list.setGrowingThreshold(20);sap.ca.scfld.md.app.Application.getImpl().getConnectionManager().getModel().attachRequestSent(function(){if(this._list){this._list.setNoDataText(this.getModel("i18n").getResourceBundle().getText("LOADING_TEXT"))}},this._accountSelectDialog);sap.ca.scfld.md.app.Application.getImpl().getConnectionManager().getModel().attachRequestCompleted(function(){if(this._list){this._list.setNoDataText(this.getModel("i18n").getResourceBundle().getText("NO_DATA_TEXT"))}},this._accountSelectDialog);this._accountSelectDialog._dialog.setVerticalScrolling(true)}this._accountSelectDialog.getModel().attachRequestCompleted(null,this._setAccountF4Text,this);var f=[];var a=cus.crm.opportunity.util.schema._getEntityAnnotation(this.oModel,'service-schema-version','Account');var t=this.byId('customer').getValue();if(t!==""){f.push(new sap.ui.model.Filter(((a===null)?"name1":"fullName"),sap.ui.model.FilterOperator.Contains,t))}this._accountSelectDialog._list.bindAggregation("items",{path:"/AccountCollection",parameters:{expand:"MainAddress",select:"accountID,MainAddress/city,MainAddress/country,"+((a===null)?"name1":"fullName")},filters:f,template:this.accountF4Template,});this._accountSelectDialog.open()},closeAccountF4:function(e){this.byId('dialogAccountF4').close();this.accountf4open=""},closeContactF4:function(e){var j=new sap.ui.model.json.JSONModel();j.setData({ContactCollection:[]});this.contactF4Fragment.setModel(j,"json");this.contactF4Fragment.close()},setAccount:function(e){var s=e.getParameter("selectedItem");var a=s.data('NAME');var b=s.data("ID");if(a!==""){this.byId('customer').setValue(a);this.accountName=a}else{this.byId('customer').setValue(b);this.accountName=b}this.accountId=b;this.byId('customer').setValueState(sap.ui.core.ValueState.None);this.enableSaveBtn()},closeSalesAreaF4:function(e){if(this.salesareaF4Fragment!==undefined){this.salesareaF4Fragment.close();if(this.salesareaF4Fragment.getSubHeader().getContentLeft()[0].getValue()!="")this.salesareaF4Fragment.getSubHeader().getContentLeft()[0].setValue("")}},setSalesArea:function(e){this.oSelectedContact=e.getSource().getSelectedItem().getBindingContext("json").getObject();this.acc_salesorgid=this.oSelectedContact.SalesOrganizationId;this.acc_salesorgdesc=this.oSelectedContact.SalesOrganizationText;var s=cus.crm.opportunity.util.Formatter.formatSalesOrganization(this.acc_salesorgdesc,this.acc_salesorgid);this.getView().byId("salesOrganization").setValue(s);this.acc_dischaid=this.oSelectedContact.DistrubutionChannelId;this.acc_dischadesc=this.oSelectedContact.DistrubutionChannelText;var d=cus.crm.opportunity.util.Formatter.formatDistributionChannel(this.acc_dischadesc,this.acc_dischaid);this.getView().byId("distributionchannel_Text").setText(d);this.acc_divid=this.oSelectedContact.DivisionId;this.acc_divdesc=this.oSelectedContact.DivisionText;var a=cus.crm.opportunity.util.Formatter.formatDivision(this.acc_divdesc,this.acc_divid);this.getView().byId("division_Text").setText(a);this.salesareaF4Fragment.getContent()[0].removeSelections();this.closeSalesAreaF4(e)},searchSalesArea:function(e){var v=e.getParameter("query").toLowerCase();var s=this.salesareaF4Fragment.getContent()[0].getModel("SalesArea").getProperty("/SalesAreaList").results;var a=new Array();for(var k=0;k<s.length;k++){if(s[k].SalesOrganizationText.toLowerCase().search(v)!=-1||s[k].DistrubutionChannelText.toLowerCase().search(v)!=-1||s[k].DivisionText.toLowerCase().search(v)!=-1){a.push(s[k])}}this.salesareaF4Fragment.getContent()[0].setNoDataText(this.oResourceBundle.getText('NO_DATA_TEXT'));this.salesareaF4Fragment.getModel('json').setData({SalesAreaCollection:a});this.salesareaF4Fragment.getModel('json').updateBindings()},showSalesAreaF4:function(e){var a=this.byId('customer').getValue();if(a.length==0){var m=this.oResourceBundle.getText('NO_ACCOUNT');sap.m.MessageToast.show(m);return}if(!this.salesareaF4Fragment){this.salesareaF4Fragment=new sap.ui.xmlfragment(this.createId("salesareaF4"),'cus.crm.opportunity.view.SalesAreaDialog',this);this.salesareaF4Fragment.setModel(new sap.ui.model.json.JSONModel(),"json");this.salesareaF4Fragment.setModel(this.oI18nModel,'i18n')}this.salesareaF4Fragment.getContent()[0].removeSelections();this.salesareaF4Fragment.setModel(this.oI18nModel,"i18n");this.salesareaF4Fragment.getContent()[0].setNoDataText(sap.ca.scfld.md.app.Application.getImpl().getResourceBundle().getText('LOADING_TEXT'));var t=this.salesareaF4Fragment.getContent()[0].getInfoToolbar();var b=t.getContent()[0];if(this.accountId!==""&&this.accountId!==null&&this.accountId!==undefined){t.setVisible(true);b.setText(sap.ca.scfld.md.app.Application.getImpl().getResourceBundle().getText('FILTER')+" "+this.accountName);this.oModel.read("/SalesAreas",null,["$filter=ProspectNumber eq '"+this.accountId+"'"],false,jQuery.proxy(function(o,r){this.salesareaF4Fragment.getContent()[0].setNoDataText(this.oResourceBundle.getText('NO_DATA_TEXT'));if(!this.salesareaF4Fragment.getModel("SalesArea")){this.salesareaF4Fragment.setModel(new sap.ui.model.json.JSONModel(),"SalesArea")}var d=this.salesareaF4Fragment.getContent()[0].getModel("SalesArea");d.setProperty("/SalesAreaList",r.data)},this),jQuery.proxy(function(E){this.salesareaF4Fragment.getModel('json').setData({SalesAreaCollection:[]});this.salesareaF4Fragment.getContent()[0].setNoDataText(this.oResourceBundle.getText('NO_DATA_TEXT'))},this))}var v=this.byId("salesOrganization").getValue().toLowerCase();this.salesareaF4Fragment.getSubHeader().getContentLeft()[0].setValue(v);var s=this.salesareaF4Fragment.getContent()[0].getModel("SalesArea").getProperty("/SalesAreaList").results;var c=new Array();for(var k=0;k<s.length;k++){if(s[k].SalesOrganizationText.toLowerCase().search(v)!=-1||s[k].DistrubutionChannelText.toLowerCase().search(v)!=-1||s[k].DivisionText.toLowerCase().search(v)!=-1){c.push(s[k])}}this.salesareaF4Fragment.getContent()[0].setNoDataText(this.oResourceBundle.getText('NO_DATA_TEXT'));this.salesareaF4Fragment.getModel('json').setData({SalesAreaCollection:c});this.salesareaF4Fragment.getModel('json').updateBindings();this.salesareaF4Fragment.open()},closeEmployeeF4:function(e){this.employeeF4Fragment.close()},showEmployeeF4:function(e){if(!this.employeeF4Fragment){this.employeeF4Fragment=new sap.ui.xmlfragment(this.createId("employeeF4"),'cus.crm.opportunity.view.EmployeeF4',this);this.employeeF4Fragment.setModel(new sap.ui.model.json.JSONModel(),"json");this.employeeF4Fragment.setModel(this.oI18nModel,'i18n')}this.employeeF4Fragment.getContent()[0].removeSelections();this.employeeF4Fragment.setModel(this.oI18nModel,"i18n");this.employeeF4Fragment.getContent()[0].setNoDataText(sap.ca.scfld.md.app.Application.getImpl().getResourceBundle().getText('LOADING_TEXT'));var t=this.employeeF4Fragment.getContent()[0].getInfoToolbar();var a=t.getContent()[0];t.setVisible(false);var s=this.byId('inputEmpResponsible_S5').getValue();var T=s.split('/');var b=T[0].replace(/\s+$/,"");this.employeeF4Fragment.getSubHeader().getContentLeft()[0].setValue(b);var o=this.HeaderObject;if(this.accountId!==undefined&&this.accountId!==null&&this.accountId!==""){t.setVisible(true);a.setText(sap.ca.scfld.md.app.Application.getImpl().getResourceBundle().getText('FILTER')+" "+this.accountName);this.oModel.read("/AccountCollection(accountID='"+this.accountId+"')/EmployeeResponsibles",null,["$filter=substringof('"+this.byId('inputEmpResponsible_S5').getValue()+"'"+",fullName)"],true,jQuery.proxy(function(c,r){this.employeeF4Fragment.getContent()[0].setNoDataText(this.oResourceBundle.getText('NO_DATA_TEXT'));this.employeeF4Fragment.getModel('json').setData({EmployeeCollection:r.data.hasOwnProperty("results")?r.data.results:[r.data]});this.employeeF4Fragment.getModel('json').updateBindings()},this),jQuery.proxy(function(E){this.employeeF4Fragment.getModel('json').setData({EmployeeCollection:[]});this.employeeF4Fragment.getContent()[0].setNoDataText(this.oResourceBundle.getText('NO_DATA_TEXT'))},this))}else{t.setVisible(false);this.employeeF4Fragment.getModel('json').setData({EmployeeCollection:[]});this.employeeF4Fragment.getContent()[0].setNoDataText(sap.ca.scfld.md.app.Application.getImpl().getResourceBundle().getText('LOADING_TEXT'));this.oModel.read("EmployeeCollection",null,["$filter=substringof('"+this.byId('inputEmpResponsible_S5').getValue()+"'"+",fullName)"],true,jQuery.proxy(function(c,r){this.employeeF4Fragment.getModel('json').setData({EmployeeCollection:r.data.hasOwnProperty("results")?r.data.results:[r.data]});this.employeeF4Fragment.getContent()[0].setNoDataText(this.oResourceBundle.getText('NO_DATA_TEXT'))},this),jQuery.proxy(function(E){this.employeeF4Fragment.getContent()[0].setNoDataText(this.oResourceBundle.getText('NO_DATA_TEXT'))},this))}this.employeeF4Fragment.open()},closeEmpToolbar:function(e){var t=this.employeeF4Fragment.getContent()[0].getInfoToolbar();var o=this.employeeF4Fragment.getContent()[0];var s=this.employeeF4Fragment.getSubHeader().getContentLeft()[0].getValue();t.setVisible(false);o.getBinding("items").aFilters=[];o.getBinding("items").sFilterParams="";o.getBinding("items").refresh();this.employeeF4Fragment.getModel('json').setData({EmployeeCollection:[]});o.setNoDataText(sap.ca.scfld.md.app.Application.getImpl().getResourceBundle().getText('LOADING_TEXT'));this.oModel.read("EmployeeCollection",null,["$filter=substringof('"+s+"',fullName)"],true,jQuery.proxy(function(a,r){this.employeeF4Fragment.getModel('json').setData({EmployeeCollection:r.data.results});if(r.data.results.length===0)this.employeeF4Fragment.getContent()[0].setNoDataText(sap.ca.scfld.md.app.Application.getImpl().getResourceBundle().getText('NO_DATA_TEXT'))},this),jQuery.proxy(function(E){this.employeeF4Fragment.getContent()[0].setNoDataText(sap.ca.scfld.md.app.Application.getImpl().getResourceBundle().getText('NO_DATA_TEXT'))},this))},searchEmployee:function(e){var v=e.getParameter("query");this.employeeF4Fragment.getContent()[0].setNoDataText(sap.ca.scfld.md.app.Application.getImpl().getResourceBundle().getText('LOADING_TEXT'));var t=this.employeeF4Fragment.getContent()[0].getInfoToolbar();if(t.getVisible()===false){this.oModel.read("EmployeeCollection",null,["$filter=substringof('"+v+"'"+",fullName)"],true,jQuery.proxy(function(o,r){this.employeeF4Fragment.getContent()[0].setNoDataText(this.oResourceBundle.getText('NO_DATA_TEXT'));this.employeeF4Fragment.getModel('json').setData({EmployeeCollection:(r.data.hasOwnProperty("results"))?r.data.results:[r.data]})},this),jQuery.proxy(function(E){this.employeeF4Fragment.getModel('json').setData({EmployeeCollection:[]});this.employeeF4Fragment.getContent()[0].setNoDataText(this.oResourceBundle.getText('NO_DATA_TEXT'))},this))}else{this.oModel.read("/AccountCollection(accountID='"+this.accountId+"')/EmployeeResponsibles",null,["$filter=substringof('"+v+"'"+",fullName)"],true,jQuery.proxy(function(o,r){this.employeeF4Fragment.getContent()[0].setNoDataText(this.oResourceBundle.getText('NO_DATA_TEXT'));this.employeeF4Fragment.getModel('json').setData({EmployeeCollection:(r.data.hasOwnProperty("results"))?r.data.results:[r.data]})},this),jQuery.proxy(function(E){this.employeeF4Fragment.getModel('json').setData({EmployeeCollection:[]});this.employeeF4Fragment.getContent()[0].setNoDataText(this.oResourceBundle.getText('NO_DATA_TEXT'))},this))}},setEmployee:function(e){this.oSelectedEmployee=e.getSource().getSelectedItem().getBindingContext("json").getObject();if(this.oSelectedEmployee.fullName!=="")this.byId('inputEmpResponsible_S5').setValue(this.oSelectedEmployee.fullName);else this.byId('inputEmpResponsible_S5').setValue(this.oSelectedEmployee.employeeID);this.employeeF4Fragment.getContent()[0].removeSelections();var j=new sap.ui.model.json.JSONModel();j.setData({EmployeeCollection:[]});this.employeeF4Fragment.setModel(j,"json");this.employeeF4Fragment.close()},setContact:function(e){this.oSelectedContact=e.getSource().getSelectedItem().getBindingContext("json").getObject();if(this.oSelectedContact.fullName!=="")this.byId('inputMainContact').setValue(this.oSelectedContact.fullName);else this.byId('inputMainContact').setValue(this.oSelectedContact.contactID);this.contactId=this.oSelectedContact.contactID;this.contactF4Fragment.getContent()[0].removeSelections();var j=new sap.ui.model.json.JSONModel();j.setData({ContactCollection:[]});this.contactF4Fragment.setModel(j,"json");this.contactF4Fragment.close()},searchAccount:function(e){var v=e.getParameter("value");var f=[];if(v!==""){var a=cus.crm.opportunity.util.schema._getEntityAnnotation(this.oModel,'service-schema-version','Account');f.push(new sap.ui.model.Filter(((a===null)?"name1":"fullName"),sap.ui.model.FilterOperator.Contains,v))}var i=e.getParameter("itemsBinding");if(i){i.aApplicationFilters=[];i.filter(f)}},searchContact:function(e){var v=e.getParameter("query");this.contactF4Fragment.getContent()[0].setNoDataText(sap.ca.scfld.md.app.Application.getImpl().getResourceBundle().getText('LOADING_TEXT'));var t=this.contactF4Fragment.getContent()[0].getInfoToolbar();if(t.getVisible()===false){this.getView().getModel().read("ContactCollection",null,["$filter=substringof('"+v+"'"+",fullName)"],true,jQuery.proxy(function(o,r){this.contactF4Fragment.getModel('json').setData({ContactCollection:r.data.results});if(r.data.results.length===0)this.contactF4Fragment.getContent()[0].setNoDataText(sap.ca.scfld.md.app.Application.getImpl().getResourceBundle().getText('NO_CONTACTS'))},this),jQuery.proxy(function(E){this.contactF4Fragment.getModel('json').setData({ContactCollection:[]});this.contactF4Fragment.getContent()[0].setNoDataText(sap.ca.scfld.md.app.Application.getImpl().getResourceBundle().getText('NO_CONTACTS'))},this))}else{this.getView().getModel().read("/AccountCollection(accountID='"+this.accountId+"')/Contacts",null,["$filter=substringof('"+v+"'"+",fullName)"],true,jQuery.proxy(function(o,r){this.contactF4Fragment.getModel('json').setData({ContactCollection:r.data.results});if(r.data.results.length===0)this.contactF4Fragment.getContent()[0].setNoDataText(sap.ca.scfld.md.app.Application.getImpl().getResourceBundle().getText('NO_CONTACTS'))},this),jQuery.proxy(function(E){this.contactF4Fragment.getModel('json').setData({ContactCollection:[]});this.contactF4Fragment.getContent()[0].setNoDataText(sap.ca.scfld.md.app.Application.getImpl().getResourceBundle().getText('NO_CONTACTS'))},this))}},closeToolbar:function(e){var t=this.contactF4Fragment.getContent()[0].getInfoToolbar();var o=this.contactF4Fragment.getContent()[0];var s=this.contactF4Fragment.getSubHeader().getContentLeft()[0].getValue();t.setVisible(false);o.getBinding("items").aFilters=[];o.getBinding("items").sFilterParams="";o.getBinding("items").refresh();this.contactF4Fragment.getModel('json').setData({ContactCollection:[]});o.setNoDataText(sap.ca.scfld.md.app.Application.getImpl().getResourceBundle().getText('LOADING_TEXT'));this.getView().getModel().read("ContactCollection",null,["$filter=substringof('"+s+"',fullName)"],true,jQuery.proxy(function(a,r){this.contactF4Fragment.getModel('json').setData({ContactCollection:r.data.results});if(r.data.results.length===0)this.contactF4Fragment.getContent()[0].setNoDataText(sap.ca.scfld.md.app.Application.getImpl().getResourceBundle().getText('NO_CONTACTS'))},this),jQuery.proxy(function(E){this.contactF4Fragment.getContent()[0].setNoDataText(sap.ca.scfld.md.app.Application.getImpl().getResourceBundle().getText('NO_CONTACTS'))},this))},showCurrencyF4:function(){var t=this.byId('currency').getValue();if(!this.oCurrencyF4Fragment){this.oCurrencyF4Fragment=sap.ui.xmlfragment("cus.crm.opportunity.view.CurrencySelectDialog",this);this.oCurrencyF4Fragment.setModel(this.getView().getModel("i18n"),"i18n");var j=new sap.ui.model.json.JSONModel({Currencies:this.Currencies});this.oCurrencyF4Fragment.setModel(j,"json")}var f=[];if(t===""){this.oCurrencyF4Fragment._searchField.setPlaceholder(sap.ca.scfld.md.app.Application.getImpl().getResourceBundle().getText("SEARCH"))}else{this.oCurrencyF4Fragment._searchField.setValue(t);f=new sap.ui.model.Filter([new sap.ui.model.Filter("CurrencyText",sap.ui.model.FilterOperator.Contains,t),new sap.ui.model.Filter("CurrencyKey",sap.ui.model.FilterOperator.Contains,t)],false)}this.oCurrencyF4Fragment.getBinding("items").filter(f);window.setTimeout(jQuery.proxy(function(){if(t===""){this.oCurrencyF4Fragment._searchField.setPlaceholder(sap.ca.scfld.md.app.Application.getImpl().getResourceBundle().getText("SEARCH"))}else{this.oCurrencyF4Fragment._searchField.setValue(t)}},this),10);this.oCurrencyF4Fragment.open()},setCurrency:function(e){var s=e.getParameter("selectedItem");this.byId('currency').setValue(s.data("CurrencyKey"))},searchCurrency:function(e){var v=e.getParameter("value");if(v!==undefined){var f=new sap.ui.model.Filter([new sap.ui.model.Filter("CurrencyText",sap.ui.model.FilterOperator.Contains,v),new sap.ui.model.Filter("CurrencyKey",sap.ui.model.FilterOperator.Contains,v)],false);e.getParameter("itemsBinding").filter([f])}},closeCurrencyF4:function(e){this.byId('dialogCurrencyF4').close()},descriptionChanged:function(e){var d=this.byId('desc');if(e.getParameter('newValue').length>40){d.setValueState(sap.ui.core.ValueState.Error)}else d.setValueState(sap.ui.core.ValueState.None);this.enableSaveBtn()},quantityChanged:function(e){var d=e.getSource().getBindingContext("json").getObject();var n=e.getParameter('newValue');var p=/[^0-9.]/;if(p.test(n)===false){if(n.split(".").length>2){e.getSource().setValue(d.OldValue)}else{d.OldValue=n;e.getSource().setValueState(sap.ui.core.ValueState.None)}}else{if(d.OldValue===undefined)d.OldValue=1;e.getSource().setValue(d.OldValue)}},chanceOfSuccessChanged:function(e){var n=e.getParameter('newValue');var p=/[^0-9.]/;if(p.test(n)===false){if(n.split(".").length>2){e.getSource().setValue(this.OldcosValue)}else{this.OldcosValue=n;e.getSource().setValueState(sap.ui.core.ValueState.None)}}else{e.getSource().setValue(this.OldcosValue)}},volumeChanged:function(e){var n=e.getParameter('newValue');var p=/[^0-9.]/;var c=n.charAt(0);if(p.test(n)===false){if(n.split(".").length>2){e.getSource().setValue(this.OldvolumeValue)}else{this.OldvolumeValue=n;e.getSource().setValueState(sap.ui.core.ValueState.None)}}else if(p.test(c)===true){e.getSource().setValue("")}else{e.getSource().setValue(this.OldvolumeValue)}},validateCurrency:function(){var c=this.Currencies.length;var r=true;var a=this.getView().byId("currency").getValue().trim();a=a.toLocaleUpperCase();this.currencyMessage=sap.ca.scfld.md.app.Application.getImpl().getResourceBundle().getText('INVALID_CURRENCY');if(a!=""){for(var i=0;i<c;i++){if(this.Currencies[i].CurrencyKey===a){r=false;return}}}else this.currencyMessage=sap.ca.scfld.md.app.Application.getImpl().getResourceBundle().getText('NULL_CURRENCY');return r},validateSavePage:function(){var c=false;if(this.byId('desc').getValue()===""){this.byId('desc').setValueState(sap.ui.core.ValueState.Error);c=true}if(this.byId('customer').getValue()===""){this.byId('customer').setValueState(sap.ui.core.ValueState.Error);c=true}if(this.accountName!==this.byId('customer').getValue()){this.byId('customer').setValueState(sap.ui.core.ValueState.Error);c=true}if(this.byId('volume').getValue()===""){this.byId('volume').setValue(0)}if(this.byId('desc').getValueState()===sap.ui.core.ValueState.Error)c=true;if((this.byId('datePickerStartDate').getValueState()===sap.ui.core.ValueState.Error)||(this.byId('datePickerCloseDate').getValueState()===sap.ui.core.ValueState.Error)){c=true}if(this.byId('chanceofSuccess').getValueState()===sap.ui.core.ValueState.Error)c=true;if(this.byId('volume').getValueState()===sap.ui.core.ValueState.Error)c=true;var d=this.byId('datePickerCloseDate');var a=$('#'+d.getIdForLabel()).val();if(a===""){this.byId('datePickerCloseDate').setValueState(sap.ui.core.ValueState.Error);c=true}if(this.validateProductBasket()===false){c=true}if(c==true){return false}return true},validateProductBasket:function(){var a=this.byId('productBasket').getItems();var i,l;l=a.length;var c=false;if(l<=0){return!c}var b=null;var d=a[0].getCells();for(i=0;i<d.length;i++){if(d[i].data("field")==="QUANTITY"){b=i;var q=d[i].getContent()[0];var v=parseFloat(q.getValue())+"";if(v==="NaN"){q.setValueState(sap.ui.core.ValueState.Error);c=true}}}if(b){for(i=1;i<a.length;i++){var q=a[i].getCells()[b].getContent()[0];var v=parseFloat(q.getValue())+"";if(v==="NaN"){q.setValueState(sap.ui.core.ValueState.Error);c=true}}}return!c},validateDates:function(){var d=this.byId('datePickerStartDate');var a=this.byId('datePickerCloseDate');var l=$('#'+d.getIdForLabel()).val();var b=$('#'+a.getIdForLabel()).val();var i=false;if(l!==""&&(this.oDateFormatter.parse(l)===null)){i=true;d.setValueState(sap.ui.core.ValueState.Error);sap.ca.ui.message.showMessageBox({type:sap.ca.ui.message.Type.ERROR,message:sap.ca.scfld.md.app.Application.getImpl().getResourceBundle().getText('JUNK_DATE')})}if(b!==""&&(this.oDateFormatter.parse(b)===null)){i=true;sap.ca.ui.message.showMessageBox({type:sap.ca.ui.message.Type.ERROR,message:sap.ca.scfld.md.app.Application.getImpl().getResourceBundle().getText('JUNK_DATE')});a.setValueState(sap.ui.core.ValueState.Error)}if(i)return false;if(l!==""&&b!==""&&this.oDateFormatter.parse(l)>this.oDateFormatter.parse(b)){sap.ca.ui.message.showMessageBox({type:sap.ca.ui.message.Type.ERROR,message:sap.ca.scfld.md.app.Application.getImpl().getResourceBundle().getText('INVALID_DATE')});a.setValueState(sap.ui.core.ValueState.Error);return false}return true},handleErrors:function(e){sap.ca.ui.utils.busydialog.releaseBusyDialog();jQuery.sap.log.error(JSON.stringify(e));sap.ca.ui.message.showMessageBox({type:sap.ca.ui.message.Type.ERROR,message:e.message,details:JSON.parse(e.response.body).error.message.value},function(r){})},_setAccountF4Text:function(e){this._accountSelectDialog._searchField.setValue(this.byId('customer').getValue());this._accountSelectDialog.getModel().detachRequestCompleted(this._setAccountF4Text,this)},followUpView:function(){this.byId('desc').setValue(this.title);this.byId('customer').setValue(this.AccountName);this.accountName=this.AccountName;this.byId('inputMainContact').setValue(this.ContactName);this.byId('inputEmpResponsible_S5').setValue(this.ResponsibleTxt);this.byId('datePickerStartDate').setValue(cus.crm.opportunity.util.Formatter.dateFormatter(this.StartDate));this.getView().byId('datePickerCloseDate').setValue(cus.crm.opportunity.util.Formatter.dateFormatter(new Date()));this.byId('datePickerStartDate').setValueState(sap.ui.core.ValueState.None);this.byId('datePickerCloseDate').setValueState(sap.ui.core.ValueState.None);this.byId('datePickerStartDate').fireChange(this.byId('datePickerStartDate'));this.getView().byId("TxtTypeInput").setText(this.ProcessTypeDescription);this.byId('Switch').setState(true)},fromTaskFollowUpView:function(){this.byId('desc').setValue(this.title);this.byId('customer').setValue(this.AccountName);this.accountName=this.AccountName;this.byId('inputMainContact').setValue(this.ContactName);this.byId('datePickerStartDate').setValue(cus.crm.opportunity.util.Formatter.dateFormatter(new Date()));this.getView().byId('datePickerCloseDate').setValue(cus.crm.opportunity.util.Formatter.dateFormatter(new Date()));this.byId('datePickerStartDate').setValueState(sap.ui.core.ValueState.None);this.byId('datePickerCloseDate').setValueState(sap.ui.core.ValueState.None);this.getView().byId("TxtTypeInput").setText(this.ProcessTypeDescription);this.byId('Switch').setState(true)},bindEditView:function(){var s;s=this.getView().getModel('controllers').getData().s3Controller;var a={};this.deleteBuffer=[];this.controller=s;a.Header=s.byId('info').getModel('json').getData();this.HeaderObject=a.Header;this.headerGuid=a.Header.Guid;;this.userStatusCode=a.Header.UserStatusCode;this.UserStatuses=a.UserStatuses;this.Currencies=s.Currencies;this.currentDescription=a.Header.Description;this.byId('desc').setValue(a.Header.Description);this.accountName=a.Header.ProspectName;this.byId('customer').setValue(a.Header.ProspectName);if(a.Header.ProspectName==="")this.byId('customer').setValue(a.Header.ProspectNumber);this.byId('inputEmpResponsible_S5').setValue(a.Header.EmployeeResponsibleName);this.byId('datePickerStartDate').setValue(cus.crm.opportunity.util.Formatter.dateFormatter(a.Header.StartDate));this.getView().byId('datePickerCloseDate').setValue(cus.crm.opportunity.util.Formatter.dateFormatter(new Date()));this.byId('datePickerStartDate').setValueState(sap.ui.core.ValueState.None);this.byId('datePickerCloseDate').setValueState(sap.ui.core.ValueState.None);this.byId('currency').setValue(a.Header.CurrencyCode);this.byId('Switch').setState(a.Header.ForecastRelevance);this.getView().byId('salesOrganization').setValue(a.Header.SalesOrganizationDescription);this.byId('distributionchannel_Text').setText(a.Header.DistributionChannelDescription);this.byId('division_Text').setText(a.Header.DivisionDescription);var m=s.getView().getModel();this.byId('inputMainContact').setValue(a.Header.MainContactName);this.oSelectedContact.contactID=a.Header.MainContactId;this.oSelectedContact.fullName=a.Header.MainContactName;this.contactId=a.Header.MainContactId;this.accountId=a.Header.ProspectNumber;this.getView().byId("laTypeInput").setVisible(false);this.getView().byId("TxtTypeInput").setVisible(false);var p=null;if(s!=null||s!=undefined){p=s.processTypeDesc;if(p!=null){this.getView().byId("laTypeInput").setVisible(true);this.getView().byId("TxtTypeInput").setVisible(true);this.getView().byId("TxtTypeInput").setText(p)}}if(parseFloat(this.oVersioningModel.getData().BackendSchemaVersion)>=2.0){this.byId('inputEmpResponsible_S5').setValue(a.Header.EmployeeResponsibleName);this.oSelectedAccount.accountID=a.Header.ProspectNumber;this.oSelectedEmployee.employeeID=a.Header.EmployeeResponsibleNumber}this.oSelectedEmployee.fullName=a.Header.EmployeeResponsibleName;this.OldcosValue=this.byId('chanceofSuccess').getValue();this.OldvolumeValue=this.byId('volume').getValue();this.ContactCollection=s.ContactCollection;this.EmployeeCollection=s.EmployeeCollection;var i,b;var j=new sap.ui.model.json.JSONModel();var c=new sap.ui.model.json.JSONModel();var d=new sap.ui.model.json.JSONModel();var e=new sap.ui.model.json.JSONModel();b=s.UserStatuses.length;var f={UserStatuses:[{BusinessTransaction:"",LanguageCode:"",ProcessType:this.processType,StatusProfile:"",UserStatusCode:"",UserStatusText:"",}]};var g="";for(i=0;i<b;i++){if(s.UserStatuses[i].ProcessType===this.processType){f.UserStatuses.push(s.UserStatuses[i]);if(parseFloat(this.sBackendVersion)>=3){if(s.UserStatuses[i].InitialStatus==true)g=s.UserStatuses[i].UserStatusCode}if(this.UserStatusCode===""&&s.UserStatuses[i].UserStatusCode!=""){this.UserStatusCode=s.UserStatuses[i].UserStatusCode;this.UserStatusText=s.UserStatuses[i].UserStatusText}if(s.UserStatuses[i].BusinessTransaction==="WINN"){this.getView().getController().WinStatusCode=s.UserStatuses[i].UserStatusCode}if(s.UserStatuses[i].BusinessTransaction==="LOST"){this.getView().getController().LostStatusCode=s.UserStatuses[i].UserStatusCode}this.StatusProfile=s.UserStatuses[i].StatusProfile}}j.setData(f);this.byId('statusdropdown').setModel(j,"json");this.byId('statusdropdown').setSelectedKey(g);var h={Priorities:[{LanguageCode:"",PriorityCode:"",PriorityText:"",}]};b=s.Priorities.length;for(i=0;i<b;i++){h.Priorities.push(s.Priorities[i])};c.setData(h);this.byId('priority_val').setModel(c,"json");b=s.SalesStages.length;var n=new Array();var o=new Array();var q;var r;var t;var u={SalesStages:[{ChanceOfSuccess:"",LanguageCode:"",ProcessType:this.processType,SalesStageCode:"",SalesStageDescription:"",SalesStageOrder:"",}]};for(i=0;i<b;i++){if(s.SalesStages[i].ProcessType===this.processType){u.SalesStages.push(s.SalesStages[i]);n.push(s.SalesStages[i].SalesStageOrder);o=n.sort();q=o[0];if(s.SalesStages[i].SalesStageOrder==q){r=s.SalesStages[i].SalesStageCode;t=Number(s.SalesStages[i].ChanceOfSuccess)}}}d.setData(u);this.byId('stagedropdown').setModel(d,"json");this.byId('stagedropdown').setSelectedKey(r);this.getView().byId("chanceofSuccess").setValue(t);if(this.byId('statusdropdown').getSelectedKey()===this.WinStatusCode||this.byId('statusdropdown').getSelectedKey()===this.LostStatusCode){this.byId('opportunityAddProd_Button').setVisible(false)}else this.byId('opportunityAddProd_Button').setVisible(true);var v="Statuses";var w=s.byId('Product_Tab').getModel('json').getData();if(w&&w.hasOwnProperty("Products")){var x=JSON.parse(JSON.stringify(w));for(i=0;i<x.Products.length;i++){if(x.Products[i].ProductGuid===null)x.Products[i].Backend="CATEGORY";else x.Products[i].Backend="X";x.Products[i].OldValue=x.Products[i].Quantity;x.Products[i].NetValue=0}e.setData(x);this.byId('productBasket').setModel(e,"json")}if(!this.participantsF4MultiselectFragment){this.participantsF4MultiselectFragment=new sap.ui.xmlfragment(this.createId("participantsF4Multiselect_S5"),'cus.crm.opportunity.view.ParticipantsF4Multiselect',this);this.participantsF4MultiselectFragment.setModel(new sap.ui.model.json.JSONModel({}),"json");this.participantsF4MultiselectFragment.setModel(this.oI18nModel,'i18n')}var w=s.byId('Sales_Team').getModel('json').getData();if(!this.participantsF4MultiselectFragment.getModel("SelectedPartnerCategory")){this.participantsF4MultiselectFragment.setModel(new sap.ui.model.json.JSONModel(),"SelectedPartnerCategory")}var S=this.participantsF4MultiselectFragment.getModel("SelectedPartnerCategory");if(parseFloat(this.sBackendVersion)>=4){var U=cus.crm.opportunity.util.Util;if(U.getPartnerFunctions()===null){U.fetchPartnerFunctions(this.oModel)}this.partnerDeterminationMap=U.getPartnerFunctions()}else{if(!this.partnerDeterminationMap[this.processType]){this.oModel.read("OpptPartnerFctTypes",null,["TransactionType='"+this.processType+"'"],false,jQuery.proxy(function(D,E){this.partnerDeterminationMap[this.processType]=E.data.results},this),jQuery.proxy(function(E){},this))}}this.participantsF4MultiselectFragment.getModel('json').getData().PartnerFunctions=this.partnerDeterminationMap[this.processType];var P=this.participantsF4MultiselectFragment.getModel("json").getProperty("/PartnerFunctions");if(w&&w.hasOwnProperty("OpportunitySalesTeamSet")){var y={SalesTeam:[]};this.byId('partnerBasket').getModel("json").setData(y);var f=this.byId('partnerBasket').getModel("json").getData();for(var z=0;z<w.OpportunitySalesTeamSet.length;z++){for(var A=0;A<P.length;A++){if(w.OpportunitySalesTeamSet[z].PartnerFunctionText==P[A].PartnerFunctionName){var B={Name:w.OpportunitySalesTeamSet[z].PartnerName,Key:w.OpportunitySalesTeamSet[z].PartnerNumber,PartnerFunction:w.OpportunitySalesTeamSet[z].PartnerFunctionText,};y.SalesTeam.push(B)}}}var C=s.byId('tab_competitor').getModel('json').getData();if(C&&C.hasOwnProperty("Competitors")){for(var z=0;z<C.Competitors.results.length;z++){for(var A=0;A<P.length;A++){if("Competitor"==P[A].PartnerFunctionName){var B={Name:C.Competitors.results[z].PartnerName,Key:C.Competitors.results[z].PartnerNumber,PartnerFunction:"Competitor",};y.SalesTeam.push(B)}}}}this.byId('partnerBasket').getModel("json").setProperty('/SalesTeam',y.SalesTeam);for(var k=0;k<P.length;k++){var V=new Array();for(var l=0;l<y.SalesTeam.length;l++){if(y.SalesTeam[l].PartnerFunction==P[k].PartnerFunctionName){var B={key:y.SalesTeam[l].Key,value:y.SalesTeam[l].Name,};V.push(B)}}S.setProperty("/"+P[k].PartnerFunctionName,V)}}else{this.oModel.read("Opportunities(guid'"+this.headerGuid+"')",null,["$expand=SalesTeam"],false,jQuery.proxy(function(D,E){var y={SalesTeam:[]};this.byId('partnerBasket').getModel("json").setData(y);var f=this.byId('partnerBasket').getModel("json").getData();for(var z=0;z<D.SalesTeam.results.length;z++){for(var F=0;F<P.length;F++){if(D.SalesTeam.results[z].PartnerFunctionText==P[F].PartnerFunctionName){var B={Name:D.SalesTeam.results[z].PartnerName,Key:D.SalesTeam.results[z].PartnerNumber,PartnerFunction:D.SalesTeam.results[z].PartnerFunctionText,};y.SalesTeam.push(B)}}}var C=s.byId('tab_competitor').getModel('json').getData();if(C&&C.hasOwnProperty("Competitors")){for(var z=0;z<C.Competitors.results.length;z++){for(var A=0;A<P.length;A++){if("Competitor"==P[A].PartnerFunctionName){var B={Name:C.Competitors.results[z].PartnerName,Key:C.Competitors.results[z].PartnerNumber,PartnerFunction:"Competitor",};y.SalesTeam.push(B)}}}}this.byId('partnerBasket').getModel("json").setProperty('/SalesTeam',y.SalesTeam);for(var k=0;k<P.length;k++){var V=new Array();for(var l=0;l<y.SalesTeam.length;l++){if(y.SalesTeam[l].PartnerFunction==P[k].PartnerFunctionName){var B={key:y.SalesTeam[l].Key,value:y.SalesTeam[l].Name,};V.push(B)}}S.setProperty("/"+P[k].PartnerFunctionName,V)}},this),jQuery.proxy(function(E){},this))}this.followUp=true;this.enableSaveBtn()},enableProductsAddButton:function(e){if(this.oAddProductsFragment.getContent()[0].getSelectedItems().length>0){this.oAddProductsFragment.getBeginButton().setEnabled(true)}else{this.oAddProductsFragment.getBeginButton().setEnabled(false)}},onShowParticipants:function(e){var s;if(!this.participantsF4MultiselectFragment){this.participantsF4MultiselectFragment=new sap.ui.xmlfragment(this.createId("participantsF4Multiselect_S5"),'cus.crm.opportunity.view.ParticipantsF4Multiselect',this);this.participantsF4MultiselectFragment.setModel(new sap.ui.model.json.JSONModel({}),"json");this.participantsF4MultiselectFragment.setModel(this.oI18nModel,'i18n');s=this.participantsF4MultiselectFragment.getContent()[0]}s=this.participantsF4MultiselectFragment.getContent()[0];this.participantsF4MultiselectFragment.getModel('json').getData().PartnerFunctions=[];if(parseFloat(this.sBackendVersion)>=4){var u=cus.crm.opportunity.util.Util;if(u.getPartnerFunctions()===null){u.fetchPartnerFunctions(this.oModel)}this.partnerDeterminationMap=u.getPartnerFunctions()}else{if(!this.partnerDeterminationMap[this.processType]){this.oModel.read("OpptPartnerFctTypes",null,["TransactionType='"+this.processType+"'"],false,jQuery.proxy(function(o,r){this.partnerDeterminationMap[this.processType]=r.data.results},this),jQuery.proxy(function(E){},this))}}this.participantsF4MultiselectFragment.getModel('json').getData().PartnerFunctions=this.partnerDeterminationMap[this.processType];this.participantsF4MultiselectFragment.getModel('json').updateBindings();this.participantsF4MultiselectFragment.getContent()[0].getPages()[0].getContent()[0].bindItems("json>/PartnerFunctions",this.oPartnerFunctionsTemplate,null,[]);if(this.participantsF4MultiselectFragment.getModel("SelectedPartnerCategory")){var S=this.participantsF4MultiselectFragment.getModel("SelectedPartnerCategory");var p=this.participantsF4MultiselectFragment.getModel("json").getProperty("/PartnerFunctions");var t=new Array();for(var k=0;k<p.length;k++){if(this.participantsF4MultiselectFragment.getModel("SelectedPartnerCategory").getProperty("/"+p[k].PartnerFunctionName)){t.push(p[k].PartnerFunctionName)}}var i=this.participantsF4MultiselectFragment.getContent()[0].getPages()[0].getContent()[0].getItems();for(var k=0;k<i.length;k++){for(var a=0;a<t.length;a++){if(i[k].getBindingContext('json').getObject().PartnerFunctionName==t[a]){var c=S.getProperty("/"+t[a]).length;if(c>0){i[k].setInfo(c)}else{i[k].setInfo(" ")}}}}}this.participantsF4MultiselectFragment.open()},handleConfirm:function(e){jQuery.sap.require("sap.m.MessageToast");if(e.getParameters().filterString){sap.m.MessageToast.show(e.getParameters().filterString)}},onCancelParticipantDialog:function(e){if(this.participantsF4MultiselectFragment.getContent()[0].getPages()[1].getId()==e.getSource().getParent().getParent().getId()){this.participantsF4MultiselectFragment.getContent()[0].getPages()[0].getContent()[0].getSelectedItem().setSelected(false)}if(this.participantsF4MultiselectFragment.getModel("SelectedPartnerCategoryTemp")){this.participantsF4MultiselectFragment.getModel("SelectedPartnerCategoryTemp").destroy()}if(this.participantsF4MultiselectFragment.getModel("SelectedPartnerCategoryDeletedTemp")){this.participantsF4MultiselectFragment.getModel("SelectedPartnerCategoryDeletedTemp").destroy()}if(this.participantsF4MultiselectFragment.getModel("SelectedPartnerCategoryTemp1")){this.participantsF4MultiselectFragment.getModel("SelectedPartnerCategoryTemp1").destroy()}if(this.participantsF4MultiselectFragment.getModel("SelectedPartnerCategoryTemp2")){this.participantsF4MultiselectFragment.getModel()}var n=this.participantsF4MultiselectFragment.getContent()[0];n.to(this.participantsF4MultiselectFragment.getContent()[0].getPages()[0]);this.participantsF4MultiselectFragment.close()},onOKParticipantDialog:function(e){if(!this.participantsF4MultiselectFragment.getModel("SelectedPartnerCategory")){this.participantsF4MultiselectFragment.setModel(new sap.ui.model.json.JSONModel(),"SelectedPartnerCategory")}var p=this.participantsF4MultiselectFragment.getModel("json").getProperty("/PartnerFunctions");if(this.participantsF4MultiselectFragment.getModel("SelectedPartnerCategoryDeletedTemp")){for(var k=0;k<p.length;k++){if(this.participantsF4MultiselectFragment.getModel("SelectedPartnerCategoryDeletedTemp").getProperty("/"+p[k].PartnerFunctionName)){var i=this.participantsF4MultiselectFragment.getModel("SelectedPartnerCategoryDeletedTemp").getProperty("/"+p[k].PartnerFunctionName);for(var a=0;a<i.length;a++){var s=this.participantsF4MultiselectFragment.getModel("SelectedPartnerCategory").getProperty("/"+p[k].PartnerFunctionName);for(var b=0;b<s.length;b++){if(s[b].key==i[a].getDescription())this.participantsF4MultiselectFragment.getModel("SelectedPartnerCategory").getProperty("/"+p[k].PartnerFunctionName).splice(b,1)}}}}}this.participantsF4MultiselectFragment.getModel("SelectedPartnerCategoryDeletedTemp").destroy();var S=this.participantsF4MultiselectFragment.getModel("SelectedPartnerCategory");if(this.participantsF4MultiselectFragment.getContent()[0].getPages()[1].getId()==e.getSource().getParent().getParent().getId()){var c=this.participantsF4MultiselectFragment.getContent()[0]._sSelectedPartnerCategory;var E=[];if(!this.participantsF4MultiselectFragment.getModel("SelectedPartnerCategoryTemp")){this.participantsF4MultiselectFragment.setModel(new sap.ui.model.json.JSONModel(),"SelectedPartnerCategoryTemp")}var o=this.participantsF4MultiselectFragment.getModel("SelectedPartnerCategoryTemp");var l=this.participantsF4MultiselectFragment.getContent()[0].getPages()[0].getContent()[0];l.getSelectedItem().setSelected(false)}var t=new Array();var o=this.participantsF4MultiselectFragment.getModel("SelectedPartnerCategoryTemp");for(var k=0;k<p.length;k++){if(this.participantsF4MultiselectFragment.getModel("SelectedPartnerCategoryTemp").getProperty("/"+p[k].PartnerFunctionName)){t.push(p[k].PartnerFunctionName);if(S.getProperty("/"+p[k].PartnerFunctionName)){for(var a=0;a<o.getProperty("/"+p[k].PartnerFunctionName).length;a++){S.getProperty("/"+p[k].PartnerFunctionName).push(o.getProperty("/"+p[k].PartnerFunctionName)[a])}}else{S.setProperty("/"+p[k].PartnerFunctionName,o.getProperty("/"+p[k].PartnerFunctionName))}}}o.destroy();var d=this.participantsF4MultiselectFragment.getModel("SelectedPartnerCategory");var f=this.participantsF4MultiselectFragment.getModel("json").getProperty("/PartnerFunctions");var g={SalesTeam:[]};this.byId('partnerBasket').getModel("json").setData(g);var h=this.byId('partnerBasket').getModel("json").getData();if(h&&h.hasOwnProperty("SalesTeam"))g.SalesTeam=h.SalesTeam;for(var k=0;k<f.length;k++){if(d.getProperty("/"+f[k].PartnerFunctionName)){for(var a=0;a<d.getProperty("/"+f[k].PartnerFunctionName).length;a++){var j={Name:d.getProperty("/"+f[k].PartnerFunctionName)[a].value,Key:d.getProperty("/"+f[k].PartnerFunctionName)[a].key,PartnerFunction:f[k].PartnerFunctionName,};g.SalesTeam.push(j)}}}this.byId('partnerBasket').getModel("json").setProperty('/SalesTeam',g.SalesTeam);var n=this.participantsF4MultiselectFragment.getContent()[0];n._sSelectedPartnerCategoryAndParticipants=S;n.to(this.participantsF4MultiselectFragment.getContent()[0].getPages()[0]);this.participantsF4MultiselectFragment.close()},onNavBack:function(e){this.participantsF4MultiselectFragment.getContent()[0].getPages()[1].getSubHeader().getContentLeft()[0].clear();var s=this.participantsF4MultiselectFragment.getContent()[0]._sSelectedPartnerCategory;var S;if(this.participantsF4MultiselectFragment.getModel("SelectedPartnerCategoryTemp")){S=this.participantsF4MultiselectFragment.getModel("SelectedPartnerCategoryTemp")}if(this.participantsF4MultiselectFragment.getModel("SelectedPartnerCategory"))var a=this.participantsF4MultiselectFragment.getModel("SelectedPartnerCategory");if(this.participantsF4MultiselectFragment.getModel("SelectedPartnerCategoryDeletedTemp"))var d=this.participantsF4MultiselectFragment.getModel("SelectedPartnerCategoryDeletedTemp");var c=0;if(this.participantsF4MultiselectFragment.getModel("SelectedPartnerCategoryTemp"))if(this.participantsF4MultiselectFragment.getModel("SelectedPartnerCategoryTemp").getProperty("/"+s))c=c+S.getProperty("/"+s).length;if(a)if(a.getProperty("/"+s))c=c+a.getProperty("/"+s).length;if(d)if(d.getProperty("/"+s))c=c-d.getProperty("/"+s).length;var l=this.participantsF4MultiselectFragment.getContent()[0].getPages()[0].getContent()[0];if(c!=0){l.getSelectedItem().setInfo(c)}else if(l.getSelectedItem()){l.getSelectedItem().setInfo(" ")}l.getSelectedItem().setSelected(false);var n=this.participantsF4MultiselectFragment.getContent()[0];n._sSelectedPartnerCategoryAndParticipants=S;n.to(this.participantsF4MultiselectFragment.getContent()[0].getPages()[0])},onExit:function(){if(this._oDialog){this._oDialog.destroy()}},searchEmployeeList:function(e){var s=e.getParameter("query");var f=new sap.ui.model.Filter([new sap.ui.model.Filter("fullName",sap.ui.model.FilterOperator.Contains,s),new sap.ui.model.Filter("accountID",sap.ui.model.FilterOperator.Contains,s),new sap.ui.model.Filter("contactID",sap.ui.model.FilterOperator.Contains,s),new sap.ui.model.Filter("employeeID",sap.ui.model.FilterOperator.Contains,s)],false);this.participantsF4MultiselectFragment.getContent()[0].getPages()[1].getContent()[0].getBinding('items').filter((s!=="")?[f]:[])},onParticipantDelete:function(e){var I=e.getParameter("listItem");var p=e.getSource();var P=this.byId('partnerBasket').getItems();for(var i=0;i<P.length;i++){if(P[i]==I){var a=i}}e.getSource().removeItem(e.getParameter("listItem"));e.getParameter("listItem").destroy();var d=this.byId('partnerBasket').getModel("json").getData().SalesTeam[a].Name;var b=this.byId('partnerBasket').getModel("json").getData().SalesTeam[a].PartnerFunction;var c=this.byId('partnerBasket').getModel("json").getData().SalesTeam[a].Key;var f=this.participantsF4MultiselectFragment.getModel("SelectedPartnerCategory").getProperty("/"+b);for(var i=0;i<f.length;i++){if(f[i].key==c){this.participantsF4MultiselectFragment.getModel("SelectedPartnerCategory").getProperty("/"+b).splice(i,1)}}this.byId('partnerBasket').getModel("json").getData().SalesTeam.splice(a,1);var r=this.participantsF4MultiselectFragment.getContent()[0].getPages()[0].getContent()[0].getItems();for(var i=0;i<r.length;i++){if(r[i].getBindingContext("json").getObject().PartnerFunctionName==b){var g=this.participantsF4MultiselectFragment.getContent()[0].getPages()[0].getContent()[0].getItems()[i].getInfo();if(g-1!=0){this.participantsF4MultiselectFragment.getContent()[0].getPages()[0].getContent()[0].getItems()[i].setInfo(g-1)}else if(g-1==0){this.participantsF4MultiselectFragment.getContent()[0].getPages()[0].getContent()[0].getItems()[i].setInfo(" ")}}}this.participantsF4MultiselectFragment.getContent()[0].getPages()[0].getContent()[0].getItems()},onPartnerFunctionChange:function(e){if(this.participantsF4MultiselectFragment.getModel("SelectedPartnerCategoryTemp1")){this.participantsF4MultiselectFragment.getModel("SelectedPartnerCategoryTemp1").destroy()}if(this.participantsF4MultiselectFragment.getModel("SelectedPartnerCategoryTemp2")){this.participantsF4MultiselectFragment.getModel("SelectedPartnerCategoryTemp2").destroy()}var s="",d;if(e.getSource().getId().substring(e.getSource().getId().length-11)=="searchField"){var s=e.getParameter("query");if(s=="")s=" ";o=this.selectedBuffer.getBindingContext("json");d=true;if(!this.participantsF4MultiselectFragment.getModel("SelectedPartnerCategoryTemp1")){this.participantsF4MultiselectFragment.setModel(new sap.ui.model.json.JSONModel(),"SelectedPartnerCategoryTemp1")}var S=this.participantsF4MultiselectFragment.getModel("SelectedPartnerCategoryTemp1");var l=this.participantsF4MultiselectFragment.getContent()[0].getPages()[1].getContent()[0],E=[];for(var i=0;i<l.getSelectedItems().length;i++){E.push({key:l.getSelectedItems()[i].getDescription(),value:l.getSelectedItems()[i].getTitle()})}S.setProperty("/"+this.PartnerName,E)}var t,o;if(e.getSource().getId().substring(e.getSource().getId().length-7)=="XButton"){this.participantsF4MultiselectFragment.getContent()[0].getPages()[1].getSubHeader().getContentLeft()[0].clear();if(!this.participantsF4MultiselectFragment.getModel("SelectedPartnerCategoryTemp2")){this.participantsF4MultiselectFragment.setModel(new sap.ui.model.json.JSONModel(),"SelectedPartnerCategoryTemp2")}var S=this.participantsF4MultiselectFragment.getModel("SelectedPartnerCategoryTemp2");var l=this.participantsF4MultiselectFragment.getContent()[0].getPages()[1].getContent()[0],E=[];for(var i=0;i<l.getSelectedItems().length;i++){E.push({key:l.getSelectedItems()[i].getDescription(),value:l.getSelectedItems()[i].getTitle()})}S.setProperty("/"+this.PartnerName,E);this.participantsF4MultiselectFragment.getContent()[0].getPages()[1].getContent()[0].getInfoToolbar().setVisible(false);t=false;o=this.selectedBuffer.getBindingContext("json")}else if(d){}else{this.participantsF4MultiselectFragment.getContent()[0].getPages()[1].getSubHeader().getContentLeft()[0].clear();this.participantsF4MultiselectFragment.getContent()[0].getPages()[1].getContent()[0].getInfoToolbar().setVisible(true);var a=e.getParameter("listItem");this.selectedBuffer=a;o=a.getBindingContext("json");t=true}var b=this.participantsF4MultiselectFragment.getModel("SelectedPartnerCategory");var c=this.participantsF4MultiselectFragment.getModel("SelectedPartnerCategoryTemp");var p=this.participantsF4MultiselectFragment.getModel("json").getProperty("/PartnerFunctions"),n=this.participantsF4MultiselectFragment.getContent()[0];if(!this.participantsF4MultiselectFragment.getModel("PartnersBasedOnType")){this.participantsF4MultiselectFragment.setModel(new sap.ui.model.json.JSONModel(),"PartnersBasedOnType")}if(this.accountId){}else{t=false;this.participantsF4MultiselectFragment.getContent()[0].getPages()[1].getContent()[0].getInfoToolbar().setVisible(false)}if(p.indexOf(o.getObject())!==-1){var I=p.indexOf(o.getObject());this.PartnerName=p[I]["PartnerFunctionName"];switch(p[I]["PartnerFunctionCategory"]){case"0005":case"0008":var f,g;f=jQuery.proxy(function(C,D,r){var q=this.participantsF4MultiselectFragment.getModel("PartnersBasedOnType");q.setProperty("/"+C,D.results);for(var x=0;x<D.results.length;x++){if(D.results[x].fullName=="")D.results[x].fullName=" "}this.participantsF4MultiselectFragment.getContent()[0].getPages()[1].getContent()[0].bindItems("PartnersBasedOnType>/"+C,this.employeeListItemTemplate1,null,[])},this,p[I]["PartnerFunctionName"]);g=jQuery.proxy(function(q){},this);if(t){this.participantsF4MultiselectFragment.getContent()[0].getPages()[1].getContent()[0].getInfoToolbar().setVisible(true);this.participantsF4MultiselectFragment.getContent()[0].getPages()[1].getContent()[0].getInfoToolbar().getContent()[0].setText("Filtered By Account ID :"+this.accountName);this.oModel.read("/AccountCollection(accountID='"+this.accountId+"')/EmployeeResponsibles",null,null,false,f,g)}else if(this.participantsF4MultiselectFragment.getContent()[0].getPages()[1].getContent()[0].getInfoToolbar().getVisible()&&s){this.participantsF4MultiselectFragment.getContent()[0].getPages()[1].getContent()[0].getInfoToolbar().getContent()[0].setText("Filtered By Account ID :"+this.accountName);this.oModel.read("/AccountCollection(accountID='"+this.accountId+"')/EmployeeResponsibles",null,'$top=200&$filter=substringof(%27'+encodeURIComponent(s)+'%27,fullName)',false,f,g)}else if(s.length>0){this.participantsF4MultiselectFragment.getContent()[0].getPages()[1].getContent()[0].getInfoToolbar().setVisible(false);this.oModel.read("/EmployeeCollection",null,'$top=200&$filter=substringof(%27'+encodeURIComponent(s)+'%27,fullName)',false,f,g)}else{this.participantsF4MultiselectFragment.getContent()[0].getPages()[1].getContent()[0].getInfoToolbar().setVisible(false);this.oModel.read("/EmployeeCollection",null,null,false,f,g)}this.participantsF4MultiselectFragment.getContent()[0].getPages()[1].getContent()[0].destroyItems();this.participantsF4MultiselectFragment.getContent()[0].getPages()[1].getContent()[0].bindItems("PartnersBasedOnType>/"+p[I]["PartnerFunctionName"],this.employeeListItemTemplate1,null,[]);var P=this.participantsF4MultiselectFragment.getContent()[0].getPages()[1].getContent()[0].getItems();var m=this.participantsF4MultiselectFragment.getModel("PartnersBasedOnType").getProperty("/"+p[I]["PartnerFunctionName"]);var E;if(this.participantsF4MultiselectFragment.getModel("SelectedPartnerCategory")){var h=b.getProperty("/"+p[I]["PartnerFunctionName"]);if(h)for(var i=0;i<P.length;i++){for(var k=0;k<h.length;k++){if(h[k]["key"]===P[i].getDescription()){P[i].setSelected(true)}}}}if(this.participantsF4MultiselectFragment.getModel("SelectedPartnerCategoryDeletedTemp")){var j=this.participantsF4MultiselectFragment.getModel("SelectedPartnerCategoryDeletedTemp").getProperty("/"+p[I]["PartnerFunctionName"]);if(j)for(var i=0;i<P.length;i++){for(var k=0;k<j.length;k++){if(j[k].getDescription()===P[i].getDescription()){P[i].setSelected(false)}}}}if(this.participantsF4MultiselectFragment.getModel("SelectedPartnerCategoryTemp")){var j=this.participantsF4MultiselectFragment.getModel("SelectedPartnerCategoryTemp").getProperty("/"+p[I]["PartnerFunctionName"]);if(j)for(var i=0;i<P.length;i++){for(var k=0;k<j.length;k++){if(j[k]["key"]===P[i].getDescription()){P[i].setSelected(true)}}}}if(this.participantsF4MultiselectFragment.getModel("SelectedPartnerCategoryTemp1")){var j=this.participantsF4MultiselectFragment.getModel("SelectedPartnerCategoryTemp1").getProperty("/"+p[I]["PartnerFunctionName"]);if(j)for(var i=0;i<P.length;i++){for(var k=0;k<j.length;k++){if(j[k]["key"]===P[i].getDescription()){P[i].setSelected(true)}}}}if(this.participantsF4MultiselectFragment.getModel("SelectedPartnerCategoryTemp2")){var j=this.participantsF4MultiselectFragment.getModel("SelectedPartnerCategoryTemp2").getProperty("/"+p[I]["PartnerFunctionName"]);if(j)for(var i=0;i<P.length;i++){for(var k=0;k<j.length;k++){if(j[k]["key"]===P[i].getDescription()){P[i].setSelected(true)}}}}break;case"0007":var f,g;f=jQuery.proxy(function(C,D,r){var q=this.participantsF4MultiselectFragment.getModel("PartnersBasedOnType");q.setProperty("/"+C,D.results);for(var x=0;x<D.results.length;x++){if(D.results[x].fullName=="")D.results[x].fullName=" "}this.participantsF4MultiselectFragment.getContent()[0].getPages()[1].getContent()[0].bindItems("PartnersBasedOnType>/"+C,this.contactListItemTemplate1,null,[])},this,p[I]["PartnerFunctionName"]);g=jQuery.proxy(function(q){},this);if(t){this.participantsF4MultiselectFragment.getContent()[0].getPages()[1].getContent()[0].getInfoToolbar().getContent()[0].setText("Filtered By Account ID :"+this.accountName);this.participantsF4MultiselectFragment.getContent()[0].getPages()[1].getContent()[0].getInfoToolbar().setVisible(true);this.oModel.read("AccountCollection('"+this.accountId+"')/Contacts",null,null,false,f,g)}else if(this.participantsF4MultiselectFragment.getContent()[0].getPages()[1].getContent()[0].getInfoToolbar().getVisible()&&s){this.participantsF4MultiselectFragment.getContent()[0].getPages()[1].getContent()[0].getInfoToolbar().getContent()[0].setText("Filtered By Account ID :"+this.accountName);this.oModel.read("AccountCollection('"+this.accountId+"')/Contacts",null,'$top=200&$filter=substringof(%27'+encodeURIComponent(s)+'%27,fullName)',false,f,g)}else if(s.length>0){this.participantsF4MultiselectFragment.getContent()[0].getPages()[1].getContent()[0].getInfoToolbar().setVisible(false);this.oModel.read("/ContactCollection",null,'$top=200&$filter=substringof(%27'+encodeURIComponent(s)+'%27,fullName)',false,f,g)}else{this.participantsF4MultiselectFragment.getContent()[0].getPages()[1].getContent()[0].getInfoToolbar().setVisible(false);this.oModel.read("/ContactCollection",null,null,false,f,g)}this.participantsF4MultiselectFragment.getContent()[0].getPages()[1].getContent()[0].destroyItems();this.participantsF4MultiselectFragment.getContent()[0].getPages()[1].getContent()[0].bindItems("PartnersBasedOnType>/"+p[I]["PartnerFunctionName"],this.contactListItemTemplate1,null,[]);var P=this.participantsF4MultiselectFragment.getContent()[0].getPages()[1].getContent()[0].getItems();var m=this.participantsF4MultiselectFragment.getModel("PartnersBasedOnType").getProperty("/"+p[I]["PartnerFunctionName"]);var E;if(this.participantsF4MultiselectFragment.getModel("SelectedPartnerCategory")){var h=b.getProperty("/"+p[I]["PartnerFunctionName"]);if(h)for(var i=0;i<P.length;i++){for(var k=0;k<h.length;k++){if(h[k]["key"]===P[i].getDescription()){P[i].setSelected(true)}}}}if(this.participantsF4MultiselectFragment.getModel("SelectedPartnerCategoryDeletedTemp")){var j=this.participantsF4MultiselectFragment.getModel("SelectedPartnerCategoryDeletedTemp").getProperty("/"+p[I]["PartnerFunctionName"]);if(j)for(var i=0;i<P.length;i++){for(var k=0;k<j.length;k++){if(j[k].getDescription()===P[i].getDescription()){P[i].setSelected(false)}}}}if(this.participantsF4MultiselectFragment.getModel("SelectedPartnerCategoryTemp")){var j=this.participantsF4MultiselectFragment.getModel("SelectedPartnerCategoryTemp").getProperty("/"+p[I]["PartnerFunctionName"]);if(j)for(var i=0;i<P.length;i++){for(var k=0;k<j.length;k++){if(j[k]["key"]===P[i].getDescription()){P[i].setSelected(true)}}}}if(this.participantsF4MultiselectFragment.getModel("SelectedPartnerCategoryTemp1")){var j=this.participantsF4MultiselectFragment.getModel("SelectedPartnerCategoryTemp1").getProperty("/"+p[I]["PartnerFunctionName"]);if(j)for(var i=0;i<P.length;i++){for(var k=0;k<j.length;k++){if(j[k]["key"]===P[i].getDescription()){P[i].setSelected(true)}}}}if(this.participantsF4MultiselectFragment.getModel("SelectedPartnerCategoryTemp2")){var j=this.participantsF4MultiselectFragment.getModel("SelectedPartnerCategoryTemp2").getProperty("/"+p[I]["PartnerFunctionName"]);if(j)for(var i=0;i<P.length;i++){for(var k=0;k<j.length;k++){if(j[k]["key"]===P[i].getDescription()){P[i].setSelected(true)}}}}break;default:var f,g;f=jQuery.proxy(function(C,D,r){var q=this.participantsF4MultiselectFragment.getModel("PartnersBasedOnType");q.setProperty("/"+C,D.results);for(var x=0;x<D.results.length;x++){if(D.results[x].fullName=="")D.results[x].fullName=" "}if(t&&this.sBackendVersion==4){this.participantsF4MultiselectFragment.getContent()[0].getPages()[1].getContent()[0].bindItems("PartnersBasedOnType>/"+C,this.accountListItemTemplate2,null,[])}else if(s.length>0&&this.participantsF4MultiselectFragment.getContent()[0].getPages()[1].getContent()[0].getInfoToolbar().getVisible()){this.participantsF4MultiselectFragment.getContent()[0].getPages()[1].getContent()[0].bindItems("PartnersBasedOnType>/"+C,this.accountListItemTemplate2,null,[])}else if(s.length>0){this.participantsF4MultiselectFragment.getContent()[0].getPages()[1].getContent()[0].bindItems("PartnersBasedOnType>/"+C,this.accountListItemTemplate1,null,[])}else{this.participantsF4MultiselectFragment.getContent()[0].getPages()[1].getContent()[0].bindItems("PartnersBasedOnType>/"+C,this.accountListItemTemplate1,null,[])}},this,p[I]["PartnerFunctionName"]);g=jQuery.proxy(function(q){},this);if(t&&this.sBackendVersion==4){this.participantsF4MultiselectFragment.getContent()[0].getPages()[1].getContent()[0].getInfoToolbar().getContent()[0].setText("Filtered By Account ID :"+this.accountName);this.participantsF4MultiselectFragment.getContent()[0].getPages()[1].getContent()[0].getInfoToolbar().setVisible(true);this.oModel.read("AccountCollection('"+this.accountId+"')/Relationships?$filter=relationshipCategory eq '"+p[I].RelationshipCategory+"' ",null,null,false,f,g)}else if(s.length>0&&this.sBackendVersion==4&&this.participantsF4MultiselectFragment.getContent()[0].getPages()[1].getContent()[0].getInfoToolbar().getVisible()){this.participantsF4MultiselectFragment.getContent()[0].getPages()[1].getContent()[0].getInfoToolbar().setVisible(true);this.oModel.read("AccountCollection('"+this.accountId+"')/Relationships?$filter=relationshipCategory eq '"+p[I].RelationshipCategory+"'and substringof('"+s+"',account2FullName) ",null,null,false,f,g)}else if(s.length>0){this.participantsF4MultiselectFragment.getContent()[0].getPages()[1].getContent()[0].getInfoToolbar().setVisible(false);this.oModel.read("/AccountCollection",null,'$top=200&$filter=substringof(%27'+encodeURIComponent(s)+'%27,fullName)',false,f,g)}else{this.participantsF4MultiselectFragment.getContent()[0].getPages()[1].getContent()[0].getInfoToolbar().setVisible(false);this.oModel.read("/AccountCollection",null,null,false,f,g)}this.participantsF4MultiselectFragment.getContent()[0].getPages()[1].getContent()[0].destroyItems();if(t){this.participantsF4MultiselectFragment.getContent()[0].getPages()[1].getContent()[0].bindItems("PartnersBasedOnType>/"+p[I]["PartnerFunctionName"],this.accountListItemTemplate2,null,[])}else if(s.length>0&&this.participantsF4MultiselectFragment.getContent()[0].getPages()[1].getContent()[0].getInfoToolbar().getVisible()){this.participantsF4MultiselectFragment.getContent()[0].getPages()[1].getContent()[0].bindItems("PartnersBasedOnType>/"+p[I]["PartnerFunctionName"],this.accountListItemTemplate2,null,[])}else if(s.length>0){this.participantsF4MultiselectFragment.getContent()[0].getPages()[1].getContent()[0].bindItems("PartnersBasedOnType>/"+p[I]["PartnerFunctionName"],this.accountListItemTemplate1,null,[])}else{this.participantsF4MultiselectFragment.getContent()[0].getPages()[1].getContent()[0].bindItems("PartnersBasedOnType>/"+p[I]["PartnerFunctionName"],this.accountListItemTemplate1,null,[])}var P=this.participantsF4MultiselectFragment.getContent()[0].getPages()[1].getContent()[0].getItems();var m=this.participantsF4MultiselectFragment.getModel("PartnersBasedOnType").getProperty("/"+p[I]["PartnerFunctionName"]);var E;if(this.participantsF4MultiselectFragment.getModel("SelectedPartnerCategory")){var h=b.getProperty("/"+p[I]["PartnerFunctionName"]);if(h)for(var i=0;i<P.length;i++){for(var k=0;k<h.length;k++){if(h[k]["key"]===P[i].getDescription()){P[i].setSelected(true)}}}}if(this.participantsF4MultiselectFragment.getModel("SelectedPartnerCategoryDeletedTemp")){var j=this.participantsF4MultiselectFragment.getModel("SelectedPartnerCategoryDeletedTemp").getProperty("/"+p[I]["PartnerFunctionName"]);if(j)for(var i=0;i<P.length;i++){for(var k=0;k<j.length;k++){if(j[k].getDescription()===P[i].getDescription()){P[i].setSelected(false)}}}}if(this.participantsF4MultiselectFragment.getModel("SelectedPartnerCategoryTemp")){var j=this.participantsF4MultiselectFragment.getModel("SelectedPartnerCategoryTemp").getProperty("/"+p[I]["PartnerFunctionName"]);if(j)for(var i=0;i<P.length;i++){for(var k=0;k<j.length;k++){if(j[k]["key"]===P[i].getDescription()){P[i].setSelected(true)}}}}if(this.participantsF4MultiselectFragment.getModel("SelectedPartnerCategoryTemp1")){var j=this.participantsF4MultiselectFragment.getModel("SelectedPartnerCategoryTemp1").getProperty("/"+p[I]["PartnerFunctionName"]);if(j)for(var i=0;i<P.length;i++){for(var k=0;k<j.length;k++){if(j[k]["key"]===P[i].getDescription()){P[i].setSelected(true)}}}}if(this.participantsF4MultiselectFragment.getModel("SelectedPartnerCategoryTemp2")){var j=this.participantsF4MultiselectFragment.getModel("SelectedPartnerCategoryTemp2").getProperty("/"+p[I]["PartnerFunctionName"]);if(j)for(var i=0;i<P.length;i++){for(var k=0;k<j.length;k++){if(j[k]["key"]===P[i].getDescription()){P[i].setSelected(true)}}}}break}}this.participantsF4MultiselectFragment.getContent()[0].getPages()[1].setTitle(this.oResourceBundle.getText('PARTNERS')+" "+p[I]["PartnerFunctionName"]);n._sSelectedPartnerCategory=p[I]["PartnerFunctionName"];n.to(this.participantsF4MultiselectFragment.getContent()[0].getPages()[1])},onSelectParticipantMinMax:function(e){var d=true;var c=this.participantsF4MultiselectFragment.getContent()[0].getPages()[0].getContent()[0].getSelectedItem().getBindingContext('json').getObject().PartnerFunctionCode;var a=this.participantsF4MultiselectFragment.getContent()[0].getPages()[0].getContent()[0].getSelectedItem().getBindingContext('json').getObject().PartnerFunctionName;if(this.participantsF4MultiselectFragment.getModel("SelectedPartnerCategoryTemp"))if(this.participantsF4MultiselectFragment.getModel("SelectedPartnerCategoryTemp").getProperty("/"+a))if(!e.getParameters().selected){var i=e.getParameters().listItem.getDescription();var b=this.participantsF4MultiselectFragment.getModel("SelectedPartnerCategoryTemp").getProperty("/"+a);if(b){for(var k=0;k<b.length;k++){if(b[k].key==i){this.participantsF4MultiselectFragment.getModel("SelectedPartnerCategoryTemp").getProperty("/"+a).splice(k,1);d=false}}}}if(!this.participantsF4MultiselectFragment.getModel("SelectedPartnerCategoryDeletedTemp")){this.participantsF4MultiselectFragment.setModel(new sap.ui.model.json.JSONModel(),"SelectedPartnerCategoryDeletedTemp")}if(this.participantsF4MultiselectFragment.getModel("SelectedPartnerCategory"))if(d)if(!e.getParameters().selected){var i=e.getParameters().listItem.getDescription();var b=this.participantsF4MultiselectFragment.getModel("SelectedPartnerCategoryDeletedTemp").getProperty("/"+a);if(this.participantsF4MultiselectFragment.getModel("SelectedPartnerCategoryDeletedTemp").getProperty("/"+a)){this.participantsF4MultiselectFragment.getModel("SelectedPartnerCategoryDeletedTemp").getProperty("/"+a).push(e.getParameters().listItem)}else{var l=[e.getParameters().listItem];this.participantsF4MultiselectFragment.getModel("SelectedPartnerCategoryDeletedTemp").setProperty("/"+a,l)}}var s=this.participantsF4MultiselectFragment.getContent()[0].getPages()[0].getContent()[0];var f=s.indexOfItem(s.getSelectedItem());var g=this.participantsF4MultiselectFragment.getModel('json').getData().PartnerFunctions[f];var P=g.PartnerFunctionCode;var C=g.CountHigh;var h=g.CountLow;var n=0;if(this.participantsF4MultiselectFragment.getModel("SelectedPartnerCategoryTemp")){if(this.participantsF4MultiselectFragment.getModel("SelectedPartnerCategoryTemp").getProperty("/"+a)){n=this.participantsF4MultiselectFragment.getModel("SelectedPartnerCategoryTemp").getProperty("/"+a).length}else{n=0}}else{n=0}var j=0;if(this.participantsF4MultiselectFragment.getModel("SelectedPartnerCategory")){if(this.participantsF4MultiselectFragment.getModel("SelectedPartnerCategory").getProperty("/"+a))j=this.participantsF4MultiselectFragment.getModel("SelectedPartnerCategory").getProperty("/"+a).length}else{j=0}var m=0;if(this.participantsF4MultiselectFragment.getModel("SelectedPartnerCategoryDeletedTemp"))if(this.participantsF4MultiselectFragment.getModel("SelectedPartnerCategoryDeletedTemp").getProperty("/"+a))m=this.participantsF4MultiselectFragment.getModel("SelectedPartnerCategoryDeletedTemp").getProperty("/"+a).length;if(n+j-m>=C){if(e){e.getParameters().listItem.setSelected(false)}if(C===1){sap.m.MessageToast.show(this.oResourceBundle.getText('TOO_MANY_PARTICIPANTS_1',[C]),{duration:3500})}else{sap.m.MessageToast.show(this.oResourceBundle.getText('TOO_MANY_PARTICIPANTS',[C]),{duration:3500})}return}else{if(e.getParameters().selected){if(!this.participantsF4MultiselectFragment.getModel("SelectedPartnerCategoryTemp")){this.participantsF4MultiselectFragment.setModel(new sap.ui.model.json.JSONModel(),"SelectedPartnerCategoryTemp")}var o=e.getParameters().listItem.getDescription();var p=e.getParameters().listItem.getTitle();var E=[];E.push({key:o,value:p});if(this.participantsF4MultiselectFragment.getModel("SelectedPartnerCategoryTemp").getProperty("/"+a)){this.participantsF4MultiselectFragment.getModel("SelectedPartnerCategoryTemp").getProperty("/"+a).push(E[0])}else{this.participantsF4MultiselectFragment.getModel("SelectedPartnerCategoryTemp").setProperty("/"+a,E)}}}},_setAccount:function(a){var b=this.getView().byId("customer");if(b)b.setValue(a)},onAccountSuggestItemSelected:function(e){var i=e.getParameter("selectedItem");var a=null;a=i.data('oAccount');this.byId('customer').setValue(a.fullName);this.accountName=(a.fullName==="")?a.accountID:a.fullName;this.accountId=a.accountID;this.enableSaveBtn()},onAccountInputFieldChanged:function(e){this.byId('customer').setValueState(sap.ui.core.ValueState.None);var a=e.getSource();if(a.getValue()===""){this.accountId="";this.accountName=""}this._setAccount(a.getValue());if(a.getValue().length==0){this.enableSaveBtn();return}a.setShowSuggestion(true);a.setFilterSuggests(false);var c=function(A){a.removeAllSuggestionItems();if(a.getValue().length>0){for(var i=0 in A){var o=A[i];if(o.fullName.toUpperCase()==a.getValue().toUpperCase()){this._setAccount(o.fullName)}var C=new sap.ui.core.CustomData({key:"oAccount",value:o});var I=new sap.ui.core.Item({text:o.fullName,customData:C});if(o.fullName!=""){a.addSuggestionItem(I)}}}};this._readAccount(a.getValue(),c)},_readAccount:function(s,c){var t=this,m=this.getView().getModel();this.oModel.read("/AccountCollection",null,'$top=10&$filter=substringof(%27'+encodeURIComponent(s)+'%27,fullName,accountID)',true,function(d,r){var a=jQuery.parseJSON(JSON.stringify(d));if(c)c.call(t,a.results)},function(e){jQuery.sap.log.error("Read failed in S4->_readAccount:"+e.response.body)})},_setContact:function(c){var a=this.getView().byId("inputMainContact");if(a)a.setValue(c)},onContactSuggestItemSelected:function(e){var I=e.getParameter("selectedItem");var c=null;for(var i in I.getCustomData()){var C=I.getCustomData()[i];if(C.getKey()=="oContact")c=C.getValue()}this.byId('inputMainContact').setValue(c.fullName);this.contactName=c.fullName;this.contactId=c.contactID},onContactInputFieldChanged:function(e){this.byId('inputMainContact').setValueState(sap.ui.core.ValueState.None);var c=e.getSource();this._setContact(c.getValue());c.setShowSuggestion(true);c.setFilterSuggests(false);var C=function(a){c.removeAllSuggestionItems();if(c.getValue().length>0){for(var i=0 in a){var o=a[i];if(o.fullName.toUpperCase()==c.getValue().toUpperCase()){this._setContact(o.fullName)}var b=new sap.ui.core.CustomData({key:"oContact",value:o});var I=new sap.ui.core.Item({text:o.fullName,customData:b});c.addSuggestionItem(I)}}};this._readContact(c.getValue(),C)},_readContact:function(s,c){var t=this,m=this.getView().getModel();this.oModel.read("/ContactCollection",null,'$top=10&$filter=substringof(%27'+encodeURIComponent(s)+'%27,fullName)',true,function(d,r){var a=jQuery.parseJSON(JSON.stringify(d));if(c)c.call(t,a.results)},function(e){jQuery.sap.log.error("Read failed in S4->_readContact:"+e.response.body)})},_setEmployee:function(e){var a=this.getView().byId("inputEmpResponsible_S5");if(a)a.setValue(e)},onEmployeeSuggestItemSelected:function(e){var I=e.getParameter("selectedItem");var o=null;for(var i in I.getCustomData()){var c=I.getCustomData()[i];if(c.getKey()=="oemployee")o=c.getValue()}this.byId('inputEmpResponsible_S5').setValue(o.fullName);this.employeeName=o.fullName;this.oSelectedEmployee.employeeID=o.employeeID},onEmployeeInputFieldChanged:function(e){this.byId('inputEmpResponsible_S5').setValueState(sap.ui.core.ValueState.None);var a=e.getSource();this._setEmployee(a.getValue());a.setShowSuggestion(true);a.setFilterSuggests(false);var c=function(E){a.removeAllSuggestionItems();if(a.getValue().length>0){for(var i=0 in E){var o=E[i];if(o.fullName.toUpperCase()==a.getValue().toUpperCase()){this._setEmployee(o.fullName)}var C=new sap.ui.core.CustomData({key:"oemployee",value:o});var I=new sap.ui.core.Item({text:o.fullName,customData:C});a.addSuggestionItem(I)}}};this._reademployee(a.getValue(),c)},_reademployee:function(s,c){var t=this,m=this.getView().getModel();this.oModel.read("/EmployeeCollection",null,'$top=10&$filter=substringof(%27'+encodeURIComponent(s)+'%27,fullName)',true,function(d,r){var e=jQuery.parseJSON(JSON.stringify(d));if(c)c.call(t,e.results)},function(e){jQuery.sap.log.error("Read failed in S4->_reademployee:"+e.response.body)})},_setCurrency:function(c){var a=this.getView().byId("currency");if(a)a.setValue(c)},onCurrencySuggestItemSelected:function(e){var I=e.getParameter("selectedItem");var c=null;for(var i in I.getCustomData()){var C=I.getCustomData()[i];if(C.getKey()=="oCurrency")c=C.getValue()}this.byId('currency').attachBrowserEvent("keydown",jQuery.proxy(function(e){if(e.keyCode===13){this.byId('currency').setValue(c.CurrencyKey);this.CurrencyKey=c.CurrencyKey}},this))},onCurrencyInputFieldChanged:function(e){this.byId('currency').setValueState(sap.ui.core.ValueState.None);var c=e.getSource()},liveSearchAccount:function(e){var v=e.getParameter("value"),f=[];if(v.length==0||(v&&v.length>3)){var i=e.getParameter("itemsBinding");var a=cus.crm.opportunity.util.schema._getEntityAnnotation(this.oModel,'service-schema-version','Account');f.push(new sap.ui.model.Filter(((a===null)?"name1":"fullName"),sap.ui.model.FilterOperator.Contains,v));if(i){i.aApplicationFilters=[];i.filter(f)}}},liveSearchContact:function(e){var t=e.getParameters().newValue;var s=this.contactF4Fragment.getSubHeader().getContentLeft()[0];if(t.length===0||t.length>3){s.fireSearch({query:t})}},liveSearchEmployee:function(e){var t=e.getParameters().newValue;var s=this.employeeF4Fragment.getSubHeader().getContentLeft()[0];if(t.length===0||t.length>3){s.fireSearch({query:t})}},liveSearchCurrency:function(e){var v=e.getParameter("value");if(v.length==0||(v&&v.length>3)){var f=new sap.ui.model.Filter([new sap.ui.model.Filter("CurrencyText",sap.ui.model.FilterOperator.Contains,v)],false);e.getParameter("itemsBinding").filter([f])}}});
