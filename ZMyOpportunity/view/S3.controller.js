/*
 * Copyright (C) 2009-2014 SAP SE or an SAP affiliate company. All rights reserved
 */
jQuery.sap.require("sap.ca.ui.quickoverview.EmployeeLaunch");jQuery.sap.require("sap.ca.ui.quickoverview.CompanyLaunch");jQuery.sap.require("sap.m.MessageBox");jQuery.sap.require("sap.ca.ui.model.type.FileSize");jQuery.sap.require("cus.crm.opportunity.util.schema");jQuery.sap.require("cus.crm.opportunity.util.Formatter");jQuery.sap.require("sap.ca.scfld.md.controller.BaseDetailController");jQuery.sap.require("cus.crm.opportunity.util.Util");sap.ca.scfld.md.controller.BaseDetailController.extend("cus.crm.opportunity.view.S3",{SalesStages:[],Priorities:[],UserStatuses:[],Currencies:[],ContactCollection:[],EmployeeCollection:[],prospect_number:"",response:[],opportunity_number:"",bAppLaunched:true,guid:undefined,partnerFunctionMap:{},mPartnerImgSrc:{},partnerDeterminationMap:{},oPartnerFunctionsTemplate:new sap.m.StandardListItem({title:"{json>PartnerFunctionName}",key:"{json>PartnerFunctionCategory}"}),accountListItemTemplate2:new sap.m.StandardListItem({title:'{PartnersBasedOnType>account2FullName}',description:'{PartnersBasedOnType>account2ID}'}),accountListItemTemplate:new sap.m.ObjectListItem({title:'{json>name1}'}).addAttribute(new sap.m.ObjectAttribute({text:'{json>accountID}'})).addCustomData(new sap.ui.core.CustomData({key:'ID',value:'{json>accountID}'})),contactListItemTemplate:new sap.m.ObjectListItem({title:'{json>fullName}'}).addAttribute(new sap.m.ObjectAttribute({text:'{json>contactID}'})).addCustomData(new sap.ui.core.CustomData({key:'ID',value:'{json>contactID}'})),employeeListItemTemplate:new sap.m.ObjectListItem({title:'{json>fullName}'}).addAttribute(new sap.m.ObjectAttribute({text:'{json>employeeID}'})).addCustomData(new sap.ui.core.CustomData({key:'ID',value:'{json>employeeID}'})),accountListItemTemplate1:new sap.m.StandardListItem({title:'{PartnersBasedOnType>fullName}',description:'{PartnersBasedOnType>accountID}'}),contactListItemTemplate1:new sap.m.StandardListItem({title:'{PartnersBasedOnType>fullName}',description:'{PartnersBasedOnType>contactID}'}),employeeListItemTemplate1:new sap.m.StandardListItem({title:'{PartnersBasedOnType>fullName}',description:'{PartnersBasedOnType>employeeID}'}),onInit:function(){this.fullScreenMode=false;sap.ca.scfld.md.controller.BaseDetailController.prototype.onInit.call(this);this.oModel=this.getView().getModel();this.oI18nModel=sap.ca.scfld.md.app.Application.getImpl().AppI18nModel;this.oResourceBundle=this.oI18nModel.getResourceBundle();this.sProspectNumber="";this.sProspectImageSrc="";jQuery.sap.includeStyleSheet(jQuery.sap.getModulePath("cus.crm.opportunity.css.Opportunity",".css"),"sap-ui-theme-sap.crm");this.contactF4Fragment=new sap.ui.xmlfragment(this.createId("contact_F4_S3"),'cus.crm.opportunity.view.ContactF4',this);this.changeLogFragment=new sap.ui.xmlfragment(this.createId("change_Log_S3"),'cus.crm.opportunity.view.ChangeLog',this);this.changeLogFragment.setModel(new sap.ui.model.json.JSONModel());this.changeLogFragment.setModel(this.oI18nModel,'i18n');this.showErrorMsgFragment=new sap.ui.xmlfragment(this.createId("show_Error_Msg_Fragment"),'cus.crm.opportunity.view.ShowErrorMsg',this);this.showErrorMsgFragment.setModel(new sap.ui.model.json.JSONModel());this.showErrorMsgFragment.setModel(this.oI18nModel,'i18n');this.showErrorMsgFragment.getContent()[0].setModel(new sap.ui.model.json.JSONModel(),"json");this.byId('Sales_Team').addCustomData(new sap.ui.core.CustomData({key:'controller',value:this}));this.getView().setModel(new sap.ui.model.json.JSONModel(),"json");this.oRouter.attachRouteMatched(this.detailRouteMatched,this);var t=this;this.oHeaderFooterOptions={};this.oHeaderFooterOptions3UI={oEditBtn:{sI18nBtnTxt:"EDIT",onBtnPressed:function(e){t.onEdit()},bEnabled:true,},buttonList:[],oJamOptions:{oShareSettings:{object:{id:"",share:""}},fGetShareSettings:function(){var d=t.byId('info').getModel('json').getData().Description;var a=document.URL;return{object:{id:a,share:"Opportunity:"+d,display:t._getShareDisplay(),}}},oDiscussSettings:{object:{id:"",share:""}},fGetDiscussSettings:function(){var o=t.byId('info').getModel('json').getData().Id;var a=document.URL;return{oDataServiceUrl:"/sap/opu/odata/sap/SM_INTEGRATION_SRV/",feedType:"object",object:{id:t._getDiscussID(),type:t._getDiscussType(),name:"OpportunityID:"+o,ui_url:a},}},},};this.oHeaderFooterOptions4UI={oEditBtn:{sI18nBtnTxt:"EDIT",onBtnPressed:function(e){t.onEdit()},bEnabled:true,},buttonList:[{sI18nBtnTxt:"FOLLOW_UP",visible:false,onBtnPressed:function(e){t.handleOpen(e)},}],oJamOptions:{oShareSettings:{object:{id:"",share:""}},fGetShareSettings:function(){var d=t.byId('info').getModel('json').getData().Description;var a=document.URL;return{object:{id:a,share:"Opportunity:"+d,display:t._getShareDisplay(),}}},oDiscussSettings:{object:{id:"",share:""}},fGetDiscussSettings:function(){var o=t.byId('info').getModel('json').getData().Id;var a=document.URL;return{oDataServiceUrl:"/sap/opu/odata/sap/SM_INTEGRATION_SRV/",feedType:"object",object:{id:t._getDiscussID(),type:t._getDiscussType(),name:"OpportunityID:"+o,ui_url:a},}},},};this.sBackendVersion=cus.crm.opportunity.util.schema._getServiceSchemaVersion(this.oModel,"Opportunity");this.oVersioningModel=new sap.ui.model.json.JSONModel({});if(parseFloat(this.sBackendVersion)<4){this.byId('tab_transactionHistory').setVisible(false);this.byId('opportunityTotalNetValue_Label').setVisible(false);this.byId('opportunityTotalNetValue_Text').setVisible(false)}this._loadVersionSpecificUI(this.sBackendVersion);var f=this.byId('fileupload');var u=this.getView().getModel().sUrlParams;if(f.getUploadEnabled()){f.setXsrfToken(this.getXsrfToken());f.setEncodeUrl("/sap/bc/ui2/encode_file"+(u?'?'+u:''))}this.mPartnerImgSrc[""]="sap-icon://person-placeholder";if(this.extHookHideAccountImage){this.bHideImage=this.extHookHideAccountImage()}},getXsrfToken:function(){var t=this.getView().getModel().getHeaders()['x-csrf-token'];if(!t){this.getView().getModel().refreshSecurityToken(function(e,o){t=o.headers['x-csrf-token']},function(){sap.ca.ui.message.showMessageBox({type:sap.ca.ui.message.Type.ERROR,message:'Could not get XSRF token',details:''})},false)}return t},_getBackFunction:function(){if(this.fullScreenMode)return function(){window.history.back(1)};else return undefined},onBeforeRendering:function(){this.getView().getModel("controllers").getData().s3Controller=this},_loadVersionSpecificUI:function(b){if(parseFloat(b)>=4){this.byId("tab_salesarea").setVisible(true)}else{this.byId("tab_salesarea").setVisible(false)}if(parseFloat(b)>=2){this._loadWave4UI();if(!this.fullScreenMode)this.oHeaderFooterOptions=this.oHeaderFooterOptions4UI;else this.oHeaderFooterOptions=this.oHeaderFooterOptions4UI}else{this._loadWave3UI();this.oHeaderFooterOptions=this.oHeaderFooterOptions3UI}if(parseFloat(b)>=4){this.oHeaderFooterOptions.buttonList.push({sI18nBtnTxt:"ERROR_MESSAGE",sId:"errorMsg",onBtnPressed:jQuery.proxy(this.onErrorMsg,this),bEnabled:false,})}},_loadWave3UI:function(){this.oVersioningModel.getData().sParticipantsNoDataTextKey='NO_CONTACTS';this.oVersioningModel.getData().setHeaderTextForParticipants=jQuery.proxy(function(r){},this);this.byId('salesTeam').insertContent(new sap.m.Button({text:"{i18n>ADDCONTACT}",icon:"sap-icon://add",press:jQuery.proxy(this.addContact,this),type:"Transparent",}),0)},_loadWave4UI:function(){this.oVersioningModel.getData().sParticipantsNoDataTextKey='NO_PARTICIPANTS1';this.oVersioningModel.getData().setHeaderTextForParticipants=jQuery.proxy(function(r){this.byId('Sales_Team').getHeaderToolbar().getContent()[0].setText(this.oResourceBundle.getText('PARTICIPANTS',[r.data.SalesTeam.results.length]))},this);this.byId('opportunityHeader').addAggregation("attributes",new sap.m.ObjectAttribute({text:"{json>/EmployeeResponsibleName}",active:true,press:jQuery.proxy(this.onEmpBusCardLaunch,this),customData:[new sap.ui.core.CustomData({key:"PartnerNumber",value:"{json>/EmployeeResponsibleNumber}"}),new sap.ui.core.CustomData({key:"PartnerFunctionCode",value:"00000014"}),new sap.ui.core.CustomData({key:"Image",value:"{json>/ContactImgSrc}"}),new sap.ui.core.CustomData({key:"Imager",value:"{json>/ImgSrc}"}),]}));this.byId('Sales_Team').setHeaderToolbar(new sap.m.Toolbar({content:[new sap.m.Label(),new sap.m.ToolbarSpacer(),new sap.m.Button({text:"",icon:"sap-icon://add",type:"Transparent",press:jQuery.proxy(this.showParticipantsF4,this)})]}))},handleOpen:function(e){this.appointmentFlag=false;this.oppFlag=false;this.taskFlag=false;var t=this;this._actionSheet=new sap.m.ActionSheet({showCancelButton:true,placement:sap.m.PlacementType.Top,buttons:[new sap.m.Button({text:this.getView().getModel("i18n").getProperty("CREATE_APPOINTMENT"),press:function(a){t.navToAppointmentDialog(a)},}),new sap.m.Button({text:this.getView().getModel("i18n").getProperty("CREATE_TASK"),press:function(a){t.navToTaskDialog(a)},}),new sap.m.Button({text:this.getView().getModel("i18n").getProperty("CREATE_OPPORTUNITY"),press:function(a){t.navToOpptDialog(a)},}),]});if(this.extHookHandleOpen){this.extHookHandleOpen(e)}this._actionSheet.openBy(e.getSource())},navToAppointmentDialog:function(e){var m=this.getView().getModel();var h=this.oModel.getContext("/"+this.sPath).getObject();var g=this.byId('info').getModel('json').getData().Guid;var t=this.byId('info').getModel('json').getData().ProcessType;var d;m.read("AppFollowupTransTypes?Guid='"+g+"'&TransactionType='"+t+"'",null,null,false,function(D,r){d={ProcessTypes:r.data.results}});this.appointmentFlag=true;if(d.ProcessTypes.length==0){sap.ca.ui.message.showMessageBox({type:sap.ca.ui.message.Type.ERROR,message:sap.ca.scfld.md.app.Application.getImpl().getResourceBundle().getText('followupfailure')})}else if(d.ProcessTypes.length==1){this.onlyOneAppointmentProcessType=true;this.processType=d.ProcessTypes[0].ProcessTypeCode;this.processTypeDesc=d.ProcessTypes[0].Description;this.privateFlag=d.ProcessTypes[0].PrivateFlag;this.selectProcess()}else{this.oActionSheet=sap.ui.xmlfragment("cus.crm.opportunity.view.ProcessTypeDialog",this);this.oActionSheet.setModel(this.getView().getModel("i18n"),"i18n");var j=new sap.ui.model.json.JSONModel();j.setData(d);this.oActionSheet.setModel(j,"json");this.oActionSheet._searchField.setPlaceholder(sap.ca.scfld.md.app.Application.getImpl().getResourceBundle().getText("SEARCH"));this.oActionSheet._list.setGrowingScrollToLoad(true);this.oActionSheet._dialog.setVerticalScrolling(true);this.oActionSheet.open()}},searchProcess:function(e){var v=e.getParameter("value");if(v!==undefined){e.getParameter("itemsBinding").filter([new sap.ui.model.Filter("Description",sap.ui.model.FilterOperator.Contains,v)])}},navToOpptDialog:function(e){var m=this.getView().getModel();var g=this.byId('info').getModel('json').getData().Guid;var t=this.byId('info').getModel('json').getData().ProcessType;var d=null;m.read("OpptFollowupTransTypes?Guid=guid'"+g+"'&TransactionType='"+t+"'",null,null,false,function(D,r){d={ProcessTypes:r.data.results}});this.oppFlag=true;if(d.ProcessTypes.length==0){sap.ca.ui.message.showMessageBox({type:sap.ca.ui.message.Type.ERROR,message:sap.ca.scfld.md.app.Application.getImpl().getResourceBundle().getText('followupfailure')})}else if(d.ProcessTypes.length==1){this.onlyOneProcessType=true;this.processType=d.ProcessTypes[0].ProcessTypeCode;this.processTypeDesc=d.ProcessTypes[0].Description;this.selectProcess()}else{this.oActionSheet=sap.ui.xmlfragment("cus.crm.opportunity.view.ProcessTypeDialog",this);this.oActionSheet.setModel(this.getView().getModel("i18n"),"i18n");var j=new sap.ui.model.json.JSONModel();j.setData(d);this.oActionSheet.setModel(j,"json");this.oActionSheet._searchField.setPlaceholder(sap.ca.scfld.md.app.Application.getImpl().getResourceBundle().getText("SEARCH"));this.oActionSheet._list.setGrowingScrollToLoad(true);this.oActionSheet._dialog.setVerticalScrolling(true);this.oActionSheet.open()}},navToTaskDialog:function(e){var m=this.getView().getModel();var g=this.byId('info').getModel('json').getData().Guid;var t=this.byId('info').getModel('json').getData().ProcessType;var d;m.read("TaskFollowupTransTypes?Guid='"+g+"'&TransactionType='"+t+"'",null,null,false,function(D,r){d={ProcessTypes:r.data.results}});this.taskFlag=true;if(d.ProcessTypes.length==0){sap.ca.ui.message.showMessageBox({type:sap.ca.ui.message.Type.ERROR,message:sap.ca.scfld.md.app.Application.getImpl().getResourceBundle().getText('followupfailure')})}else if(d.ProcessTypes.length==1){this.onlyOneTaskProcessType=true;this.processType=d.ProcessTypes[0].ProcessTypeCode;this.processTypeDesc=d.ProcessTypes[0].Description;this.selectProcess()}else{this.oActionSheet=sap.ui.xmlfragment("cus.crm.opportunity.view.ProcessTypeDialog",this);this.oActionSheet.setModel(this.getView().getModel("i18n"),"i18n");var j=new sap.ui.model.json.JSONModel();j.setData(d);this.oActionSheet.setModel(j,"json");this.oActionSheet._searchField.setPlaceholder(sap.ca.scfld.md.app.Application.getImpl().getResourceBundle().getText("SEARCH"));this.oActionSheet._list.setGrowingScrollToLoad(true);this.oActionSheet._dialog.setVerticalScrolling(true);this.oActionSheet.open()}},selectProcess:function(e){var h=this.byId('info').getModel('json').getData().Guid;var p="/Opportunities(guid'"+h+"')";var o=this.byId('info').getModel('json').getData().Id;var s=this.byId('info').getModel('json').getData().UserStatusText;var S=this.byId('info').getModel('json').getData().StartDate;var A=this.byId('opportunityHeader').getModel('json').getData().ProspectNumber;var a=this.byId('opportunityHeader').getModel('json').getData().ProspectName;var C=this.byId('opportunityHeader').getModel('json').getData().MainContactId;var b=this.byId('opportunityHeader').getModel('json').getData().MainContactName;var t=this.byId('opportunityHeader').getModel('json').getData().Description;var c=this.byId('opportunityHeader').getModel('json').getData().Guid;var E=this.byId('opportunityHeader').getModel('json').getData().EmployeeResponsibleName;var d=this.byId('opportunityHeader').getModel('json').getData().EmployeeResponsibleNumber;if(!(this.onlyOneAppointmentProcessType||this.onlyOneTaskProcessType||this.onlyOneProcessType)){var f=e.getParameter("selectedItem");if(f){this.processType=f.data("ProcessTypeCode");this.processTypeDesc=f.data("ProcessTypeDescription");this.privateFlag=f.data("PrivateFlag")}}var g=sap.ushell&&sap.ushell.Container&&sap.ushell.Container.getService;this.oCrossAppNavigator=g&&g("CrossApplicationNavigation");if(this.oppFlag){var i=this.byId('info').getModel('json').getData().Guid;var r="createFollowup";if(this.fullScreenMode)r="fulScrOpptFollowup";this.oRouter.navTo(r,{contextPath:i,processType:this.processType,},!jQuery.device.is.phone);this.oppFlag=false}else if(this.appointmentFlag){var j=this.oCrossAppNavigator&&this.oCrossAppNavigator.hrefForExternal({target:{semanticObject:"Appointment",action:"myAppointments"},params:{"createFromOppt":"X","processType":this.processType,"selectprocess_oEvent":e,"opportunityId":o,"StartDate":S,"title":t,"prevGuid":c,"AccountID":A,"ContactID":C,"EmpID":d,}})||"";this.appointmentFlag=false;this.onlyOneAppointmentProcessType=false;window.location=j}else if(this.taskFlag){var j=this.oCrossAppNavigator&&this.oCrossAppNavigator.hrefForExternal({target:{semanticObject:"Task",action:"manageTasks"},params:{"createFromOppt":"X","AccountId":A,"ContactId":C,"processType":this.processType,"opportunityId":o,"title":t,"opportunityGuid":c,},appSpecificRoute:["&","newTask",this.processType].join("/")})||"";this.taskFlag=false;this.onlyOneTaskProcessType=false;window.location=j}},getS4Controller:function(){return this.getView().getModel('controllers').getData().s4Controller},setDefaultTabToInfo:function(){var t=this.byId('icntab');if(t&&t.getItems().length>0){if(t.getSelectedKey()!=="info")t.setSelectedKey("Info");t.setExpanded(true)}},isMainScreen:function(){return false},_getDiscussID:function(){var u=document.createElement('a');u.href=this.getView().getModel().sServiceUrl;var h=this.byId('info').getModel('json').getData().Guid;var p="/Opportunities(guid'"+h+"')";return u.pathname+p},_getDiscussType:function(){var u=document.createElement('a');u.href=this.getView().getModel().sServiceUrl;return u.pathname+"/$metadata#Opportunities"},_getShareDisplay:function(){var d=this.byId('info').getModel('json').getData().Description;var v=this.byId('info').getModel('json').getData().ExpectedSalesVolume;var c=this.byId('info').getModel('json').getData().CurrencyCode;var p=this.byId('info').getModel('json').getData().ProspectName;var a=cus.crm.opportunity.util.Formatter.dateFormatter(this.byId('info').getModel('json').getData().ClosingDate);var u=this.byId('info').getModel('json').getData().UserStatusText;var o=new sap.m.ObjectListItem({title:d,number:v,numberUnit:c,attributes:[new sap.m.ObjectAttribute({text:p}),new sap.m.ObjectAttribute({text:a})],firstStatus:new sap.m.ObjectStatus({text:u}),});return o},getHeaderFooterOptions:function(){this.oHeaderFooterOptions.oAddBookmarkSettings={icon:"sap-icon://Fiori2/F0004"};if(this.oRouter._oRouter._prevMatchedRequest.indexOf('detailonly/')>-1&&sap.ui.core.routing.History.getInstance()._iHistoryPosition>0){this.oHeaderFooterOptions.onBack=jQuery.proxy(function(e){this._navBack()},this)}if(jQuery.device.is.phone&&!this.fullScreenMode)this.oHeaderFooterOptions.onBack=this._getBackFunction();else if(jQuery.device.is.phone&&this.fullScreenMode)this.oHeaderFooterOptions.onBack=this._getBackFunction();else if(!jQuery.device.is.phone&&this.fullScreenMode)this.oHeaderFooterOptions.onBack=this._getBackFunction();else this.oHeaderFooterOptions.onBack=null;this.extendHeaderFooterOptions(this.oHeaderFooterOptions);return this.oHeaderFooterOptions},extendHeaderFooterOptions:function(h){},navToSubview:function(){this.oRouter.navTo("subDetail",{contextPath:this.getView().getBindingContext().sPath.substr(1)},!jQuery.device.is.phone)},navToEmpty:function(){this.oRouter.navTo("noData",{viewTitle:"DETAIL_TITLE",languageKey:"NO_ITEMS_AVAILABLE"})},selectedTab:function(c){var m=this.getView().getModel();var t=c.getSource().getSelectedKey();if(this.byId('info').getModel('json'))var h=this.byId('info').getModel('json').getData().Guid;var p="/Opportunities(guid'"+h+"')";if(this.extHookSelectedTab){this.extHookSelectedTab(c)}var s=false;if(this.extHookSkipTab){s=this.extHookSkipTab(c)}if(t=="Notes"&&!s){this.notesTabSelected()}if(t=="Parties Involved"&&!s){this.participantsTabSelected()}if(t=="Competitors"&&!s){this.competitorsTabSelected()}if(t=="Attachments"&&!s){this.attachmentsTabSelected()}if(t=="TransactionHistory"&&!s){this.txHistoryTabSelected()}},navigateDocHistory:function(e){var t=e.getSource().getText();var O="";var g="";for(var i=0;i<this.newResult.length;i++){if(t==this.newResult[i].TransactionId){O=this.newResult[i].ObjectType;g=this.newResult[i].Guid;break}}var f=sap.ushell&&sap.ushell.Container&&sap.ushell.Container.getService;this.oCrossAppNavigator=f&&f("CrossApplicationNavigation");if(O==="BUS2000111"){var a=this.oCrossAppNavigator&&this.oCrossAppNavigator.hrefForExternal({target:{semanticObject:"Opportunity",action:"manageOpportunity&/display/Opportunities(guid'"+g+"')"}})||"";window.location=a}else if(O==="BUS2000125"){var a=this.oCrossAppNavigator&&this.oCrossAppNavigator.hrefForExternal({target:{semanticObject:"Task",action:"manageTasks&/taskOverview/Tasks(guid'"+g+"')"}})||"";window.location=a}else if(O==="BUS2000126"){var a=this.oCrossAppNavigator&&this.oCrossAppNavigator.hrefForExternal({target:{semanticObject:"Appointment",action:"myAppointments&/appointment/"+g}})||"";window.location=a}else if(O==="BUS2000108"){var a=this.oCrossAppNavigator&&this.oCrossAppNavigator.hrefForExternal({target:{semanticObject:"Lead",action:"manageLead&/display/Leads(guid'"+g+"')"}})||"";window.location=a}},_handleAddNote:function(e){var t=e.getParameter("value");if(t){var a=this;var m=this.getView().getModel();var h=this.byId('info').getModel('json').getData().Guid;var E={HeaderGuid:h,Content:t};m.create('/OpportunityNotesSet',E,null,jQuery.proxy(function(){var a=this;m.read(a.sPath,null,["$expand=Notes"],true,function(o,r){a.byId('listItem').setModel(new sap.ui.model.json.JSONModel({OpportunityNotesSet:o.Notes.results}),"json")})},this),function(M){a.displayResponseErrorMessage(M,sap.ca.scfld.md.app.Application.getImpl().getResourceBundle().getText('SAVE_FAILED'))})}},displayResponseErrorMessage:function(m,d){var M;if(m.response){M=jQuery.parseJSON(m.response.body).error.message.value}sap.m.MessageToast.show(M||d)},onFileUploadFailed:function(e){var r=e.getParameters().response.jqXHR.responseText;var j=JSON.parse(r);sap.ca.ui.message.showMessageBox({type:sap.ca.ui.message.Type.ERROR,message:j.error.message.value})},onUploadFile:function(r){var f;if(r.getParameters()&&r.getParameters().d)f=r.getParameters().d;else f=r.getParameters();var U;if(f.__metadata.media_src)U=f.__metadata.media_src;else U=f.url;var d=parseInt((f.CreatedAt).substr(6));var n=decodeURIComponent(f.Name);var o={"fileExtension":cus.crm.opportunity.util.Formatter.mimeTypeFormatter(f.MimeType),"contributor":f.CreatedBy,"uploadedDate":new Date(d),"name":n,"url":cus.crm.opportunity.util.Formatter.urlConverter(U),"size":f.fileSize,"fileId":f.DocumentId,"media_src":f.__metadata.media_src,};this.byId('fileupload').commitFileUpload(o)},changeToString:function(v){var s=v.split("%");var c=s[0];for(var i=1;i<s.length;i++){c+=String.fromCharCode(parseInt(s[i].substring(0,2),16))+s[i].substring(2)}return c},onEdit:function(){var c=this.byId('info').getModel('json').getData().Guid;var a="Opportunities(guid'"+c+"')";var t=this;var m=this.oModel;this.sBackendVersion=cus.crm.opportunity.util.schema._getServiceSchemaVersion(this.oModel,"Opportunity");if(parseFloat(this.sBackendVersion)>=3){m.read("EditAuthorizationCheck",null,{ObjectGuid:m.formatValue(c,"Edm.Guid")},false,function(d,r){if(r.data.EditAuthorizationCheck.ActionSuccessful=="X"){if(!t.fullScreenMode){t.oRouter.navTo("subDetail",{contextPath:a},!jQuery.device.is.phone)}else{t.oRouter.navTo("edit",{contextPath:a},!jQuery.device.is.phone)}}else{sap.ca.ui.message.showMessageBox({type:sap.ca.ui.message.Type.ERROR,message:r.data.EditAuthorizationCheck.Message,details:null})}},null)}else{if(!t.fullScreenMode){t.oRouter.navTo("subDetail",{contextPath:a},!jQuery.device.is.phone)}else{t.oRouter.navTo("edit",{contextPath:a},!jQuery.device.is.phone)}}},onLogChange:function(e){var m=this.getView().getModel();var d;var h=this.byId('info').getModel('json').getData().Guid;var p="/Opportunities(guid'"+h+"')";this.changeLogFragment.getContent()[0].setNoDataText(sap.ca.scfld.md.app.Application.getImpl().getResourceBundle().getText('LOG_CHANGE'));this.changeLogFragment.setModel(e.getSource().getModel("i18n"),"i18n");this.changeLogFragment.getModel().setData({OpportunitySalesTeamSet:[]});var t=this;m.read(p,null,["$expand=ChangeDocs"],true,function(o,r){d={OpportunityChangeDocs:r.data.ChangeDocs.results};t.changeLogFragment.getModel().setData(d);if(d.OpportunityChangeDocs.length==0){t.changeLogFragment.getContent()[0].setNoDataText(sap.ca.scfld.md.app.Application.getImpl().getResourceBundle().getText('NOLOGCHANGE'))}});this.changeLogFragment.open(e)},onCancelLogChange:function(e){this.changeLogFragment.close()},onEmpBusCardLaunch:function(e){if(e.getSource().data("PartnerNumber")!==''){var p="/EmployeeCollection('"+e.getSource().data("PartnerNumber")+"')";var u;if(!this.bHideImage){u="$expand=WorkAddress,Company,Photo"}else{u="$expand=WorkAddress,Company"}var s=e.getSource();var t=this;this.oModel.read(p,null,[u],true,function(o,r){jQuery.sap.log.info("oData employee response");var T=t.oResourceBundle.getText("EMPLOYEE");var E="";var a="";var b="";var c="";var C="";var d="";var f="";var P=" ";if(o.WorkAddress){E=o.WorkAddress.mobilePhone;a=o.WorkAddress.phone;b=o.WorkAddress.email;c=o.WorkAddress.department;C=o.WorkAddress.address}if(o.Company&&o.Company.name1){d=o.Company.name1}if(o.fullName&&o.fullName!==""){f=o.fullName}if(o.Photo&&o.Photo.__metadata){var m=cus.crm.opportunity.util.Formatter.formatPhotoUrl(o.Photo.__metadata.media_src);P=cus.crm.opportunity.util.Formatter.urlConverter(m)}var g={title:T,name:f,imgurl:P,department:c,contactmobile:E,contactphone:a,contactemail:b,contactemailsubj:"",companyname:d,companyaddress:C};var h=new sap.ca.ui.quickoverview.EmployeeLaunch(g);h.openBy(s)},function(E){jQuery.sap.log.error("oData request for employee failed")})}},onEmployeeLaunchheader:function(e){var c=e.getSource().data("PartnerNumber");var p="/AccountCollection('"+c+"')";var l="sap-icon://person-placeholder";var m=this.getView().getModel();if(!this.bHideImage){m.read(p,null,["$expand=Logo"],false,function(o,r){jQuery.sap.log.info("oData account response");if(o.Logo&&o.Logo.__metadata){var d=o.Logo.__metadata.media_src?o.Logo.__metadata.media_src:"sap-icon://person-placeholder";l=d.toString()}});var I=l}else{var I=" "}var M=this.getView().getModel();var a=this.byId('info').getModel('json').getData().ProspectNumber;var b=e.getSource();var P=e.getSource().data("PartnerFunctionCode");if(a&&c){this.AccountId=a;this.ContactId=c;var p="/ContactCollection(accountID='"+a+"',contactID='"+c+"')?$expand=WorkAddress,Account,Account/MainAddress,Account/MainContact,Account/MainContact/WorkAddress";var B=[];B.push(M.createBatchOperation(p,"GET"));M.addBatchReadOperations(B);M.submitBatch(jQuery.proxy(function(r){var d={Value:""};d.Value=r.__batchResponses[0].data;var C=jQuery.proxy(function(e){var n={};n.target={};n.target.semanticObject="ContactPerson";n.target.action="MyContacts&/display/ContactCollection(contactID='"+this.ContactId+"',accountID='"+this.AccountId+"')";this.navToOtherApp=false;return n},this);if(d.Value.Account){if(d.Value.Account.MainContact){if(d.Value.Account.MainContact.WorkAddress){if(d.Value.WorkAddress){if(d.Value.Account.MainAddress){var E={title:"Contact",name:d.Value.fullName,imgurl:I,department:d.Value.department,contactmobile:d.Value.WorkAddress.mobilePhone,contactphone:d.Value.WorkAddress.phone,contactemail:d.Value.WorkAddress.email,contactemailsubj:"App Genrated Mail",companyname:d.Value.Account.name1,companyaddress:d.Value.Account.MainAddress.address,beforeExtNav:C,companycard:{title:"Account",imgurl:I,companyphone:d.Value.Account.MainAddress.phone,maincontactname:d.Value.Account.MainContact.fullName,maincontactmobile:d.Value.Account.MainContact.WorkAddress.mobilePhone,maincontactphone:d.Value.Account.MainContact.WorkAddress.phone,maincontactemail:d.Value.Account.MainContact.WorkAddress.email,maincontactemailsubj:"Automatic Mail for Maincontact",}};var o=new sap.ca.ui.quickoverview.EmployeeLaunch(E);o.openBy(b)}else{var E={title:"Contact",name:d.Value.fullName,imgurl:I,department:d.Value.department,contactmobile:d.Value.WorkAddress.mobilePhone,contactphone:d.Value.WorkAddress.phone,contactemail:d.Value.WorkAddress.email,contactemailsubj:"App Genrated Mail",companyname:d.Value.Account.name1,beforeExtNav:C,companycard:{title:"Account",imgurl:"sap-icon://person-placeholder",maincontactname:d.Value.Account.MainContact.fullName,maincontactmobile:d.Value.Account.MainContact.WorkAddress.mobilePhone,maincontactphone:d.Value.Account.MainContact.WorkAddress.phone,maincontactemail:d.Value.Account.MainContact.WorkAddress.email,maincontactemailsubj:"Automatic Mail for Maincontact",}};var o=new sap.ca.ui.quickoverview.EmployeeLaunch(E);o.openBy(e.getSource())}}else{if(d.Value.Account.MainAddress){var E={title:"Contact",name:d.Value.fullName,imgurl:I,department:d.Value.department,contactemailsubj:"App Genrated Mail",companyname:d.Value.Account.name1,companyaddress:d.Value.Account.MainAddress.address,beforeExtNav:C,companycard:{title:"Account",imgurl:"sap-icon://person-placeholder",companyphone:d.Value.Account.MainAddress.phone,maincontactname:d.Value.Account.MainContact.fullName,maincontactmobile:d.Value.Account.MainContact.WorkAddress.mobilePhone,maincontactphone:d.Value.Account.MainContact.WorkAddress.phone,maincontactemail:d.Value.Account.MainContact.WorkAddress.email,maincontactemailsubj:"Automatic Mail for Maincontact",}};var o=new sap.ca.ui.quickoverview.EmployeeLaunch(E);o.openBy(b)}else{var E={title:"Contact",name:d.Value.fullName,imgurl:I,department:d.Value.department,contactemailsubj:"App Genrated Mail",companyname:d.Value.Account.name1,beforeExtNav:C,companycard:{title:"Account",imgurl:"sap-icon://person-placeholder",maincontactname:d.Value.Account.MainContact.fullName,maincontactmobile:d.Value.Account.MainContact.WorkAddress.mobilePhone,maincontactphone:d.Value.Account.MainContact.WorkAddress.phone,maincontactemail:d.Value.Account.MainContact.WorkAddress.email,maincontactemailsubj:"Automatic Mail for Maincontact",}};var o=new sap.ca.ui.quickoverview.EmployeeLaunch(E);o.openBy(b)}}}else{if(d.Value.WorkAddress){if(d.Value.Account.MainAddress){var E={title:"Contact",name:d.Value.fullName,imgurl:I,department:d.Value.department,contactmobile:d.Value.WorkAddress.mobilePhone,contactphone:d.Value.WorkAddress.phone,contactemail:d.Value.WorkAddress.email,contactemailsubj:"App Genrated Mail",companyname:d.Value.Account.name1,companyaddress:d.Value.Account.MainAddress.address,beforeExtNav:C,companycard:{title:"Account",imgurl:"sap-icon://person-placeholder",companyphone:d.Value.Account.MainAddress.phone,maincontactname:d.Value.Account.MainContact.fullName,maincontactemailsubj:"Automatic Mail for Maincontact",}};var o=new sap.ca.ui.quickoverview.EmployeeLaunch(E);o.openBy(b)}else{var E={title:"Contact",name:d.Value.fullName,imgurl:I,department:d.Value.department,contactmobile:d.Value.WorkAddress.mobilePhone,contactphone:d.Value.WorkAddress.phone,contactemail:d.Value.WorkAddress.email,contactemailsubj:"App Genrated Mail",companyname:d.Value.Account.name1,beforeExtNav:C,companycard:{title:"Account",imgurl:"sap-icon://person-placeholder",maincontactname:d.Value.Account.MainContact.fullName,maincontactemailsubj:"Automatic Mail for Maincontact",}};var o=new sap.ca.ui.quickoverview.EmployeeLaunch(E);o.openBy(b)}}else{if(d.Value.Account.MainAddress){var E={title:"Contact",name:d.Value.fullName,imgurl:I,department:d.Value.department,contactemailsubj:"App Genrated Mail",companyname:d.Value.Account.name1,companyaddress:d.Value.Account.MainAddress.address,beforeExtNav:C,companycard:{title:"Account",imgurl:"sap-icon://person-placeholder",companyphone:d.Value.Account.MainAddress.phone,maincontactname:d.Value.Account.MainContact.fullName,maincontactemailsubj:"Automatic Mail for Maincontact",}};var o=new sap.ca.ui.quickoverview.EmployeeLaunch(E);o.openBy(b)}else{var E={title:"Contact",name:d.Value.fullName,imgurl:I,department:d.Value.department,contactemailsubj:"App Genrated Mail",companyname:d.Value.Account.name1,beforeExtNav:C,companycard:{title:"Account",imgurl:"sap-icon://person-placeholder",maincontactname:d.Value.Account.MainContact.fullName,maincontactemailsubj:"Automatic Mail for Maincontact",}};var o=new sap.ca.ui.quickoverview.EmployeeLaunch(E);o.openBy(b)}}}}else{if(d.Value.WorkAddress){if(d.Value.Account.MainAddress){var E={title:"Contact",name:d.Value.fullName,imgurl:I,department:d.Value.department,contactmobile:d.Value.WorkAddress.mobilePhone,contactphone:d.Value.WorkAddress.phone,contactemail:d.Value.WorkAddress.email,contactemailsubj:"App Genrated Mail",companyname:d.Value.Account.name1,companyaddress:d.Value.Account.MainAddress.address,beforeExtNav:C,companycard:{title:"Account",imgurl:"sap-icon://person-placeholder",companyphone:d.Value.Account.MainAddress.phone,}};var o=new sap.ca.ui.quickoverview.EmployeeLaunch(E);o.openBy(b)}else{var E={title:"Contact",name:d.Value.fullName,imgurl:I,department:d.Value.department,contactmobile:d.Value.WorkAddress.mobilePhone,contactphone:d.Value.WorkAddress.phone,contactemail:d.Value.WorkAddress.email,contactemailsubj:"App Genrated Mail",companyname:d.Value.Account.name1,beforeExtNav:C,companycard:{title:"Account",imgurl:"sap-icon://person-placeholder",}};var o=new sap.ca.ui.quickoverview.EmployeeLaunch(E);o.openBy(b)}}else{if(d.Value.Account.MainAddress){var E={title:"Contact",name:d.Value.fullName,imgurl:I,department:d.Value.department,contactemailsubj:"App Genrated Mail",companyname:d.Value.Account.name1,companyaddress:d.Value.Account.MainAddress.address,beforeExtNav:C,companycard:{title:"Account",imgurl:"sap-icon://person-placeholder",companyphone:d.Value.Account.MainAddress.phone,}};var o=new sap.ca.ui.quickoverview.EmployeeLaunch(E);o.openBy(b)}else{var E={title:"Contact",name:d.Value.fullName,imgurl:I,department:d.Value.department,contactemailsubj:"App Genrated Mail",companyname:d.Value.Account.name1,beforeExtNav:C,companycard:{title:"Account",imgurl:"sap-icon://person-placeholder",}};var o=new sap.ca.ui.quickoverview.EmployeeLaunch(E);o.openBy(b)}}}}else{sap.m.MessageToast.show(sap.ca.scfld.md.app.Application.getImpl().getResourceBundle().getText('NOT_IN_MAIN_CONTACT'))}},this),jQuery.proxy(function(E){sap.m.MessageToast.show(sap.ca.scfld.md.app.Application.getImpl().getResourceBundle().getText('NOT_IN_MAIN_CONTACT'))},this),true)}else{sap.m.MessageToast.show(sap.ca.scfld.md.app.Application.getImpl().getResourceBundle().getText('NOT_IN_MAIN_CONTACT'))}},onEmployeeLaunch:function(e){var m=this.getView().getModel();var a=this.byId('info').getModel('json').getData().ProspectNumber;var b=e.getSource();var c=e.getSource().data("PartnerNumber");var P=e.getSource().data("PartnerFunctionCode");var I;if(!this.bHideImage){var I=e.getSource().data("Image")}else var I=" ";if(P=="00000015"){var d;if(a&&c){this.AccountId=a;this.ContactId=c;var p="/ContactCollection(accountID='"+a+"',contactID='"+c+"')?$expand="+"WorkAddress,Account,Account/MainAddress,Account/MainContact,Account/MainContact/WorkAddress";var B=[];B.push(m.createBatchOperation(p,"GET"));m.addBatchReadOperations(B);m.submitBatch(jQuery.proxy(function(r){var d={Value:""};d.Value=r.__batchResponses[0].data;var C=jQuery.proxy(function(e){var n={};n.target={};n.target.semanticObject="ContactPerson";n.target.action="MyContacts&/display/ContactCollection(contactID='"+this.ContactId+"',accountID='"+this.AccountId+"')";this.navToOtherApp=true;this.oRouter.detachRouteMatched(this.detailRouteMatched,this);return n},this);if(d.Value.Account){if(d.Value.Account.MainContact){if(d.Value.Account.MainContact.WorkAddress){if(d.Value.WorkAddress){if(d.Value.Account.MainAddress){var E={title:"Contact",name:d.Value.fullName,imgurl:I,department:d.Value.department,contactmobile:d.Value.WorkAddress.mobilePhone,contactphone:d.Value.WorkAddress.phone,contactemail:d.Value.WorkAddress.email,contactemailsubj:"App Genrated Mail",companyname:d.Value.Account.name1,companyaddress:d.Value.Account.MainAddress.address,beforeExtNav:C,companycard:{title:"Account",imgurl:I,companyphone:d.Value.Account.MainAddress.phone,maincontactname:d.Value.Account.MainContact.fullName,maincontactmobile:d.Value.Account.MainContact.WorkAddress.mobilePhone,maincontactphone:d.Value.Account.MainContact.WorkAddress.phone,maincontactemail:d.Value.Account.MainContact.WorkAddress.email,maincontactemailsubj:"Automatic Mail for Maincontact",}};var o=new sap.ca.ui.quickoverview.EmployeeLaunch(E);o.openBy(b)}else{var E={title:"Contact",name:d.Value.fullName,imgurl:I,department:d.Value.department,contactmobile:d.Value.WorkAddress.mobilePhone,contactphone:d.Value.WorkAddress.phone,contactemail:d.Value.WorkAddress.email,contactemailsubj:"App Genrated Mail",companyname:d.Value.Account.name1,beforeExtNav:C,companycard:{title:"Account",imgurl:"sap-icon://person-placeholder",maincontactname:d.Value.Account.MainContact.fullName,maincontactmobile:d.Value.Account.MainContact.WorkAddress.mobilePhone,maincontactphone:d.Value.Account.MainContact.WorkAddress.phone,maincontactemail:d.Value.Account.MainContact.WorkAddress.email,maincontactemailsubj:"Automatic Mail for Maincontact",}};var o=new sap.ca.ui.quickoverview.EmployeeLaunch(E);o.openBy(e.getSource())}}else{if(d.Value.Account.MainAddress){var E={title:"Contact",name:d.Value.fullName,imgurl:I,department:d.Value.department,contactemailsubj:"App Genrated Mail",companyname:d.Value.Account.name1,companyaddress:d.Value.Account.MainAddress.address,beforeExtNav:C,companycard:{title:"Account",imgurl:"sap-icon://person-placeholder",companyphone:d.Value.Account.MainAddress.phone,maincontactname:d.Value.Account.MainContact.fullName,maincontactmobile:d.Value.Account.MainContact.WorkAddress.mobilePhone,maincontactphone:d.Value.Account.MainContact.WorkAddress.phone,maincontactemail:d.Value.Account.MainContact.WorkAddress.email,maincontactemailsubj:"Automatic Mail for Maincontact",}};var o=new sap.ca.ui.quickoverview.EmployeeLaunch(E);o.openBy(b)}else{var E={title:"Contact",name:d.Value.fullName,imgurl:I,department:d.Value.department,contactemailsubj:"App Genrated Mail",companyname:d.Value.Account.name1,beforeExtNav:C,companycard:{title:"Account",imgurl:"sap-icon://person-placeholder",maincontactname:d.Value.Account.MainContact.fullName,maincontactmobile:d.Value.Account.MainContact.WorkAddress.mobilePhone,maincontactphone:d.Value.Account.MainContact.WorkAddress.phone,maincontactemail:d.Value.Account.MainContact.WorkAddress.email,maincontactemailsubj:"Automatic Mail for Maincontact",}};var o=new sap.ca.ui.quickoverview.EmployeeLaunch(E);o.openBy(b)}}}else{if(d.Value.WorkAddress){if(d.Value.Account.MainAddress){var E={title:"Contact",name:d.Value.fullName,imgurl:I,department:d.Value.department,contactmobile:d.Value.WorkAddress.mobilePhone,contactphone:d.Value.WorkAddress.phone,contactemail:d.Value.WorkAddress.email,contactemailsubj:"App Genrated Mail",companyname:d.Value.Account.name1,companyaddress:d.Value.Account.MainAddress.address,beforeExtNav:C,companycard:{title:"Account",imgurl:"sap-icon://person-placeholder",companyphone:d.Value.Account.MainAddress.phone,maincontactname:d.Value.Account.MainContact.fullName,maincontactemailsubj:"Automatic Mail for Maincontact",}};var o=new sap.ca.ui.quickoverview.EmployeeLaunch(E);o.openBy(b)}else{var E={title:"Contact",name:d.Value.fullName,imgurl:I,department:d.Value.department,contactmobile:d.Value.WorkAddress.mobilePhone,contactphone:d.Value.WorkAddress.phone,contactemail:d.Value.WorkAddress.email,contactemailsubj:"App Genrated Mail",companyname:d.Value.Account.name1,beforeExtNav:C,companycard:{title:"Account",imgurl:"sap-icon://person-placeholder",maincontactname:d.Value.Account.MainContact.fullName,maincontactemailsubj:"Automatic Mail for Maincontact",}};var o=new sap.ca.ui.quickoverview.EmployeeLaunch(E);o.openBy(b)}}else{if(d.Value.Account.MainAddress){var E={title:"Contact",name:d.Value.fullName,imgurl:I,department:d.Value.department,contactemailsubj:"App Genrated Mail",companyname:d.Value.Account.name1,companyaddress:d.Value.Account.MainAddress.address,beforeExtNav:C,companycard:{title:"Account",imgurl:"sap-icon://person-placeholder",companyphone:d.Value.Account.MainAddress.phone,maincontactname:d.Value.Account.MainContact.fullName,maincontactemailsubj:"Automatic Mail for Maincontact",}};var o=new sap.ca.ui.quickoverview.EmployeeLaunch(E);o.openBy(b)}else{var E={title:"Contact",name:d.Value.fullName,imgurl:I,department:d.Value.department,contactemailsubj:"App Genrated Mail",companyname:d.Value.Account.name1,beforeExtNav:C,companycard:{title:"Account",imgurl:"sap-icon://person-placeholder",maincontactname:d.Value.Account.MainContact.fullName,maincontactemailsubj:"Automatic Mail for Maincontact",}};var o=new sap.ca.ui.quickoverview.EmployeeLaunch(E);o.openBy(b)}}}}else{if(d.Value.WorkAddress){if(d.Value.Account.MainAddress){var E={title:"Contact",name:d.Value.fullName,imgurl:I,department:d.Value.department,contactmobile:d.Value.WorkAddress.mobilePhone,contactphone:d.Value.WorkAddress.phone,contactemail:d.Value.WorkAddress.email,contactemailsubj:"App Genrated Mail",companyname:d.Value.Account.name1,companyaddress:d.Value.Account.MainAddress.address,beforeExtNav:C,companycard:{title:"Account",imgurl:"sap-icon://person-placeholder",companyphone:d.Value.Account.MainAddress.phone,}};var o=new sap.ca.ui.quickoverview.EmployeeLaunch(E);o.openBy(b)}else{var E={title:"Contact",name:d.Value.fullName,imgurl:I,department:d.Value.department,contactmobile:d.Value.WorkAddress.mobilePhone,contactphone:d.Value.WorkAddress.phone,contactemail:d.Value.WorkAddress.email,contactemailsubj:"App Genrated Mail",companyname:d.Value.Account.name1,beforeExtNav:C,companycard:{title:"Account",imgurl:"sap-icon://person-placeholder",}};var o=new sap.ca.ui.quickoverview.EmployeeLaunch(E);o.openBy(b)}}else{if(d.Value.Account.MainAddress){var E={title:"Contact",name:d.Value.fullName,imgurl:I,department:d.Value.department,contactemailsubj:"App Genrated Mail",companyname:d.Value.Account.name1,companyaddress:d.Value.Account.MainAddress.address,beforeExtNav:C,companycard:{title:"Account",imgurl:"sap-icon://person-placeholder",companyphone:d.Value.Account.MainAddress.phone,}};var o=new sap.ca.ui.quickoverview.EmployeeLaunch(E);o.openBy(b)}else{var E={title:"Contact",name:d.Value.fullName,imgurl:I,department:d.Value.department,contactemailsubj:"App Genrated Mail",companyname:d.Value.Account.name1,beforeExtNav:C,companycard:{title:"Account",imgurl:"sap-icon://person-placeholder",}};var o=new sap.ca.ui.quickoverview.EmployeeLaunch(E);o.openBy(b)}}}}else{sap.m.MessageToast.show(sap.ca.scfld.md.app.Application.getImpl().getResourceBundle().getText('NOT_IN_MAIN_CONTACT'))}},this),jQuery.proxy(function(E){sap.m.MessageToast.show(sap.ca.scfld.md.app.Application.getImpl().getResourceBundle().getText('NOT_IN_MAIN_CONTACT'))},this),true)}else{sap.m.MessageToast.show(sap.ca.scfld.md.app.Application.getImpl().getResourceBundle().getText('NOT_IN_MAIN_CONTACT'))}}else if(P=="00000021"){this.accountNum=a;if(a){var p="AccountCollection(accountID='"+a+"')?$expand=MainAddress,MainContact/WorkAddress,MainContact";var B=[];var t=this;B.push(m.createBatchOperation(p,"GET"));m.addBatchReadOperations(B);m.submitBatch(jQuery.proxy(function(r){var M={Value:""};M.Value=r.__batchResponses[0].data;var C=jQuery.proxy(function(e){var n={};n.target={};n.target.semanticObject="Account";n.target.action="MyAccounts&/detail/AccountCollection('"+this.accountNum+"')";this.navToOtherApp=true;this.oRouter.detachRouteMatched(this.detailRouteMatched,this);return n},this);if(M.Value.MainContact){if(M.Value.MainContact.WorkAddress){if(M.Value.MainAddress){var o={title:"Account",imgurl:I,companyname:M.Value.name1,companyphone:M.Value.MainAddress.phone,companyaddress:M.Value.MainAddress.address,maincontactname:M.Value.MainContact.fullName,maincontactmobile:M.Value.MainContact.WorkAddress.mobilePhone,maincontactphone:M.Value.MainContact.WorkAddress.phone,maincontactemail:M.Value.MainContact.WorkAddress.email,maincontactemailsubj:"Automatic Mail for Maincontact",beforeExtNav:C,};var f=new sap.ca.ui.quickoverview.CompanyLaunch(o);f.openBy(b)}else{var o={title:"Account",imgurl:I,companyname:M.Value.name1,maincontactname:M.Value.MainContact.fullName,maincontactmobile:M.Value.MainContact.WorkAddress.mobilePhone,maincontactphone:M.Value.MainContact.WorkAddress.phone,maincontactemail:M.Value.MainContact.WorkAddress.email,maincontactemailsubj:"Automatic Mail for Maincontact",beforeExtNav:C,};var f=new sap.ca.ui.quickoverview.CompanyLaunch(o);f.openBy(b)}}else{if(M.Value.MainAddress){var o={title:"Account",imgurl:I,companyname:M.Value.name1,companyphone:M.Value.MainAddress.phone,companyaddress:M.Value.MainAddress.address,maincontactname:M.Value.MainContact.fullName,beforeExtNav:C,};var f=new sap.ca.ui.quickoverview.CompanyLaunch(o);f.openBy(b)}else{var o={title:"Account",imgurl:I,companyname:M.Value.name1,maincontactname:M.Value.MainContact.fullName,beforeExtNav:C,};var f=new sap.ca.ui.quickoverview.CompanyLaunch(o);f.openBy(b)}}}else{if(M.Value.MainAddress){var o={title:"Account",imgurl:I,companyname:M.Value.name1,companyphone:M.Value.MainAddress.phone,companyaddress:M.Value.MainAddress.address,beforeExtNav:C,};var f=new sap.ca.ui.quickoverview.CompanyLaunch(o);f.openBy(b)}else{var o={title:"Account",imgurl:I,companyname:M.Value.name1,beforeExtNav:C,};var f=new sap.ca.ui.quickoverview.CompanyLaunch(o);f.openBy(b)}}},this),jQuery.proxy(function(E){sap.m.MessageToast.show(sap.ca.scfld.md.app.Application.getImpl().getResourceBundle().getText('ERROR'))},this),true)}else{sap.m.MessageToast.show(sap.ca.scfld.md.app.Application.getImpl().getResourceBundle().getText('ACCOUNT_IS_NULL'))}}else{sap.m.MessageToast.show(sap.ca.scfld.md.app.Application.getImpl().getResourceBundle().getText('NOT_CONTACT_OR_ACCOUNT'))}},onAttachmentSelected:function(e){var s=e.getParameter('listItem').getBindingContext().getObject();var w=window.open(s.__metadata.media_src,'_blank');w.focus()},getRuleForPartnerFunction:function(p){for(var i=0;i<this.partnerDeterminationMap[this.transactionType].length;i++){if(this.partnerDeterminationMap[this.transactionType][i].PartnerFunctionCode===p){return this.partnerDeterminationMap[this.transactionType][i]}}return null},getCountForPartnerFunction:function(p){var c=0;var a=this.byId('Sales_Team').getModel('json').getData().OpportunitySalesTeamSet;for(var i=0;i<a.length;i++){if(a[i].PartnerFunctionCode===p){c++}}return c},enableAddParticipantsButton:function(){var p=this.participantsF4Fragment.getContent()[2];if(p.getSelectedItems().length>0){this.participantsF4Fragment.getBeginButton().setEnabled(true)}else{this.participantsF4Fragment.getBeginButton().setEnabled(false)}},searchParticipants:function(){var s=this.participantsF4Fragment.getContent()[0];this.participantsF4Fragment.getBeginButton().setEnabled(false);s.fireChange({selectedItem:s.getSelectedItem()})},onPartnerFunctionChange:function(e){if(!this.participantsF4MultiselectFragment){this.participantsF4MultiselectFragment=new sap.ui.xmlfragment(this.createId("participantsF4Multiselect_S5"),'cus.crm.opportunity.view.ParticipantsF4Multiselect',this);this.participantsF4MultiselectFragment.setModel(new sap.ui.model.json.JSONModel({}),"json");this.participantsF4MultiselectFragment.setModel(this.oI18nModel,'i18n')}if(e.getSource().getBindingContext('json')){this.participantsF4MultiselectFragment.getContent()[0].getPages()[1].getContent()[0].setMode("SingleSelectLeft")}var p=this.participantsF4MultiselectFragment.getModel("json").getProperty("/PartnerFunctions"),n=this.participantsF4MultiselectFragment.getContent()[0];if(!p)p=this.partnerDeterminationMap[this.transactionType];var a=false;var I;var b=false;if(this.participantsF4MultiselectFragment.getModel("SelectedPartnerCategoryTemp1")){this.participantsF4MultiselectFragment.getModel("SelectedPartnerCategoryTemp1").destroy()}if(this.participantsF4MultiselectFragment.getModel("SelectedPartnerCategoryTemp2")){this.participantsF4MultiselectFragment.getModel("SelectedPartnerCategoryTemp2").destroy()}var s="",d;if(e.getSource().getId().substring(e.getSource().getId().length-11)=="searchField"){var s=e.getParameter("query");if(s=="")s=" ";if(this.iIndexStatus){I=this.IndexValue}else{o=this.selectedBuffer.getBindingContext("json")}d=true;if(!this.participantsF4MultiselectFragment.getModel("SelectedPartnerCategoryTemp1")){this.participantsF4MultiselectFragment.setModel(new sap.ui.model.json.JSONModel(),"SelectedPartnerCategoryTemp1")}var S=this.participantsF4MultiselectFragment.getModel("SelectedPartnerCategoryTemp1");var l=this.participantsF4MultiselectFragment.getContent()[0].getPages()[1].getContent()[0],E=[];for(var i=0;i<l.getSelectedItems().length;i++){E.push({key:l.getSelectedItems()[i].getDescription(),value:l.getSelectedItems()[i].getTitle()})}S.setProperty("/"+this.PartnerName,E)}var t,o;if(e.getSource().getId().substring(e.getSource().getId().length-7)=="XButton"){this.participantsF4MultiselectFragment.getContent()[0].getPages()[1].getSubHeader().getContentLeft()[0].clear();if(!this.participantsF4MultiselectFragment.getModel("SelectedPartnerCategoryTemp2")){this.participantsF4MultiselectFragment.setModel(new sap.ui.model.json.JSONModel(),"SelectedPartnerCategoryTemp2")}var S=this.participantsF4MultiselectFragment.getModel("SelectedPartnerCategoryTemp2");var l=this.participantsF4MultiselectFragment.getContent()[0].getPages()[1].getContent()[0],E=[];for(var i=0;i<l.getSelectedItems().length;i++){E.push({key:l.getSelectedItems()[i].getDescription(),value:l.getSelectedItems()[i].getTitle()})}S.setProperty("/"+this.PartnerName,E);this.participantsF4MultiselectFragment.getContent()[0].getPages()[1].getContent()[0].getInfoToolbar().setVisible(false);t=false;if(this.iIndexStatus){I=this.IndexValue}else{o=this.selectedBuffer.getBindingContext("json")}}else if(d){}else if(this.participantsF4MultiselectFragment.getContent()[0].getPages()[1].getContent()[0].getMode()=="SingleSelectLeft"){this.participantsF4MultiselectFragment.getContent()[0].getPages()[1].getSubHeader().getContentLeft()[0].clear();if(e.getSource().getBindingContext('json')){var c=e.getSource().getBindingContext('json').getObject();this.oCurrentPartnerBuffer=c;this.itemToDelete=c}else{c=this.oCurrentPartnerBuffer;a=true}if(!this.participantsF4MultiselectFragment.getModel("PartnersBasedOnType")){this.participantsF4MultiselectFragment.setModel(new sap.ui.model.json.JSONModel(),"PartnersBasedOnType")}var f=this.partnerDeterminationMap[this.transactionType];var g;var h;for(var k=0;k<f.length;k++){if(f[k].PartnerFunctionCode==c.PartnerFunctionCode){g=f[k].PartnerFunctionCategory;h=f[k].PartnerFunctionName}}for(var k=0;k<p.length;k++){if(g==p[k].PartnerFunctionCategory){I=k;this.IndexValue=k;this.iIndexStatus=true}t=true}}else{this.participantsF4MultiselectFragment.getContent()[0].getPages()[1].getSubHeader().getContentLeft()[0].clear();this.participantsF4MultiselectFragment.getContent()[0].getPages()[1].getContent()[0].getInfoToolbar().setVisible(true);var j=e.getParameter("listItem");this.selectedBuffer=j;o=j.getBindingContext("json");t=true}this.accountId=this.byId('info').getModel('json').getData().ProspectNumber;this.accountName=this.byId('opportunityHeader').getModel('json').getData().ProspectName;var m=this.participantsF4MultiselectFragment.getModel("SelectedPartnerCategory");var q=this.participantsF4MultiselectFragment.getModel("SelectedPartnerCategoryTemp");if(!this.participantsF4MultiselectFragment.getModel("PartnersBasedOnType")){this.participantsF4MultiselectFragment.setModel(new sap.ui.model.json.JSONModel(),"PartnersBasedOnType")}if(!this.iIndexStatus)I=p.indexOf(o.getObject());this.PartnerName=p[I]["PartnerFunctionName"];switch(p[I]["PartnerFunctionCategory"]){case"0005":case"0008":var r,u;r=jQuery.proxy(function(C,D,R){var B=this.participantsF4MultiselectFragment.getModel("PartnersBasedOnType");B.setProperty("/"+C,D.results);for(var x=0;x<D.results.length;x++){if(D.results[x].fullName=="")D.results[x].fullName=" "}this.participantsF4MultiselectFragment.getContent()[0].getPages()[1].getContent()[0].bindItems("PartnersBasedOnType>/"+C,this.employeeListItemTemplate1,null,[])},this,p[I]["PartnerFunctionName"]);u=jQuery.proxy(function(x){},this);if(t){this.participantsF4MultiselectFragment.getContent()[0].getPages()[1].getContent()[0].getInfoToolbar().setVisible(true);this.participantsF4MultiselectFragment.getContent()[0].getPages()[1].getContent()[0].getInfoToolbar().getContent()[0].setText("Filtered By Account ID :"+this.accountName);this.oModel.read("/AccountCollection(accountID='"+this.accountId+"')/EmployeeResponsibles",null,null,false,r,u)}else if(this.participantsF4MultiselectFragment.getContent()[0].getPages()[1].getContent()[0].getInfoToolbar().getVisible()&&s){this.participantsF4MultiselectFragment.getContent()[0].getPages()[1].getContent()[0].getInfoToolbar().getContent()[0].setText("Filtered By Account ID :"+this.accountName);this.oModel.read("/AccountCollection(accountID='"+this.accountId+"')/EmployeeResponsibles",null,'$top=200&$filter=substringof(%27'+encodeURIComponent(s)+'%27,fullName)',false,r,u)}else if(s.length>0){this.participantsF4MultiselectFragment.getContent()[0].getPages()[1].getContent()[0].getInfoToolbar().setVisible(false);this.oModel.read("/EmployeeCollection",null,'$top=200&$filter=substringof(%27'+encodeURIComponent(s)+'%27,fullName)',false,r,u)}else{this.participantsF4MultiselectFragment.getContent()[0].getPages()[1].getContent()[0].getInfoToolbar().setVisible(false);this.oModel.read("/EmployeeCollection",null,null,false,r,u)}if(this.participantsF4MultiselectFragment.getContent()[0].getPages()[1].getContent()[0].getMode()=="SingleSelectLeft"){this.participantsF4MultiselectFragment.getContent()[0].getPages()[1].setShowNavButton(false);this.participantsF4MultiselectFragment.getContent()[0].getPages()[1].getFooter().getContentRight()[0].setEnabled(false);var P=this.participantsF4MultiselectFragment.getContent()[0].getPages()[1].getContent()[0].getItems();var v=this.oCurrentPartnerBuffer.PartnerNumber;for(var w=0;w<P.length;w++){if(P[w].getDescription()==v){P[w].setSelected(true)}}}else{this.participantsF4MultiselectFragment.getContent()[0].getPages()[1].getContent()[0].destroyItems();this.participantsF4MultiselectFragment.getContent()[0].getPages()[1].getContent()[0].bindItems("PartnersBasedOnType>/"+p[I]["PartnerFunctionName"],this.employeeListItemTemplate1,null,[]);var P=this.participantsF4MultiselectFragment.getContent()[0].getPages()[1].getContent()[0].getItems();var y=this.participantsF4MultiselectFragment.getModel("PartnersBasedOnType").getProperty("/"+p[I]["PartnerFunctionName"]);var E;if(this.participantsF4MultiselectFragment.getModel("SelectedPartnerCategory")){var z=m.getProperty("/"+p[I]["PartnerFunctionName"]);if(z)for(var i=0;i<P.length;i++){for(var k=0;k<z.length;k++){if(z[k]["key"]===P[i].getDescription()){P[i].setSelected(true)}}}}if(this.participantsF4MultiselectFragment.getModel("SelectedPartnerCategoryTemp")){var A=this.participantsF4MultiselectFragment.getModel("SelectedPartnerCategoryTemp").getProperty("/"+p[I]["PartnerFunctionName"]);if(A)for(var i=0;i<P.length;i++){for(var k=0;k<A.length;k++){if(A[k]["key"]===P[i].getDescription()){P[i].setSelected(true)}}}}if(this.participantsF4MultiselectFragment.getModel("SelectedPartnerCategoryTemp1")){var A=this.participantsF4MultiselectFragment.getModel("SelectedPartnerCategoryTemp1").getProperty("/"+p[I]["PartnerFunctionName"]);if(A)for(var i=0;i<P.length;i++){for(var k=0;k<A.length;k++){if(A[k]["key"]===P[i].getDescription()){P[i].setSelected(true)}}}}if(this.participantsF4MultiselectFragment.getModel("SelectedPartnerCategoryTemp2")){var A=this.participantsF4MultiselectFragment.getModel("SelectedPartnerCategoryTemp2").getProperty("/"+p[I]["PartnerFunctionName"]);if(A)for(var i=0;i<P.length;i++){for(var k=0;k<A.length;k++){if(A[k]["key"]===P[i].getDescription()){P[i].setSelected(true)}}}}}break;case"0007":var r,u;r=jQuery.proxy(function(C,D,R){var B=this.participantsF4MultiselectFragment.getModel("PartnersBasedOnType");B.setProperty("/"+C,D.results);for(var x=0;x<D.results.length;x++){if(D.results[x].fullName=="")D.results[x].fullName=" "}this.participantsF4MultiselectFragment.getContent()[0].getPages()[1].getContent()[0].bindItems("PartnersBasedOnType>/"+C,this.contactListItemTemplate1,null,[])},this,p[I]["PartnerFunctionName"]);u=jQuery.proxy(function(x){},this);if(t){this.participantsF4MultiselectFragment.getContent()[0].getPages()[1].getContent()[0].getInfoToolbar().setVisible(true);this.participantsF4MultiselectFragment.getContent()[0].getPages()[1].getContent()[0].getInfoToolbar().getContent()[0].setText("Filtered By Account ID :"+this.accountName);this.oModel.read("AccountCollection('"+this.accountId+"')/Contacts",null,null,false,r,u)}else if(this.participantsF4MultiselectFragment.getContent()[0].getPages()[1].getContent()[0].getInfoToolbar().getVisible()&&s){this.participantsF4MultiselectFragment.getContent()[0].getPages()[1].getContent()[0].getInfoToolbar().getContent()[0].setText("Filtered By Account ID :"+this.accountName);this.oModel.read("AccountCollection('"+this.accountId+"')/Contacts",null,'$top=200&$filter=substringof(%27'+encodeURIComponent(s)+'%27,fullName)',false,r,u)}else if(s.length>0){this.participantsF4MultiselectFragment.getContent()[0].getPages()[1].getContent()[0].getInfoToolbar().setVisible(false);this.oModel.read("/ContactCollection",null,'$top=200&$filter=substringof(%27'+encodeURIComponent(s)+'%27,fullName)',false,r,u)}else{this.participantsF4MultiselectFragment.getContent()[0].getPages()[1].getContent()[0].getInfoToolbar().setVisible(false);this.oModel.read("/ContactCollection",null,null,false,r,u)}if(this.participantsF4MultiselectFragment.getContent()[0].getPages()[1].getContent()[0].getMode()=="SingleSelectLeft"){this.participantsF4MultiselectFragment.getContent()[0].getPages()[1].setShowNavButton(false);this.participantsF4MultiselectFragment.getContent()[0].getPages()[1].getFooter().getContentRight()[0].setEnabled(false);var P=this.participantsF4MultiselectFragment.getContent()[0].getPages()[1].getContent()[0].getItems();var v=this.oCurrentPartnerBuffer.PartnerNumber;for(var w=0;w<P.length;w++){if(P[w].getDescription()==v){P[w].setSelected(true)}}}else{this.participantsF4MultiselectFragment.getContent()[0].getPages()[1].getContent()[0].destroyItems();this.participantsF4MultiselectFragment.getContent()[0].getPages()[1].getContent()[0].bindItems("PartnersBasedOnType>/"+p[I]["PartnerFunctionName"],this.contactListItemTemplate1,null,[]);var P=this.participantsF4MultiselectFragment.getContent()[0].getPages()[1].getContent()[0].getItems();var y=this.participantsF4MultiselectFragment.getModel("PartnersBasedOnType").getProperty("/"+p[I]["PartnerFunctionName"]);var E;if(this.participantsF4MultiselectFragment.getModel("SelectedPartnerCategory")){var z=m.getProperty("/"+p[I]["PartnerFunctionName"]);if(z)for(var i=0;i<P.length;i++){for(var k=0;k<z.length;k++){if(z[k]["key"]===P[i].getDescription()){P[i].setSelected(true)}}}}if(this.participantsF4MultiselectFragment.getModel("SelectedPartnerCategoryTemp")){var A=this.participantsF4MultiselectFragment.getModel("SelectedPartnerCategoryTemp").getProperty("/"+p[I]["PartnerFunctionName"]);if(A)for(var i=0;i<P.length;i++){for(var k=0;k<A.length;k++){if(A[k]["key"]===P[i].getDescription()){P[i].setSelected(true)}}}}if(this.participantsF4MultiselectFragment.getModel("SelectedPartnerCategoryTemp1")){var A=this.participantsF4MultiselectFragment.getModel("SelectedPartnerCategoryTemp1").getProperty("/"+p[I]["PartnerFunctionName"]);if(A)for(var i=0;i<P.length;i++){for(var k=0;k<A.length;k++){if(A[k]["key"]===P[i].getDescription()){P[i].setSelected(true)}}}}if(this.participantsF4MultiselectFragment.getModel("SelectedPartnerCategoryTemp2")){var A=this.participantsF4MultiselectFragment.getModel("SelectedPartnerCategoryTemp2").getProperty("/"+p[I]["PartnerFunctionName"]);if(A)for(var i=0;i<P.length;i++){for(var k=0;k<A.length;k++){if(A[k]["key"]===P[i].getDescription()){P[i].setSelected(true)}}}}}break;default:var r,u;r=jQuery.proxy(function(C,D,R){var B=this.participantsF4MultiselectFragment.getModel("PartnersBasedOnType");B.setProperty("/"+C,D.results);for(var x=0;x<D.results.length;x++){if(D.results[x].fullName=="")D.results[x].fullName=" "}if((t&&this.sBackendVersion==4)||((s.length>0&&this.participantsF4MultiselectFragment.getContent()[0].getPages()[1].getContent()[0].getInfoToolbar().getVisible())&&this.sBackendVersion==4)){this.participantsF4MultiselectFragment.getContent()[0].getPages()[1].getContent()[0].bindItems("PartnersBasedOnType>/"+C,this.accountListItemTemplate2,null,[])}else if(s.length>0){this.participantsF4MultiselectFragment.getContent()[0].getPages()[1].getContent()[0].bindItems("PartnersBasedOnType>/"+C,this.accountListItemTemplate1,null,[])}else{this.participantsF4MultiselectFragment.getContent()[0].getPages()[1].getContent()[0].bindItems("PartnersBasedOnType>/"+C,this.accountListItemTemplate1,null,[])}},this,p[I]["PartnerFunctionName"]);u=jQuery.proxy(function(x){},this);if(t&&this.sBackendVersion==4){this.participantsF4MultiselectFragment.getContent()[0].getPages()[1].getContent()[0].getInfoToolbar().getContent()[0].setText("Filtered By Account ID :"+this.accountName);this.participantsF4MultiselectFragment.getContent()[0].getPages()[1].getContent()[0].getInfoToolbar().setVisible(true);this.oModel.read("AccountCollection('"+this.accountId+"')/Relationships?$filter=relationshipCategory eq '"+p[I].RelationshipCategory+"' ",null,null,false,r,u)}else if(s.length>0&&this.sBackendVersion==4&&this.participantsF4MultiselectFragment.getContent()[0].getPages()[1].getContent()[0].getInfoToolbar().getVisible()){this.participantsF4MultiselectFragment.getContent()[0].getPages()[1].getContent()[0].getInfoToolbar().setVisible(true);this.oModel.read("AccountCollection('"+this.accountId+"')/Relationships?$filter=relationshipCategory eq '"+p[I].RelationshipCategory+"'and substringof('"+s+"',account2FullName) ",null,null,false,r,u)}else if(s.length>0){this.participantsF4MultiselectFragment.getContent()[0].getPages()[1].getContent()[0].getInfoToolbar().setVisible(false);this.oModel.read("/AccountCollection",null,'$top=200&$filter=substringof(%27'+encodeURIComponent(s)+'%27,fullName)',false,r,u)}else{this.participantsF4MultiselectFragment.getContent()[0].getPages()[1].getContent()[0].getInfoToolbar().setVisible(false);this.oModel.read("/AccountCollection",null,null,false,r,u)}if(this.participantsF4MultiselectFragment.getContent()[0].getPages()[1].getContent()[0].getMode()=="SingleSelectLeft"){this.participantsF4MultiselectFragment.getContent()[0].getPages()[1].setShowNavButton(false);this.participantsF4MultiselectFragment.getContent()[0].getPages()[1].getFooter().getContentRight()[0].setEnabled(false);var P=this.participantsF4MultiselectFragment.getContent()[0].getPages()[1].getContent()[0].getItems();var v=this.oCurrentPartnerBuffer.PartnerNumber;for(var w=0;w<P.length;w++){if(P[w].getDescription()==v){P[w].setSelected(true)}}}else{this.participantsF4MultiselectFragment.getContent()[0].getPages()[1].getContent()[0].destroyItems();if((t&&this.sBackendVersion==4)||(this.participantsF4MultiselectFragment.getContent()[0].getPages()[1].getContent()[0].getInfoToolbar().getVisible()&&this.sBackendVersion==4)){this.participantsF4MultiselectFragment.getContent()[0].getPages()[1].getContent()[0].bindItems("PartnersBasedOnType>/"+p[I]["PartnerFunctionName"],this.accountListItemTemplate2,null,[])}else if(s.length>0){this.participantsF4MultiselectFragment.getContent()[0].getPages()[1].getContent()[0].bindItems("PartnersBasedOnType>/"+p[I]["PartnerFunctionName"],this.accountListItemTemplate1,null,[])}else{this.participantsF4MultiselectFragment.getContent()[0].getPages()[1].getContent()[0].bindItems("PartnersBasedOnType>/"+p[I]["PartnerFunctionName"],this.accountListItemTemplate1,null,[])}var P=this.participantsF4MultiselectFragment.getContent()[0].getPages()[1].getContent()[0].getItems();var y=this.participantsF4MultiselectFragment.getModel("PartnersBasedOnType").getProperty("/"+p[I]["PartnerFunctionName"]);var E;if(this.participantsF4MultiselectFragment.getModel("SelectedPartnerCategory")){var z=m.getProperty("/"+p[I]["PartnerFunctionName"]);if(z)for(var i=0;i<P.length;i++){for(var k=0;k<z.length;k++){if(z[k]["key"]===P[i].getDescription()){P[i].setSelected(true)}}}}if(this.participantsF4MultiselectFragment.getModel("SelectedPartnerCategoryTemp")){var A=this.participantsF4MultiselectFragment.getModel("SelectedPartnerCategoryTemp").getProperty("/"+p[I]["PartnerFunctionName"]);if(A)for(var i=0;i<P.length;i++){for(var k=0;k<A.length;k++){if(A[k]["key"]===P[i].getDescription()){P[i].setSelected(true)}}}}if(this.participantsF4MultiselectFragment.getModel("SelectedPartnerCategoryTemp1")){var A=this.participantsF4MultiselectFragment.getModel("SelectedPartnerCategoryTemp1").getProperty("/"+p[I]["PartnerFunctionName"]);if(A)for(var i=0;i<P.length;i++){for(var k=0;k<A.length;k++){if(A[k]["key"]===P[i].getDescription()){P[i].setSelected(true)}}}}if(this.participantsF4MultiselectFragment.getModel("SelectedPartnerCategoryTemp2")){var A=this.participantsF4MultiselectFragment.getModel("SelectedPartnerCategoryTemp2").getProperty("/"+p[I]["PartnerFunctionName"]);if(A)for(var i=0;i<P.length;i++){for(var k=0;k<A.length;k++){if(A[k]["key"]===P[i].getDescription()){P[i].setSelected(true)}}}}}break}this.participantsF4MultiselectFragment.getContent()[0].getPages()[1].setTitle(this.oResourceBundle.getText('PARTNERS')+" "+p[I]["PartnerFunctionName"]);n._sSelectedPartnerCategory=p[I]["PartnerFunctionName"];n._sSelectedPartnerCategoryCode=p[I]["PartnerFunctionCategory"];n.to(this.participantsF4MultiselectFragment.getContent()[0].getPages()[1]);if(this.participantsF4MultiselectFragment.getContent()[0].getPages()[1].getContent()[0].getMode()=="SingleSelectLeft")this.participantsF4MultiselectFragment.open()},bindS3Header:function(d){var s=this.byId('opportunityHeader');var p="/AccountCollection('"+d.ProspectNumber+"')";var l="sap-icon://person-placeholder";var j=s.getModel("json");var D=j.oData;var t=this;if(!this.bHideImage){if(this.sProspectNumber!==d.ProspectNumber||!this.mPartnerImgSrc[this.sProspectNumber]){this.sProspectNumber=d.ProspectNumber;if(this.sProspectNumber!==""){this.oModel.read(p,null,["$expand=Logo"],false,function(o,r){jQuery.sap.log.info("oData account response");if(o.Logo&&o.Logo.__metadata){var m=o.Logo.__metadata.media_src?o.Logo.__metadata.media_src:"sap-icon://person-placeholder";l=m.toString()}},jQuery.proxy(this.handleErrors,this))}d.ImgSrc=l;this.mPartnerImgSrc[this.sProspectNumber]=l}else{d.ImgSrc=this.mPartnerImgSrc[this.sProspectNumber]}}else{d.ImgSrc=" "}if(s&&s.getModel('json')){s.getModel('json').setData(d)}delete d.Products;D=jQuery.extend(true,{},D,d);j.oData=D;j.updateBindings()},getParticipants:function(){var d;var l=[];var t=this;this.partnerFunctionMap={};this.byId("Sales_Team").setNoDataText(sap.ca.scfld.md.app.Application.getImpl().getResourceBundle().getText('LOADING_TEXT'));this.byId('Sales_Team').getModel('json').setData({OpportunitySalesTeamSet:[]});this.oModel.read(this.sPath,null,["$expand=SalesTeam,Competitors"],false,function(o,r){t.bindS3Header(r.data);var a=t.getView().byId("Sales_Team");var b=new sap.ui.model.json.JSONModel();d={OpportunitySalesTeamSet:r.data.SalesTeam.results};t.byId('Sales_Team').getHeaderToolbar().getContent()[0].setText(t.oResourceBundle.getText('PARTICIPANTS',[r.data.SalesTeam.results.length]));if(d.OpportunitySalesTeamSet.length==0){t.byId("Sales_Team").setNoDataText(sap.ca.scfld.md.app.Application.getImpl().getResourceBundle().getText('NO_CONTACTS'))}var B=[];var m={};var c=0;for(var i=0;i<d.OpportunitySalesTeamSet.length;i++){var e=d.OpportunitySalesTeamSet[i].PartnerNumber;var p="/AccountCollection('"+e+"')?$expand=Logo";l[i]="sap-icon://person-placeholder";if(!t.mPartnerImgSrc[e]&&e!==""){B.push(t.oModel.createBatchOperation(p,"GET"));m[c]=i;c++}else{d.OpportunitySalesTeamSet[i].ImgSrc=t.mPartnerImgSrc[e]}};t.oModel.addBatchReadOperations(B);t.oModel.submitBatch(jQuery.proxy(function(R){for(var j=0;j<c;j++){if(!R.__batchResponses[j].hasOwnProperty("data")){l[j]="sap-icon://person-placesholder"}else{if(R.__batchResponses[j].data&&R.__batchResponses[j].data.Logo&&R.__batchResponses[j].data.Logo.__metadata.media_src){var f=R.__batchResponses[j].data.Logo.__metadata.media_src?R.__batchResponses[j].data.Logo.__metadata.media_src:"sap-icon://person-placeholder";var U=f;l[j]=U.toString()}}d.OpportunitySalesTeamSet[m[j]].ImgSrc=l[j];t.mPartnerImgSrc[d.OpportunitySalesTeamSet[m[j]].PartnerNumber]=l[j]}},this),jQuery.proxy(function(){},this),false);b.setData(d);a.setModel(b,"json");if(r.data.Competitors&&r.data.Competitors.results){if(r.data.Competitors.results.length===0){t.byId('tab_competitor').setVisible(false)}else{t.byId('tab_competitor').setVisible(true)}var M=t.byId('competitors').getModel('json');if(M){M.oData.OpportunityCompetitors=r.data.Competitors.results;M.updateBindings()}else{t.byId('competitors').setModel(new sap.ui.model.json.JSONModel({OpportunityCompetitors:r.data.Competitors.results}),'json')}}});if(parseFloat(this.sBackendVersion)>=4){this.refreshMsgLog(true)}if(this.release)sap.ca.ui.utils.busydialog.releaseBusyDialog();this.release=false},addParticipants:function(){this.oModel.clearBatch();var c=[];var a=this.participantsF4Fragment.getContent()[0].getSelectedItem().getBindingContext('json').getObject().PartnerFunctionCode;var h=this.byId('info').getModel('json').getData().Guid;var b=this.participantsF4Fragment.getContent()[2].getSelectedItems();var e;for(var i=0;i<b.length;i++){e={HeaderGuid:h,PartnerNumber:b[i].data("ID"),PartnerFunctionCode:a};c.push(this.oModel.createBatchOperation("OpportunitySalesTeamSet","POST",e,null))}if(c.length>0){this.oModel.addBatchChangeOperations(c);this.oModel.submitBatch(jQuery.proxy(function(r){this.getParticipants();this.participantsF4Fragment.getContent()[2].removeSelections();this.participantsF4Fragment.getContent()[1].clear();this.participantsF4Fragment.close();if(a==="00000015")sap.ui.getCore().getEventBus().publish("cus.crm.opportunity","contactAdded",{contextPath:"Opportunities(guid'"+h+"')"})},this),jQuery.proxy(function(E){this.handleErrors(E)},this))}},onDeleteParticipant:function(e){var c=e.getSource().getBindingContext('json').getObject();var C=this.getRuleForPartnerFunction(c.PartnerFunctionCode);if(this.getCountForPartnerFunction(c.PartnerFunctionCode)-1<C.CountLow){if(C.CountLow===1){sap.ca.ui.message.showMessageToast(this.oResourceBundle.getText('MUST_HAVE_PARTICIPANTS_1',[C.CountLow]))}else{sap.ca.ui.message.showMessageToast(this.oResourceBundle.getText('MUST_HAVE_PARTICIPANTS',[C.CountLow]))}return}var h=this.byId('info').getModel('json').getData().Guid;var p=["OpportunitySalesTeamSet(HeaderGuid=guid'",h,"',PartnerNumber='",c.PartnerNumber,"',PartnerFunctionCode='",c.PartnerFunctionCode,"')"].join("");this.oModel.remove(p,null,jQuery.proxy(function(){this.getParticipants();this.oModel.refresh();if(c&&c.PartnerFunctionCode==="00000015")sap.ui.getCore().getEventBus().publish("cus.crm.opportunity","contactDeleted",{contextPath:"Opportunities(guid'"+h+"')"})},this),jQuery.proxy(function(E){this.handleErrors(E)},this))},getChangeable:function(p){for(var i=0;i<this.partnerDeterminationMap[this.transactionType].length;i++){if(this.partnerDeterminationMap[this.transactionType].PartnerFunctionCode===p){return this.partnerDeterminationMap[this.transactionType].ChangeableFlag}}return true},showParticipantsF4:function(){this.iIndexStatus=false;var s;if(!this.participantsF4MultiselectFragment){this.participantsF4MultiselectFragment=new sap.ui.xmlfragment(this.createId("participantsF4_S3"),'cus.crm.opportunity.view.ParticipantsF4Multiselect',this);this.participantsF4MultiselectFragment.setModel(new sap.ui.model.json.JSONModel({}),"json");this.participantsF4MultiselectFragment.setModel(this.oI18nModel,'i18n');s=this.participantsF4MultiselectFragment.getContent()[0]}s=this.participantsF4MultiselectFragment.getContent()[0];this.participantsF4MultiselectFragment.getModel('json').getData().PartnerFunctions=this.partnerDeterminationMap[this.transactionType];this.participantsF4MultiselectFragment.getModel('json').updateBindings();this.participantsF4MultiselectFragment.getContent()[0].getPages()[0].getContent()[0].bindItems("json>/PartnerFunctions",this.oPartnerFunctionsTemplate,null,[]);s.getPages()[1].getContent()[0].setMode("MultiSelect");var c=this.participantsF4MultiselectFragment.getContent()[0].getPages()[0].getContent()[0].getItems();if(c.length>0)for(var k=0;k<c.length;k++){c[k].setInfo(" ");c[k].setSelected(false)}this.participantsF4MultiselectFragment.getContent()[0].getPages()[1].setShowNavButton(true);this.participantsF4MultiselectFragment.getContent()[0].getPages()[1].getFooter().getContentRight()[0].setEnabled(true);this.participantsF4MultiselectFragment.open()},closeParticipantsF4:function(e){this.participantsF4Fragment.getContent()[1].clear();this.participantsF4Fragment.getContent()[2].removeSelections();this.participantsF4Fragment.close()},addContact:function(e){var m=this.getView().getModel();this.contactF4Fragment.getContent()[0].removeSelections();this.contactF4Fragment.setModel(new sap.ui.model.json.JSONModel());this.contactF4Fragment.setModel(this.getView().getModel("i18n"),"i18n");this.contactF4Fragment.getContent()[0].setNoDataText(sap.ca.scfld.md.app.Application.getImpl().getResourceBundle().getText('LOADING_TEXT'));var t=this.contactF4Fragment.getContent()[0].getInfoToolbar();var a=t.getContent()[0];t.setVisible(false);this.contactF4Fragment.getSubHeader().getContentLeft()[0].setValue("");var o=this.byId('info').getModel('json').getData();this.opportunity_number=o.ProspectNumber;this.contactF4Fragment.open();var j=new sap.ui.model.json.JSONModel();this.contactF4Fragment.setModel(j,"json");if(this.opportunity_number!=""&&this.opportunity_number!=undefined){t.setVisible(true);a.setText(sap.ca.scfld.md.app.Application.getImpl().getResourceBundle().getText('FILTER')+" "+o.ProspectName);m.read("/AccountCollection(accountID='"+this.opportunity_number+"')/Contacts",null,null,true,jQuery.proxy(function(b,r){this.contactF4Fragment.getModel('json').setData({ContactCollection:r.data.results});if(r.data.results.length===0)this.contactF4Fragment.getContent()[0].setNoDataText(sap.ca.scfld.md.app.Application.getImpl().getResourceBundle().getText('NO_CONTACTS'))},this),jQuery.proxy(function(E){this.contactF4Fragment.getModel('json').setData({ContactCollection:[]});this.contactF4Fragment.getContent()[0].setNoDataText(sap.ca.scfld.md.app.Application.getImpl().getResourceBundle().getText('NO_CONTACTS'))},this))}else{t.setVisible(false);this.contactF4Fragment.getModel('json').setData({ContactCollection:[]});this.contactF4Fragment.getContent()[0].setNoDataText(sap.ca.scfld.md.app.Application.getImpl().getResourceBundle().getText('LOADING_TEXT'));m.read("ContactCollection",null,null,true,jQuery.proxy(function(b,r){this.contactF4Fragment.getModel('json').setData({ContactCollection:r.data.results});if(r.data.results.length===0)this.contactF4Fragment.getContent()[0].setNoDataText(sap.ca.scfld.md.app.Application.getImpl().getResourceBundle().getText('NO_CONTACTS'))},this),jQuery.proxy(function(E){this.contactF4Fragment.getContent()[0].setNoDataText(sap.ca.scfld.md.app.Application.getImpl().getResourceBundle().getText('NO_CONTACTS'))},this))}},setContact:function(e){var m=this.getView().getModel();this.oSelectedContact=e.getSource().getSelectedItem().getBindingContext("json").getObject();var a=this.byId('info').getModel('json').getData().ProspectNumber;var h=this.byId('info').getModel('json').getData().Guid;var t=this;m.refreshSecurityToken();m.update("OpportunitySalesTeamSet(PartnerNumber='"+this.oSelectedContact.contactID+"',PartnerFunctionCode='00000015',HeaderGuid=guid'"+h+"')",{HeaderGuid:h,PartnerNumber:this.oSelectedContact.contactID,PartnerFunctionCode:'00000015'},{fnSuccess:jQuery.proxy(function(){this.getParticipants()},this),fnError:function(E){this.handleErrors(E)},bMerge:true});this.contactF4Fragment.getContent()[0].removeSelections();var j=new sap.ui.model.json.JSONModel();j.setData({ContactCollection:[]});this.contactF4Fragment.setModel(j,"json");this.contactF4Fragment.close()},closeToolbar:function(e){var t=this.contactF4Fragment.getContent()[0].getInfoToolbar();var o=this.contactF4Fragment.getContent()[0];t.setVisible(false);o.getBinding("items").aFilters=[];o.getBinding("items").sFilterParams="";o.getBinding("items").refresh();this.contactF4Fragment.getModel('json').setData({ContactCollection:[]});o.setNoDataText(sap.ca.scfld.md.app.Application.getImpl().getResourceBundle().getText('LOADING_TEXT'));this.getView().getModel().read("ContactCollection",null,null,true,jQuery.proxy(function(a,r){this.contactF4Fragment.getModel('json').setData({ContactCollection:r.data.results});if(r.data.results.length===0)this.contactF4Fragment.getContent()[0].setNoDataText(sap.ca.scfld.md.app.Application.getImpl().getResourceBundle().getText('NO_CONTACTS'))},this),jQuery.proxy(function(E){this.contactF4Fragment.getContent()[0].setNoDataText(sap.ca.scfld.md.app.Application.getImpl().getResourceBundle().getText('NO_CONTACTS'))},this))},onRenameFile:function(e){var n=e.getParameters().newFilename;var f=e.getParameters().fileId;var o={"newFileName":n+"","fileId":f+""};var h=this.byId('info').getModel('json').getData().Guid;var P=e.getParameters();var U;if(P.media_src)U=P.media_src;else U=P.url;var r=U.split("(").pop();var p="OpportunityAttachments(";var u=p+r;this.oModel.setHeaders(o);this.oModel.addBatchChangeOperations([this.oModel.createBatchOperation(u,"PUT",o,null)])},onSaveClicked:function(){var b;this.oModel.submitBatch();var s=true;var f=this.byId("fileupload");if(s){f.commitPendingRenames()}else{f.abandonPendingRenames()}},closeContactF4:function(e){var j=new sap.ui.model.json.JSONModel();j.setData({ContactCollection:[]});this.contactF4Fragment.setModel(j,"json");this.contactF4Fragment.close()},searchContact:function(e){var v=e.getParameter("query");this.contactF4Fragment.getContent()[0].setNoDataText(sap.ca.scfld.md.app.Application.getImpl().getResourceBundle().getText('LOADING_TEXT'));var t=this.contactF4Fragment.getContent()[0].getInfoToolbar();if(t.getVisible()===false){this.getView().getModel().read("ContactCollection",null,["$filter=substringof('"+v+"'"+",fullName)"],true,jQuery.proxy(function(o,r){this.contactF4Fragment.getModel('json').setData({ContactCollection:r.data.results});if(r.data.results.length===0)this.contactF4Fragment.getContent()[0].setNoDataText(sap.ca.scfld.md.app.Application.getImpl().getResourceBundle().getText('NO_CONTACTS'))},this),jQuery.proxy(function(E){this.contactF4Fragment.getModel('json').setData({ContactCollection:[]});this.contactF4Fragment.getContent()[0].setNoDataText(sap.ca.scfld.md.app.Application.getImpl().getResourceBundle().getText('NO_CONTACTS'))},this))}else{var a=this.byId('info').getModel('json').getData().ProspectNumber;this.getView().getModel().read("/AccountCollection(accountID='"+a+"')/Contacts",null,["$filter=substringof('"+v+"'"+",fullName)"],true,jQuery.proxy(function(o,r){this.contactF4Fragment.getModel('json').setData({ContactCollection:r.data.results});if(r.data.results.length===0)this.contactF4Fragment.getContent()[0].setNoDataText(sap.ca.scfld.md.app.Application.getImpl().getResourceBundle().getText('NO_CONTACTS'))},this),jQuery.proxy(function(E){this.contactF4Fragment.getModel('json').setData({ContactCollection:[]});this.contactF4Fragment.getContent()[0].setNoDataText(sap.ca.scfld.md.app.Application.getImpl().getResourceBundle().getText('NO_CONTACTS'))},this))}},handleErrors:function(e){sap.ca.ui.utils.busydialog.releaseBusyDialog();jQuery.sap.log.error(JSON.stringify(e));sap.ca.ui.message.showMessageBox({type:sap.ca.ui.message.Type.ERROR,message:e.message,details:JSON.parse(e.response.body).error.message.value},function(r){})},getDataForDetailScreen:function(s){var e="$expand=Products,ChangeDocs,Competitors";if(parseFloat(this.sBackendVersion)>=4){e+=",OpportunityLogSet";var a=this.getView().getModel("controllers").getData().s4Controller;if(a&&a.bSuccessSave){delete a.bSuccessSave}else{cus.crm.opportunity.util.Util.refreshHeaderETag(this.sPath,this)}}if(this.bAppLaunched){this.oModel.addBatchReadOperations([this.oModel.createBatchOperation("SalesStages","GET")]);this.oModel.addBatchReadOperations([this.oModel.createBatchOperation("Priorities","GET")]);this.oModel.addBatchReadOperations([this.oModel.createBatchOperation("UserStatuses","GET")]);this.oModel.addBatchReadOperations([this.oModel.createBatchOperation("Currencies","GET")]);this.oModel.addBatchReadOperations([this.oModel.createBatchOperation(this.sPath+"?"+e,"GET")]);if(parseFloat(this.sBackendVersion)>=4){this.oModel.addBatchReadOperations([this.oModel.createBatchOperation(this.sPath,"GET")]);var p=cus.crm.opportunity.util.Util.getPartnerFunctions();if(!p){this.oModel.addBatchReadOperations([this.oModel.createBatchOperation("PartnerFunctions","GET")])}}if(this.extHookGetAdditionalCustomizing){this.extHookGetAdditionalCustomizing()}this.oModel.submitBatch(jQuery.proxy(this.handleBatchResponses,this),jQuery.proxy(this.handleBatchErrors,this))}else this.oModel.read(this.sPath,null,[e],true,jQuery.proxy(function(o,r){this.bindInfoAndProducts(r.data,s)},this),jQuery.proxy(this.handleErrors,this));if(this.extHookGetDataForDetailScreen){this.extHookGetDataForDetailScreen()}},handleBatchResponses:function(r){var f=false;var e;var a;var t=this;this.bAppLaunched=false;if(r.__batchResponses[0].statusCode==="200"){t.SalesStages=r.__batchResponses[0].data.results}else{f=true;e=r.__batchResponses[0].statusText;a=JSON.parse(r.__batchResponses[0].response.body).error.message.value+"\n"}if(r.__batchResponses[1].statusCode==="200"){t.Priorities=r.__batchResponses[1].data.results}else{f=true;e=r.__batchResponses[1].statusText;a=JSON.parse(r.__batchResponses[1].response.body).error.message.value+"\n"}if(r.__batchResponses[2].statusCode==="200"){t.UserStatuses=r.__batchResponses[2].data.results}else{f=true;e=r.__batchResponses[2].statusText;a=JSON.parse(r.__batchResponses[2].response.body).error.message.value+"\n"}if(r.__batchResponses[3].statusCode==="200"){t.Currencies=r.__batchResponses[3].data.results}else{f=true;e=r.__batchResponses[3].statusText;a=JSON.parse(r.__batchResponses[3].response.body).error.message.value+"\n"}if(f){sap.ca.ui.message.showMessageBox({type:sap.ca.ui.message.Type.ERROR,message:e,details:a},function(R){var i=0;i++})}if(r.__batchResponses[4].hasOwnProperty("data"))this.bindInfoAndProducts(r.__batchResponses[4].data,true);else this.handleErrors(r.__batchResponses[4]);if(parseFloat(this.sBackendVersion)>=4){if(r.__batchResponses[5].hasOwnProperty("data")){this._saveETag(r.__batchResponses[5].data.Etag)}else this.handleErrors(aResponses.__batchResponses[5]);if(r.__batchResponses[6]&&r.__batchResponses[6].hasOwnProperty("data")){var u=cus.crm.opportunity.util.Util;u.aggregatePartnerFunctions(r.__batchResponses[6].data.results);this.partnerDeterminationMap=u.getPartnerFunctions()}else{this.handleErrors(r.__batchResponses[6])}}if(this.extHookHandleBatchResponses){this.extHookHandleBatchResponses(r)}},bindInfoAndProducts:function(d,s){var i=this.byId('info');var p=this.byId('Product_Tab');var a=this.byId('S3_Header');var j=this.getView().getModel("json");if(parseFloat(this.sBackendVersion)<4){this.byId('opportunityTotalNetValue_Label').setVisible(false);this.byId('opportunityTotalNetValue_Text').setVisible(false)}var t=this.oResourceBundle.getText('ERROR_MESSAGE');var L=this.showErrorMsgFragment.getContent()[0];var D=j.oData;this.transactionType=a.getModel('json').getData().ProcessType;if(p){D.Products=d.Products.results}j.updateBindings();if(this.sBackendVersion>=4){if(L&&L.getModel('json')){L.getModel('json').setData({OpportunityLogSet:d.OpportunityLogSet.results});var o=d.OpportunityLogSet.results.length;var m=this.oResourceBundle.getText("ERROR_MESSAGE_TITLE",o);this.showErrorMsgFragment.setTitle(m)}}if(d.Products&&d.Products.results){if(d.Products.results.length===0){this.byId('tab_product').setVisible(false)}else{this.byId('tab_product').setVisible(true)}}if(d.ChangeDocs&&d.ChangeDocs.results){if(d.ChangeDocs.results.length===0){this.byId("log").setVisible(false)}else{this.byId("log").setVisible(true)}}if(d.Competitors&&d.Competitors.results){if(d.Competitors.results.length===0)this.byId('tab_competitor').setVisible(false);else this.byId('tab_competitor').setVisible(true)}if(this.sBackendVersion>=4){if(d.OpportunityLogSet&&d.OpportunityLogSet.results){if(d.OpportunityLogSet.results.length===0){this.setBtnEnabled("errorMsg",false)}else{this.setBtnEnabled("errorMsg",true)}}}if(s){this.setDefaultTabToInfo()}this.bindS3Header(d)},onDeleteFile:function(e){var P=e.getParameters();var U;if(P.media_src)U=P.media_src;else U=P.url;var r=U.split("(").pop();var p="OpportunityAttachments(";var u=p+r;this.oModel.remove(u);this.byId('fileupload').removeFile(P.fileId)},detailRouteMatched:function(e){if(e.getParameter("name")==="detail"||e.getParameter("name")==="detailonly"){this.fullScreenMode=false;this.mPartnerImgSrc={};if(this.navToOtherApp){this.navToOtherApp=false;return}var s=this.getS4Controller();if(s&&s.bCancel&&!this.bAppLaunched){s.bCancel=false;this.setDefaultTabToInfo();return}if(s&&s.bEmployeeUpdateSuccess){this.oModel.refresh()}this.byId('opportunityHeader').setIcon("sap-icon://person-placeholder");this.sPath=e.getParameter("arguments").contextPath;this.getDataForDetailScreen(true);if(this.bAppLaunched){this.bAppLaucnhed=false}}if(e.getParameter("name")==="display"){this.fullScreenMode=true;this.oHeaderFooterOptions=this.oHeaderFooterOptions4UI;if(this.navToOtherApp){this.navToOtherApp=false;return}var s=this.getS4Controller();if(s&&s.bCancel){s.bCancel=false;this.setDefaultTabToInfo();return}if(s&&s.bEmployeeUpdateSuccess){this.oModel.refresh()}this.byId('opportunityHeader').setIcon("sap-icon://person-placeholder");this.sPath=e.getParameter("arguments").contextPath;this.getDataForDetailScreen(true)}},searchSalesArea:function(e){var v=e.getParameter("query").toLowerCase();var s=this.salesareaF4Fragment.getContent()[0].getModel("SalesArea").getProperty("/SalesAreaList").results;var a=new Array();var i=new Array();for(var k=0;k<s.length;k++){if(s[k].SalesOrganizationText.toLowerCase().search(v)!=-1||s[k].DistrubutionChannelText.toLowerCase().search(v)!=-1||s[k].DivisionText.toLowerCase().search(v)!=-1){a.push(s[k])}}this.salesareaF4Fragment.getContent()[0].setNoDataText(this.oResourceBundle.getText('NO_DATA_TEXT'));this.salesareaF4Fragment.getModel('json').setData({SalesAreaCollection:a});this.salesareaF4Fragment.getModel('json').updateBindings()},showSalesAreaF4:function(e){var a=this.byId('opportunityHeader').getModel('json').getData().ProspectNumber;var b=this.byId('opportunityHeader').getModel('json').getData().ProspectName;if(!this.salesareaF4Fragment){this.salesareaF4Fragment=new sap.ui.xmlfragment(this.createId("salesareaF4"),'cus.crm.opportunity.view.SalesAreaDialog',this);this.salesareaF4Fragment.setModel(new sap.ui.model.json.JSONModel(),"json");this.salesareaF4Fragment.setModel(this.oI18nModel,'i18n')}this.salesareaF4Fragment.getContent()[0].removeSelections();this.salesareaF4Fragment.setModel(this.oI18nModel,"i18n");this.salesareaF4Fragment.getContent()[0].setNoDataText(sap.ca.scfld.md.app.Application.getImpl().getResourceBundle().getText('LOADING_TEXT'));var t=this.salesareaF4Fragment.getContent()[0].getInfoToolbar();var c=t.getContent()[0];t.setVisible(false);if(a!==""){t.setVisible(true);c.setText(sap.ca.scfld.md.app.Application.getImpl().getResourceBundle().getText('FILTER')+" "+b);this.oModel.read("/SalesAreas",null,["$filter=ProspectNumber eq '"+a+"'"],true,jQuery.proxy(function(o,r){this.salesareaF4Fragment.getContent()[0].setNoDataText(this.oResourceBundle.getText('NO_DATA_TEXT'));this.salesareaF4Fragment.getModel('json').setData({SalesAreaCollection:r.data.hasOwnProperty("results")?r.data.results:[r.data]});if(!this.salesareaF4Fragment.getModel("SalesArea")){this.salesareaF4Fragment.setModel(new sap.ui.model.json.JSONModel(),"SalesArea")}var s=this.salesareaF4Fragment.getContent()[0].getModel("SalesArea");s.setProperty("/SalesAreaList",r.data);this.salesareaF4Fragment.getModel('json').updateBindings()},this),jQuery.proxy(function(E){this.salesareaF4Fragment.getModel('json').setData({SalesAreaCollection:[]});this.salesareaF4Fragment.getContent()[0].setNoDataText(this.oResourceBundle.getText('NO_DATA_TEXT'))},this))}else{t.setVisible(false);this.salesareaF4Fragment.getModel('json').setData({SalesAreaCollection:[]});this.salesareaF4Fragment.getContent()[0].setNoDataText(sap.ca.scfld.md.app.Application.getImpl().getResourceBundle().getText('LOADING_TEXT'));this.oModel.read("SalesAreas ",null,["$filter=substringof('"+this.byId('salesorganization_Text').getText()+"')"],true,jQuery.proxy(function(o,r){this.salesareaF4Fragment.getModel('json').setData({SalesAreaCollection:r.data.hasOwnProperty("results")?r.data.results:[r.data]});this.salesareaF4Fragment.getContent()[0].setNoDataText(this.oResourceBundle.getText('NO_DATA_TEXT'))},this),jQuery.proxy(function(E){this.salesareaF4Fragment.getContent()[0].setNoDataText(this.oResourceBundle.getText('NO_DATA_TEXT'))},this))}this.salesareaF4Fragment.open()},closeSalesAreaF4:function(e){if(this.salesareaF4Fragment.getContent()[0].getModel("SalesArea")){this.salesareaF4Fragment.getContent()[0].getModel("SalesArea").destroy()}if(this.salesareaF4Fragment!==undefined){this.salesareaF4Fragment.close();if(this.salesareaF4Fragment.getSubHeader().getContentLeft()[0].getValue()!="")this.salesareaF4Fragment.getSubHeader().getContentLeft()[0].setValue("")}},setSalesArea:function(e){if(this.salesareaF4Fragment.getContent()[0].getModel("SalesArea")){this.salesareaF4Fragment.getContent()[0].getModel("SalesArea").destroy()}this.oSelectedContact=e.getSource().getSelectedItem().getBindingContext("json").getObject();this.acc_salesorgid=this.oSelectedContact.SalesOrganizationId;this.acc_salesorgdesc=this.oSelectedContact.SalesOrganizationText;var s=cus.crm.opportunity.util.Formatter.formatSalesOrganization(this.acc_salesorgdesc,this.acc_salesorgid);this.getView().byId("salesorganization_Text").setText(s);this.acc_dischaid=this.oSelectedContact.DistrubutionChannelId;this.acc_dischadesc=this.oSelectedContact.DistrubutionChannelText;var d=cus.crm.opportunity.util.Formatter.formatDistributionChannel(this.acc_dischadesc,this.acc_dischaid);this.getView().byId("distributionchannel_Text").setText(d);this.acc_divid=this.oSelectedContact.DivisionId;this.acc_divdesc=this.oSelectedContact.DivisionText;var a=cus.crm.opportunity.util.Formatter.formatDivision(this.acc_divdesc,this.acc_divid);this.getView().byId("division_Text").setText(a);this.oModel.clearBatch();var c=[];var i=this.getView().byId('info');var h=i.getModel('json').getData().Guid;this.salesareaF4Fragment.getContent()[0].getSelectedItems();var E;E={Guid:h,SalesOrganization:this.acc_salesorgid,SalesOrganizationDescription:this.acc_salesorgdesc,DistributionChannel:this.acc_dischaid,DistributionChannelDescription:this.acc_dischadesc,Division:this.acc_divid,DivisionDescription:this.acc_divdesc,};this.oModel.update("Opportunities(guid'"+h+"')",E,{fnSuccess:jQuery.proxy(function(r){this.salesareaF4Fragment.getContent()[0].removeSelections();this.salesareaF4Fragment.close();cus.crm.opportunity.util.Util.refreshHeaderETag(this.sPath,this)},this),fnError:jQuery.proxy(function(o){if(o.response.statusCode===412){cus.crm.opportunity.util.Util.show412ErrorDialog(this,jQuery.proxy(function(){cus.crm.opportunity.util.Util.refreshHeaderETag(this.sPath,this)},this));return}this.handleErrors(o)},this),bMerge:true});this.closeSalesAreaF4(e);this.refreshMsgLog(true)},onAccountBusCardLaunch:function(e){var a=e.getSource().data("PartnerNumber");var I;if(!this.bHideImage){I=e.getSource().data("Image")}else{I=" "}var m=this.oModel;var b=e.getSource();if(a){var p="AccountCollection(accountID='"+a+"')?$expand=MainAddress,MainContact/WorkAddress,MainContact";var B=[];B.push(m.createBatchOperation(p,"GET"));m.addBatchReadOperations(B);m.submitBatch(jQuery.proxy(function(r){var M={Value:""};M.Value=r.__batchResponses[0].data;var c=jQuery.proxy(function(E){var n={};n.target={};n.target.semanticObject="Account";n.target.action="MyAccounts&/detail/AccountCollection('"+a+"')";this.navToOtherApp=true;return n},this);if(M.Value.MainContact){if(M.Value.MainContact.WorkAddress){if(M.Value.MainAddress){var C={title:sap.ca.scfld.md.app.Application.getImpl().getResourceBundle().getText('ACCOUNT'),imgurl:I,companyname:M.Value.name1,companyphone:M.Value.MainAddress.phone,companyaddress:M.Value.MainAddress.address,maincontactname:M.Value.MainContact.fullName,maincontactmobile:M.Value.MainContact.WorkAddress.mobilePhone,maincontactphone:M.Value.MainContact.WorkAddress.phone,maincontactemail:M.Value.MainContact.WorkAddress.email,maincontactemailsubj:"Automatic Mail for Maincontact",beforeExtNav:c,};var o=new sap.ca.ui.quickoverview.CompanyLaunch(C);o.openBy(b)}else{var C={title:sap.ca.scfld.md.app.Application.getImpl().getResourceBundle().getText('ACCOUNT'),imgurl:I,companyname:M.Value.name1,maincontactname:M.Value.MainContact.fullName,maincontactmobile:M.Value.MainContact.WorkAddress.mobilePhone,maincontactphone:M.Value.MainContact.WorkAddress.phone,maincontactemail:M.Value.MainContact.WorkAddress.email,maincontactemailsubj:"Automatic Mail for Maincontact",beforeExtNav:c,};var o=new sap.ca.ui.quickoverview.CompanyLaunch(C);o.openBy(b)}}else{if(M.Value.MainAddress){var C={title:sap.ca.scfld.md.app.Application.getImpl().getResourceBundle().getText('ACCOUNT'),imgurl:I,companyname:M.Value.name1,companyphone:M.Value.MainAddress.phone,companyaddress:M.Value.MainAddress.address,maincontactname:M.Value.MainContact.fullName,beforeExtNav:c,};var o=new sap.ca.ui.quickoverview.CompanyLaunch(C);o.openBy(b)}else{var C={title:sap.ca.scfld.md.app.Application.getImpl().getResourceBundle().getText('ACCOUNT'),imgurl:I,companyname:M.Value.name1,maincontactname:M.Value.MainContact.fullName,beforeExtNav:c,};var o=new sap.ca.ui.quickoverview.CompanyLaunch(C);o.openBy(b)}}}else{if(M.Value.MainAddress){var C={title:sap.ca.scfld.md.app.Application.getImpl().getResourceBundle().getText('ACCOUNT'),imgurl:I,companyname:M.Value.name1,companyphone:M.Value.MainAddress.phone,companyaddress:M.Value.MainAddress.address,beforeExtNav:c,};var o=new sap.ca.ui.quickoverview.CompanyLaunch(C);o.openBy(b)}else{var C={title:sap.ca.scfld.md.app.Application.getImpl().getResourceBundle().getText('ACCOUNT'),imgurl:I,companyname:M.Value.name1,beforeExtNav:c,};var o=new sap.ca.ui.quickoverview.CompanyLaunch(C);o.openBy(b)}}},this),jQuery.proxy(function(E){sap.m.MessageToast.show(sap.ca.scfld.md.app.Application.getImpl().getResourceBundle().getText('ERROR'))},this),true)}},notesTabSelected:function(){var m=this.getView().getModel();this.byId("listItem").setNoDataText(sap.ca.scfld.md.app.Application.getImpl().getResourceBundle().getText('LOADING_TEXT'));this.byId('listItem').getModel('json').oData.OpportunityNotesSet=[];this.byId('listItem').getModel('json').updateBindings();m.read(this.sPath,null,["$expand=Notes"],true,jQuery.proxy(function(o,r){var t=this.getView().byId("listItem");var j=t.getModel("json");var d=j.oData;d.OpportunityNotesSet=r.data.Notes.results;if(d.OpportunityNotesSet.length==0){this.byId("listItem").setNoDataText(sap.ca.scfld.md.app.Application.getImpl().getResourceBundle().getText('NONOTES'))}j.updateBindings()},this),jQuery.proxy(function(e){this.handleErrors(e)},this))},participantsTabSelected:function(){var d;var l=[];var t=this;var m=this.oModel;var p=this.sPath;this.byId("Sales_Team").setNoDataText((this.oResourceBundle.getText('LOADING_TEXT')));if(parseFloat(this.sBackendVersion)>=2.0){this.partnerFunctionMap={};if(parseFloat(this.sBackendVersion)>=4){var u=cus.crm.opportunity.util.Util;if(u.getPartnerFunctions()===null){u.fetchPartnerFunctions(this.oModel)}this.partnerDeterminationMap=u.getPartnerFunctions()}else{var s=this.byId('S3_Header');this.transactionType=s.getModel('json').getData().ProcessType;if(!this.partnerDeterminationMap[this.transactionType]){this.oModel.read("OpptPartnerFctTypes",null,["TransactionType='"+this.transactionType+"'"],false,jQuery.proxy(function(o,r){this.partnerDeterminationMap[this.transactionType]=r.data.results},this),jQuery.proxy(function(e){},this))}}}this.oModel.read(this.sPath,null,["$expand=SalesTeam"],true,function(o,r){var a=t.getView().byId("Sales_Team");var J=a.getModel("json");var D=J.oData;t.oVersioningModel.getData().setHeaderTextForParticipants(r);D.OpportunitySalesTeamSet=r.data.SalesTeam.results;t.oVersioningModel.getData().setHeaderTextForParticipants(r);if(D.OpportunitySalesTeamSet.length==0){t.byId("Sales_Team").setNoDataText(t.oResourceBundle.getText(t.oVersioningModel.getData().sParticipantsNoDataTextKey))}var b=[];if(!t.bHideImage){for(var i=0;i<D.OpportunitySalesTeamSet.length;i++){var c=D.OpportunitySalesTeamSet[i].PartnerNumber;var p="/AccountCollection('"+c+"')?$expand=Logo";l[i]="sap-icon://person-placeholder";b.push(m.createBatchOperation(p,"GET"))};m.addBatchReadOperations(b);m.submitBatch(jQuery.proxy(function(R){for(var j=0;j<D.OpportunitySalesTeamSet.length;j++){if(!R.__batchResponses[j].hasOwnProperty("data")){l[j]="sap-icon://person-placeholder"}else{if(R.__batchResponses[j].data){if(R.__batchResponses[j].data.Logo&&R.__batchResponses[j].data.Logo.__metadata.media_src){var M=R.__batchResponses[j].data.Logo.__metadata.media_src?R.__batchResponses[j].data.Logo.__metadata.media_src:"sap-icon://person-placeholder";var U=M;l[j]=U.toString()}}}D.OpportunitySalesTeamSet[j].ImgSrc=l[j];t.mPartnerImgSrc[D.OpportunitySalesTeamSet[j].PartnerNumber]=l[j]}J.updateBindings()},this),jQuery.proxy(function(e){sap.m.MessageToast.show(sap.ca.scfld.md.app.Application.getImpl().getResourceBundle().getText('ERROR'))},this),true)}else{for(var i=0;i<D.OpportunitySalesTeamSet.length;i++){D.OpportunitySalesTeamSet[i].ImgSrc=" "}J.updateBindings()}})},competitorsTabSelected:function(){var m=this.oModel;var p=this.sPath;var d;var l=[];var t=this;this.byId("competitors").setNoDataText(sap.ca.scfld.md.app.Application.getImpl().getResourceBundle().getText('LOADING_TEXT'));this.oModel.read(this.sPath,null,["$expand=Competitors"],true,function(o,r){var a=t.getView().byId("competitors");var j=a.getModel("json");var D=j.oData;D.OpportunityCompetitors=r.data.Competitors.results;if(D.OpportunityCompetitors.length==0){t.byId("competitors").setNoDataText(sap.ca.scfld.md.app.Application.getImpl().getResourceBundle().getText('NOCOMPETITORS'))}if(!t.bHideImage){for(var i=0;i<D.OpportunityCompetitors.length;i++){var b=D.OpportunityCompetitors[i].PartnerNumber;var p="/AccountCollection('"+b+"')";l[i]="sap-icon://person-placeholder";m.read(p,null,["$expand=Logo"],false,function(o,r){jQuery.sap.log.info("oData account response");if(o.Logo&&o.Logo.__metadata){var M=o.Logo.__metadata.media_src?o.Logo.__metadata.media_src:"sap-icon://person-placeholder";var U=M;l[i]=U.toString()}});D.OpportunityCompetitors[i].ImgSrc=l[i]}}else{for(var i=0;i<D.OpportunityCompetitors.length;i++){l[i]=" "}};j.updateBindings()})},attachmentsTabSelected:function(){var a=this.getView().byId('info');var h=a.getModel('json').getData().Guid;var m=this.oModel;var p=this.sPath;var t=this.getView();var f=t.byId("fileupload");if(f.getEditMode()===true)f.setEditMode(false);m.refreshSecurityToken();var M=m.getHeaders();f.setXsrfToken(M['x-csrf-token']);var n=h.replace(/-/g,'');f.setCustomHeader("slug",n);m.read(p,null,["$expand=Attachments"],true,function(b,r){var d={OpportunityAttachments:[]};var l=r.data.Attachments.results.length;for(var i=0;i<l;i++){var v=r.data.Attachments.results[i];var c=r.data.Attachments.results[i].Url;var U=v.__metadata.media_src;if(c=="")c=U;var o={name:v.Name,size:v.fileSize,url:cus.crm.opportunity.util.Formatter.urlConverter(c),uploadedDate:v.CreatedAt,contributor:v.CreatedBy,fileExtension:cus.crm.opportunity.util.Formatter.mimeTypeFormatter(v.MimeType),fileId:v.DocumentId,media_src:v.__metadata.media_src};d.OpportunityAttachments.push(o)}t.byId('fileupload').setModel(new sap.ui.model.json.JSONModel(d))})},txHistoryTabSelected:function(){var m=this.oModel;var h=this.byId('info').getModel('json').getData().Guid;var p="/Opportunities(guid'"+h+"')/DocumentHistory";var t=this;m.read(p,null,null,true,jQuery.proxy(function(o,r){this.newResult=r.data.results;var a=t.getView().byId("DocHistory_Tab");var j=a.getModel("json");var d=j.oData;d.OpportunityDocHistory=r.data.results;j.updateBindings()},this),jQuery.proxy(function(e){this.handleErrors(e)},this))},_saveETag:function(e){this.sETag=e},onErrorMsg:function(e){this.showErrorMsgFragment.open()},onOKParticipantDialog:function(e){if(this.participantsF4MultiselectFragment.getContent()[0].getPages()[1].getContent()[0].getMode()=="MultiSelect"){if(this.participantsF4MultiselectFragment.getModel("SelectedPartnerCategoryTemp")){this.oModel.clearBatch();var c=[];var h=this.byId('info').getModel('json').getData().Guid;var E;var p=this.participantsF4MultiselectFragment.getModel("json").getProperty("/PartnerFunctions");for(var a=0;a<p.length;a++){if(this.participantsF4MultiselectFragment.getModel("SelectedPartnerCategoryTemp").getProperty("/"+p[a].PartnerFunctionName)){var b=this.participantsF4MultiselectFragment.getModel("SelectedPartnerCategoryTemp").getProperty("/"+p[a].PartnerFunctionName);for(var i=0;i<b.length;i++){E={HeaderGuid:h,PartnerNumber:b[i].key,PartnerFunctionCode:p[a].PartnerFunctionCode};c.push(this.oModel.createBatchOperation("OpportunitySalesTeamSet","POST",E,null))}}}if(c.length>0){sap.ca.ui.utils.busydialog.requireBusyDialog();this.release=true;this.oModel.addBatchChangeOperations(c);this.oModel.submitBatch(jQuery.proxy(function(r){if(this.participantsF4MultiselectFragment.getModel("SelectedPartnerCategoryTemp")){this.participantsF4MultiselectFragment.getModel("SelectedPartnerCategoryTemp").destroy()}this.getParticipants()},this),jQuery.proxy(function(q){this.handleErrors(q)},this))}}}else{var d=this.participantsF4MultiselectFragment.getContent()[0].getPages()[1].getContent()[0].getSelectedItem();sap.ca.ui.utils.busydialog.requireBusyDialog();this.release=true;var C=this.itemToDelete;var o=this.getRuleForPartnerFunction(C.PartnerFunctionCode);var f=this.partnerDeterminationMap[this.transactionType];var g;for(var k=0;k<f.length;k++){if(f[k].PartnerFunctionCode==C.PartnerFunctionCode){g=f[k].PartnerFunctionCategory}}var j=o.CountLow;if(this.participantsF4MultiselectFragment.getContent()[0]._sSelectedPartnerCategoryCode!=g){if(this.getCountForPartnerFunction(C.PartnerFunctionCode)-1<j){if(j===1){sap.ca.ui.message.showMessageToast(this.oResourceBundle.getText('MUST_HAVE_PARTICIPANTS_1',[j]))}else{sap.ca.ui.message.showMessageToast(this.oResourceBundle.getText('MUST_HAVE_PARTICIPANTS',[j]))}return}}var h=this.byId('info').getModel('json').getData().Guid;var P=["OpportunitySalesTeamSet(HeaderGuid=guid'",h,"',PartnerNumber='",C.PartnerNumber,"',PartnerFunctionCode='",C.PartnerFunctionCode,"')"].join("");this.oModel.clearBatch();var c=[];var h=this.byId('info').getModel('json').getData().Guid;var E;var l=this.participantsF4MultiselectFragment.getContent()[0]._sSelectedPartnerCategoryCode;var p=this.participantsF4MultiselectFragment.getModel("json").getProperty("/PartnerFunctions");var m;for(var n=0;n<p.length;n++){if(p[n].PartnerFunctionCategory==l){m=p[n].PartnerFunctionCode}}E={HeaderGuid:h,PartnerNumber:d.getDescription(),PartnerFunctionCode:m};if(d.getDescription()){this.oModel.addBatchChangeOperations([this.oModel.createBatchOperation("OpportunitySalesTeamSet","POST",E,null)]);this.oModel.addBatchChangeOperations([this.oModel.createBatchOperation(P,"DELETE")]);this.oModel.addBatchChangeOperations(c);this.oModel.submitBatch(jQuery.proxy(function(r){this.getParticipants()},this),jQuery.proxy(function(q){this.handleErrors(q)},this))}}this.participantsF4MultiselectFragment.close();var N=this.participantsF4MultiselectFragment.getContent()[0];N.to(this.participantsF4MultiselectFragment.getContent()[0].getPages()[0])},getCountForPartnerFunctionCode:function(p){var c=0;var a=this.byId('Sales_Team').getModel('json').getData().OpportunitySalesTeamSet;for(var i=0;i<a.length;i++){var b=this.partnerDeterminationMap[this.transactionType];var d;for(var k=0;k<b.length;k++){if(b[k].PartnerFunctionCode==a[i].PartnerFunctionCode){d=b[k].PartnerFunctionCategory}}if(d===p){c++}}return c},onSelectParticipantMinMax:function(e){this.unSelect="";if(this.lastSelectedItem==e.getParameters().listItem.getDescription())this.lastSelectedItem=e.getParameters().listItem.getDescription();var P,a,c,b;if(this.participantsF4MultiselectFragment.getContent()[0].getPages()[1].getContent()[0].getMode()=="MultiSelect"){c=this.participantsF4MultiselectFragment.getContent()[0].getPages()[0].getContent()[0].getSelectedItem().getBindingContext('json').getObject().PartnerFunctionCode;b=this.participantsF4MultiselectFragment.getContent()[0].getPages()[0].getContent()[0].getSelectedItem().getBindingContext('json').getObject().PartnerFunctionName;if(this.participantsF4MultiselectFragment.getModel("SelectedPartnerCategoryTemp"))if(!e.getParameters().selected){var d=e.getParameters().listItem.getDescription();var f=this.participantsF4MultiselectFragment.getModel("SelectedPartnerCategoryTemp").getProperty("/"+b);for(var k=0;k<f.length;k++){if(f[k].key==d){this.participantsF4MultiselectFragment.getModel("SelectedPartnerCategoryTemp").getProperty("/"+b).splice(k,1)}}}var s=this.participantsF4MultiselectFragment.getContent()[0].getPages()[0].getContent()[0];a=s.indexOfItem(s.getSelectedItem());if(a>-1)var g=this.participantsF4MultiselectFragment.getModel('json').getData().PartnerFunctions[a];P=g.PartnerFunctionCategory}var o=this.byId('Sales_Team').getModel('json').oData.OpportunitySalesTeamSet;var p=this.partnerDeterminationMap[this.transactionType];var h=true;for(var x=0;x<o.length;x++){if(o[x].PartnerFunctionText=="Competitor")h=false}if(this.byId('tab_competitor'))var l=this.byId('tab_competitor').getModel('json').getData();if(h)for(var y=0;y<l.Competitors.results.length;y++){for(var k=0;k<p.length;k++){if(p[k].PartnerFunctionName=="Competitor"){o.push({PartnerName:l.Competitors.results[y].PartnerName,PartnerNumber:l.Competitors.results[y].PartnerNumber,PartnerFunctionText:"Competitor",PartnerDetermineProcedure:p[k].PartnerDetermineProcedure,PartnerFunctionCategory:p[k].PartnerFunctionCategory,PartnerFunctionCode:p[k].PartnerFunctionCode});h=false}}}if(h)this.oModel.read(this.sPath,null,["$expand=Competitors"],false,jQuery.proxy(function(A,B){for(var j=0;j<A.Competitors.results.length;j++){for(var k=0;k<p.length;k++){if(p[k].PartnerFunctionName=="Competitor"){o.push({PartnerName:A.Competitors.results[j].PartnerName,PartnerNumber:A.Competitors.results[j].PartnerNumber,PartnerFunctionText:"Competitor",PartnerDetermineProcedure:p[k].PartnerDetermineProcedure,PartnerFunctionCategory:p[k].PartnerFunctionCategory,PartnerFunctionCode:p[k].PartnerFunctionCode})}}}},this),jQuery.proxy(this.handleErrors,this));if(e){var m=e.getParameters().listItem.getTitle();var n=e.getParameters().listItem.getDescription();if(this.participantsF4MultiselectFragment.getContent()[0].getPages()[1].getContent()[0].getMode()=="SingleSelectLeft"){P=this.participantsF4MultiselectFragment.getContent()[0]._sSelectedPartnerCategoryCode;this.participantsF4MultiselectFragment.getModel('json').getData().PartnerFunctions=this.partnerDeterminationMap[this.transactionType];var q=this.participantsF4MultiselectFragment.getModel('json').getData().PartnerFunctions;for(var k=0;k<q.length;k++){if(q[k].PartnerFunctionCategory==P)a=k}}for(var i=0;i<o.length;i++){var p=this.partnerDeterminationMap[this.transactionType];var r;for(var k=0;k<p.length;k++){if(p[k].PartnerFunctionCode==o[i].PartnerFunctionCode){r=p[k].PartnerFunctionCategory}}if(o[i].PartnerNumber==n&&r==P){this.unSelect="unselect";sap.m.MessageToast.show(this.oResourceBundle.getText('PARTICIPANT_EXISTS',[m,b]),{duration:3500});e.getParameters().listItem.setSelected(false);return}}}var t=this.getCountForPartnerFunctionCode(P);var g=this.participantsF4MultiselectFragment.getModel('json').getData().PartnerFunctions[a];var P=g.PartnerFunctionCode;var C=g.CountHigh;var u=g.CountLow;var v=0;if(this.participantsF4MultiselectFragment.getModel("SelectedPartnerCategoryTemp")){if(this.participantsF4MultiselectFragment.getModel("SelectedPartnerCategoryTemp").getProperty("/"+b))v=this.participantsF4MultiselectFragment.getModel("SelectedPartnerCategoryTemp").getProperty("/"+b).length}if(this.participantsF4MultiselectFragment.getContent()[0].getPages()[1].getContent()[0].getMode()=="MultiSelect"){if(v+t>=C){if(e){e.getParameters().listItem.setSelected(false)}if(C===1){sap.m.MessageToast.show(this.oResourceBundle.getText('TOO_MANY_PARTICIPANTS_1',[C]),{duration:3500})}else{sap.m.MessageToast.show(this.oResourceBundle.getText('TOO_MANY_PARTICIPANTS',[C]),{duration:3500})}return}else{if(e.getParameters().selected){if(!this.participantsF4MultiselectFragment.getModel("SelectedPartnerCategoryTemp")){this.participantsF4MultiselectFragment.setModel(new sap.ui.model.json.JSONModel(),"SelectedPartnerCategoryTemp")}var w=e.getParameters().listItem.getDescription();var z=e.getParameters().listItem.getTitle();var E=[];E.push({key:w,value:z});if(this.participantsF4MultiselectFragment.getModel("SelectedPartnerCategoryTemp").getProperty("/"+b)){this.participantsF4MultiselectFragment.getModel("SelectedPartnerCategoryTemp").getProperty("/"+b).push(E[0])}else{this.participantsF4MultiselectFragment.getModel("SelectedPartnerCategoryTemp").setProperty("/"+b,E)}}}}else{this.participantsF4MultiselectFragment.getContent()[0].getPages()[1].getFooter().getContentRight()[0].setEnabled(true)}},onCancelParticipantDialog:function(e){if(this.participantsF4MultiselectFragment.getContent()[0].getPages()[1].getContent()[0].getMode()!="SingleSelectLeft"){if(this.participantsF4MultiselectFragment.getContent()[0].getPages()[1].getId()==e.getSource().getParent().getParent().getId()){this.participantsF4MultiselectFragment.getContent()[0].getPages()[0].getContent()[0].getSelectedItem().setSelected(false)}if(this.participantsF4MultiselectFragment.getModel("SelectedPartnerCategoryTemp")){this.participantsF4MultiselectFragment.getModel("SelectedPartnerCategoryTemp").destroy()}}else{if(this.participantsF4MultiselectFragment.getModel("PartnersBasedonType")){this.participantsF4MultiselectFragment.getModel("PartnersBasedonType").destroy()}}var n=this.participantsF4MultiselectFragment.getContent()[0];n.to(this.participantsF4MultiselectFragment.getContent()[0].getPages()[0]);this.participantsF4MultiselectFragment.close()},onNavBack:function(e){this.participantsF4MultiselectFragment.getContent()[0].getPages()[1].getSubHeader().getContentLeft()[0].clear();if(this.participantsF4MultiselectFragment.getContent()[0].getPages()[1].getContent()[0].getMode()!="SingleSelectLeft"){var s=this.participantsF4MultiselectFragment.getContent()[0]._sSelectedPartnerCategory;var S;if(this.participantsF4MultiselectFragment.getModel("SelectedPartnerCategoryTemp")){S=this.participantsF4MultiselectFragment.getModel("SelectedPartnerCategoryTemp")}var c=0;if(this.participantsF4MultiselectFragment.getModel("SelectedPartnerCategoryTemp"))if(S.getProperty("/"+s))c=c+S.getProperty("/"+s).length;var l=this.participantsF4MultiselectFragment.getContent()[0].getPages()[0].getContent()[0];if(c!=0){l.getSelectedItem().setInfo(c)}else if(l.getSelectedItem()){l.getSelectedItem().setInfo(" ")}l.getSelectedItem().setSelected(false);var n=this.participantsF4MultiselectFragment.getContent()[0];n._sSelectedPartnerCategoryAndParticipants=S;n.to(this.participantsF4MultiselectFragment.getContent()[0].getPages()[0])}else{var a=this.participantsF4MultiselectFragment.getContent()[0].getPages()[0].getContent()[0].getItems();if(a.length>0)for(var k=0;k<a.length;k++){a[k].setInfo(" ");a[k].setSelected(false)}var s=this.participantsF4MultiselectFragment.getContent()[0]._sSelectedPartnerCategoryText;if(this.participantsF4MultiselectFragment.getContent()[0].getPages()[1].getContent()[0].getSelectedItem()){var b=this.participantsF4MultiselectFragment.getContent()[0].getPages()[1].getContent()[0].getSelectedItem();this.participantsF4MultiselectFragment.getContent()[0].getPages()[1].getContent()[0].getSelectedItem().setSelected(false)}if(this.participantsF4MultiselectFragment.getContent()[0].PartnerKey&&!b){var b=this.participantsF4MultiselectFragment.getContent()[0].PartnerKey}var d=this.participantsF4MultiselectFragment.getContent()[0];this.participantsF4MultiselectFragment.getModel('json').getData().PartnerFunctions=this.partnerDeterminationMap[this.transactionType];this.participantsF4MultiselectFragment.getModel('json').updateBindings();var p=this.participantsF4MultiselectFragment.getContent()[0].getPages()[0].getContent()[0].getItems();for(var k=0;k<p.length;k++){p[k].setSelected(false)}var n=this.participantsF4MultiselectFragment.getContent()[0];n.PartnerKey=b;n.to(this.participantsF4MultiselectFragment.getContent()[0].getPages()[0])}},closeErrorMsg:function(e){this.showErrorMsgFragment.close()},refreshMsgLog:function(s){this.oModel.read(this.sPath,null,["$expand=Products,ChangeDocs,Competitors,OpportunityLogSet"],true,jQuery.proxy(function(o,r){this.bindInfoAndProducts(r.data)},this),jQuery.proxy(this.handleErrors,this))}});
